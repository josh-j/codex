---
# playbooks/audit_stigs.yaml
# STIG Compliance Audit Playbook

# ─────────────────────────────────────────────────────────────────────────────
# 1) INITIALIZATION PLAY (localhost)
# ─────────────────────────────────────────────────────────────────────────────
- name: Initialize STIG Audit
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Generate Global Run ID and Metadata
      ansible.builtin.set_fact:
        run_ctx:
          id: "{{ lookup('pipe', 'date +%Y-%m-%d_%H%M%S') }}"
          date: "{{ lookup('pipe', 'date +%Y-%m-%d') }}"
          timestamp: '{{ lookup(''pipe'', ''date "+%Y-%m-%dT%H:%M:%S%z"'') }}'
          report_base: "{{ ops_config.report_directory | default('/srv/samba/reports') }}"
      tags: ["always"]

    - name: Set Output Directory
      ansible.builtin.set_fact:
        run_ctx: "{{ run_ctx | combine({'output_dir': run_ctx.report_base + '/AdHoc/STIG_' + run_ctx.id}) }}"
      tags: ["always"]

    - name: Create Report Directory
      ansible.builtin.file:
        path: "{{ run_ctx.output_dir }}"
        state: directory
        mode: "0755"
      tags: ["always"]

# ─────────────────────────────────────────────────────────────────────────────
# 2) AUDIT PLAY
# ─────────────────────────────────────────────────────────────────────────────
- name: Apply Security Baselines (STIG Audit)
  hosts: all
  gather_facts: false

  pre_tasks:
    - name: Apply Run Context
      ansible.builtin.set_fact:
        global_run_id: "{{ _ctx.id }}"
        ops_report_output_dir: "{{ _ctx.output_dir }}"
      vars:
        _ctx: "{{ hostvars['localhost'].run_ctx }}"
      tags: ["always"]

    - name: Gather Facts (Linux Only)
      ansible.builtin.setup:
      when:
        - "'vcenters' not in group_names"
        - "'esxi' not in group_names"
        - "'linux_servers' in group_names"
      tags: ["linux"]

  tasks:
    - name: Audit vCenter STIGs
      ansible.builtin.include_role:
        name: internal.vsphere.vsphere_stig_audit
      vars:
        ansible_connection: local
      when: "'vcenters' in group_names"
      tags: ["vsphere", "stig"]

    - name: Audit ESXi Hosts
      ansible.builtin.include_role:
        name: internal.esxi.esxi_stig_audit
        apply:
          tags: ["esxi", "stig"]
      vars:
        target_cluster: "ALL"
      when: "'esxi' in group_names"
      tags: ["esxi", "stig"]

    - name: Audit Linux STIGs
      ansible.builtin.include_role:
        name: internal.linux.ubuntu_stig_audit
      when:
        - "'linux_servers' in group_names"
        - ansible_distribution | default('') == 'Ubuntu'
      tags: ["linux", "stig"]
