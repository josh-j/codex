# playbooks/site_health.yaml
# Main entry point for daily infrastructure health checks.
# Uses a three-play structure: Initialize -> Execute -> Aggregate.

# ─────────────────────────────────────────────────────────────────────────────
# 1) INITIALIZATION PLAY (localhost)
# ─────────────────────────────────────────────────────────────────────────────
- name: Initialize Run Context
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Generate Global Run ID and Metadata
      ansible.builtin.set_fact:
        run_ctx:
          id: "{{ lookup('pipe', 'date +%Y-%m-%d_%H%M%S') }}"
          date: "{{ lookup('pipe', 'date +%Y-%m-%d') }}"
          timestamp: '{{ lookup(''pipe'', ''date "+%Y-%m-%dT%H:%M:%S%z"'') }}'
          day: "{{ ops_config.run_day | default(lookup('pipe', 'date +%A') | lower) }}"
      tags: ["always"]

    - name: Determine today's tasks based on schedule
      ansible.builtin.set_fact:
        run_ctx: "{{ run_ctx | combine({'tasks': _tasks}, recursive=true) }}"
      vars:
        _tasks: "{{ ops_config.schedule.day_matrix[run_ctx.day] | default([]) }}"
      tags: ["always"]

    - name: Display Run Summary
      ansible.builtin.debug:
        msg: |
          Run ID:   {{ run_ctx.id }}
          Day:      {{ run_ctx.day }}
          Tasks:    {{ run_ctx.tasks | join(', ') if run_ctx.tasks else 'None (Skipping)' }}
      tags: ["always"]

# ─────────────────────────────────────────────────────────────────────────────
# 2) WORKER PLAY (all sites)
# ─────────────────────────────────────────────────────────────────────────────
- name: Daily Ops Checks (sites)
  hosts: all
  gather_facts: false
  strategy: linear

  pre_tasks:
    - name: Prepare host-specific ops object
      ansible.builtin.set_fact:
        # Bind static config and initialize dynamic keys
        ops: >-
          {{
            ops | default({}) | internal.core.recursive_combine({
              'config': (ops_config | default({})),
              'check': {
                'id': _ctx.id,
                'run_id': _ctx.id,
                'date': _ctx.date,
                'timestamp': _ctx.timestamp,
                'site': inventory_hostname
              },
              'alerts': (ops.alerts | default([])),
              'reports': (ops.reports | default([])),
              'overall': (ops.overall | default({'status': 'Unknown', 'issues': 0, 'summary': ''}))
            })
          }}
        today_tasks: "{{ _ctx.tasks | default([]) }}"
        global_run_id: "{{ _ctx.id }}"
      vars:
        _ctx: "{{ hostvars['localhost'].run_ctx }}"
      tags: ["always"]

  roles:
    - role: internal.vsphere.vsphere_audit
      when:
        - "'vcenters' in group_names"
        - "'vcenter' in today_tasks"

    - role: internal.storage.unity
      when:
        - "'sa' in group_names"
        - "'unisphere' in today_tasks"

    - role: internal.storage.datadomain
      when:
        - "'dd' in group_names"
        - "'backup_unisphere' in today_tasks"

    - role: internal.compute.ucs
      when:
        - "'ucsm' in group_names"
        - "'ucs_fi' in today_tasks"

# ─────────────────────────────────────────────────────────────────────────────
# 3) AGGREGATOR PLAY (localhost)
# ─────────────────────────────────────────────────────────────────────────────
- name: Aggregate Check Results
  hosts: localhost
  gather_facts: true

  vars:
    _ctx: "{{ run_ctx }}"
    today_tasks: "{{ _ctx.tasks }}"
    ops_report_base: "{{ ops_config.report_directory | default('/srv/samba/reports') }}"
    ops_report_dir: "{{ ops_report_base }}/Summary"

  tasks:
    - name: Initialize aggregator ops structure
      ansible.builtin.set_fact:
        ops: >-
          {{
            ops | default({}) | internal.core.recursive_combine({
              'config': (ops_config | default({})),
              'check': {
                'id': _ctx.id,
                'run_id': _ctx.id,
                'date': _ctx.date,
                'timestamp': _ctx.timestamp,
                'site': 'localhost'
              },
              'alerts': (ops.alerts | default([])),
              'reports': (ops.reports | default([])),
              'overall': (ops.overall | default({'status': 'Unknown', 'issues': 0, 'summary': ''}))
            })
          }}

    - name: Aggregate site data
      ansible.builtin.import_role:
        name: internal.core.reporting
        tasks_from: aggregate.yaml

    - name: Ensure output directory
      ansible.builtin.file:
        path: "{{ ops_report_dir }}"
        state: directory
        mode: "0755"

    - name: Render reports (Markdown & HTML)
      ansible.builtin.import_role:
        name: internal.core.reporting
        tasks_from: render.yaml

    # ─────────────────────────────────────────────────────────────────────────
    # 4) EMAIL NOTIFICATION (Optional)
    # ─────────────────────────────────────────────────────────────────────────
    # - name: find combined csv reports to attach
    #   ansible.builtin.find:
    #     paths: "{{ ops_report_base }}/combined/{{ _ctx.id }}"
    #     patterns: "*.csv"
    #     file_type: file
    #   register: _csv_attachments
    #   when: ops.config.email.enabled | default(false) | bool
    #
    # - name: email operations report
    #   community.general.mail:
    #     host: "{{ ops.config.email.smtp.server }}"
    #     port: "{{ ops.config.email.smtp.port | default(25) }}"
    #     subject: "ops report - {{ _ctx.date }} - {{ (today_tasks | default(['ad-hoc'])) | join(', ') | title }}"
    #     from: "{{ ops.config.email.from | default('ansible@example.com') }}"
    #     to: "{{ ops.config.email.recipients | default([]) }}"
    #     attach: >-
    #       {{
    #         [
    #           ops_report_dir ~ '/ops-report-' ~ _ctx.id ~ '.html',
    #           ops_report_dir ~ '/ops-report-' ~ _ctx.id ~ '.md'
    #         ]
    #         + (
    #           (_csv_attachments.files | default([]))
    #           | map(attribute='path')
    #           | list
    #         )
    #       }}
    #     subtype: html
    #     body: |
    #       <h3>daily operations check complete</h3>
    #       <p>run id: {{ _ctx.id }}</p>
    #       <p>tasks: {{ (today_tasks | default(['ad-hoc'])) | join(', ') }}</p>
    #       <p>attached: html dashboard, markdown source, and csv data.</p>
    #       <p><a href="{{ ops.config.report_share_path | default('#') }}">view report archive</a></p>
    #   delegate_to: localhost
    #   when:
    #     - ops.config.email.enabled | default(false) | bool
    #     - not (ops.config.dry_run_mode | default(false) | bool)
    #   ignore_errors: true
