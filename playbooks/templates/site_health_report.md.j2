{#── Helper Macros for Professional Markdown ──#}
{% macro safe(val, default='N/A') -%}
{{ val if val is defined and val is not none and val != '' else default }}
{%- endmacro %}

{% macro health_label(status) -%}
{%- set s = (status | default('unknown') | string | lower) -%}
{%- if s in ['green','ok','healthy','pass'] -%}[OK]
{%- elif s in ['red','critical','fail','failed'] -%}[CRITICAL]
{%- else -%}[WARN]
{%- endif -%}
{%- endmacro %}

{% set stamp = report_stamp | default(now(utc=true, fmt='%Y%m%d')) %}

# Enterprise Infrastructure Audit Report
**Environment:** Production
**Reference ID:** `{{ report_id | default('N/A') }}`
**Generated:** {{ report_date }}

---

## Executive Summary

| Fleet Health | Critical Issues | Warnings | Sites Audited |
| :--- | :--- | :--- | :--- |
| **{{ 100 - (grand_total_critical | int * 2) }}%** | **{{ grand_total_critical }}** | **{{ grand_total_warning }}** | {{ (all_hosts.hosts | default(all_hosts)) | length }} |

> **Audit Note:** Fleet health is calculated based on active critical faults relative to total managed assets.

### Subsystem Status Overview

| Subsystem | Status | Detailed Report |
| :--- | :---: | :--- |
| **VMware Management** | {{ health_label('OK' if alarms_critical|int == 0 else 'CRITICAL') }} | [View VMware Fleet ↗](platform/vmware/vmware_health_report_{{ stamp }}.html) |
| **Linux Infrastructure** | {{ health_label('OK' if alerts_critical|int == 0 else 'CRITICAL') }} | [View Linux Fleet ↗](platform/ubuntu/ubuntu_health_report_{{ stamp }}.html) |

---

## Compute Environment Details

### System Health

| Host | Audit Type | Health | Critical | Warning |
| :--- | :--- | :--- | :--- | :--- |
{% for hostname, audits in (all_hosts.hosts | default(all_hosts)).items() %}
{% if hostname not in ['Split', 'Summary', 'platform'] %}
{% for audit_type, data in audits.items() %}
| [`{{ hostname }}`](platform/ubuntu/{{ hostname }}/health_report_{{ stamp }}.html) | {{ audit_type }} | {{ health_label(data.health | default('unknown')) }} | {{ data.summary.critical_count | default(0) }} | {{ data.summary.warning_count | default(0) }} |
{% endfor %}
{% endif %}
{% endfor %}

---

### Security Compliance (STIG)

| Hostname | Open Findings | Status |
| :--- | :---: | :--- |
{% for hostname, audits in (all_hosts.hosts | default(all_hosts)).items() %}
{% if hostname not in ['Split', 'Summary', 'platform'] %}
{% if audits.stig is defined %}
{% set stig = audits.stig %}
| [`{{ hostname }}`](platform/ubuntu/{{ hostname }}/health_report_{{ stamp }}.html) | {{ stig.alerts | default([]) | length }} | {{ health_label(stig.health | default('unknown')) }} |
{% endif %}
{% endif %}
{% endfor %}

---

## Active Alert Queue

{% set all_active_alerts = [] %}
{% for hostname, audits in (all_hosts.hosts | default(all_hosts)).items() %}
{% if hostname not in ['Split', 'Summary', 'platform'] %}
{% for audit_type, data in audits.items() %}
{% for alert in (data.alerts | default([])) %}
{% set _ = all_active_alerts.append(alert | combine({'host': hostname, 'audit_type': audit_type})) %}
{% endfor %}
{% endfor %}
{% endif %}
{% endfor %}

{% if all_active_alerts | length > 0 %}

| Severity | Host | Audit | Category | Message |
| :--- | :--- | :--- | :--- | :--- |
{% for alert in all_active_alerts %}
| **{{ alert.severity | upper }}** | `{{ alert.host }}` | {{ alert.audit_type }} | {{ alert.category | upper }} | {{ alert.message }} |
{% endfor %}

{% else %}
*No active alerts or compliance violations detected.*
{% endif %}

---
**Report Source:** `{{ ncs_config.report_directory | default('/srv/samba/reports') }}`
**Aggregation ID:** `{{ report_id }}`
*Confidential - Internal Use Only*
