{#── Helper Macros for Professional Markdown ──#}
{% macro safe(val, default='N/A') -%}
{{ val if val is defined and val is not none and val != '' else default }}
{%- endmacro %}

{% macro health_label(status) -%}
{%- set s = (status | default('unknown') | string | lower) -%}
{%- if s in ['green','ok','healthy'] -%}[OK]
{%- elif s in ['red','critical'] -%}[CRITICAL]
{%- else -%}[WARN]
{%- endif -%}
{%- endmacro %}

{% macro bool_label(val, true_text='YES', false_text='NO', invert=False) -%}
{% if invert %}
{{ '[FAILED] ' + true_text if val else '[PASS] ' + false_text }}
{% else %}
{{ '[PASS] ' + true_text if val else '[FAILED] ' + false_text }}
{% endif %}
{%- endmacro %}

# Enterprise Infrastructure Audit Report
**Environment:** Production
**Reference ID:** `{{ report_id | default('N/A') }}`
**Generated:** {{ report_date }}

---

## Executive Summary

| Fleet Health | Critical Issues | Warnings | Sites Audited |
| :--- | :--- | :--- | :--- |
| **{{ 100 - (grand_total_critical * 2) }}%** | **{{ grand_total_critical }}** | **{{ grand_total_warning }}** | {{ counts.get('sites_audited', 0) }} |

> **Audit Note:** Fleet health is calculated based on active critical faults relative to total managed assets.

### Subsystem Status Overview

| Subsystem | Site Count | Faults (C/W) | SLA Status |
| :--- | :---: | :---: | :--- |
| **VMware Management** | {{ (groups['vcenters'] | default([])) | length }} | {{ alarms_critical }}/{{ alarms_warning }} | {{ 'PASS' if (alarms_critical == 0) else 'FAIL' }} |
| **Linux Infrastructure** | {{ (groups['ubuntu_servers'] | default([])) | length }} | {{ alerts_critical }}/{{ alerts_warning }} | {{ 'PASS' if (alerts_critical == 0) else 'FAIL' }} |
| **Enterprise Storage** | {{ unisphere | length }} | - / - | {{ 'STABLE' if unisphere | length > 0 else 'NO DATA' }} |

---

## Compute Environment Details

### vCenter Infrastructure Health

| Site | Version | Overall | Database | Storage | Backup | SSH |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- |
{% for hostname, audits in all_hosts.items() if audits.system is defined %}
{% set sys = audits.system %}
| `{{ hostname }}` | {{ sys.version | default('---') }} | {{ health_label(sys.health) }} | {{ health_label(sys.db_health) }} | {{ health_label(sys.storage_health) }} | {{ 'Enabled' if sys.backup_enabled else 'Disabled' }} | {{ 'SECURE' if not sys.ssh_enabled else 'OPEN' }} |
{% endfor %}

### Security Compliance (STIG)

| Hostname | Compliance Score | Open Findings | Status |
| :--- | :--- | :---: | :--- |
{% for hostname, audits in all_hosts.items() if audits.stig is defined %}
{% set stig = audits.stig %}
| `{{ hostname }}` | {{ 100 - (stig.alerts | length) }}% | {{ stig.alerts | length }} | {{ health_label(stig.health) }} |
{% endfor %}

---

## Active Alert Queue

{% if all_hosts.values() | map(attribute='alerts') | flatten | length > 0 %}

| Severity | Origin | Category | Message |
| :--- | :--- | :--- | :--- |
{% for hostname, audits in all_hosts.items() %}
{% for alert in audits.get('system', {}).get('alerts', []) + audits.get('stig', {}).get('alerts', []) %}
| **{{ alert.severity | upper }}** | `{{ hostname }}` | {{ alert.category | upper }} | {{ alert.message }} |
{% endfor %}
{% endfor %}

{% else %}
*No active alerts or compliance violations detected.*
{% endif %}

---
**Report Source:** `{{ ncs_config.report_directory | default('/srv/samba/reports') }}`
**Aggregation ID:** `{{ report_id }}`
*Confidential - Internal Use Only*
