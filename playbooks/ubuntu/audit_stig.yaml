---
# playbooks/ubuntu/audit_stig.yaml
- name: "Phase 1: Prepare Environment"
  ansible.builtin.import_playbook: ../common/init_environment.yaml
  tags: ["always"]

- name: "Phase 2: Ubuntu STIG Audit"
  hosts: "{{ ubuntu_target_hosts | default('ubuntu_servers') }}"
  gather_facts: false
  become: true
  tags: ["ubuntu", "audit", "stig", "security"]
  roles:
    - role: internal.linux.ubuntu_system_discover
      vars:
        ubuntu_mem_warning_pct: "{{ ubuntu_config.mem_warning_pct | default(95) }}"
        ubuntu_disk_warning_pct: "{{ ubuntu_config.storage_warning_pct | default(90) }}"
        ncs_export_path: "{{ ncs_config | internal.core.resolve_ncs_path('ubuntu', inventory_hostname, 'discovery') }}"
    - role: internal.linux.ubuntu_stig_audit
      vars:
        ubuntu_stig_enable_audit: true
        ubuntu_stig_enable_hardening: false
        ubuntu_stig_artifacts_dir: "{{ ncs_config | internal.core.resolve_ncs_path('artifacts', audit_type='stig') | dirname }}"
        ncs_export_path: "{{ ncs_config | internal.core.resolve_ncs_path('ubuntu', inventory_hostname, 'stig') }}"
- name: "Phase 3: Aggregate and Report"
  ansible.builtin.import_playbook: ../common/generate_fleet_reports.yaml
  tags: ["always"]
