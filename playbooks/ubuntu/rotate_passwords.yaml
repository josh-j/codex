---
- name: "Tactical Password Rotation"
  hosts: "{{ target | default('undefined') }}"
  gather_facts: false
  serial: 1 # Processes one host at a time for secure prompting

  vars_prompt:
    - name: user_name
      prompt: "Target username to rotate"
      default: "admin"
      private: false

    - name: new_password
      prompt: "Enter the new password for {{ user_name }}"
      private: true
      confirm: true

  pre_tasks:
    - name: "Validate target"
      ansible.builtin.fail:
        msg: "Please specify a target (e.g., -e 'target=my-host')"
      when: target == 'undefined'

    - name: "Generate secure hash"
      ansible.builtin.set_fact:
        # High-security SHA512 hashing
        _hashed_password: "{{ new_password | password_hash('sha512') }}"
        ubuntu_users:
          - name: "{{ user_name }}"
            password: "{{ new_password | password_hash('sha512') }}"
            update_password: "always"
            force_change: true
      no_log: true

  roles:
    # 1. Update the password (Phase 2 Action)
    - role: internal.linux.ubuntu_manage_passwords

    # 2. Re-discover & Audit (Phase 1 & 2 Refresh)
    # This ensures the local YAML state file is updated immediately
    - role: internal.linux.ubuntu_system_discover
    - role: internal.linux.ubuntu_system_audit

  post_tasks:
    - name: "Final Summary"
      ansible.builtin.debug:
        msg: "Rotation complete for {{ inventory_hostname }}. User {{ user_name }} forced to change at next login."
