---
- name: "Phase 1: Prepare Environment"
  ansible.builtin.import_playbook: ../common/init_environment.yaml
  tags: ['always']

- name: "Phase 2: Windows Audit (Inventory / Compliance, No Updates)"
  hosts: "{{ windows_target_hosts | default('windows_servers') }}"
  gather_facts: false
  tags: ['windows', 'audit']
  roles:
    - role: internal.windows.windows_audit
      vars:
        windows_audit_force_update: "{{ windows_config.force_update | default(false) }}"
        windows_audit_include_system_apps: "{{ windows_config.include_system_apps | default(false) }}"
        windows_audit_update_age_warning_days: "{{ windows_config.update_age_warning_days | default(30) }}"
        windows_audit_update_age_critical_days: "{{ windows_config.update_age_critical_days | default(90) }}"
        ncs_export_path: "{{ ncs_config | internal.core.resolve_ncs_path('windows', inventory_hostname, 'windows_audit') }}"

- name: "Phase 3: Aggregate and Report"
  ansible.builtin.import_playbook: ../common/generate_fleet_reports.yaml
  tags: ['always']
