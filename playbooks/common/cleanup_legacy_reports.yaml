---
# playbooks/common/cleanup_legacy_reports.yaml
#
# PURPOSE: One-time execution to prune the legacy report structure.
# CAUTION: This will recursively delete folders. Ensure paths are correct.

- name: Clean Legacy Report Architecture
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    _reports_root: "{{ ncs_config.report_directory | default('/srv/samba/reports') }}"

  tasks:
    - name: "1. Identify legacy host directories in root"
      # We look for any directory in root that IS NOT 'platform'
      ansible.builtin.find:
        paths: "{{ _reports_root }}"
        file_type: directory
        excludes: "platform"
      register: _root_dirs

    - name: "2. Prune legacy host directories from root"
      ansible.builtin.file:
        path: "{{ item.path }}"
        state: absent
      loop: "{{ _root_dirs.files }}"
      loop_control:
        label: "{{ item.path }}"

    - name: "3. Verification"
      ansible.builtin.debug:
        msg: "Cleanup complete. Root '{{ _reports_root }}' now only contains platform-specific subdirs."
