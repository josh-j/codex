---
# playbooks/common/init_environment.yaml
# Phase 1: Validates the report root and platform hierarchy.
# Refactored to support the decentralized 3-tier reporting architecture.

- name: Initialize Environment
  hosts: localhost
  gather_facts: false

  vars:
    _report_dir: "{{ ncs_config.report_directory | default('/srv/samba/reports') }}"
    # Only the platform root is required here.
    # Sub-directories like /ubuntu and /vmware are created on-the-fly by summary roles.
    _required_subdirs:
      - "platform"

  tasks:
    - name: Verify report directory exists and is writable
      ansible.builtin.file:
        path: "{{ _report_dir }}"
        state: directory
        # SetGID (2) + rwxrwxr-x (775)
        mode: "2775"
      register: _dir_check
      failed_when: false

    - name: Fail if directory missing
      ansible.builtin.fail:
        msg: >-
          Report directory '{{ _report_dir }}' is missing or inaccessible.
          Ensure the Samba share is provisioned.
          Run: ansible-playbook playbooks/common/setup_samba_reports.yaml
      when: _dir_check is failed

    - name: Ensure report subdirectories exist
      ansible.builtin.file:
        path: "{{ _report_dir }}/{{ item }}"
        state: directory
        # Reinforced 2775 ensures 'platform' and its children inherit group ownership
        mode: "2775"
      loop: "{{ _required_subdirs }}"
