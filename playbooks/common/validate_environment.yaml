---
# Pre-flight validation playbook
# Run this before site_health.yaml to ensure environment is ready
# Usage: ansible-playbook playbooks/validate_environment.yaml

- name: Validate localhost environment
  hosts: localhost
  gather_facts: true
  vars:
    validation_failed: false
    validation_warnings: []
    validation_errors: []
    # Dynamic default if variable is missing (matches group_vars/all/config.yaml)
    _report_dir_path: "{{ ncs.config.report_directory | default('/srv/samba/reports') }}"

  tasks:
    - name: Display validation header
      ansible.builtin.debug:
        msg: |
          ╔══════════════════════════════════════════════════════════╗
          ║      Ansible NCS Environment Validation                  ║
          ║      Checking prerequisites before running checks        ║
          ╚══════════════════════════════════════════════════════════╝

    - name: Check Python version
      ansible.builtin.command: python3 --version
      register: python_version
      changed_when: false

    - name: Display Python version
      ansible.builtin.debug:
        msg: "✓ Python version: {{ python_version.stdout }}"

    - name: Check if virtual environment is activated
      ansible.builtin.shell: echo $VIRTUAL_ENV
      register: venv_check
      changed_when: false

    - name: Warn if venv not activated
      ansible.builtin.set_fact:
        validation_warnings: "{{ validation_warnings + ['Virtual environment not activated - run: source .venv/bin/activate'] }}"
      when: venv_check.stdout == ""

    - name: Check for vault password file
      ansible.builtin.stat:
        path: "../.vaultpass"
      register: vaultpass_file

    - name: Report vault password file status
      ansible.builtin.debug:
        msg: "{{ '✓' if vaultpass_file.stat.exists else '✗' }} Vault password file: {{ '.vaultpass exists' if vaultpass_file.stat.exists else '.vaultpass NOT FOUND' }}"

    - name: Add error if vault password missing
      ansible.builtin.set_fact:
        validation_errors: "{{ validation_errors + ['Vault password file missing: .vaultpass'] }}"
        validation_failed: true
      when: not vaultpass_file.stat.exists

    # -----------------------------------------------------------
    # UPDATED: Dynamic Report Directory Check
    # -----------------------------------------------------------
    - name: Check report directory
      ansible.builtin.stat:
        path: "{{ _report_dir_path }}"
      register: report_dir

    - name: Report directory status
      ansible.builtin.debug:
        msg: "{{ '✓' if report_dir.stat.exists else '⚠' }} Report directory: {{ _report_dir_path }} {{ 'exists' if report_dir.stat.exists else 'NOT FOUND' }}"

    - name: Warn if report directory missing
      ansible.builtin.set_fact:
        validation_warnings: "{{ validation_warnings + ['Report directory ' + _report_dir_path + ' not found - reports will fail'] }}"
      when: not report_dir.stat.exists
    # -----------------------------------------------------------

    - name: Check logs directory
      ansible.builtin.stat:
        path: "{{ playbook_dir }}/../logs"
      register: logs_dir

    - name: Create logs directory if missing
      ansible.builtin.file:
        path: "{{ playbook_dir }}/../logs"
        state: directory
        mode: "0755"
      when: not logs_dir.stat.exists

    - name: Report logs directory status
      ansible.builtin.debug:
        msg: "✓ Logs directory: {{ 'exists' if logs_dir.stat.exists else 'created' }}"

    - name: Check required Python packages
      ansible.builtin.command: python3 -c "import {{ item }}"
      register: package_check
      changed_when: false
      failed_when: false
      loop:
        - ansible
        - pyVmomi
        - pyVim
        - aiohttp
      loop_control:
        label: "{{ item }}"

    - name: Report package status
      ansible.builtin.debug:
        msg: "{{ '✓' if item.rc == 0 else '✗' }} Python package: {{ item.item }} {{ 'installed' if item.rc == 0 else 'MISSING' }}"
      loop: "{{ package_check.results }}"
      loop_control:
        label: "{{ item.item }}"

    - name: Add errors for missing packages
      ansible.builtin.set_fact:
        validation_errors: "{{ validation_errors + ['Python package missing: ' + item.item] }}"
        validation_failed: true
      when: item.rc != 0
      loop: "{{ package_check.results }}"
      loop_control:
        label: "{{ item.item }}"

    - name: Check Ansible collections
      ansible.builtin.command: ansible-galaxy collection list {{ item }}
      register: collection_check
      changed_when: false
      failed_when: false
      loop:
        - community.vmware
        - community.general
      loop_control:
        label: "{{ item }}"

    - name: Report collection status
      ansible.builtin.debug:
        msg: "{{ '✓' if item.rc == 0 else '✗' }} Ansible collection: {{ item.item }} {{ 'installed' if item.rc == 0 else 'MISSING' }}"
      loop: "{{ collection_check.results }}"
      loop_control:
        label: "{{ item.item }}"

    - name: Add errors for missing collections
      ansible.builtin.set_fact:
        validation_errors: "{{ validation_errors + ['Ansible collection missing: ' + item.item + ' (run: ./scripts/install_collections.sh)'] }}"
        validation_failed: true
      when: item.rc != 0
      loop: "{{ collection_check.results }}"
      loop_control:
        label: "{{ item.item }}"

    - name: Display warnings summary
      ansible.builtin.debug:
        msg: |2

          ⚠ WARNINGS ({{ validation_warnings | length }}):
          {% for warning in validation_warnings %}
          - {{ warning }}
          {% endfor %}
      when: validation_warnings | length > 0

    - name: Display errors summary
      ansible.builtin.debug:
        msg: |2

          ✗ ERRORS ({{ validation_errors | length }}):
          {% for error in validation_errors %}
          - {{ error }}
          {% endfor %}
      when: validation_errors | length > 0

    - name: Display success message
      ansible.builtin.debug:
        msg: |2

          ╔══════════════════════════════════════════════════════════╗
          ║      ✓ Environment validation PASSED                      ║
          ║      Ready to run ops checks                              ║
          ╚══════════════════════════════════════════════════════════╝
      when:
        - not validation_failed
        - validation_warnings | length == 0

    - name: Display passed with warnings
      ansible.builtin.debug:
        msg: |2

          ╔══════════════════════════════════════════════════════════╗
          ║      ⚠ Environment validation PASSED with warnings        ║
          ║      You can proceed but may encounter issues             ║
          ╚══════════════════════════════════════════════════════════╝
      when:
        - not validation_failed
        - validation_warnings | length > 0

    - name: Fail if validation errors found
      ansible.builtin.fail:
        msg: |2

          ╔══════════════════════════════════════════════════════════╗
          ║      ✗ Environment validation FAILED                      ║
          ║      Fix errors above before running ops checks           ║
          ╚══════════════════════════════════════════════════════════╝
      when: validation_failed

- name: Validate connectivity to remote systems
  hosts: vcenters,sa,dd,ucsm
  gather_facts: false
  vars:
    connectivity_failed: false
    connectivity_errors: []
  tasks:
    - name: Display connectivity check header
      ansible.builtin.debug:
        msg: |2

          ╔══════════════════════════════════════════════════════════╗
          ║      Testing connectivity to remote systems              ║
          ╚══════════════════════════════════════════════════════════╝
      run_once: true

    - name: Test connection to host
      ansible.builtin.wait_for:
        host: "{{ ansible_host | default(inventory_hostname) }}"
        port: 443
        timeout: 10
      register: connectivity_check
      failed_when: false
      delegate_to: localhost

    - name: Report connectivity status
      ansible.builtin.debug:
        msg: "{{ '✓' if connectivity_check is success else '✗' }} {{ inventory_hostname }}: {{ 'reachable' if connectivity_check is success else 'UNREACHABLE' }}"

    - name: Display connectivity summary
      ansible.builtin.debug:
        msg: |2

          ╔══════════════════════════════════════════════════════════╗
          ║      ✓ Connectivity validation completed                 ║
          ║      Check results above for any unreachable hosts       ║
          ╚══════════════════════════════════════════════════════════╝
      run_once: true
