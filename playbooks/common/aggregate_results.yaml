---
# playbooks/common/aggregate_results.yaml
# Phase 5: Final Site Health Aggregation

- name: Phase 5 | Aggregate Audit Results & Generate Global Dashboard
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    # Anchor to project root and scripts folder (handling the /common/ nesting)
    _playbooks_root: "{{ playbook_dir.split('/common')[0] if '/common' in playbook_dir else playbook_dir }}"
    _project_root: "{{ _playbooks_root | dirname }}"
    _scripts_dir: "{{ _playbooks_root }}/scripts"
    _template_dir: "{{ _playbooks_root }}/templates"

    _reports_root: "{{ ncs_config.report_directory | default('/srv/samba/reports') }}"
    _platform_root: "{{ _reports_root }}/platform"

    # Unified metadata
    report_stamp: "{{ now(utc=true, fmt='%Y%m%d') }}"
    report_date: "{{ now(utc=true, fmt='%Y-%m-%d %H:%M:%S') }}"
    report_id: "{{ now(utc=true, fmt='%Y%m%dT%H%M%SZ') }}"

  tasks:
    - name: Ensure environment is ready
      ansible.builtin.include_tasks: init_environment.yaml

    - name: Run Python Aggregator (Merge All Platform States)
      ansible.builtin.command:
        argv:
          - python3
          - "{{ _scripts_dir }}/aggregate_yaml_reports.py"
          - "{{ _platform_root }}"
          - "{{ _platform_root }}/all_hosts_state.yaml"
      changed_when: false

    - name: Load Aggregated Data
      ansible.builtin.include_vars:
        file: "{{ _platform_root }}/all_hosts_state.yaml"
        name: all_hosts

    - name: Build Global Context
      ansible.builtin.set_fact:
        _all_alerts: >-
          {%- set alerts = [] -%}
          {%- for host, audits in (all_hosts.hosts | default({})).items() -%}
            {# Filter out structural platform folders and state files #}
            {%- if host not in ['platform', 'ubuntu', 'vmware', 'linux_fleet_state', 'vmware_fleet_state', 'history'] -%}
              {%- for audit_type, data in audits.items() -%}
                {# Use get() to prevent 'Undefined' errors if one host is missing alerts #}
                {%- for alert in (data.get('alerts', [])) -%}
                  {%- set _ = alerts.append(alert | combine({'host': host, 'audit_type': audit_type})) -%}
                {%- endfor -%}
              {%- endfor -%}
            {%- endif -%}
          {%- endfor -%}
          {{ alerts }}

    - name: Calculate Dashboard Variables
      ansible.builtin.set_fact:
        grand_total_critical: "{{ _all_alerts | selectattr('severity', 'equalto', 'CRITICAL') | list | length }}"
        grand_total_warning: "{{ _all_alerts | selectattr('severity', 'equalto', 'WARNING') | list | length }}"
        totals:
          critical: "{{ _all_alerts | selectattr('severity', 'equalto', 'CRITICAL') | list | length }}"
          warning: "{{ _all_alerts | selectattr('severity', 'equalto', 'WARNING') | list | length }}"

        # Health badges for summary cards
        linux_global_health: >-
          {{ 'CRITICAL' if (_all_alerts | selectattr('audit_type', 'equalto', 'system') | selectattr('severity', 'equalto', 'CRITICAL') | list | length > 0) else 'OK' }}
        vmware_global_health: >-
          {{ 'CRITICAL' if (_all_alerts | selectattr('audit_type', 'search', 'vcenter') | selectattr('severity', 'equalto', 'CRITICAL') | list | length > 0) else 'OK' }}

        # c_alarms dictionary for VMware cards
        c_alarms:
          critical: "{{ _all_alerts | selectattr('audit_type', 'search', 'vcenter') | selectattr('severity', 'equalto', 'CRITICAL') | list | length }}"
          warning: "{{ _all_alerts | selectattr('audit_type', 'search', 'vcenter') | selectattr('severity', 'equalto', 'WARNING') | list | length }}"

    - name: Render Global HTML Dashboard
      ansible.builtin.template:
        src: "{{ _template_dir }}/site_health_report.html.j2"
        dest: "{{ _reports_root }}/site_health_report_{{ report_stamp }}.html"
        mode: "0644"

    - name: Maintain 'Latest' Global Symlink
      ansible.builtin.file:
        src: "site_health_report_{{ report_stamp }}.html"
        dest: "{{ _reports_root }}/site_health_report.html"
        state: link
        force: true

    - name: Render Operations Markdown Report
      ansible.builtin.template:
        src: "{{ _template_dir }}/site_health_report.md.j2"
        dest: "{{ _reports_root }}/ops_summary_{{ report_stamp }}.md"
        mode: "0644"

    - name: Announce Completion
      ansible.builtin.debug:
        msg: "âœ… Global Site Report Created: {{ _reports_root }}/site_health_report.html"
