---
- name: Phase 3 | Aggregate Audit Results & Generate Dashboard
  hosts: localhost
  connection: local
  gather_facts: true # Gathers ansible_date_time for the report timestamp

  vars:
    # FIX: Since this playbook is in playbooks/common/, we must go up TWO levels to reach the project root
    _project_root: "{{ playbook_dir | dirname | dirname }}"

  tasks:
    - name: Ensure summary directory exists
      ansible.builtin.file:
        path: "{{ _project_root }}/reports/summary"
        state: directory
        mode: "0755"

    - name: Run Python Aggregator (Merge Raw State)
      ansible.builtin.command: >
        python3 {{ _project_root }}/scripts/aggregate_yaml_reports.py
        {{ _project_root }}/reports/raw_state
        {{ _project_root }}/reports/summary/all_hosts_state.yaml
      changed_when: false

    - name: Load Aggregated Data into Playbook
      ansible.builtin.include_vars:
        file: "{{ _project_root }}/reports/summary/all_hosts_state.yaml"
        name: all_hosts

    - name: Render Global HTML Dashboard
      ansible.builtin.template:
        src: "{{ _project_root }}/templates/site_health_report.html.j2"
        dest: "{{ _project_root }}/reports/summary/site_health_report.html"
        mode: "0644"

    - name: Announce Completion
      ansible.builtin.debug:
        msg: "âœ… Fleet aggregation complete. Dashboard available at: {{ _project_root }}/reports/summary/site_health_report.html"
