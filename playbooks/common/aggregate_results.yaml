- name: Aggregate Audit Results
  hosts: localhost
  gather_facts: false
  vars:
    _report_base: "{{ ncs_config.report_directory | default('/srv/samba/reports') }}"
    _summary_dir: "{{ _report_base }}/Summary/{{ run_ctx.id }}"
    _combined: "{{ _summary_dir }}/all_hosts.yaml"
  tasks:
    - name: Ensure summary directory exists
      ansible.builtin.file:
        path: "{{ _summary_dir }}"
        state: directory
        mode: "0755"

    - name: Aggregate per-host YAML reports
      ansible.builtin.script:
        cmd: "{{ playbook_dir }}/../scripts/aggregate_yaml_reports.py {{ _report_base }} {{ _combined }}"
      register: _aggregate_result

    - name: Load combined host data
      ansible.builtin.set_fact:
        _all_host_data: "{{ lookup('file', _combined) | from_yaml }}"

    - name: Render HTML dashboard
      ansible.builtin.template:
        src: "{{ playbook_dir }}/templates/site_health_report.html.j2"
        dest: "{{ _summary_dir }}/dashboard.html"
        mode: "0644"
      vars:
        all_hosts: "{{ _all_host_data | default({}) }}"
        report_date: "{{ run_ctx.date }}"
        report_id: "{{ run_ctx.id }}"

    - name: Render Markdown summary
      ansible.builtin.template:
        src: "{{ playbook_dir }}/templates/site_health_report.md.j2"
        dest: "{{ _summary_dir }}/dashboard.md"
        mode: "0644"
      vars:
        all_hosts: "{{ _all_host_data | default({}) }}"
        report_date: "{{ run_ctx.date }}"
        report_id: "{{ run_ctx.id }}"

    - name: Display report location
      ansible.builtin.debug:
        msg: "Reports written to {{ _summary_dir }}"
