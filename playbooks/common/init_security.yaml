---
# playbooks/plays/init_stigs.yaml
# Initialize shared context for Security/STIG audits.

- name: Initialize STIG Audit
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Generate Global Run ID and Metadata
      ansible.builtin.set_fact:
        run_ctx:
          id: "{{ lookup('pipe', 'date +%Y-%m-%d_%H%M%S') }}"
          date: "{{ lookup('pipe', 'date +%Y-%m-%d') }}"
          timestamp: '{{ lookup(''pipe'', ''date "+%Y-%m-%dT%H:%M:%S%z"'') }}'
          report_base: "{{ ncs_config.report_directory | default('/srv/samba/reports') }}"
      tags: ["always"]

    - name: Set Output Directory
      ansible.builtin.set_fact:
        run_ctx: "{{ run_ctx | combine({'output_dir': run_ctx.report_base + '/AdHoc/STIG_' + run_ctx.id}) }}"
      tags: ["always"]

    - name: Create Report Directory
      ansible.builtin.file:
        path: "{{ run_ctx.output_dir }}"
        state: directory
        mode: "0755"
      tags: ["always"]

    - name: Publish run context
      ansible.builtin.set_stats:
        data:
          run_ctx: "{{ run_ctx }}"
        per_host: false
      tags: ["always"]
