---
# playbooks/plays/init_context.yaml
# Initialize shared run context and scheduling metadata.

- name: Initialize Run Context
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Generate Global Run ID and Metadata
      ansible.builtin.set_fact:
        run_ctx:
          id: "{{ lookup('pipe', 'date +%Y-%m-%d_%H%M%S') }}"
          date: "{{ lookup('pipe', 'date +%Y-%m-%d') }}"
          timestamp: '{{ lookup(''pipe'', ''date "+%Y-%m-%dT%H:%M:%S%z"'') }}'
          day: "{{ ncs_config.run_day | default(lookup('pipe', 'date +%A') | lower, true) }}"
      tags: ["always"]

    - name: Determine today's tasks based on schedule
      ansible.builtin.set_fact:
        run_ctx: "{{ run_ctx | combine({'tasks': _tasks}, recursive=true) }}"
      vars:
        _tasks: "{{ ncs_config.schedule.day_matrix[run_ctx.day] | default([]) }}"
      tags: ["always"]

    - name: Publish run context for subsequent plays
      ansible.builtin.set_stats:
        data:
          run_ctx: "{{ run_ctx }}"
        per_host: false
      tags: ["always"]

    - name: Display Run Summary
      ansible.builtin.debug:
        msg: |
          Run ID:   {{ run_ctx.id }}
          Day:      {{ run_ctx.day }}
          Tasks:    {{ run_ctx.tasks | join(', ') if run_ctx.tasks else 'None (Skipping)' }}
      tags: ["always"]
