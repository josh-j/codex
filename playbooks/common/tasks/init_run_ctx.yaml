---
# playbooks/common/tasks/init_run_ctx.yaml
#
# Builds run_ctx with timing, scheduling, and output path.
# Called by init plays on localhost before domain plays start.
#
# Parameters:
#   init_report_subdir      - subdirectory under report base (e.g. "Ubuntu_Ops")
#   init_enable_scheduling  - when true, resolves day_matrix into run_ctx.tasks
#                             when false, run_ctx.tasks is [] and domain plays
#                             use their own when conditions

- name: Build run context
  ansible.builtin.set_fact:
    run_ctx:
      id: "{{ now(fmt='%Y-%m-%d_%H%M%S') }}"
      date: "{{ now(fmt='%Y-%m-%d') }}"
      timestamp: "{{ now(fmt='%Y-%m-%dT%H:%M:%S%z') }}"
      # Precedence: CLI override → ncs_config.run_day → today's day name
      # Empty string in ncs_config.run_day is treated as unset.
      day: >-
        {{
          ops_run_day_override
          if (ops_run_day_override | default('') | length > 0)
          else (
            ncs_config.run_day
            if (ncs_config.run_day | default('') | length > 0)
            else now(fmt='%A') | lower
          )
        }}
      tasks: >-
        {{
          ncs_config.schedule.day_matrix[_run_day] | default([])
          if (init_enable_scheduling | default(false) | bool)
          else []
        }}
      output_dir: >-
        {{
          ncs_config.report_directory | default('/srv/samba/reports')
        }}/{{ init_report_subdir | default('') }}/{{ now(fmt='%Y-%m-%d_%H%M%S') }}
  vars:
    # Resolve day once so tasks lookup uses the same value as run_ctx.day
    _run_day: >-
      {{
        ops_run_day_override
        if (ops_run_day_override | default('') | length > 0)
        else (
          ncs_config.run_day
          if (ncs_config.run_day | default('') | length > 0)
          else now(fmt='%A') | lower
        )
      }}

- name: Create output directory
  ansible.builtin.file:
    path: "{{ run_ctx.output_dir }}"
    state: directory
    mode: "0755"

- name: Publish run context to subsequent plays
  ansible.builtin.set_stats:
    data:
      run_ctx: "{{ run_ctx }}"
    per_host: false

- name: Display run summary
  ansible.builtin.debug:
    msg: |
      Run ID:     {{ run_ctx.id }}
      Day:        {{ run_ctx.day }}
      Tasks:      {{ run_ctx.tasks | join(', ') if run_ctx.tasks else 'None (scheduling disabled)' }}
      Output Dir: {{ run_ctx.output_dir }}
