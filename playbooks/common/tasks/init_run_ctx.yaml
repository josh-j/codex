---
# playbooks/common/tasks/init_run_ctx.yaml
# Shared run context initialization logic.
#
# Parameters (set as vars before importing):
#   init_report_subdir  — optional subdirectory under report_base (e.g. "Ubuntu_Ops")
#   init_enable_scheduling — when true, resolves day_matrix into run_ctx.tasks

- name: Generate Global Run ID and Metadata
  ansible.builtin.set_fact:
    run_ctx:
      id: "{{ lookup('pipe', 'date +%Y-%m-%d_%H%M%S') }}"
      date: "{{ lookup('pipe', 'date +%Y-%m-%d') }}"
      timestamp: '{{ lookup(''pipe'', ''date "+%Y-%m-%dT%H:%M:%S%z"'') }}'
      day: "{{ ncs_config.run_day | default(lookup('pipe', 'date +%A') | lower, true) }}"
      tasks: []
  tags: ["always"]

- name: Determine today's tasks based on schedule
  ansible.builtin.set_fact:
    run_ctx: "{{ run_ctx | combine({'tasks': _tasks}, recursive=true) }}"
  vars:
    _tasks: "{{ ncs_config.schedule.day_matrix[run_ctx.day] | default([]) }}"
  when: init_enable_scheduling | default(false) | bool
  tags: ["always"]

- name: Set report base path
  ansible.builtin.set_fact:
    run_ctx: >-
      {{ run_ctx | combine({
        'report_base': ncs_config.report_directory | default('/srv/samba/reports')
      }, recursive=true) }}
  when: init_report_subdir is defined
  tags: ["always"]

- name: Set Output Directory
  ansible.builtin.set_fact:
    run_ctx: "{{ run_ctx | combine({'output_dir': run_ctx.report_base + '/' + init_report_subdir + '/' + run_ctx.id}) }}"
  when: init_report_subdir is defined
  tags: ["always"]

- name: Create Report Directory
  ansible.builtin.file:
    path: "{{ run_ctx.output_dir }}"
    state: directory
    mode: "0755"
  when: run_ctx.output_dir is defined
  tags: ["always"]

- name: Publish run context for subsequent plays
  ansible.builtin.set_stats:
    data:
      run_ctx: "{{ run_ctx }}"
    per_host: false
  tags: ["always"]

- name: Display Run Summary
  ansible.builtin.debug:
    msg: |
      Run ID:     {{ run_ctx.id }}
      Day:        {{ run_ctx.day }}
      Tasks:      {{ run_ctx.tasks | join(', ') if run_ctx.tasks else 'None' }}
      Output Dir: {{ run_ctx.output_dir | default('N/A') }}
  tags: ["always"]
