---
# playbooks/vmware/audit.yaml
# ===============================================================================
# Phase 2: Per-vCenter Health & Policy Audit
# ===============================================================================
- name: Phase 2 | VMware Health & Compliance Audit
  hosts: vcenters
  connection: local
  gather_facts: true
  tasks:
    - name: Execute vCenter Audit & Notify
      ansible.builtin.include_role:
        name: internal.vmware.audit
      vars:
        vmware_snapshot_age_warning_days: 7
        vmware_snapshot_size_warning_gb: 100
        vmware_enable_email_notifications: false
        # vmware_owner_notification_days: ["monday", "wednesday", "friday"]
        # Optional: role now honors caller-provided audit export path
        # ncs_export_path: "{{ ncs_config.report_directory | default('/srv/samba/reports') }}/platform/vmware/{{ inventory_hostname }}/vcenter.yaml"
        # Optional: disable export payload assertion temporarily during migrations
        # vmware_validate_export_schema: false

# ===============================================================================
# Phase 3: Aggregation and Fleet-Wide Dashboard Generation
# ===============================================================================
- name: Phase 3 | Generate VMware Fleet Dashboard
  hosts: localhost
  connection: local
  gather_facts: false
  run_once: true

  tasks:
    - name: Execute VMware Summary Role
      ansible.builtin.include_role:
        name: internal.vmware.summary
        tasks_from: report.yaml

    - name: Announce Completion
      ansible.builtin.debug:
        msg: >-
          VMware Fleet Dashboard Updated:
          {{ (ncs_config.report_directory | default('/srv/samba/reports')) }}/platform/vmware/vmware_health_report.html
