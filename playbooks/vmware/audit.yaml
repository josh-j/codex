---
# playbooks/vmware/audit.yaml
# ===============================================================================
# Phase 2: Per-vCenter Health & Policy Audit
# ===============================================================================
- name: Phase 2 | VMware Health & Compliance Audit
  hosts: vcenters
  connection: local
  gather_facts: true
  tasks:
    - name: Execute vCenter Audit & Notify
      ansible.builtin.include_role:
        name: internal.vmware.audit
      vars:
        vmware_validate_certs: "{{ vmware_config.validate_certs | default(false) }}"
        vmware_cpu_critical_pct: "{{ vmware_config.cpu_critical_pct | default(90.0) }}"
        vmware_cpu_warning_pct: "{{ vmware_config.cpu_warning_pct | default(80.0) }}"
        vmware_memory_critical_pct: "{{ vmware_config.memory_critical_pct | default(90.0) }}"
        vmware_memory_warning_pct: "{{ vmware_config.memory_warning_pct | default(80.0) }}"
        vmware_datastore_free_critical_pct: "{{ vmware_config.datastore_free_critical_pct | default(10.0) }}"
        vmware_datastore_free_warning_pct: "{{ vmware_config.datastore_free_warning_pct | default(15.0) }}"
        vmware_snapshot_age_warning_days: "{{ vmware_config.snapshot_age_warning_days | default(7) }}"
        vmware_snapshot_size_warning_gb: "{{ vmware_config.snapshot_size_warning_gb | default(100.0) }}"
        vmware_enable_email_notifications: "{{ vmware_config.enable_email_notifications | default(false) }}"
        ncs_export_path: "{{ ncs_config | internal.core.resolve_ncs_path('vmware', inventory_hostname, 'vcenter') }}"
        # vmware_owner_notification_days: ["monday", "wednesday", "friday"]
        # Optional: role now honors caller-provided audit export path
        # ncs_export_path: "{{ ncs_config.report_directory | default('/srv/samba/reports') }}/platform/vmware/{{ inventory_hostname }}/vcenter.yaml"
        # Optional: disable export payload assertion temporarily during migrations
        # vmware_validate_export_schema: false

# ===============================================================================
# Phase 3: Aggregation and Fleet-Wide Dashboard Generation
# ===============================================================================
- name: Phase 3 | Generate Fleet Reports
  ansible.builtin.import_playbook: ../common/generate_fleet_reports.yaml
  tags: ["always"]
