---
# playbooks/vmware/audit_stig.yaml
#
# READ-ONLY — This playbook performs STIG compliance evaluation only.
# All STIG tasks run in check_mode (no infrastructure changes are applied).
# The only writes are report artifacts to the local report directory.
#
# For remediation, use playbooks/vmware/remediate_stig.yaml instead.
#
# Pipeline:
#   Phase 1: init_environment (ensure report dirs exist)
#   Phase 2a: VMware Discovery (read-only inventory collection)
#   Phase 2b: ESXi STIG Audit (check_mode=true via vmware_stig_enable_hardening: false)
#   Phase 2c: VM STIG Audit (check_mode=true, optional)
#   Phase 3: Fleet report generation

- name: "Phase 1 | Prepare Environment"
  ansible.builtin.import_playbook: ../common/init_environment.yaml
  tags: ["always"]

- name: "Phase 2a | VMware Discovery (per vCenter)"
  hosts: vcenters
  connection: local
  gather_facts: false
  tags: ["vmware", "discover"]

  tasks:
    - name: "Execute vCenter Discovery"
      ansible.builtin.include_role:
        name: internal.vmware.discovery
      vars:
        ncs_export_path: "{{ ncs_config | internal.core.resolve_ncs_path('vmware', inventory_hostname, 'discovery') }}"

- name: "Phase 2b | ESXi STIG Audit (per vCenter)"
  hosts: vcenters
  connection: local
  gather_facts: false
  tags: ["vmware", "stig", "audit", "esxi"]
  vars:
    vmware_stig_enable_audit: "{{ vmware_config.stig.enable_audit | default(true) }}"
    vmware_stig_enable_hardening: "{{ vmware_config.stig.enable_hardening | default(false) }}"   # READ-ONLY — enforces check_mode on all STIG tasks
    vmware_stig_target: "esxi"

  tasks:
    - name: "Execute ESXi STIG Audit"
      ansible.builtin.include_role:
        name: internal.vmware.stig
      vars:
        vmware_validate_certs: "{{ vmware_config.validate_certs | default(false) }}"
        vmware_stig_artifacts_dir: "{{ ncs_config | internal.core.resolve_ncs_path('artifacts', audit_type='stig') | dirname }}"
        ncs_export_path: "{{ ncs_config | internal.core.resolve_ncs_path('vmware', inventory_hostname, 'stig_esxi') }}"

- name: "Phase 2c | VM STIG Audit (per vCenter)"
  hosts: vcenters
  connection: local
  gather_facts: false
  tags: ["vmware", "stig", "audit", "vm"]
  vars:
    vmware_stig_enable_audit: "{{ vmware_config.stig.enable_audit | default(true) }}"
    vmware_stig_enable_hardening: "{{ vmware_config.stig.enable_hardening | default(false) }}"   # READ-ONLY — enforces check_mode on all STIG tasks
    vmware_stig_target: "vm"

  tasks:
    - name: "Execute VM STIG Audit"
      ansible.builtin.include_role:
        name: internal.vmware.stig
      vars:
        vmware_validate_certs: "{{ vmware_config.validate_certs | default(false) }}"
        vmware_stig_artifacts_dir: "{{ ncs_config | internal.core.resolve_ncs_path('artifacts', audit_type='stig') | dirname }}"
        ncs_export_path: "{{ ncs_config | internal.core.resolve_ncs_path('vmware', inventory_hostname, 'stig_vm') }}"
      when: vm_stig_target_vms | default([]) | length > 0

- name: "Phase 3 | Generate Fleet Reports"
  ansible.builtin.import_playbook: ../common/generate_fleet_reports.yaml
  tags: ["always"]
