---
# playbooks/vmware/audit_stig.yaml
#
# Runs VMware STIG audit(s) against vCenter-managed targets and exports per-vCenter STIG results,
# then generates the fleet dashboard.
#
# Assumptions (based on your collection layout):
# - vCenter inventory discovery is done via internal.vmware.discovery and exports platform state.
# - VMware STIG evaluation is done via internal.vmware.stig (role) and exports a stig.yaml per vCenter.
# - Fleet dashboard is generated via the decoupled generate_fleet_reports.yaml playbook.
#
# Adjust the vars under "Phase 2" to match the exact knobs exposed by internal.vmware.stig.

- name: "Phase 1 | Prepare Environment"
  ansible.builtin.import_playbook: ../common/init_environment.yaml
  tags: ["always"]

- name: "Phase 2a | VMware Discovery (per vCenter)"
  hosts: vcenters
  connection: local
  gather_facts: false
  tags: ["vmware", "discover"]

  tasks:
    - name: "Execute vCenter Discovery"
      ansible.builtin.include_role:
        name: internal.vmware.discovery
      vars:
        ncs_export_path: "{{ ncs_config | internal.core.resolve_ncs_path('vmware', inventory_hostname, 'discovery') }}"

- name: "Phase 2b | VMware STIG Audit (per vCenter)"
  hosts: vcenters
  connection: local
  gather_facts: false
  tags: ["vmware", "stig", "audit"]
  vars:
    # ---- STIG behavior knobs (rename to match your role defaults if needed) ----
    vmware_stig_enable_audit: true
    vmware_stig_enable_hardening: false
    vmware_stig_quiet_mode: false

    # Targets:
    # - "esxi": evaluate ESXi host STIGs
    # - "vm":   evaluate VM STIGs
    #
    # If your role supports running both, set vmware_stig_targets: ["esxi","vm"] instead.
    vmware_stig_target: "esxi"

    # Optional scoping
    # vmware_stig_filter: ""          # only a specific object
    # vmware_stig_exclusions: []      # list of names to skip

    # Export location for this vCenterâ€™s STIG results
    ncs_export_path: "{{ ncs_config | internal.core.resolve_ncs_path('vmware', inventory_hostname, 'stig') }}"

  tasks:
    - name: "Execute VMware STIG Audit"
      ansible.builtin.include_role:
        name: internal.vmware.stig

- name: "Phase 3 | Generate Fleet Reports"
  ansible.builtin.import_playbook: ../common/generate_fleet_reports.yaml
  tags: ["always"]
