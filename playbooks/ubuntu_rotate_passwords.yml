---
# playbooks/ubuntu_rotate_passwords.yml
# Secure administrative password rotation for the Ubuntu server fleet.
# This interactive playbook prompts for a target username and new password,
# generating a high-security SHA512 hash locally before deployment.
# It applies the new credentials across the target hosts, forces a password
# change on the next login, and re-triggers discovery to update the local
# configuration state files with the modified user metadata.

- name: "One-off Password Rotation"
  hosts: "{{ target | default('undefined') }}"
  gather_facts: false
  serial: 1 # Processes one host at a time for secure prompting


  vars:
    user_name: admin

  vars_prompt:
    - name: user_name
      prompt: "Target username to rotate"
      default: "admin"
      private: false

    - name: new_password
      prompt: "Enter the new password for {{ user_name }}"
      private: true
      confirm: true

  pre_tasks:
    - name: Validate target
      ansible.builtin.fail:
        msg: "Please specify a target (e.g., -e 'target=my-host')"
      when: target == 'undefined'

    - name: Generate secure password hash
      ansible.builtin.set_fact:
        # High-security SHA512 hashing
        _hashed_password: "{{ new_password | password_hash('sha512') }}"
        ubuntu_users:
          - name: "{{ user_name }}"
            password: "{{ new_password | password_hash('sha512') }}"
            update_password: "always"
            force_change: true
      no_log: true

  roles:
    # 1. Update the password (Phase 2 Action)
    - role: internal.linux.ubuntu
      vars:
        ubuntu_action: passwords

    # 2. Re-discover (Phase 1 Refresh)
    # This ensures the local YAML state file is updated immediately
    - role: internal.linux.ubuntu
      vars:
        ubuntu_action: discover

  post_tasks:
    - name: Display final summary
      ansible.builtin.debug:
        msg: "Rotation complete for {{ inventory_hostname }}. User {{ user_name }} forced to change at next login."
