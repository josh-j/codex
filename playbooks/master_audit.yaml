---
# =============================================================================
# MASTER INFRASTRUCTURE AUDIT ORCHESTRATOR
# =============================================================================

# Phase 1: Environment Readiness
- name: "Phase 1: Initialize Reporting Environment"
  import_playbook: common/init_environment.yaml

# Phase 2: VMware Discovery & Audit
- name: "Phase 2a: VMware Infrastructure Inventory"
  hosts: vcenters
  connection: local
  gather_facts: false
  roles:
    - role: internal.vmware.discovery

- name: "Phase 2b: VMware Health & Compliance Audit"
  hosts: vcenters
  connection: local
  gather_facts: true
  roles:
    - role: internal.vmware.audit
      vars:
        ncs_ctx: "{{ vmware_ctx }}"

# Phase 3: Linux Fleet Audit
- name: "Phase 3: Linux System Health Audit"
  hosts: ubuntu_servers
  roles:
    - role: internal.linux.ubuntu_system_discover
    - role: internal.linux.ubuntu_system_audit
      vars:
        ncs_ctx: "{{ ubuntu_ctx }}"

# Phase 3b: Windows Fleet Audit
- name: "Phase 3b: Windows System Audit"
  hosts: windows_servers
  gather_facts: false
  roles:
    - role: internal.windows.windows_audit
      vars:
        ncs_ctx: "{{ windows_ctx }}"
        force_update: false

# Phase 3c: Windows Server STIG Audit (optional)
- name: "Phase 3c: Windows Server STIG Audit (Optional)"
  hosts: windows_servers
  gather_facts: false
  tasks:
    - name: "STIG | Windows Audit"
      ansible.builtin.include_role:
        name: internal.windows.windows_stig_audit
      vars:
        windows_stig_enable_audit: true
      when: master_enable_windows_stig | default(false) | bool

# Phase 4: Reporting & Dashboards (Decoupled Engine)
- name: "Phase 4: Unified Infrastructure Reporting"
  import_playbook: common/generate_fleet_reports.yaml
