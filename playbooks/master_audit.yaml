---
# =============================================================================
# MASTER INFRASTRUCTURE AUDIT ORCHESTRATOR
# =============================================================================

# Phase 1: Environment Readiness
- name: "Phase 1: Initialize Reporting Environment"
  import_playbook: common/init_environment.yaml

# Phase 2: VMware Discovery & Audit
- name: "Phase 2a: VMware Infrastructure Inventory"
  hosts: vcenters
  connection: local
  gather_facts: false
  roles:
    - role: internal.vmware.discovery
      vars:
        vmware_validate_certs: "{{ vmware_config.validate_certs | default(false) }}"
        ncs_export_path: "{{ ncs_config | internal.core.resolve_ncs_path('vmware', inventory_hostname, 'discovery') }}"

- name: "Phase 2b: VMware Health & Compliance Audit"
  hosts: vcenters
  connection: local
  gather_facts: true
  roles:
    - role: internal.vmware.audit
      vars:
        ncs_ctx: "{{ vmware_ctx }}"
        vmware_validate_certs: "{{ vmware_config.validate_certs | default(false) }}"
        vmware_cpu_critical_pct: "{{ vmware_config.cpu_critical_pct | default(90.0) }}"
        vmware_memory_critical_pct: "{{ vmware_config.memory_critical_pct | default(90.0) }}"
        vmware_datastore_free_critical_pct: "{{ vmware_config.datastore_free_critical_pct | default(10.0) }}"
        ncs_export_path: "{{ ncs_config | internal.core.resolve_ncs_path('vmware', inventory_hostname, 'vcenter') }}"

# Phase 3: Linux Fleet Audit
- name: "Phase 3: Linux System Health Audit"
  hosts: ubuntu_servers
  roles:
    - role: internal.linux.ubuntu_system_discover
      vars:
        ubuntu_memory_warning_pct: "{{ ubuntu_config.memory_warning_pct | default(95.0) }}"
        ubuntu_storage_warning_pct: "{{ ubuntu_config.storage_warning_pct | default(90.0) }}"
        ncs_export_path: "{{ ncs_config | internal.core.resolve_ncs_path('ubuntu', inventory_hostname, 'discovery') }}"
    - role: internal.linux.ubuntu_system_audit
      vars:
        ncs_ctx: "{{ ubuntu_ctx }}"
        ncs_export_path: "{{ ncs_config | internal.core.resolve_ncs_path('ubuntu', inventory_hostname, 'system') }}"

# Phase 3b: Windows Fleet Audit
- name: "Phase 3b: Windows System Audit"
  hosts: windows_servers
  gather_facts: false
  roles:
    - role: internal.windows.windows_audit
      vars:
        ncs_ctx: "{{ windows_ctx }}"
        windows_audit_force_update: "{{ windows_config.force_update | default(false) }}"
        windows_audit_include_system_apps: "{{ windows_config.include_system_apps | default(false) }}"
        windows_audit_update_age_warning_days: "{{ windows_config.update_age_warning_days | default(30) }}"
        windows_audit_update_age_critical_days: "{{ windows_config.update_age_critical_days | default(90) }}"
        ncs_export_path: "{{ ncs_config | internal.core.resolve_ncs_path('windows', inventory_hostname, 'windows_audit') }}"

# Phase 3c: Windows Server STIG Audit (optional)
- name: "Phase 3c: Windows Server STIG Audit (Optional)"
  hosts: windows_servers
  gather_facts: false
  tasks:
    - name: "STIG | Windows Audit"
      ansible.builtin.include_role:
        name: internal.windows.windows_stig_audit
      vars:
        windows_stig_enable_audit: "{{ windows_config.stig.enable_audit | default(false) }}"
        windows_stig_native_checks_only: "{{ windows_config.stig.native_checks_only | default(false) }}"
        windows_stig_target_type: "{{ windows_config.stig.target_type | default('windows_server_2022') }}"
        windows_stig_artifact_file: "{{ ncs_config | internal.core.resolve_ncs_path('artifacts', inventory_hostname, 'windows_stig', 'json') }}"
        ncs_export_path: "{{ ncs_config | internal.core.resolve_ncs_path('windows', inventory_hostname, 'stig') }}"
      when: master_enable_windows_stig | default(false) | bool

# Phase 4: Reporting & Dashboards (Decoupled Engine)
- name: "Phase 4: Unified Infrastructure Reporting"
  import_playbook: common/generate_fleet_reports.yaml
