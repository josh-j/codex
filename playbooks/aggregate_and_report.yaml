---
- name: "Phase 3: Global Fleet Aggregation & Reporting"
  hosts: localhost
  connection: local
  gather_facts: true
  vars:
    # Paths align with your internal.core.state role
    report_base_dir: "{{ ncs_config.report_directory | default('/srv/samba/reports') }}"
    summary_dir: "{{ report_base_dir }}/Summary"
    aggregated_file: "{{ summary_dir }}/all_hosts.yaml"
    output_html: "{{ summary_dir }}/fleet_dashboard.html"
    output_md: "{{ summary_dir }}/ops_report.md"

  tasks:
    - name: "Aggregation | Merge host state files"
      ansible.builtin.command:
        cmd: "python3 {{ playbook_dir }}/../scripts/aggregate_yaml_reports.py {{ report_base_dir }} {{ aggregated_file }}"
      changed_when: true

    - name: "Data Loading | Read aggregated state"
      ansible.builtin.slurp:
        src: "{{ aggregated_file }}"
      register: _aggregated_raw

    - name: "Normalization | Parse global context"
      ansible.builtin.set_fact:
        all_hosts: "{{ _aggregated_raw.content | b64decode | from_json }}"
        report_date: "{{ ansible_date_time.date }}"
        report_id: "{{ ansible_date_time.iso8601_basic_short }}"

    - name: "Reporting | Render HTML Dashboard"
      ansible.builtin.template:
        src: "templates/site_health_report.html.j2"
        dest: "{{ output_html }}"
        mode: "0644"

    - name: "Reporting | Render Markdown Summary"
      ansible.builtin.template:
        src: "templates/site_health_report.md.j2"
        dest: "{{ output_md }}"
        mode: "0644"

    - name: "Finalize | Display Dashboard Link"
      ansible.builtin.debug:
        msg:
          - "--------------------------------------------------------"
          - "REPORT GENERATION COMPLETE"
          - "HTML Dashboard: {{ output_html }}"
          - "Markdown Ops: {{ output_md }}"
          - "--------------------------------------------------------"
