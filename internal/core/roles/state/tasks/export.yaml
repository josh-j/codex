---
# internal.core.state : export.yaml

- name: Ensure controller facts are available
  ansible.builtin.setup:
    gather_subset: [min]
  delegate_to: localhost
  delegate_facts: true
  run_once: true
  when: hostvars['localhost']['ansible_date_time'] is not defined

- name: Ensure host state directory exists
  ansible.builtin.file:
    path: "{{ ncs_config.report_directory | default('/srv/samba/reports') }}/{{ inventory_hostname }}"
    state: directory
    mode: "0755"
  delegate_to: localhost
  become: false

- name: Export host state to YAML
  ansible.builtin.copy:
    dest: >-
      {{ ncs_config.report_directory | default('/srv/samba/reports') }}/{{ inventory_hostname }}/{{ inventory_hostname }}.{{ ncs_export_data.audit_type | default('system') }}.yaml
    mode: "0664"
    # We structure the keys so the most important metadata is at the top of the YAML file
    content: >-
      {{
        {
          'metadata': {
            'host': inventory_hostname,
            'audit_type': ncs_export_data.audit_type | default('system'),
            'timestamp': hostvars['localhost']['ansible_date_time']['iso8601']
          },
          'health': ncs_export_data.health | default('UNKNOWN'),
          'summary': ncs_export_data.summary | default({}),
          'alerts': ncs_export_data.alerts | default([])
        } | combine(ncs_export_data, recursive=True) | to_nice_yaml(indent=2)
      }}
  delegate_to: localhost
  become: false
