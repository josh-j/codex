---
# internal.core.stig : tasks/discovery_parser.yaml
#
# Parses JSON output from a discovery script into a named namespace var.
# Handles PowerCLI/script noise by extracting only the JSON block.
#
# Required vars:
#   script_result:     register result from ansible.builtin.script
#   generic_namespace: str  - var name to store results in (e.g. 'vsphere_ctx')
#   json_data_key:     str  - key in parsed JSON containing the data list

- name: "DISCOVERY | Parse script output"
  ansible.builtin.set_fact:
    _discovery_json: "{{ script_result.stdout | regex_search('(?s)\\{.*') | from_json }}"
  when:
    - script_result.rc == 0
    - script_result.stdout | trim | length > 0

- name: "DISCOVERY | Store facts in namespace"
  ansible.builtin.set_fact:
    "{{ generic_namespace }}": >-
      {{
        lookup('vars', generic_namespace, default={})
        | combine({'stig_facts': _discovery_json[json_data_key] | default([])}, recursive=true)
      }}
  when:
    - _discovery_json is defined
    - _discovery_json.success | default(false)

- name: "DISCOVERY | Store empty facts on failure"
  ansible.builtin.set_fact:
    "{{ generic_namespace }}": >-
      {{
        lookup('vars', generic_namespace, default={})
        | combine({'stig_facts': []}, recursive=true)
      }}
  when: >-
    _discovery_json is not defined or
    not (_discovery_json.success | default(false)) or
    script_result.rc != 0
