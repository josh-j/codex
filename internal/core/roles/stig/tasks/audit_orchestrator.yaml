---
# internal.core.stig : tasks/audit_orchestrator.yaml
#
# Generic STIG evaluation engine. Renders an audit logic template against
# each item in raw_discovery_data and accumulates results.
#
# Required vars:
#   raw_discovery_data:   list  - discovery facts, one dict per target
#   audit_logic_template: str   - absolute path to Jinja2 evaluation template
# Optional vars:
#   stig_filter:      str  - if set, only evaluate items where name matches
#   stig_exclusions:  list - item names to skip

- name: "AUDIT | Verify template exists"
  ansible.builtin.stat:
    path: "{{ audit_logic_template }}"
  register: _template_stat
  delegate_to: localhost
  check_mode: false
  when: audit_logic_template is defined

- name: "AUDIT | Fail if template missing"
  ansible.builtin.fail:
    msg: "Template not found: {{ audit_logic_template }}"
  when:
    - audit_logic_template is defined
    - not _template_stat.stat.exists

- name: "AUDIT | Initialize result lists"
  ansible.builtin.set_fact:
    # Use default([]) to append to existing results from previous check files
    audit_full_list: "{{ audit_full_list | default([]) }}"
    audit_violations: "{{ audit_violations | default([]) }}"
  changed_when: false

- name: "AUDIT | Debug template render (first item)"
  when:
    - vmware_config_debug_mode | default(false) | bool
    - raw_discovery_data | length > 0
  ansible.builtin.debug:
    msg: >-
      {{
        (audit_logic_inline | from_json)
        if audit_logic_inline is defined
        else (lookup('template', audit_logic_template) | from_json)
      }}
  vars:
    item: "{{ raw_discovery_data | first }}"
  ignore_errors: true # noqa: ignore-errors

- name: "AUDIT | Evaluate compliance per item"
  ansible.builtin.set_fact:
    audit_full_list: >-
      {%- set rendered = (audit_logic_inline | from_json) if audit_logic_inline is defined else (lookup('template', audit_logic_template) | from_json) -%}
      {{
        audit_full_list + (
          rendered
          | map('combine', {'name': item.name, 'uuid': item.uuid | default('N/A')})
          | list
        )
      }}
  loop: "{{ raw_discovery_data | default([]) }}"
  loop_control:
    label: "{{ item.name }}"
  when:
    - stig_filter | default('') == '' or item.name == stig_filter
    - item.name not in (stig_exclusions | default([]))

- name: "AUDIT | Extract violations"
  ansible.builtin.set_fact:
    audit_violations: >-
      {%- set violations = [] -%}
      {%- for item in (audit_full_list | default([])) -%}
        {%- if (item.status | default('') | string | lower) == 'failed' -%}
          {%- set _ = violations.append(item) -%}
        {%- endif -%}
      {%- endfor -%}
      {{ violations }}
