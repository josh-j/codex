---
# roles/common/tasks/safeguarding/create_snapshot.yaml
# PURPOSE: Take a safety snapshot of the current host in vCenter if it is a VM.
#
# REQUIRED VARS:
#   - snapshot_prefix (e.g., "Ansible_Pre_Hardening")
#   - snapshot_desc   (e.g., "Created before STIG application")
- name: "Safety | Create VMware Snapshot"
  delegate_to: localhost
  become: false
  # Self-contained check: Only runs if it's actually a VMware VM
  when: ansible_facts['virtualization_type'] | default('NA') == "VMware"
  block:
    - name: Discover VM location in vCenter
      community.vmware.vmware_vm_info:
        hostname: >-
          {{
            vmware_hostname
            | regex_replace('^https?://', '')
            | regex_replace('/.*$', '')
          }}
        username: "{{ vmware_username | default(vault_vcenters_user) }}"
        password: "{{ vmware_password | default(vault_vcenters_password) }}"
        validate_certs: false
        vm_name: "{{ inventory_hostname }}"
      register: vm_discovery

    - name: Extract VM datacenter and folder
      ansible.builtin.set_fact:
        vm_datacenter: "{{ vm_discovery.virtual_machines[0].datacenter }}"
        vm_folder: "{{ vm_discovery.virtual_machines[0].folder }}"
      when: vm_discovery.virtual_machines | length > 0

    - name: Trigger vCenter Snapshot ({{ snapshot_prefix }})
      vmware.vmware.vm_snapshot:
        hostname: >-
          {{
            vmware_hostname
            | regex_replace('^https?://', '')
            | regex_replace('/.*$', '')
          }}
        username: "{{ vmware_username | default(vault_vcenters_user) }}"
        password: "{{ vmware_password | default(vault_vcenters_password) }}"
        validate_certs: false
        # Use dynamically discovered location
        datacenter: "{{ vm_datacenter }}"
        name: "{{ inventory_hostname }}"
        folder: "{{ vm_folder }}"
        state: present
        # Dynamic Naming
        snapshot_name: "{{ snapshot_prefix }}_{{ ansible_facts['date_time']['date'] }}"
        description: "{{ snapshot_desc }} on {{ ansible_facts['date_time']['iso8601'] }}"
        # Quiesce: Flush filesystem buffers for crash-consistent snapshot (requires VMware Tools)
        # Memory dump disabled: Faster snapshots, no live state needed for rollback scenarios
        quiesce: true
        memory_dump: false
      # Fail-Fast: If snapshot fails, stop everything. Do not ignore errors.
