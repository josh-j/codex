---
# collections/ansible_collections/internal/linux/roles/ubuntu_system_remediate/tasks/maintain.yaml
#
# Execution order matters here:
#   1. Snapshot (safety net before any changes)
#   2. STIG hardening (configuration changes)
#   3. Snapshot (safety net before patching)
#   4. Patching (package upgrades)
#   5. Reboot (if needed and allowed)

# ========================================================================
# PRE-HARDENING SNAPSHOT
# Takes a VM snapshot before applying STIG changes so we can roll back.
# Skipped if STIG hardening is not enabled.
# ========================================================================

- name: Take snapshot before STIG hardening
  ansible.builtin.include_role:
    name: internal.core.common
    tasks_from: safeguarding/create_snapshot.yaml
  vars:
    snapshot_prefix: "Ansible_Pre_Hardening"
    snapshot_desc: "Created by Ansible before applying STIG hardening"
  when: ubuntu_enable_stig_hardening | default(false) | bool

# ========================================================================
# STIG HARDENING
# Applies DoD STIG configuration changes to the host.
# Runs in normal mode (not check_mode) so changes are actually applied.
# ========================================================================

- name: Apply STIG hardening
  when: ubuntu_enable_stig_hardening | default(false) | bool
  block:
    - name: Execute STIG role
      ansible.builtin.include_role:
        name: internal.linux.ubuntu_stig_audit
        apply:
          check_mode: false

# ========================================================================
# PASSWORD ROTATION
# Rotates the root password using a vault-encrypted value.
# ========================================================================

- name: Rotate root password
  ansible.builtin.user:
    name: root
    password: "{{ vault_ubuntu_root_password | password_hash('sha512') }}"
  become: true
  when: ubuntu_enable_password_rotation | default(false) | bool

# ========================================================================
# PRE-PATCHING SNAPSHOT
# Takes a second snapshot before applying package updates.
# The snapshot task internally checks if the host is a VM before running.
# ========================================================================

- name: Take snapshot before patching
  ansible.builtin.include_role:
    name: internal.core.common
    tasks_from: safeguarding/create_snapshot.yaml
  vars:
    snapshot_prefix: "Ansible_Pre_Patch"
    snapshot_desc: "Created by Ansible before system dist-upgrade"

# ========================================================================
# PATCHING
# Applies all available package updates.
# ========================================================================

- name: Apply all available package updates
  ansible.builtin.apt:
    upgrade: dist
    update_cache: true
    lock_timeout: 600
    autoremove: true
    purge: true
  become: true
  register: _patch_result

- name: Log patching result
  ansible.builtin.debug:
    msg:
      - "Packages changed: {{ _patch_result.changed }}"
      - "{{ _patch_result.stdout_lines | default(['No output']) | last }}"

# ========================================================================
# REBOOT
# Checks reboot status after patching since a new kernel may have been
# installed. Reboots only if a reboot was needed AND automatic reboots
# are explicitly allowed.
# ========================================================================

- name: Check if reboot is required after patching
  ansible.builtin.stat:
    path: /var/run/reboot-required
  register: _post_patch_reboot

- name: Reboot if required and allowed
  ansible.builtin.reboot:
    msg: "Rebooting to apply updates - initiated by Ansible"
    pre_reboot_delay: 10
    post_reboot_delay: 30
    connect_timeout: 300
  become: true
  when:
    - ubuntu_allow_automatic_reboot | default(false) | bool
    - (ubuntu_ctx.updates.reboot_pending | bool) or (_post_patch_reboot.stat.exists)
