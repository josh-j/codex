---
# collections/ansible_collections/internal/linux/roles/ubuntu_stig_audit/tasks/main.yaml

# =============================================================================
# Phase 0 | Preconditions / Input Validation
# =============================================================================

- name: "Ubuntu STIG | Phase 0 | Gather service facts"
  ansible.builtin.service_facts:

- name: "Ubuntu STIG | Phase 0 | Validate discovery data exists"
  ansible.builtin.include_role:
    name: internal.core.common
    tasks_from: validate_typed_schema.yaml
  vars:
    ncs_validate_data: "{{ ubuntu_ctx }}"
    ncs_validate_schema_ref: "internal.linux:schemas/ubuntu_ctx.yaml"
    ncs_validate_root_key: "ubuntu_ctx"
    ncs_validate_fail_msg: "STIG audit requires discovery data. Run ubuntu_system_discover first."

# =============================================================================
# Phase 1 | Evaluate
# =============================================================================

- name: "Ubuntu STIG | Phase 1 | Evaluate"
  block:
    - name: "Ubuntu STIG | Phase 1a | Run audit"
      ansible.builtin.import_tasks: check.yaml
      tags: [checks, stig, security]

  rescue:
    - name: "Ubuntu STIG | Phase 1r | Set failure flag"
      ansible.builtin.set_fact:
        _stig_audit_failed: true
      changed_when: false

    - name: "Ubuntu STIG | Phase 1r | Log failure"
      ansible.builtin.debug:
        msg: "STIG audit failed on {{ inventory_hostname }}. Exporting partial results."

  always:
    # =============================================================================
    # Phase 2 | Finalize / Export
    # =============================================================================
    - name: "Ubuntu STIG | Phase 2a | Locate callback JSON artifact"
      vars:
        _stig_artifacts_dir: >-
          {{
            ubuntu_stig_artifacts_dir
            | default((playbook_dir | dirname | dirname) ~ '/.artifacts')
          }}
        _host_hint_1: "{{ inventory_hostname }}"
        _host_hint_2: "{{ ansible_facts['hostname'] | default('') }}"
      ansible.builtin.find:
        paths: "{{ _stig_artifacts_dir }}"
        file_type: file
        patterns:
          - "xccdf-results_*.json"
      register: _stig_json_found
      delegate_to: localhost
      become: false
      changed_when: false

    - name: "Ubuntu STIG | Phase 2a | Choose best JSON artifact"
      vars:
        _files: "{{ _stig_json_found.files | default([]) }}"
        _host_hint_1: "{{ inventory_hostname }}"
        _host_hint_2: "{{ ansible_facts['hostname'] | default('') }}"
        _preferred: >-
          {%- set out = [] -%}
          {%- for f in _files -%}
            {%- set p = (f.path | default('')) -%}
            {%- if (_host_hint_1 and _host_hint_1 in p) or (_host_hint_2 and _host_hint_2 in p) -%}
              {%- set _ = out.append(f) -%}
            {%- endif -%}
          {%- endfor -%}
          {{ out }}
        _cands: "{{ _preferred if (_preferred | length > 0) else _files }}"
      ansible.builtin.set_fact:
        ubuntu_stig_artifact_file_resolved: >-
          {{
            (_cands | sort(attribute='mtime') | last | default({})).path | default('')
          }}
      changed_when: false

    - name: "Ubuntu STIG | Phase 2b | Read callback artifact (if present)"
      ansible.builtin.slurp:
        src: "{{ ubuntu_stig_artifact_file_resolved }}"
      register: _stig_json_raw
      delegate_to: localhost
      become: false
      when: ubuntu_stig_artifact_file_resolved | length > 0
      changed_when: false

    - name: "Ubuntu STIG | Phase 2c | Set audit_full_list from artifact"
      vars:
        _raw: "{{ (_stig_json_raw.content | b64decode) if (_stig_json_raw is defined and ('content' in _stig_json_raw)) else '[]' }}"
        _data: "{{ _raw | from_json }}"
      ansible.builtin.set_fact:
        # Callback writes "fixed" for changed tasks; in check_mode that means NON-compliant.
        audit_full_list: >-
          {%- set out = [] -%}
          {%- for r in (_data | default([])) -%}
            {%- if r is mapping -%}
              {%- set s = (r.status | default('') | string | lower) -%}
              {%- if (not (ubuntu_stig_enable_hardening | default(false) | bool)) and s == 'fixed' -%}
                {%- set _ = out.append(r | combine({'status': 'failed'})) -%}
              {%- else -%}
                {%- set _ = out.append(r) -%}
              {%- endif -%}
            {%- endif -%}
          {%- endfor -%}
          {{ out }}
      when: ubuntu_stig_artifact_file_resolved | length > 0
      changed_when: false

    - name: "Ubuntu STIG | Phase 2d | Fail with actionable error if no artifact"
      ansible.builtin.fail:
        msg: >-
          No STIG callback JSON artifact found in {{
            ubuntu_stig_artifacts_dir | default((playbook_dir | dirname | dirname) ~ '/.artifacts')
          }}.
          Ensure the 'stig_xml' callback is enabled and writing artifacts.
      when: ubuntu_stig_artifact_file_resolved | length == 0
