---
- name: Phase 3 | Generate Linux Node & Fleet Reports
  delegate_to: localhost
  run_once: true
  vars:
    _playbooks_root: "{{ playbook_dir | dirname }}"
    _reports_root: "{{ ncs_config.report_directory | default('/srv/samba/reports') }}"
    _platform_root: "{{ _reports_root }}/platform"
    _ubuntu_report_dir: "{{ _platform_root }}/ubuntu"

    # Unified timestamp for this run (e.g., 20260224)
    report_stamp: "{{ now(utc=true, fmt='%Y%m%d') }}"

  block:
    - name: Ensure Ubuntu platform report structure exists
      ansible.builtin.file:
        path: "{{ _ubuntu_report_dir }}"
        state: directory
        mode: "0755"

    - name: Aggregate Linux Audit State
      # Source: platform/ubuntu (contains host folders)
      # Destination: platform/ubuntu/linux_fleet_state.yaml
      ansible.builtin.command: >
        python3 {{ _playbooks_root }}/scripts/aggregate_yaml_reports.py
        {{ _ubuntu_report_dir }}
        {{ _ubuntu_report_dir }}/linux_fleet_state.yaml
      changed_when: false

    - name: Load Aggregated Data
      ansible.builtin.include_vars:
        file: "{{ _ubuntu_report_dir }}/linux_fleet_state.yaml"
        name: all_hosts

    - name: Ensure per-host report directories exist
      ansible.builtin.file:
        path: "{{ _ubuntu_report_dir }}/{{ item.key }}"
        state: directory
        mode: "0755"
      loop: "{{ (all_hosts.hosts | default(all_hosts)) | dict2items }}"
      # Skip metadata/state files that might exist in the directory
      when: item.key not in ['Split', 'Summary', 'platform', 'linux_fleet_state']

    - name: Render detailed per-host HTML reports
      ansible.builtin.template:
        src: "ubuntu_host_health_report.html.j2"
        dest: "{{ _ubuntu_report_dir }}/{{ item.key }}/health_report_{{ report_stamp }}.html"
        mode: "0644"
      loop: "{{ (all_hosts.hosts | default(all_hosts)) | dict2items }}"
      when: item.key not in ['Split', 'Summary', 'platform', 'linux_fleet_state']
      vars:
        host_name: "{{ item.key }}"
        host_data: "{{ item.value.system | default({}) }}"

    - name: Render Linux Fleet HTML Report (Platform Level)
      ansible.builtin.template:
        src: "ubuntu_health_report.html.j2"
        dest: "{{ _ubuntu_report_dir }}/ubuntu_health_report_{{ report_stamp }}.html"
        mode: "0644"
