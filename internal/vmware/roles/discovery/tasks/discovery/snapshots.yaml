---
# internal.vmware.discovery : discovery/snapshots.yaml
#
# Collect snapshots once (discovery phase), normalize into _disc_snapshots.
# Audit phase should only read vmware_ctx.inventory.snapshots.

- name: Snapshots | Derive datacenter name
  ansible.builtin.set_fact:
    _snap_dc_name: >-
      {{
        _disc_datacenters.summary.primary_dc
          | default('')
      }}
  changed_when: false

- name: Snapshots | Skip if no datacenter discovered
  ansible.builtin.set_fact:
    _disc_snapshots: >-
      {{
        '' | internal.vmware.snapshot_no_datacenter_result(
          _vmware_controller_collected_at
        )
      }}
  when: (_snap_dc_name | length) == 0
  changed_when: false

- name: Snapshots | Build VM owner lookup map
  ansible.builtin.set_fact:
    _vm_owner_map: "{{ _disc_vms | internal.vmware.snapshot_owner_map }}"
  when: (_snap_dc_name | length) > 0
  changed_when: false

- name: Snapshots | Gather all active snapshots (discovery)
  community.vmware.vmware_all_snapshots_info:
    hostname: "{{ _vcenter_hostname }}"
    username: "{{ vmware_username }}"
    password: "{{ vmware_password }}"
    validate_certs: "{{ vmware_validate_certs | default(false) | bool }}"
    datacenter: "{{ _snap_dc_name }}"
  register: _snapshots_raw
  delegate_to: localhost
  no_log: true
  failed_when: false
  changed_when: false
  when: (_snap_dc_name | length) > 0

# Note: module returns list in key "vmware_all_snapshots_info" (docs)

- name: Snapshots | Normalize into _disc_snapshots
  ansible.builtin.set_fact:
    _disc_snapshots: >-
      {{
        _snapshots_raw
        | internal.vmware.normalize_snapshots_result(
          _all_snaps,
          _aged_snaps,
          _vmware_controller_collected_at,
          (vmware_snapshot_size_warning_gb | default(100) | float)
        )
      }}
  vars:
    _raw_list: "{{ _snapshots_raw.vmware_all_snapshots_info | default([]) }}"
    # Keep raw snapshot list too if you want to display "all snapshots" in HTML
    _all_snaps: >-
      {{ _raw_list | internal.vmware.enrich_snapshots(_vm_owner_map) }}
    # Filter by age using your existing custom filter
    _aged_snaps: >-
      {{
        _raw_list
        | internal.core.filter_by_age(
          (_vmware_controller_epoch | int),
          (vmware_snapshot_age_warning_days | default(7) | int)
        )
        | internal.vmware.enrich_snapshots(_vm_owner_map)
      }}
  when: (_snap_dc_name | length) > 0
  changed_when: false
