---
# internal.vmware.discovery : discovery/appliance_health.yaml

- name: Gather vCenter appliance system data
  vmware.vmware.appliance_info:
    hostname: "{{ _vcenter_hostname }}"
    username: "{{ vmware_username }}"
    password: "{{ vmware_password }}"
    validate_certs: "{{ vmware_validate_certs | default(false) | bool }}"
    properties: [all]
  register: _appliance_raw
  delegate_to: localhost
  no_log: true
  failed_when: false
  retries: 2
  delay: 5
  until: _appliance_raw is succeeded
  ignore_errors: true
  changed_when: false

- name: Normalize appliance state
  ansible.builtin.set_fact:
    _disc_appliance: >-
      {{
        _appliance_raw
        | internal.vmware.normalize_appliance_health_result(
          _disc_appliance_backup | default({}),
          _vmware_controller_collected_at
        )
      }}
  changed_when: false

- name: Log critical health metrics
  ansible.builtin.debug:
    msg: >-
      vCenter Instance: {{ inventory_hostname }} |
      Overall: {{ _disc_appliance.health.overall | upper }} |
      Database: {{ _disc_appliance.health.database | upper }} |
      NTP: {{ _disc_appliance.config.ntp_mode }}
  when: (_disc_appliance.status | default('SUCCESS')) == 'SUCCESS'
