---
# internal.vmware.discovery : discovery.yaml

# ========================================================================
# 1. COLLECTION (Include sub-tasks)
# ========================================================================

- name: Discovery | Appliance Health
  ansible.builtin.include_tasks: discovery/appliance_health.yaml
  tags: [discovery, infrastructure]

- name: Discovery | Appliance Backup
  ansible.builtin.include_tasks: discovery/appliance_backup.yaml
  tags: [discovery, infrastructure]

- name: Discovery | Datacenters
  ansible.builtin.include_tasks: discovery/datacenter.yaml
  tags: [discovery, infrastructure]

- name: Discovery | Compute (Clusters & Hosts)
  ansible.builtin.include_tasks: discovery/compute.yaml
  tags: [discovery, infrastructure]

- name: Discovery | Storage (Datastores)
  ansible.builtin.include_tasks: discovery/storage.yaml
  tags: [discovery, storage]

- name: Discovery | Workload (VMs)
  ansible.builtin.include_tasks: discovery/workload.yaml
  tags: [discovery, workload]

- name: Discovery | Snapshots
  ansible.builtin.include_tasks: discovery/snapshots.yaml
  tags: [discovery, snapshots]

- name: Discovery | Alarms
  ansible.builtin.include_tasks: discovery/alarms.yaml
  tags: [discovery, alarms]

# ========================================================================
# 2. NORMALIZE (Assemble and Standardize)
# ========================================================================

- name: Ensure local facts are available for timestamping
  ansible.builtin.setup:
    gather_subset:
      - min
  delegate_to: localhost
  run_once: true

- name: Assemble discovery context
  ansible.builtin.set_fact:
    vmware_ctx: >-
      {{
        vmware_ctx | combine({
          'system': {
             'status': 'DISCOVERY_COMPLETE',
             'updated_at': ansible_facts['date_time']['iso8601']
          },
          'health': {
            'appliance': _temp_appliance | default({}),
            'alarms': _temp_alarms | default({})
          },
          'inventory': {
            'datacenters': _temp_datacenters | default({}),
            'clusters': _temp_clusters | default({}),
            'hosts': _temp_hosts | default({}),
            'datastores': _temp_datastores | default({}),
            'vms': _temp_vms | default({}),
            'snapshots': _temp_snapshots | default({'all': [], 'aged': [], 'summary': {'total_count': 0, 'aged_count': 0, 'total_size_gb': 0.0, 'large_snapshots': [], 'oldest_days': 0, 'status': 'NOT_RUN'}})
          }
        }, recursive=true)
      }}
  changed_when: false

# ========================================================================
# 3. EXPORT (Phase 2 Standardized State)
# ========================================================================

- name: Export VMware discovery state
  ansible.builtin.include_role:
    name: internal.core.state
    tasks_from: export
  vars:
    ncs_export_path: "{{ ncs_config.report_directory | default('/srv/samba/reports') }}/platform/vmware/{{ inventory_hostname }}/discovery.yaml"
    ncs_export_data: >-
      {{
        vmware_ctx | combine({
          'audit_type': 'discovery',
          'summary': {
             'clusters': _temp_clusters.list | length | default(0),
             'hosts': _temp_hosts.list | length | default(0),
             'vms': _temp_vms.list | length | default(0)
          }
        })
      }}
