---
# internal.vmware.discovery : tasks/export.yaml
#
# Wrapper around internal.core.state:export.
# - Resolves export path without recursion
# - Always passes ncs_export_data to the state exporter

- name: "VMware Discovery | Resolve export path"
  ansible.builtin.set_fact:
    _vmware_discovery_export_path: >-
      {{
        (ncs_export_path | default('', true))
        if ((ncs_export_path | default('', true)) | length) > 0
        else (
          (ncs_config.report_directory | default('/srv/samba/reports'))
          ~ '/platform/vmware/'
          ~ inventory_hostname
          ~ '/discovery.yaml'
        )
      }}
  changed_when: false

- name: "VMware Discovery | Export discovery state"
  ansible.builtin.include_role:
    name: internal.core.state
    tasks_from: export
  vars:
    ncs_export_path: "{{ _vmware_discovery_export_path }}"
    ncs_export_data: "{{ vmware_ctx | internal.vmware.build_discovery_export_payload }}"
