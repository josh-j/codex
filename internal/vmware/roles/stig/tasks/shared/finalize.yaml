---
# internal.vmware.stig : tasks/shared/finalize.yaml

- name: "STIG | Resolve absolute paths"
  ansible.builtin.set_fact:
    # FIX: Use an inline Jinja expression to prevent whitespace injection
    _vmw_skeleton_abs_path: >-
      {{
        role_path ~ '/files/cklb_skeleton_vsphere7_esxi_V1R4.json'
        if (_stig_target_type | default('esxi')) == 'esxi'
        else role_path ~ '/files/cklb_skeleton_vsphere7_vms_V1R4.json'
      }}

    _vmw_export_abs_path: >-
      {{
        ncs_export_path | default(
          (ncs_config.report_directory | default('/srv/samba/reports'))
          ~ '/platform/vmware/'
          ~ inventory_hostname
          ~ '/stig_'
          ~ (_stig_target_type | default('esxi'))
          ~ '.yaml'
        )
      }}
  changed_when: false

- name: "STIG | Export reports"
  tags: [stig, reporting]
  ansible.builtin.include_role:
    name: internal.core.stig
    tasks_from: finalize.yaml
  vars:
    ncs_export_path: "{{ _vmw_export_abs_path }}"
    stig_skeleton_path: "{{ _vmw_skeleton_abs_path }}"
    stig_target_type: "{{ _stig_target_type | default('esxi') }}"
    stig_export_cklb: "{{ vmware_config_export_cklb | default(true) }}"
