---
# internal.vmware.stig : tasks/shared/finalize.yaml

- name: "STIG | Export reports"
  tags: [stig, reporting]
  ansible.builtin.include_role:
    name: internal.core.stig
    tasks_from: finalize.yaml
  vars:
    stig_quiet_mode: "{{ vmware_config_quiet_mode | default(false) }}"
    ncs_export_path: >-
      {{
        (ncs_config.report_directory | default('/srv/samba/reports'))
        ~ '/platform/vmware/'
        ~ inventory_hostname
        ~ '/stig_'
        ~ stig_target_type
        ~ '.yaml'
      }}

- name: "STIG | Generate CKLB artifacts"
  tags: [stig, reporting]
  when:
    - vmware_config_export_cklb | default(true) | bool
    - audit_full_list | default([]) | length > 0
  ansible.builtin.template:
    src: "cklb_generic.json.j2"
    dest: >-
      {{
        (ncs_config.report_directory | default('/srv/samba/reports'))
        ~ '/platform/vmware/'
        ~ inventory_hostname
        ~ '/'
        ~ item.0
        ~ '_'
        ~ (_stig_report_id | default(now(utc=true, fmt='%Y%m%dT%H%M%SZ')))
        ~ '_STIG.cklb'
      }}
    mode: "0664"
  vars:
    target_name: "{{ item.0 }}"
    audit_data: "{{ item.1 }}"
    cklb_skeleton_path: "{{ vsphere_stig_skeleton_path }}"
  loop: "{{ audit_full_list | groupby('name') | map('list') | list }}"
  loop_control:
    label: "{{ item.0 }}"
  delegate_to: localhost
  become: false
