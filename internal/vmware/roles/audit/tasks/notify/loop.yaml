---
# internal.vmware.audit : notify/loop.yaml

- name: "Compile personalized compliance data for {{ owner_email }}"
  ansible.builtin.set_fact:
    _my_vms: >-
      {{
        vmware_ctx.inventory.vms.list | default([])
        | selectattr('owner_email', 'equalto', owner_email)
        | list
      }}
    _my_names: >-
      {{
        vmware_ctx.inventory.vms.list | default([])
        | selectattr('owner_email', 'equalto', owner_email)
        | map(attribute='name')
        | list
      }}

- name: "Categorize issues for {{ owner_email }}"
  ansible.builtin.set_fact:
    my_issues:
      no_backup: "{{ vmware_ctx.inventory.vms.never_backed_up | default([]) | selectattr('name', 'in', _my_names) | list }}"
      no_backup_tags: "{{ vmware_ctx.inventory.vms.without_backup_tags | default([]) | selectattr('name', 'in', _my_names) | list }}"
      overdue_backup: "{{ vmware_ctx.inventory.vms.with_overdue_backup | default([]) | selectattr('name', 'in', _my_names) | list }}"
      aged_snapshots: "{{ vmware_ctx.inventory.snapshots.aged | default([]) | selectattr('vm_name', 'in', _my_names) | list }}"
      powered_off: "{{ _my_vms | selectattr('power_state', 'equalto', 'POWEREDOFF') | list }}"

# - name: "Dispatch compliance digest to {{ owner_email }}"
#   # Removed {{ }} to satisfy ansible-lint (rule: no-jinja-when)
#   # When is implicitly Jinja2, so we just write the expression directly.
#   when: >
#     my_issues.no_backup | length > 0 or
#     my_issues.no_backup_tags | length > 0 or
#     my_issues.overdue_backup | length > 0 or
#     my_issues.aged_snapshots | length > 0
#   community.general.mail:
#     host: "{{ ncs_config.email.smtp.server | default('localhost') }}"
#     port: "{{ ncs_config.email.smtp.port | default(25) }}"
#     from: "{{ vmware_notification_from | default('vcenter-audit@' + inventory_hostname) }}"
#     to: "{{ owner_email }}"
#     subject: "[ACTION REQUIRED] Infrastructure Compliance: {{ inventory_hostname }}"
#     subtype: html
#     body: "{{ lookup('ansible.builtin.template', 'owner_notification_email.html.j2') }}"
#   vars:
#     issues: "{{ my_issues }}"
#     vm_count: "{{ _my_names | length }}"
#   delegate_to: localhost
#   no_log: true
