---
# internal.vmware.audit : tasks/checks/storage.yaml

- name: Audit | Evaluate Datastore Capacity
  ansible.builtin.set_fact:
    vmware_alerts: "{{ vmware_alerts + [new_alert] }}"
  loop: "{{ vmware_ctx.inventory.datastores.list | default([]) }}"
  vars:
    # Thresholds from defaults/main.yaml
    _crit_t: "{{ vmware_datastore_free_critical_pct | default(10) | float }}"
    _warn_t: "{{ vmware_datastore_free_warning_pct | default(15) | float }}"

    # Logic: Only one alert per DS. Critical takes precedence.
    _is_crit: "{{ item.free_pct | float <= _crit_t }}"
    _is_warn: "{{ item.free_pct | float <= _warn_t and item.free_pct | float > _crit_t }}"

    new_alert:
      severity: "{{ 'CRITICAL' if _is_crit else 'WARNING' }}"
      category: "storage_capacity"
      message: "Datastore {{ item.name }} is low on space ({{ item.free_pct }}% free)"
      detail:
        datastore: "{{ item.name }}"
        free_gb: "{{ item.free_gb }}"
        capacity_gb: "{{ item.capacity_gb }}"
        threshold: "{{ _crit_t if _is_crit else _warn_t }}%"
  when: _is_crit or _is_warn
  loop_control:
    label: "{{ item.name }} ({{ item.free_pct }}%)"

- name: Audit | Detect Inaccessible Datastores
  ansible.builtin.set_fact:
    vmware_alerts: "{{ vmware_alerts + [inaccessible_alert] }}"
  loop: "{{ vmware_ctx.inventory.datastores.list | default([]) }}"
  vars:
    inaccessible_alert:
      severity: "CRITICAL"
      category: "storage_health"
      message: "Datastore {{ item.name }} is INACCESSIBLE"
      detail:
        datastore: "{{ item.name }}"
        type: "{{ item.type }}"
        path_status: "Down"
  when: not (item.accessible | bool)
  loop_control:
    label: "{{ item.name }}"
