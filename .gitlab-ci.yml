image: python:3.11

stages:
  - lint
  - syntax
  - test

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  ANSIBLE_FORCE_COLOR: "true"
  PY_COLORS: "1"

cache:
  paths:
    - .cache/pip

before_script:
  - python -m pip install --upgrade pip
  - pip install ansible-core ansible-lint yamllint
  - export ANSIBLE_CONFIG="$CI_PROJECT_DIR/ansible.cfg"
  - export ANSIBLE_LOCAL_TEMP="/tmp/ansible-local"
  - export ANSIBLE_REMOTE_TEMP="/tmp/ansible-remote"

# ─────────────────────────────────────────────────────────────────────────────
# 1) LINT STAGE
# ─────────────────────────────────────────────────────────────────────────────
yaml_lint:
  stage: lint
  script:
    - yamllint .

ansible_lint:
  stage: lint
  script:
    - ansible-lint

# ─────────────────────────────────────────────────────────────────────────────
# 2) SYNTAX STAGE
# ─────────────────────────────────────────────────────────────────────────────
playbook_syntax:
  stage: syntax
  script:
    - echo "dummy_password" > .vaultpass
    - |
      for playbook in playbooks/*.yaml playbooks/common/*.yaml; do
        [ -f "$playbook" ] || continue
        echo "Checking syntax for $playbook..."
        ansible-playbook -i inventory/production --syntax-check "$playbook"
      done

# ─────────────────────────────────────────────────────────────────────────────
# 3) TEST STAGE (Unit Tests)
# ─────────────────────────────────────────────────────────────────────────────
unit_tests:
  stage: test
  script:
    - python -m unittest
        tests/unit/test_core_reporting_filter.py
        tests/unit/test_core_stig_filter.py
        tests/unit/test_report_css_single_source.py
        tests/unit/test_report_view_model_vmware.py
        tests/unit/test_report_view_model_linux.py
        tests/unit/test_report_view_model_site.py
        tests/unit/test_vmware_audit_export_contract.py
        tests/unit/test_vmware_snapshot_filter.py
