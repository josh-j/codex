---
# Integration test wrapper: Ubuntu system audit check.yaml
- name: Ubuntu Audit Check Integration Test
  hosts: localhost
  connection: local
  gather_facts: true

  tasks:
    - name: Run ubuntu system audit checks
      ansible.builtin.include_role:
        name: internal.linux.ubuntu_system_audit
        tasks_from: check.yaml

    - name: Compute rollups
      ansible.builtin.set_fact:
        _ubuntu_rollups: >-
          {{
            (ubuntu_alerts | default([]) | list)
            | internal.core.compute_audit_rollups
          }}

    - name: Dump captured facts to JSON
      ansible.builtin.copy:
        dest: "{{ _output_path }}"
        mode: "0644"
        content: >-
          {{
            {
              'ubuntu_alerts': (ubuntu_alerts | default([])),
              'health': ((_ubuntu_rollups | default({})).health | default('HEALTHY')),
              'summary': ((_ubuntu_rollups | default({})).summary | default({}))
            } | to_json
          }}
