---
# Integration test wrapper: VMware audit (init → checks → finalize)
# Uses include_tasks with absolute paths to avoid triggering role dependencies
# (the audit role depends on discovery, which attempts a vCenter connection).
- name: VMware Audit Integration Test
  hosts: localhost
  connection: local
  gather_facts: true

  vars:
    # Disable export/validation that needs filesystem state paths
    vmware_validate_export_schema: false
    ncs_export_path: "{{ _state_output_dir }}/vmware_state.yaml"
    # Role defaults that would normally be loaded by include_role
    vmware_emit_per_cluster_alerts: true
    vmware_emit_per_object_storage_alerts: false
    vmware_alert_items_max: 25
    vmware_alarm_items_max: 25
    vmware_snapshot_items_max: 25
    vmware_datastore_items_max: 25
    vmware_tools_items_max: 50

  pre_tasks:
    - name: Create state output directory
      ansible.builtin.file:
        path: "{{ _state_output_dir }}"
        state: directory
        mode: "0755"

    - name: Resolve role task path
      ansible.builtin.set_fact:
        _audit_tasks: "{{ _collections_dir }}/ansible_collections/internal/vmware/roles/audit/tasks"

  tasks:
    - name: Initialize audit state (from init.yaml)
      ansible.builtin.set_fact:
        vmware_alerts: "{{ (vmware_ctx | default({})).alerts | default([]) | list }}"
        _vmw_audit_failed: false

    - name: "Checks | Health"
      ansible.builtin.include_tasks:
        file: "{{ _audit_tasks }}/checks/health.yaml"

    - name: "Checks | Configuration"
      ansible.builtin.include_tasks:
        file: "{{ _audit_tasks }}/checks/configuration.yaml"
      when: vmware_emit_per_cluster_alerts | default(true) | bool

    - name: "Checks | Datastore Usage (Rollup)"
      ansible.builtin.include_tasks:
        file: "{{ _audit_tasks }}/checks/storage_alerts.yaml"
      when: not (vmware_emit_per_object_storage_alerts | default(false) | bool)

    - name: "Checks | Resources"
      ansible.builtin.include_tasks:
        file: "{{ _audit_tasks }}/checks/resources.yaml"

    - name: "Checks | Snapshots"
      ansible.builtin.include_tasks:
        file: "{{ _audit_tasks }}/checks/snapshots.yaml"

    - name: "Checks | Tools"
      ansible.builtin.include_tasks:
        file: "{{ _audit_tasks }}/checks/tools.yaml"

    - name: "Checks | Alarms"
      ansible.builtin.include_tasks:
        file: "{{ _audit_tasks }}/checks/alarms.yaml"

    - name: Finalize audit
      ansible.builtin.include_tasks:
        file: "{{ _audit_tasks }}/finalize.yaml"

    - name: Dump captured facts to JSON
      ansible.builtin.copy:
        dest: "{{ _output_path }}"
        mode: "0644"
        content: >-
          {{
            {
              'vmware_alerts': (vmware_alerts | default([])),
              'vmware_ctx': vmware_ctx,
              'health': (_vmw_health | default('HEALTHY')),
              'summary': (_vmw_summary | default({})),
              'export': (_vmware_audit_export_data | default({}))
            } | to_json
          }}
