---
# Integration test wrapper: STIG normalization pipeline (inlined from finalize.yaml)
- name: STIG Normalize Integration Test
  hosts: localhost
  connection: local
  gather_facts: false

  tasks:
    - name: Compute internal facts
      ansible.builtin.set_fact:
        _stig_target_type: "{{ stig_target_type | default('unknown') }}"
      changed_when: false

    - name: Run normalization filter
      ansible.builtin.set_fact:
        _stig_normalized: >-
          {{
            (audit_full_list | default([]))
            | internal.core.normalize_stig_results(_stig_target_type)
          }}
      changed_when: false

    - name: Extract normalized subsets
      ansible.builtin.set_fact:
        _stig_audit_full_list_normalized: "{{ _stig_normalized.full_audit | default([]) }}"
        _stig_audit_violations_normalized: "{{ _stig_normalized.violations | default([]) }}"
        _stig_alerts_normalized: "{{ _stig_normalized.alerts | default([]) }}"
      changed_when: false

    - name: Dump captured facts to JSON
      ansible.builtin.copy:
        dest: "{{ _output_path }}"
        mode: "0644"
        content: >-
          {{
            {
              'normalized': _stig_normalized,
              'full_audit': _stig_audit_full_list_normalized,
              'violations': _stig_audit_violations_normalized,
              'alerts': _stig_alerts_normalized
            } | to_json
          }}
