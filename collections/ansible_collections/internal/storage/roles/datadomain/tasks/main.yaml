---
# collections/ansible_collections/internal/storage/roles/datadomain/tasks/main.yaml

- name: Initialize Role Context
  ansible.builtin.include_role:
    name: internal.storage.common
    tasks_from: sync_ctx

- name: Data Domain | Perform health checks
  block:
    - name: Data Domain | Check API connectivity
      ansible.builtin.uri:
        url: "{{ item.url }}"
        method: GET
        validate_certs: false
        status_code: [200, 401]
      loop: "{{ backup_unisphere | default([]) }}"
      register: _dd_reachability
      when: item.type == 'ddve'

    - name: Data Domain | Emit connectivity alert
      ansible.builtin.include_role:
        name: internal.core.reporting
        tasks_from: alert.yaml
      vars:
        ncs_alert_severity: "{{ 'INFO' if item.status == 200 or item.status == 401 else 'CRITICAL' }}"
        ncs_alert_category: "BACKUP_CONNECTIVITY"
        ncs_alert_message: "Data Domain API at {{ item.item.url }} is {{ 'reachable' if item.status == 200 or item.status == 401 else 'UNREACHABLE' }}"
      loop: "{{ _dd_reachability.results }}"
      when: not ansible_check_mode

    - name: Data Domain | Record report generation
      ansible.builtin.include_role:
        name: internal.core.reporting
        tasks_from: report.yaml
      vars:
        ncs_report_name: 'datadomain_health_check'
      when: not ansible_check_mode

  rescue:
    - name: Data Domain | Log failure
      ansible.builtin.include_role:
        name: internal.core.common
        tasks_from: logging/error
      vars:
        ncs_log_message: "Data Domain checks failed for {{ inventory_hostname }}: {{ ansible_failed_result.msg | default('unknown error') }}"
