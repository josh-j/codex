---
# collections/ansible_collections/internal/stig/roles/esxi/tasks/audit_ssh.yaml

# ------------------------------------------------------------------------------
# PHASE 1: ENABLE SSH (Via vCenter API) - Runs Locally
# ------------------------------------------------------------------------------
- name: "SSH | Enable SSH Service (Temporary)"
  community.vmware.vmware_host_service_manager:
    hostname: "{{ vcenter_hostname }}"
    username: "{{ vcenter_username }}"
    password: "{{ vcenter_password }}"
    validate_certs: false
    esxi_hostname: "{{ inventory_hostname }}"
    service_name: TSM-SSH
    state: present
  delegate_to: localhost
  vars:
    ansible_connection: local
  register: ssh_enable_result
  ignore_errors: true

# ------------------------------------------------------------------------------
# PHASE 2: EXECUTE READ-ONLY CHECKS (Via SSH) - Runs Remotely
# ------------------------------------------------------------------------------
- name: "SSH | Perform Deep Audit"
  when: ssh_enable_result is success
  block:
    # 1. Gather File Contents (Using RAW to bypass Python requirements)
    - name: "SSH | Read Configuration Files"
      ansible.builtin.raw: |
        echo "===ISSUE==="; cat /etc/issue
        echo "===SSHD==="; cat /etc/ssh/sshd_config
        echo "===VMWARE_CONFIG==="; cat /etc/vmware/config
        echo "===VMWARE_SETTINGS==="; cat /etc/vmware/settings
      register: ssh_file_contents
      changed_when: false
      failed_when: false
      # [FIX] Define credentials explicitly for SSH connection (Phase 2 only)
      vars: &ssh_creds
        ansible_connection: ssh
        ansible_user: "root"
        ansible_password: "{{ vault_esxi_root_password }}"
        ansible_ssh_common_args: '-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null'



    - name: "DEBUG | Print SSH File Contents"
      ansible.builtin.debug:
        msg: "{{ ssh_file_contents }}"

    # 2. Gather Command Outputs
    - name: "SSH | Run ESXCLI Commands"
      ansible.builtin.raw: |
        echo "===FIPS_SSH==="; esxcli system security fips140 ssh get
        echo "===FIPS_PROXY==="; esxcli system security fips140 rhttpproxy get
        echo "===SECURE_BOOT==="; /usr/lib/vmware/secureboot/bin/secureBoot.py -s
        echo "===FIREWALL==="; esxcli network firewall get
        echo "===SNMP==="; esxcli system snmp get
        echo "===SYSLOG_SSL==="; esxcli system syslog config get | grep "Strict X509"
        echo "===AUDIT_LOCAL==="; esxcli system auditrecords local get 2>/dev/null || echo "NotSupported"
        echo "===AUDIT_REMOTE==="; esxcli system auditrecords remote get 2>/dev/null || echo "NotSupported"
      register: ssh_command_outputs
      changed_when: false
      failed_when: false
      vars: *ssh_creds



    # 3. Parse & Map Results
    - name: "SSH | Map Audit Results"
      ansible.builtin.set_fact:
        ssh_audit_results:
          # Use 'default' filters aggressively to prevent 'NoneType' crashes
          banner_content: "{{ ssh_file_contents.stdout | default('') | regex_search('===ISSUE===\\r?\\n([\\s\\S]*?)(?=\\r?\\n===)', '\\1') | default([], true) | first | default('') | trim }}"

          # Load "Golden" Template
          banner_expected: "{{ lookup('file', role_path + '/templates/issue') | trim }}"

          sshd_config: "{{ ssh_file_contents.stdout | default('') | regex_search('===SSHD===\\r?\\n([\\s\\S]*?)(?=\\r?\\n===)', '\\1') | default([], true) | first | default('') }}"
          vmx_log_override: "{{ ssh_file_contents.stdout | default('') | regex_search('^vmx.*\\.log', multiline=True) | default([], true) | first | default('') }}"
          vmware_settings: "{{ ssh_file_contents.stdout | default('') | regex_search('===VMWARE_SETTINGS===\\r?\\n([\\s\\S]*)', '\\1') | default([], true) | first | default('') }}"

          fips_ssh: "{{ ssh_command_outputs.stdout | default('') | regex_search('===FIPS_SSH===[\\s\\S]*?Enabled: (true|false)', '\\1') | default([], true) | first | default('false') }}"
          fips_proxy: "{{ ssh_command_outputs.stdout | default('') | regex_search('===FIPS_PROXY===[\\s\\S]*?Enabled: (true|false)', '\\1') | default([], true) | first | default('false') }}"

          # Secure Boot
          secure_boot: "{{ ssh_command_outputs.stdout | default('') | regex_search('===SECURE_BOOT===[\\s\\S]*?(Enabled|Disabled)', '\\1') | default([], true) | first | default('Unknown') }}"

          firewall_default: "{{ ssh_command_outputs.stdout | default('') | regex_search('(?i)Default Action: (DROP|PASS)', '\\1') | default([], true) | first | default('Pass') }}"

          snmp_enable: "{{ ssh_command_outputs.stdout | default('') | regex_search('(?i)Enable: (true|false)', '\\1') | default([], true) | first | default('true') }}"

          audit_local: "{{ ssh_command_outputs.stdout | default('') | regex_search('===AUDIT_LOCAL===[\\s\\S]*?storage is (enabled|disabled)', '\\1') | default([], true) | first | default('disabled') }}"
          audit_remote: "{{ ssh_command_outputs.stdout | default('') | regex_search('===AUDIT_REMOTE===[\\s\\S]*?logging is (enabled|disabled)', '\\1') | default([], true) | first | default('disabled') }}"

          syslog_x509: "{{ ssh_command_outputs.stdout | default('') | regex_search('Strict X509Compliance: (true|false)', '\\1') | default([], true) | first | default('false') }}"

    - name: "DEBUG | Print SSH Audit Results"
      ansible.builtin.debug:
        msg: "{{ ssh_audit_results }}"

# ------------------------------------------------------------------------------
# PHASE 3: DISABLE SSH (Always runs, even if Audit fails) - Runs Locally
# ------------------------------------------------------------------------------
  always:
    - name: "SSH | Disable SSH Service (Cleanup)"
      community.vmware.vmware_host_service_manager:
        hostname: "{{ vcenter_hostname }}"
        username: "{{ vcenter_username }}"
        password: "{{ vcenter_password }}"
        validate_certs: false
        esxi_hostname: "{{ inventory_hostname }}"
        service_name: TSM-SSH
        state: absent
      delegate_to: localhost
      vars:
        # [FIX] Reset connection to local.
        # DO NOT define 'ansible_user' here to avoid recursive loop with host_vars.
        ansible_connection: local
      when: ssh_enable_result is changed or ssh_enable_result is success
