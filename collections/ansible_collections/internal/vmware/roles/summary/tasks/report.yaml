---
# internal.vmware.summary : tasks/report.yaml

- name: Phase 3 | VMware Fleet & Node Report Generation
  vars:
    _scripts_dir: "{{ playbook_dir.split('/playbooks')[0] }}/playbooks/scripts"
    _reports_root: "{{ ncs_config.report_directory | default('/srv/samba/reports') }}"
    _vmware_report_dir: "{{ _reports_root }}/platform/vmware"

    report_stamp: "{{ now(utc=true, fmt='%Y%m%d') }}"
    report_date: "{{ now(utc=true, fmt='%Y-%m-%d %H:%M:%S') }}"
    report_id: "{{ now(utc=true, fmt='%Y%m%dT%H%M%SZ') }}"

  block:
    - name: Prepare VMware aggregated platform state
      ansible.builtin.include_role:
        name: internal.core.reporting
        tasks_from: prepare_platform_state.yaml
      vars:
        ncs_reporting_scripts_dir: "{{ _scripts_dir }}"
        ncs_reporting_platform_dir: "{{ _vmware_report_dir }}"
        ncs_reporting_aggregate_output: "{{ _vmware_report_dir }}/vmware_fleet_state.yaml"
        ncs_reporting_aggregate_var_name: "vmw_all_hosts"

    - name: Ensure per-host report directories exist
      ansible.builtin.include_role:
        name: internal.core.reporting
        tasks_from: host_loop_ensure_dirs.yaml
      vars:
        ncs_reporting_hosts_map: "{{ vmw_all_hosts.hosts | default({}) }}"
        ncs_reporting_host_dir_root: "{{ _vmware_report_dir }}"
        ncs_reporting_skip_keys: ['Summary', 'Split', 'platform', 'vmware_fleet_state', 'history']

    - name: Render detailed per-vCenter HTML reports
      ansible.builtin.include_role:
        name: internal.core.reporting
        tasks_from: host_loop_render_template.yaml
      vars:
        ncs_reporting_hosts_map: "{{ vmw_all_hosts.hosts | default({}) }}"
        ncs_reporting_template_src: "vcenter_health_report.html.j2"
        ncs_reporting_template_dest: "{{ _vmware_report_dir }}/{{ item.key }}/health_report_{{ report_stamp }}.html"
        ncs_reporting_skip_keys: ['Summary', 'Split', 'platform', 'vmware_fleet_state', 'history']
        ncs_reporting_item_vars:
          vmware_node_view: >-
            {{
              (item.value | default({}))
              | internal.vmware.vmware_node_view(
                hostname=item.key,
                report_stamp=report_stamp,
                report_date=report_date,
                report_id=report_id
              )
            }}

    - name: Maintain 'Latest' Host Symlinks
      ansible.builtin.include_role:
        name: internal.core.reporting
        tasks_from: host_loop_latest_symlink.yaml
      vars:
        ncs_reporting_hosts_map: "{{ vmw_all_hosts.hosts | default({}) }}"
        ncs_reporting_host_dir_root: "{{ _vmware_report_dir }}"
        ncs_reporting_latest_src_name: "health_report_{{ report_stamp }}.html"
        ncs_reporting_latest_dest_name: "health_report.html"
        ncs_reporting_skip_keys: ['Summary', 'Split', 'platform', 'vmware_fleet_state', 'history']

    - name: Build VMware fleet dashboard view model
      ansible.builtin.set_fact:
        vmware_fleet_view: >-
          {{
            (vmw_all_hosts.hosts | default({}))
            | internal.vmware.vmware_fleet_view(
              report_stamp=report_stamp,
              report_date=report_date,
              report_id=report_id
            )
          }}

    - name: Render VMware Fleet HTML Dashboard
      ansible.builtin.template:
        src: "vmware_health_report.html.j2"
        dest: "{{ _vmware_report_dir }}/vmware_health_report_{{ report_stamp }}.html"
        mode: "0644"

    - name: Create 'Latest' Fleet Symlink
      ansible.builtin.file:
        src: "vmware_health_report_{{ report_stamp }}.html"
        dest: "{{ _vmware_report_dir }}/vmware_health_report.html"
        state: link
        force: true
