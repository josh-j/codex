---
# internal.vmware.discovery : assemble.yaml

- name: Assemble staged discovery sections
  ansible.builtin.set_fact:
    _disc:
      appliance: "{{ _disc_appliance | default({}) }}"
      alarms: "{{ _disc_alarms | default({}) }}"
      datacenters: "{{ _disc_datacenters | default({}) }}"
      clusters: "{{ _disc_clusters | default({}) }}"
      hosts: "{{ _disc_hosts | default({}) }}"
      datastores: "{{ _disc_datastores | default({}) }}"
      vms: "{{ _disc_vms | default({}) }}"
      snapshots: "{{ _disc_snapshots | default({}) }}"
  changed_when: false

- name: Assemble discovery context
  ansible.builtin.set_fact:
    vmware_ctx: >-
      {{
        vmware_ctx
        | internal.vmware.build_discovery_ctx(
          _disc | default({}),
          _vmware_controller_collected_at
        )
      }}
  changed_when: false

- name: VMware ctx | Ensure inventory.vms.metrics.powered_off_pct exists
  ansible.builtin.set_fact:
    vmware_ctx: >-
      {{
        vmware_ctx
        | combine(
            {
              'inventory': {
                'vms': {
                  'metrics': {
                    'powered_off_count': _po_count,
                    'powered_off_pct': _po_pct
                  }
                }
              }
            },
            recursive=true
          )
      }}
  vars:
    _vms: "{{ vmware_ctx.inventory.vms | default({}) }}"
    _metrics: "{{ _vms.metrics | default({}) }}"
    _total: >-
      {{
        (_vms.summary.total_vms
          | default((_vms.list | default([]) | length))
          | int)
      }}
    _po_count: "{{ (_metrics.powered_off_count | default(0) | int) }}"
    _po_pct: >-
      {{
        (0.0 if (_total | int) == 0 else (((_po_count | float) / (_total | float)) * 100.0))
        | float
      }}
  changed_when: false
