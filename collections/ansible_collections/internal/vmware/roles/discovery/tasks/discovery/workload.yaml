---
# internal.vmware.discovery : discovery/workload.yaml
#
# Collects VM inventory and analyzes backup status.
# Stores results in _temp_vms for assembly in discovery.yaml.

- name: Get VM info from vCenter API
  community.vmware.vmware_vm_info:
    hostname: "{{ _vcenter_hostname }}"
    username: "{{ vmware_username }}"
    password: "{{ vmware_password }}"
    validate_certs: "{{ vmware_validate_certs | default(false) | bool }}"
    vm_type: vm
    show_attribute: true
    show_tag: true
  register: _vms_raw
  delegate_to: localhost
  no_log: true
  retries: 3
  delay: 2
  until: _vms_raw is succeeded

- name: Build VM inventory and backup analysis
  ansible.builtin.set_fact:
    _temp_vms: "{{ vm_data }}"
  vars:
    _curr_ep: "{{ (run_ctx.timestamp | default(now().isoformat()) | to_datetime('%Y-%m-%dT%H:%M:%S%z')).strftime('%s') | int }}"
    _raw_vms: "{{ _vms_raw.virtual_machines | default([]) | selectattr('guest_name', 'defined') | list }}"

    _vm_list: >-
      {%- set results = [] -%}
      {%- for item in _raw_vms -%}
        {%- set attrs = item.attributes | default({}) -%}
        {%- set owner = (
              attrs.get('Owner Email', '') or
              attrs.get('OwnerEmail', '') or
              attrs.get('owner_email', '') or
              attrs.get('Owner_Email', '') or ''
            ) | trim -%}
        {%- set schedule = (
              item.tags | default([])
              | selectattr('category_name', 'equalto', 'Backup Schedule')
              | list | first | default({'name': 'None'})
            ).name -%}
        {%- set _ = results.append({
          'name':            item.guest_name,
          'uuid':            item.uuid,
          'power_state':     item.power_state | upper,
          'guest_os':        item.guest_fullname | default('Unknown'),
          'cluster':         item.cluster    | default('N/A'),
          'datacenter':      item.datacenter | default('N/A'),
          'tags':            item.tags       | default([]),
          'backup_info':     attrs.get('Last Dell PowerProtect Backup', ''),
          'backup_schedule': schedule,
          'owner_email':     owner,
          'vcenter':         inventory_hostname
        }) -%}
      {%- endfor -%}
      {{ results }}

    _backup_analysis: >-
      {%- set results = [] -%}
      {%- for vm in _vm_list -%}
        {%- set has_backup  = vm.backup_info != '' and 'EndTime=' in vm.backup_info -%}
        {%- set ts_str      = vm.backup_info.split('EndTime=')[1].split(',')[0] if has_backup else '' -%}
        {%- set epoch       = (ts_str | to_datetime('%Y-%m-%dT%H:%M:%SZ')).strftime('%s') | int if ts_str != '' else 0 -%}
        {%- set days_since  = ((_curr_ep | int - epoch) / 86400) | int if epoch > 0 else 9999 -%}
        {%- set freq        = vmware_backup_schedules.get(vm.backup_schedule | lower, 0) -%}
        {%- set overdue     = freq | int > 0 and days_since > (freq | int + vmware_backup_grace_period_days | default(1) | int) -%}
        {%- set _ = results.append({
          'vcenter':           vm.vcenter,
          'name':              vm.name,
          'datacenter':        vm.datacenter,
          'cluster':           vm.cluster,
          'power_state':       vm.power_state,
          'backup_schedule':   vm.backup_schedule,
          'has_backup':        has_backup,
          'last_backup_date':  ts_str,
          'days_since_backup': days_since,
          'expected_frequency': freq,
          'backup_overdue':    overdue,
          'owner_email':       vm.owner_email
        }) -%}
      {%- endfor -%}
      {{ results }}

    vm_data:
      list: "{{ _vm_list }}"
      backup_analysis: "{{ _backup_analysis }}"
      never_backed_up: >-
        {{
          _backup_analysis
          | selectattr('has_backup', 'equalto', false)
          | rejectattr('backup_schedule', 'equalto', 'None')
          | rejectattr('backup_schedule', 'equalto', 'No Backup')
          | list
        }}
      with_overdue_backup: "{{ _backup_analysis | selectattr('backup_overdue', 'equalto', true)        | list }}"
      without_backup_tags: "{{ _backup_analysis | selectattr('backup_schedule', 'equalto', 'None')     | list }}"
      without_owner_email: "{{ _vm_list         | selectattr('owner_email', 'equalto', '')             | list }}"
      metrics:
        total: "{{ _vm_list | length }}"
        powered_off: "{{ _vm_list | selectattr('power_state', 'equalto', 'POWEREDOFF') | list | length }}"
        powered_off_pct: >-
          {{
            ((_vm_list | selectattr('power_state', 'equalto', 'POWEREDOFF') | list | length)
            / ([_vm_list | length, 1] | max) * 100) | round(1)
          }}
  changed_when: false

- name: Log VM summary
  ansible.builtin.debug:
    msg: >-
      Discovered {{ _temp_vms.metrics.total }} VMs:
      {{ _temp_vms.never_backed_up | length }} never backed up,
      {{ _temp_vms.with_overdue_backup | length }} overdue.
