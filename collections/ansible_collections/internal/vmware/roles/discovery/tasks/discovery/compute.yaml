---
# internal.vmware.discovery : discovery/compute.yaml
#
# Discovers clusters and hosts for each datacenter.
# Stores results in _temp_clusters and _temp_hosts for assembly in discovery.yaml.

- name: Get cluster info for each datacenter
  vmware.vmware.cluster_info:
    hostname: "{{ _vcenter_hostname }}"
    username: "{{ vmware_username }}"
    password: "{{ vmware_password }}"
    validate_certs: "{{ vmware_validate_certs | default(false) | bool }}"
    datacenter: "{{ item }}"
  register: _clusters_per_dc
  delegate_to: localhost
  no_log: true
  failed_when: false
  retries: 3
  delay: 2
  loop: "{{ vmware_ctx.discovery.datacenters.names | default([]) }}"
  when: (vmware_ctx.discovery.datacenters.names | default([])) | length > 0

- name: Consolidate and enrich cluster data
  ansible.builtin.set_fact:
    _temp_clusters: "{{ {'by_name': _enriched_clusters, 'list': _enriched_clusters | dict2items | map(attribute='value') | list} }}"
  vars:
    _raw_results: "{{ _clusters_per_dc.results | default([]) }}"
    _consolidated: >-
      {%- set res = {} -%}
      {%- for r in _raw_results -%}
        {%- if r.clusters is defined -%}
          {%- set _ = res.update(r.clusters) -%}
        {%- endif -%}
      {%- endfor -%}
      {{ res }}
    _enriched_clusters: >-
      {%- set result = {} -%}
      {%- for name, data in _consolidated.items() -%}
        {%- set res     = data.resource_summary | default({}) -%}
        {%- set cpu_cap = [res.cpuCapacityMHz | default(0) | int, 1] | max -%}
        {%- set mem_cap = [res.memCapacityMB  | default(0) | int, 1] | max -%}
        {%- set enriched = data | combine({
          'utilization': {
            'cpu_used_mhz': res.cpuUsedMHz | default(0),
            'cpu_total_mhz': cpu_cap,
            'mem_used_mb':  res.memUsedMB  | default(0),
            'mem_total_mb': mem_cap,
            'cpu_pct': (((res.cpuUsedMHz | default(0) | int) / cpu_cap) * 100) | round(1),
            'mem_pct': (((res.memUsedMB  | default(0) | int) / mem_cap) * 100) | round(1)
          },
          'compliance': {
            'ha_enabled':   data.ha_enabled   | default(false),
            'drs_enabled':  data.drs_enabled  | default(false),
            'vsan_enabled': data.vsan_enabled | default(false)
          }
        }, recursive=true) -%}
        {%- set _ = result.update({name: enriched}) -%}
      {%- endfor -%}
      {{ result }}
  changed_when: false

- name: Build host inventory from cluster data
  ansible.builtin.set_fact:
    _temp_hosts: "{{ host_data }}"
  vars:
    _hosts_list: >-
      {%- set results = [] -%}
      {%- for cname, cdata in (_temp_clusters.by_name | default({})).items() -%}
        {%- for h in (cdata.hosts | default([])) -%}
          {%- set _ = results.append(h | combine({
            'cluster':    cname,
            'datacenter': cdata.datacenter | default('unknown')
          })) -%}
        {%- endfor -%}
      {%- endfor -%}
      {{ results }}
    _hosts_map: >-
      {%- set result = {} -%}
      {%- for h in _hosts_list -%}
        {%- set _ = result.update({h.name | default('unknown'): h}) -%}
      {%- endfor -%}
      {{ result }}
    host_data:
      list: "{{ _hosts_list }}"
      by_name: "{{ _hosts_map }}"
  changed_when: false
