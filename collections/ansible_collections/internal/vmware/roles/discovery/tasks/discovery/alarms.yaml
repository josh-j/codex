---
# internal.vmware.discovery : discovery/alarms.yaml
#
# Collects active vCenter alarms via PyVmomi script.
# Stores normalized alarm data in _temp_alarms for assembly in discovery.yaml.

- name: Execute alarm collection script
  ansible.builtin.script:
    cmd: >-
      {{ role_path }}/files/get_vcenter_alarms.py
      {{ _vcenter_hostname }}
      {{ vmware_username }}
  environment:
    VC_PASSWORD: "{{ vmware_password }}"
  register: _alarms_script_result
  delegate_to: localhost
  failed_when: false
  changed_when: false
  no_log: true

- name: Parse and store alarm results
  ansible.builtin.set_fact:
    _temp_alarms: "{{ alarm_data }}"
  vars:
    _succeeded: >-
      {{
        _alarms_script_result is mapping and
        (_alarms_script_result.get('rc', 1) | int) == 0 and
        (_alarms_script_result.get('stdout', '') | trim | length) > 0
      }}
    _parsed: >-
      {{
        (_alarms_script_result.get('stdout', '') | trim | from_json)
        if _succeeded else {'alarms': []}
      }}
    # Script already normalizes severity from overallStatus - no re-mapping needed.
    # We add site/vcenter fields and standardize field names here.
    _alarm_list: >-
      {%- set res = [] -%}
      {%- for item in (_parsed.alarms | default([])) -%}
        {%- set _ = res.append({
          'site':        inventory_hostname,
          'vcenter':     inventory_hostname,
          'alarm_name':  item.alarm_name  | default('unknown'),
          'entity':      item.entity      | default('unknown'),
          'description': item.description | default(''),
          'severity':    item.severity    | default('info') | lower,
          'status':      item.status      | default('unknown'),
          'time':        item.time        | default('')
        }) -%}
      {%- endfor -%}
      {{ res }}
    alarm_data:
      list: "{{ _alarm_list }}"
      by_severity:
        critical: "{{ _alarm_list | selectattr('severity', 'equalto', 'critical') | list }}"
        warning:  "{{ _alarm_list | selectattr('severity', 'equalto', 'warning')  | list }}"
      metrics:
        total:          "{{ _alarm_list | length }}"
        critical_count: "{{ _alarm_list | selectattr('severity', 'equalto', 'critical') | list | length }}"
        warning_count:  "{{ _alarm_list | selectattr('severity', 'equalto', 'warning')  | list | length }}"
  changed_when: false
