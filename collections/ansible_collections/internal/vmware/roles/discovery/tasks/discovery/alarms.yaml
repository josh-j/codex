---
- name: Execute vCenter alarm collection script
  ansible.builtin.command:
    argv:
      - python3
      - "{{ role_path }}/files/get_vcenter_alarms.py"
      - "{{ _vcenter_hostname }}"
      - "{{ vmware_username }}"
  environment:
    VC_PASSWORD: "{{ vmware_password }}"
  register: _alarms_script_raw
  delegate_to: localhost
  failed_when: false
  changed_when: false
  no_log: true

- name: Parse alarm script output
  ansible.builtin.set_fact:
    _alarms_parsed: >-
      {{ _alarms_script_raw | internal.vmware.parse_alarm_script_output }}
  changed_when: false

- name: Normalize alarm data + metrics
  ansible.builtin.set_fact:
    _disc_alarms: >-
      {{
        _alarms_parsed
        | internal.vmware.normalize_alarm_result(
          inventory_hostname,
          _vmware_controller_collected_at
        )
      }}
  changed_when: false
