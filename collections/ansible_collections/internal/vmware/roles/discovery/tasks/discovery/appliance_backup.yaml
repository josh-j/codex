---
# Discover VCSA Backup Configuration
- name: Get VCSA Backup Configuration
  vmware.vmware.vcsa_backup_schedule_info:
    hostname: "{{ vmware_ctx.discovery.connection.hostname }}"
    username: "{{ vmware_ctx.discovery.connection.username }}"
    password: "{{ vmware_ctx.discovery.connection.password }}"
    validate_certs: "{{ (vmware_ctx.config | default({})).get('validate_certs', false) | bool }}"
  register: _vcsa_backup_info
  delegate_to: localhost
  failed_when: false
  changed_when: false

- name: Sync vmware_ctx backup health
  ansible.builtin.set_fact:
    vmware_ctx: >-
      {{
        vmware_ctx | internal.core.recursive_combine({
          'health': {
            'appliance': {
              'backup': vcsa_backup_data
            }
          }
        })
      }}
  vars:
    schedules: "{{ _vcsa_backup_info.schedules | default([]) }}"
    enabled_schedule: "{{ schedules | selectattr('enabled', 'equalto', true) | list | first | default({}) }}"
    vcsa_backup_data:
      configured: "{{ schedules | length > 0 }}"
      enabled: "{{ enabled_schedule.enabled | default(false) }}"
      location: "{{ enabled_schedule.location | default('Not Configured') }}"
      recurrence: >-
        {{
          (enabled_schedule.schedule.days_of_week | default([])) | join(', ')
          if enabled_schedule.schedule is defined else 'None'
        }}
  changed_when: false
