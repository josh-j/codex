---
# internal.vmware.discovery : discovery/storage.yaml
#
# Discovers datastores for the primary datacenter.
# Stores normalized datastore list in _temp_datastores for assembly in discovery.yaml.

- name: Get datastore info from vCenter
  community.vmware.vmware_datastore_info:
    hostname:       "{{ _vcenter_hostname }}"
    username:       "{{ vmware_username }}"
    password:       "{{ vmware_password }}"
    validate_certs: "{{ vmware_validate_certs | default(false) | bool }}"
    datacenter:     "{{ vmware_ctx.discovery.datacenter.name | default(omit) }}"
  register: _datastores_raw
  delegate_to: localhost
  no_log: true
  retries: 3
  delay: 2
  until: _datastores_raw is succeeded
  changed_when: false

- name: Normalize datastore data
  ansible.builtin.set_fact:
    _temp_datastores: "{{ datastore_data }}"
  vars:
    _gb: 1073741824.0
    _ds_list: >-
      {%- set results = [] -%}
      {%- for ds in (_datastores_raw.datastores | default([])) -%}
        {%- set cap_b  = ds.capacity  | default(0) | int -%}
        {%- set free_b = ds.freeSpace | default(0) | int -%}
        {%- set cap_safe  = [cap_b, 1] | max -%}
        {%- set free_pct  = ((free_b | float / cap_safe) * 100.0) | round(1) -%}
        {%- set _ = results.append({
          'name':             ds.name            | default(''),
          'type':             ds.type            | default(''),
          'capacity_gb':      (cap_b  | float / _gb) | round(1),
          'free_gb':          (free_b | float / _gb) | round(1),
          'free_pct':         free_pct,
          'used_pct':         (100.0 - free_pct) | round(1),
          'accessible':       ds.accessible      | default(true),
          'maintenance_mode': ds.maintenanceMode | default('unknown')
        }) -%}
      {%- endfor -%}
      {{ results }}
    datastore_data:
      list: "{{ _ds_list }}"
      metrics:
        total: "{{ _ds_list | length }}"
  changed_when: false
