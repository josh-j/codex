---
# internal.vmware.discovery : discovery/storage.yaml

- name: Storage | Query Datastore Inventory
  community.vmware.vmware_datastore_info:
    hostname: "{{ _vcenter_hostname }}"
    username: "{{ vmware_username }}"
    password: "{{ vmware_password }}"
    validate_certs: "{{ vmware_validate_certs | default(false) | bool }}"
    datacenter: "{{ _disc_datacenters.summary.primary_dc | default(omit) }}"
  register: _datastores_raw
  delegate_to: localhost
  no_log: true
  failed_when: false
  changed_when: false
  retries: 3
  delay: 5
  until: _datastores_raw is succeeded
  ignore_errors: true

- name: Storage | Build standardized output
  ansible.builtin.set_fact:
    _disc_datastores: >-
      {{
        _datastores_raw
        | internal.vmware.normalize_storage_result(
          _vmware_controller_collected_at,
          10
        )
      }}
  changed_when: false
