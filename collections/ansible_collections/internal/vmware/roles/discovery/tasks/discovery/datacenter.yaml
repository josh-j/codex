---
# internal.vmware.discovery : discovery/datacenter.yaml
#
# Discovers vCenter datacenters via REST API.
# Writes directly into vmware_ctx.discovery so compute.yaml can read
# datacenter names when looping cluster discovery - _temp_* pattern
# cannot be used here since assembly happens after all sub-tasks complete.

- name: Get datacenter info from vCenter
  vmware.vmware_rest.vcenter_datacenter_info:
    vcenter_hostname:       "{{ _vcenter_hostname }}"
    vcenter_username:       "{{ vmware_username }}"
    vcenter_password:       "{{ vmware_password }}"
    vcenter_validate_certs: "{{ vmware_validate_certs | default(false) | bool }}"
  register: _datacenters_raw
  delegate_to: localhost
  no_log: true

- name: Store datacenter data in vmware_ctx
  ansible.builtin.set_fact:
    vmware_ctx: "{{ vmware_ctx | combine(_dc_data, recursive=true) }}"
  vars:
    _names: "{{ _datacenters_raw.value | default([]) | map(attribute='name') | list }}"
    _dc_data:
      discovery:
        datacenters:
          list:    "{{ _datacenters_raw.value | default([]) }}"
          names:   "{{ _names }}"
          metrics:
            total: "{{ _datacenters_raw.value | default([]) | length }}"
        datacenter:
          name: "{{ _names | first | default('') }}"
  changed_when: false
