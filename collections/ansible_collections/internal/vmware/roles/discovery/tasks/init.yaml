---
# internal.vmware.discovery : init.yaml
#
# Sets _vcenter_hostname for use by all discovery module calls.
# Builds vmware_ctx as pure audit state - no connection metadata or credentials.
# Stops host processing if vCenter is unreachable.

- name: Set vCenter target hostname
  ansible.builtin.set_fact:
    _vcenter_hostname: >-
      {{
        (vmware_hostname | default(ansible_host) | default(inventory_hostname))
        | regex_replace('^https?://', '')
        | regex_replace('/.*$', '')
      }}
  tags: [always]

- name: Build vmware_ctx
  ansible.builtin.set_fact:
    vmware_ctx:
      checks_failed: false
      check:
        started_at: "{{ run_ctx.timestamp | default('') }}"
        date: "{{ run_ctx.date | default('') }}"
        site: "{{ inventory_hostname }}"
  tags: [always]

- name: Check vCenter reachability
  ansible.builtin.uri:
    url: "https://{{ _vcenter_hostname }}/rest/com/vmware/cis/session"
    method: POST
    user: "{{ vmware_username }}"
    password: "{{ vmware_password }}"
    validate_certs: "{{ vmware_validate_certs | default(false) | bool }}"
    force_basic_auth: true
    status_code: [200, 503]
    timeout: 15
    return_content: false
    use_proxy: false
  register: _vc_api
  delegate_to: localhost
  failed_when: false
  changed_when: false
  no_log: true
  check_mode: false
  tags: [always]

- name: Handle unreachable vCenter
  when:
    - (_vc_api.status | default(0)) not in [200, 503]
    - not ansible_check_mode
  block:
    - name: Log connectivity failure
      ansible.builtin.debug:
        msg: >-
          CRITICAL: vCenter {{ _vcenter_hostname }} unreachable
          (HTTP {{ _vc_api.status | default('no response') }})

    - name: Build connectivity alert
      ansible.builtin.set_fact:
        vmware_alerts: "{{ vmware_alerts | default([]) + [connectivity_alert] }}"
      vars:
        connectivity_alert:
          severity: CRITICAL
          category: connectivity
          message: "vCenter {{ _vcenter_hostname }} is unreachable"
          detail:
            hostname: "{{ _vcenter_hostname }}"
            http_status: "{{ _vc_api.status | default('no response') }}"

    - name: Mark host checks failed
      ansible.builtin.set_fact:
        vmware_ctx: "{{ vmware_ctx | combine({'checks_failed': true}) }}"

    - name: Stop processing this host
      ansible.builtin.meta: end_host
  tags: [always]
