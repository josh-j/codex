---
# internal.vmware.stig : vm/discovery.yaml
#
# Collects VM STIG facts via pyVmomi. Stores results in vsphere_ctx.stig_facts.

- name: "VM STIG | Execute discovery script"
  tags: [stig, discovery]
  ansible.builtin.script: >-
    {{ role_path }}/files/get_vm_stig_facts.py
    '{{ _vcenter_hostname }}'
    '{{ vmware_username }}'
    '{{ vmware_password }}'
    '{{ stig_vm_filter | default("") }}'
  register: _vm_script_result
  delegate_to: localhost
  no_log: true
  changed_when: false
  failed_when: _vm_script_result.rc != 0

- name: "VM STIG | Parse discovery results"
  tags: [stig, discovery]
  ansible.builtin.set_fact:
    vsphere_ctx: >-
      {{
        vsphere_ctx | default({}) | combine({
          'stig_facts': _parsed.vms | default([])
        }, recursive=true)
      }}
  vars:
    _parsed: "{{ _vm_script_result.stdout | regex_search('(?s)\\{.*') | from_json }}"
  when:
    - _vm_script_result.rc == 0
    - _vm_script_result.stdout | trim | length > 0
    - (_vm_script_result.stdout | regex_search('(?s)\\{.*') | from_json).success | default(false)
