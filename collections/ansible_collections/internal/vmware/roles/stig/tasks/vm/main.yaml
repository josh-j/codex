---
# internal.vmware.stig : vm/main.yaml
#
# VM STIG audit + remediation pipeline.
# Phase 0: Preconditions
# Phase 1: Evaluate (check_mode) or Remediate (normal mode)
# Phase 2: Export results (always runs)
#
# Toggles:
#   vmware_stig_enable_hardening: false  - when true, tasks apply changes
#   vmware_stig_enable_audit: true       - runs compliance evaluation
#   vm_stig_target_vms: []               - list of VM names to process

# Phase 0: Preconditions
- name: "VM STIG | Phase 0 | Validate target VMs"
  ansible.builtin.assert:
    that: vm_stig_target_vms | length > 0
    fail_msg: "No VMs defined in vm_stig_target_vms"

# Phase 1: Evaluate/Remediate
- name: "VM STIG | Phase 1"
  block:
    - name: "VM STIG | Phase 1a | Run audit/hardening"
      ansible.builtin.import_tasks: check.yaml
      tags: [checks, stig, security]

  rescue:
    - name: "VM STIG | Phase 1r | Set failure flag"
      ansible.builtin.set_fact:
        _stig_audit_failed: true
      changed_when: false

    - name: "VM STIG | Phase 1r | Log failure"
      ansible.builtin.debug:
        msg: "VM STIG audit failed on {{ inventory_hostname }} â€” export will indicate failure."

  always:
    # Phase 2: Export
    - name: "VM STIG | Phase 2a | Read callback artifacts"
      tags: [always, stig, reporting]
      when: _stig_audit_ran | default(false)
      ansible.builtin.include_role:
        name: internal.core.stig
        tasks_from: read_callback_artifacts_multi.yaml
      vars:
        _stig_target_hosts: "{{ vm_stig_target_vms }}"
        _stig_artifacts_dir: "{{ ncs_config | internal.core.resolve_ncs_path('artifacts', audit_type='stig') | dirname }}"
        _stig_is_hardening: "{{ vmware_stig_enable_hardening | default(false) | bool }}"

    - name: "VM STIG | Phase 2b | Export reports via core finalize"
      tags: [always, stig, reporting]
      when: _stig_audit_ran | default(false)
      ansible.builtin.include_role:
        name: internal.core.stig
        tasks_from: finalize.yaml
      vars:
        ncs_export_path: "{{ ncs_config | internal.core.resolve_ncs_path('vmware', inventory_hostname, 'stig_vm') }}"
        stig_skeleton_path: "{{ role_path }}/files/cklb_skeleton_vsphere7_vms_V1R4.json"
        stig_target_type: vm
        stig_export_cklb: "{{ vmware_config_export_cklb | default(true) }}"
