---
# internal.vmware.stig : vm/checks.yaml

- name: "VM STIG | Initialize result lists"
  tags: [stig, audit]
  ansible.builtin.set_fact:
    audit_full_list: []
    audit_violations: []

- name: "VM STIG | Evaluate compliance per VM"
  tags: [stig, audit]
  ansible.builtin.set_fact:
    audit_full_list: >-
      {{
        audit_full_list + (
          lookup('template', role_path ~ '/../templates/vm_logic.j2') | from_json
          | map('combine', {'name': item.name, 'uuid': item.uuid | default('N/A')})
          | list
        )
      }}
  loop: "{{ vsphere_ctx.stig_facts | default([]) }}"
  loop_control:
    label: "{{ item.name }}"
  when:
    - item.name is not search('vCLS')
    - item.name not in (exclusion_list | default([]))
    - stig_vm_filter | default('') == '' or item.name == stig_vm_filter

- name: "VM STIG | Extract violations"
  tags: [stig, audit]
  ansible.builtin.set_fact:
    audit_violations: "{{ audit_full_list | selectattr('status', 'equalto', 'failed') | list }}"
