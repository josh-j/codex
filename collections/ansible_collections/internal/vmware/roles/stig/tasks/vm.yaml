---
# internal.vmware.stig : vm.yaml
# Entry point for VM Guest Audits.

- name: "VM Audit | Initialize Context"
  ansible.builtin.include_role:
    name: internal.vmware.common
    tasks_from: sync_ctx

- name: "VM Audit | Load STIG Policies"
  ansible.builtin.include_vars:
    file: defaults/main.yaml
  tags: ['stig', 'security']

# STEP 0: Path Locking
- name: "VM Audit | Set Absolute Path for Skeleton"
  ansible.builtin.set_fact:
    _vsphere_cklb_skeleton_absolute_path: "{{ role_path }}/files/cklb_skeleton_vsphere7_vms_V1R4.json"
  tags: ['always']

# STEP 1: DISCOVERY
- name: "VM Audit | Discover VM Configuration"
  ansible.builtin.include_tasks: vm/discovery.yaml
  tags: ['stig', 'security']

# STEP 2: LOGIC ENGINE
- name: "VM Audit | Calculate Compliance"
  ansible.builtin.include_tasks: vm/checks.yaml
  vars:
    stig_exclusions: "{{ exclusion_list | default([]) }}"
  tags: ['stig', 'security']

# STEP 3: CONSOLE SUMMARY
- name: "VM Audit | Console Summary"
  ansible.builtin.debug:
    msg:
      - "STIG Audit Complete"
      - "VMs Audited: {{ vsphere_stig_vm_full_audit | default([]) | length }}"
      - "Violations Found: {{ vsphere_stig_vm_violations | default([]) | length }}"
  when: not (vmware_config_quiet_mode | default(false))
  tags: ['stig', 'security']

# STEP 4: GENERALIZED REPORTING
- name: "VM Audit | Generate Reports and Artifacts"
  ansible.builtin.include_role:
    name: internal.core.stig
    tasks_from: stig_finalize
  vars:
    # Data Mapping
    violations: "{{ vsphere_stig_vm_violations }}"
    full_audit: "{{ vsphere_stig_vm_full_audit }}"

    # Export Configuration
    report_prefix: "vsphere_vm_stig"
    export_headers: ["VM Name", "STIG ID", "Control", "Status", "Details"]
    export_keys: ["vm_name", "id", "control", "status", "details"]

    # Use the Pre-calculated Fact we set in Step 0
    cklb_skeleton_path: "{{ _vsphere_cklb_skeleton_absolute_path }}"
  tags: ['stig', 'security', 'reporting']
