---
# internal.vmware.stig : esxi/services.yaml

- name: Get host services via external module
  tags: [discovery, services]
  community.vmware.vmware_host_service_info:
    esxi_hostname: "{{ inventory_hostname }}"
  register: _host_services_raw
  delegate_to: localhost

- name: Parse host services
  tags: [discovery, services]
  ansible.builtin.set_fact:
    _esxi_services_facts: >-
      {% set services = {} %}
      {% for s in _host_services_raw.host_service_info | default([]) %}
        {% set _ = services.update({
          s.key: {
            'running': s.running,
            'policy': s.policy,
            'label': s.label
          }
        }) %}
      {% endfor %}
      {{ services }}
  when: _host_services_raw.host_service_info is defined
