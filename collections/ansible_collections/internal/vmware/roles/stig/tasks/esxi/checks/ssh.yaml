---
# collections/ansible_collections/internal/vmware/roles/stig/tasks/esxi/checks/ssh.yaml
# Audit ESXi SSH Configuration
- name: Run SSH STIG Audit
  ansible.builtin.include_role:
    name: internal.core.stig
    tasks_from: audit_orchestrator
  vars:
    raw_discovery_data: "{{ esxi_ctx.stig_facts | default([]) }}"
    report_prefix: "esxi_ssh_stig"
    audit_logic_inline: |
      {%- set ssh = item.get('ssh', {}) -%}
      {%- set sshd_conf = ssh.get('sshd_config', '') -%}
      {{- [
        {
          "id": "ESXI-70-000009",
          "check": (sshd_conf is search('(?im)^Banner\s+/etc/issue')),
          "pass_msg": "SSHD Banner configured",
          "fail_msg": "Banner directive missing/commented in sshd_config"
        },
        {
          "id": "ESXI-70-000014",
          "check": (sshd_conf is search('(?im)^PermitRootLogin\s+no')),
          "pass_msg": "PermitRootLogin no",
          "fail_msg": "PermitRootLogin allowed"
        }
      ] | internal.core.stig_eval | to_json -}}
