---
# internal.vmware.stig : esxi/main.yaml
#
# ESXi STIG audit pipeline.
# Mirrors vm/main.yaml: block/rescue/always guarantees export.
#
# Toggles:
#   vsphere_stig_enable_audit: true  - runs compliance checks
#   exclusion_list:            []    - host names to skip

- name: ESXi STIG Audit
  block:
    - name: "ESXi STIG | Discover host configuration"
      tags: [stig, discovery]
      ansible.builtin.include_tasks: discovery.yaml

    - name: "ESXi STIG | Evaluate compliance"
      tags: [stig, audit]
      when: vsphere_stig_enable_audit | default(false) | bool
      block:
        - name: Audit | SSH
          tags: [audit, ssh]
          ansible.builtin.include_tasks: checks/ssh.yaml

        - name: Audit | Kernel
          tags: [audit, kernel]
          ansible.builtin.include_tasks: checks/kernel.yaml

        - name: Audit | Services
          tags: [audit, services]
          ansible.builtin.include_tasks: checks/services.yaml

        - name: Audit | VIBs
          tags: [audit, vibs]
          ansible.builtin.include_tasks: checks/vibs.yaml

        - name: Audit | Syslog
          tags: [audit, syslog]
          ansible.builtin.include_tasks: checks/syslog.yaml

        - name: Audit | Hardware
          tags: [audit, hardware]
          ansible.builtin.include_tasks: checks/hardware.yaml

    - name: "ESXi STIG | Flag audit as complete"
      tags: [stig, audit]
      when: vsphere_stig_enable_audit | default(false) | bool
      ansible.builtin.set_fact:
        _vsphere_stig_audit_ran: true

  rescue:
    - name: "ESXi STIG | Log failure"
      ansible.builtin.debug:
        msg: "ESXi STIG audit failed on {{ inventory_hostname }} â€” export will indicate failure."
      register: _vsphere_stig_task_failure

  always:
    - name: "ESXi STIG | Export results"
      tags: [always, stig, reporting]
      when: _vsphere_stig_audit_ran | default(false)
      ansible.builtin.include_tasks:
        file: "{{ role_path }}/../shared/finalize.yaml"
