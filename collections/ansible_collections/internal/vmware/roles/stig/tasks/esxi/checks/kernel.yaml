---
# collections/ansible_collections/internal/vmware/roles/stig/tasks/esxi/checks/kernel.yaml
# Audit ESXi Kernel Settings
- name: Run Kernel STIG Audit
  ansible.builtin.include_role:
    name: internal.core.stig
    tasks_from: audit_orchestrator
  vars:
    raw_discovery_data: "{{ esxi_ctx.stig_facts | default([]) }}"
    report_prefix: "esxi_kernel_stig"
    audit_logic_inline: |
      {%- set adv = item.get('config', {}).get('option_value', []) -%}
      {%- set bpdu = adv | internal.core.get_adv('Net.BlockGuestBPDU') | trim -%}
      {{- [
        {
          "id": "ESXI-70-000058",
          "check": (bpdu == '1'),
          "pass_msg": "Guest BPDU Blocked",
          "fail_msg": "Guest BPDU Allowed: " ~ bpdu
        }
      ] | internal.core.stig_eval | to_json -}}
