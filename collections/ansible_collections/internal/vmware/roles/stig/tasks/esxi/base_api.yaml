---
# internal.vmware.stig : esxi/base_api.yaml

- name: Get host facts via PowerCLI script
  tags: [discovery, api]
  ansible.builtin.script:
    cmd: >-
      {{ role_path }}/files/get_esxi_facts.ps1
      -vcenter     "{{ _vcenter_hostname }}"
      -vcuser      "{{ vmware_username }}"
      -vcpass      "{{ vmware_password }}"
      -target_host "{{ inventory_hostname }}"
  register: _host_api_raw
  delegate_to: localhost
  no_log: true
  changed_when: false
  failed_when: _host_api_raw.rc != 0

- name: Parse API facts
  tags: [discovery, api]
  ansible.builtin.set_fact:
    _esxi_api_facts: "{{ (_host_api_raw.stdout | regex_search('(?s)\{.*') | from_json).hosts[0] | default({}) }}"
  when: _host_api_raw.stdout | trim | length > 0
