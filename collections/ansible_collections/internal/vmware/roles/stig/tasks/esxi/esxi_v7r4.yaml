---
# internal.vmware.stig : esxi/esxi_v7r4.yaml
#
# Clean drop-in ESXi V7R4 STIG tasks for a single host (_current_esxi_host).
# Included via check.yaml which injects: check_mode, ignore_errors, tags.
#
# Conventions:
#   - Each task has ONLY: name, module, parameters, when guard
#   - NO register (except query→assert pairs), NO ignore_errors, NO tags
#   - Toggle guard: esxi_70_NNNNNN_Manage | default(esxi_70_NNNNNN) | default(true)
#   - PowerShell query tasks keep check_mode: false, no_log, register (functional)
#
# Credentials come from module_defaults in tasks/main.yaml.
# Task naming: stigrule_NNNNNN_<desc> for callback compatibility.

# =========================================================================
# PowerCLI connection preamble (used by all PowerShell query tasks)
# =========================================================================
- name: "ESXi STIG | Set PowerCLI preamble"
  ansible.builtin.set_fact:
    _pwsh_preamble: >-
      Set-PowerCLIConfiguration -InvalidCertificateAction Ignore -Confirm:$false | Out-Null;
      Connect-VIServer -Server '{{ _vcenter_hostname }}' -User '{{ vmware_username }}' -Password $env:VC_PASS -Force | Out-Null;
  check_mode: false
  changed_when: false

# =========================================================================
# GROUP A: vmware_host_config_manager tasks
# =========================================================================

# --- V-256376 / ESXI-70-000002: DCUI.Access list ---
- name: stigrule_256376_dcui_access
  community.vmware.vmware_host_config_manager:
    esxi_hostname: "{{ _current_esxi_host }}"
    options:
      DCUI.Access: "{{ esxi_stig_dcui_access | default('root') }}"
  when: esxi_70_000002_Manage | default(esxi_70_000002) | default(true) | bool

# --- V-256378 / ESXI-70-000004: Remote syslog ---
- name: stigrule_256378_syslog
  community.vmware.vmware_host_config_manager:
    esxi_hostname: "{{ _current_esxi_host }}"
    options:
      Syslog.global.logHost: "{{ esxi_stig_syslog_host }}"
  when:
    - esxi_70_000004_Manage | default(esxi_70_000004) | default(true) | bool
    - esxi_stig_syslog_host | default('') | length > 0

# --- V-256379 / ESXI-70-000005: Account lock failures ---
- name: stigrule_256379_account_lock_failures
  community.vmware.vmware_host_config_manager:
    esxi_hostname: "{{ _current_esxi_host }}"
    options:
      Security.AccountLockFailures: "{{ esxi_stig_account_lock_failures | default(3) }}"
  when: esxi_70_000005_Manage | default(esxi_70_000005) | default(true) | bool

# --- V-256380 / ESXI-70-000006: Account unlock timeout ---
- name: stigrule_256380_account_unlock_time
  community.vmware.vmware_host_config_manager:
    esxi_hostname: "{{ _current_esxi_host }}"
    options:
      Security.AccountUnlockTime: "{{ esxi_stig_account_unlock_time | default(900) }}"
  when: esxi_70_000006_Manage | default(esxi_70_000006) | default(true) | bool

# --- V-256381 / ESXI-70-000007: DoD welcome banner ---
- name: stigrule_256381_welcome_banner
  community.vmware.vmware_host_config_manager:
    esxi_hostname: "{{ _current_esxi_host }}"
    options:
      Annotations.WelcomeMessage: "{{ esxi_stig_welcome_message }}"
  when:
    - esxi_70_000007_Manage | default(esxi_70_000007) | default(true) | bool
    - esxi_stig_welcome_message | default('') | length > 0

# --- V-256396 / ESXI-70-000030: Log level ---
- name: stigrule_256396_log_level
  community.vmware.vmware_host_config_manager:
    esxi_hostname: "{{ _current_esxi_host }}"
    options:
      Config.HostAgent.log.level: "{{ esxi_stig_log_level | default('info') }}"
  when: esxi_70_000030_Manage | default(esxi_70_000030) | default(true) | bool

# --- V-256397 / ESXI-70-000031: Password complexity ---
- name: stigrule_256397_password_complexity
  community.vmware.vmware_host_config_manager:
    esxi_hostname: "{{ _current_esxi_host }}"
    options:
      Security.PasswordQualityControl: "{{ esxi_stig_password_quality | default('retry=3 min=disabled,disabled,disabled,disabled,15') }}"
  when: esxi_70_000031_Manage | default(esxi_70_000031) | default(true) | bool

# --- V-256398 / ESXI-70-000032: Password history ---
- name: stigrule_256398_password_history
  community.vmware.vmware_host_config_manager:
    esxi_hostname: "{{ _current_esxi_host }}"
    options:
      Security.PasswordHistory: "{{ esxi_stig_password_history | default(5) }}"
  when: esxi_70_000032_Manage | default(esxi_70_000032) | default(true) | bool

# --- V-256399 / ESXI-70-000034: MOB disabled ---
- name: stigrule_256399_mob_disabled
  community.vmware.vmware_host_config_manager:
    esxi_hostname: "{{ _current_esxi_host }}"
    options:
      Config.HostAgent.plugins.solo.enableMob: "{{ esxi_stig_mob_enabled | default('false') }}"
  when: esxi_70_000034_Manage | default(esxi_70_000034) | default(true) | bool

# --- V-256404 / ESXI-70-000039: AD admin group ---
- name: stigrule_256404_ad_admin_group
  community.vmware.vmware_host_config_manager:
    esxi_hostname: "{{ _current_esxi_host }}"
    options:
      Config.HostAgent.plugins.hostsvc.esxAdminsGroup: "{{ esxi_stig_ad_admin_group }}"
  when:
    - esxi_70_000039_Manage | default(esxi_70_000039) | default(true) | bool
    - esxi_stig_ad_admin_group | default('') | length > 0

# --- V-256405 / ESXI-70-000041: Shell interactive timeout ---
- name: stigrule_256405_shell_interactive_timeout
  community.vmware.vmware_host_config_manager:
    esxi_hostname: "{{ _current_esxi_host }}"
    options:
      UserVars.ESXiShellInteractiveTimeOut: "{{ esxi_stig_shell_interactive_timeout | default(120) }}"
  when: esxi_70_000041_Manage | default(esxi_70_000041) | default(true) | bool

# --- V-256406 / ESXI-70-000042: Shell timeout ---
- name: stigrule_256406_shell_timeout
  community.vmware.vmware_host_config_manager:
    esxi_hostname: "{{ _current_esxi_host }}"
    options:
      UserVars.ESXiShellTimeOut: "{{ esxi_stig_shell_timeout | default(600) }}"
  when: esxi_70_000042_Manage | default(esxi_70_000042) | default(true) | bool

# --- V-256407 / ESXI-70-000043: DCUI timeout ---
- name: stigrule_256407_dcui_timeout
  community.vmware.vmware_host_config_manager:
    esxi_hostname: "{{ _current_esxi_host }}"
    options:
      UserVars.DcuiTimeOut: "{{ esxi_stig_dcui_timeout | default(120) }}"
  when: esxi_70_000043_Manage | default(esxi_70_000043) | default(true) | bool

# --- V-256408 / ESXI-70-000045: Persistent logging ---
- name: stigrule_256408_persistent_logs
  community.vmware.vmware_host_config_manager:
    esxi_hostname: "{{ _current_esxi_host }}"
    options:
      Syslog.global.logDir: "{{ esxi_stig_log_dir }}"
  when:
    - esxi_70_000045_Manage | default(esxi_70_000045) | default(true) | bool
    - esxi_stig_log_dir | default('') | length > 0

# --- V-256416 / ESXI-70-000055: Memory salting ---
- name: stigrule_256416_memory_salting
  community.vmware.vmware_host_config_manager:
    esxi_hostname: "{{ _current_esxi_host }}"
    options:
      Mem.ShareForceSalting: "{{ esxi_stig_share_force_salting | default(2) }}"
  when: esxi_70_000055_Manage | default(esxi_70_000055) | default(true) | bool

# --- V-256419 / ESXI-70-000058: BPDU filter ---
- name: stigrule_256419_bpdu_filter
  community.vmware.vmware_host_config_manager:
    esxi_hostname: "{{ _current_esxi_host }}"
    options:
      Net.BlockGuestBPDU: "{{ esxi_stig_block_guest_bpdu | default(1) }}"
  when: esxi_70_000058_Manage | default(esxi_70_000058) | default(true) | bool

# --- V-256423 / ESXI-70-000062: dvFilter bind IP ---
- name: stigrule_256423_dvfilter
  community.vmware.vmware_host_config_manager:
    esxi_hostname: "{{ _current_esxi_host }}"
    options:
      Net.DVFilterBindIpAddress: "{{ esxi_stig_dvfilter_bind_ip | default('') }}"
  when: esxi_70_000062_Manage | default(esxi_70_000062) | default(true) | bool

# --- V-256429 / ESXI-70-000074: TLS 1.2 only ---
- name: stigrule_256429_tls
  community.vmware.vmware_host_config_manager:
    esxi_hostname: "{{ _current_esxi_host }}"
    options:
      UserVars.ESXiVPsDisabledProtocols: "{{ esxi_stig_disabled_protocols | default('tlsv1,tlsv1.1,sslv3') }}"
  when: esxi_70_000074_Manage | default(esxi_70_000074) | default(true) | bool

# --- V-256432 / ESXI-70-000079: Shell warning not suppressed ---
- name: stigrule_256432_shell_warning
  community.vmware.vmware_host_config_manager:
    esxi_hostname: "{{ _current_esxi_host }}"
    options:
      UserVars.SuppressShellWarning: "{{ esxi_stig_suppress_shell_warning | default(0) }}"
  when: esxi_70_000079_Manage | default(esxi_70_000079) | default(true) | bool

# --- V-256433 / ESXI-70-000081: HT warning not suppressed ---
- name: stigrule_256433_ht_warning
  community.vmware.vmware_host_config_manager:
    esxi_hostname: "{{ _current_esxi_host }}"
    options:
      UserVars.SuppressHyperthreadWarning: "{{ esxi_stig_suppress_ht_warning | default(0) }}"
  when: esxi_70_000081_Manage | default(esxi_70_000081) | default(true) | bool

# --- V-256438 / ESXI-70-000086: Syslog SSL cert check ---
- name: stigrule_256438_syslog_cert
  community.vmware.vmware_host_config_manager:
    esxi_hostname: "{{ _current_esxi_host }}"
    options:
      Syslog.global.logCheckSSLCerts: "{{ esxi_stig_syslog_check_ssl_certs | default('true') }}"
  when: esxi_70_000086_Manage | default(esxi_70_000086) | default(true) | bool

# --- V-256439 / ESXI-70-000087: Volatile key destruction ---
- name: stigrule_256439_eager_zero
  community.vmware.vmware_host_config_manager:
    esxi_hostname: "{{ _current_esxi_host }}"
    options:
      Mem.MemEagerZero: "{{ esxi_stig_memory_eager_zero | default(1) }}"
  when: esxi_70_000087_Manage | default(esxi_70_000087) | default(true) | bool

# --- V-256440 / ESXI-70-000088: API session timeout ---
- name: stigrule_256440_api_timeout
  community.vmware.vmware_host_config_manager:
    esxi_hostname: "{{ _current_esxi_host }}"
    options:
      Config.HostAgent.vmacore.soap.sessionTimeout: "{{ esxi_stig_api_session_timeout | default(30) }}"
  when: esxi_70_000088_Manage | default(esxi_70_000088) | default(true) | bool

# --- V-256441 / ESXI-70-000089: Host client timeout ---
- name: stigrule_256441_host_client_timeout
  community.vmware.vmware_host_config_manager:
    esxi_hostname: "{{ _current_esxi_host }}"
    options:
      UserVars.HostClientSessionTimeout: "{{ esxi_stig_host_client_timeout | default(600) }}"
  when: esxi_70_000089_Manage | default(esxi_70_000089) | default(true) | bool

# --- V-256443 / ESXI-70-000091: Password max days ---
- name: stigrule_256443_password_max_days
  community.vmware.vmware_host_config_manager:
    esxi_hostname: "{{ _current_esxi_host }}"
    options:
      Security.PasswordMaxDays: "{{ esxi_stig_password_max_days | default(90) }}"
  when: esxi_70_000091_Manage | default(esxi_70_000091) | default(true) | bool

# =========================================================================
# GROUP B: vmware_host_service_manager tasks
# =========================================================================

# --- V-256400 / ESXI-70-000035: SSH service stopped ---
- name: stigrule_256400_ssh_stopped
  community.vmware.vmware_host_service_manager:
    esxi_hostname: "{{ _current_esxi_host }}"
    service_name: TSM-SSH
    service_policy: "off"
    state: stop
  when: esxi_70_000035_Manage | default(esxi_70_000035) | default(true) | bool

# --- V-256401 / ESXI-70-000036: ESXi Shell stopped ---
- name: stigrule_256401_shell_stopped
  community.vmware.vmware_host_service_manager:
    esxi_hostname: "{{ _current_esxi_host }}"
    service_name: TSM
    service_policy: "off"
    state: stop
  when: esxi_70_000036_Manage | default(esxi_70_000036) | default(true) | bool

# --- V-256435 / ESXI-70-000083: SLPD stopped ---
- name: stigrule_256435_slpd_stopped
  community.vmware.vmware_host_service_manager:
    esxi_hostname: "{{ _current_esxi_host }}"
    service_name: slpd
    service_policy: "off"
    state: stop
  when: esxi_70_000083_Manage | default(esxi_70_000083) | default(true) | bool

# --- V-256448 / ESXI-70-000097: CIM watchdog stopped ---
- name: stigrule_256448_cim_stopped
  community.vmware.vmware_host_service_manager:
    esxi_hostname: "{{ _current_esxi_host }}"
    service_name: sfcbd-watchdog
    service_policy: "off"
    state: stop
  when: esxi_70_000097_Manage | default(esxi_70_000097) | default(true) | bool

# =========================================================================
# GROUP C: Other module tasks
# =========================================================================

# --- V-256409 / ESXI-70-000046: NTP servers ---
- name: stigrule_256409_ntp_servers
  community.vmware.vmware_host_ntp:
    esxi_hostname: "{{ _current_esxi_host }}"
    state: present
    ntp_servers: "{{ esxi_stig_ntp_servers }}"
  when:
    - esxi_70_000046_Manage | default(esxi_70_000046) | default(true) | bool
    - esxi_stig_ntp_servers | default([]) | length > 0

# --- V-256409 / ESXI-70-000046: NTP service running ---
- name: stigrule_256409_ntp_service
  community.vmware.vmware_host_service_manager:
    esxi_hostname: "{{ _current_esxi_host }}"
    service_name: ntpd
    service_policy: "on"
    state: start
  when:
    - esxi_70_000046_Manage | default(esxi_70_000046) | default(true) | bool
    - esxi_stig_ntp_servers | default([]) | length > 0

# --- V-256410 / ESXI-70-000047: VIB acceptance level ---
- name: stigrule_256410_acceptance_level
  community.vmware.vmware_host_acceptance:
    esxi_hostname: "{{ _current_esxi_host }}"
    acceptance_level: "{{ esxi_stig_acceptance_level | default('PartnerSupported') }}"
    state: present
  when: esxi_70_000047_Manage | default(esxi_70_000047) | default(true) | bool

# =========================================================================
# GROUP D: PowerShell / Assert audit tasks
# Query tasks keep check_mode: false, no_log, register (functional needs).
# =========================================================================

# --- V-256375 / ESXI-70-000001: Lockdown mode ---
- name: stigrule_256375_lockdown_query
  ansible.builtin.shell:
    cmd: >-
      set -o pipefail &&
      pwsh -NoProfile -Command "
      {{ _pwsh_preamble }}
      (Get-VMHost -Name '{{ _current_esxi_host }}' | Get-View).Config.LockdownMode
      "
  environment:
    VC_PASS: "{{ vmware_password }}"
  register: _q_256375
  changed_when: false
  check_mode: false
  no_log: true
  when: esxi_70_000001_Manage | default(esxi_70_000001) | default(true) | bool

- name: stigrule_256375_lockdown_assert
  ansible.builtin.assert:
    that:
      - _q_256375.stdout | default('') | lower != 'lockdowndisabled'
      - _q_256375.stdout | default('') | length > 0
    fail_msg: "Lockdown mode is disabled"
    success_msg: "Lockdown mode is enabled ({{ _q_256375.stdout | default('unknown') }})"
  when:
    - esxi_70_000001_Manage | default(esxi_70_000001) | default(true) | bool
    - _q_256375 is not skipped
    - not (_q_256375.failed | default(false))

- name: stigrule_256375_lockdown_remediate
  ansible.builtin.shell:
    cmd: >-
      set -o pipefail &&
      pwsh -NoProfile -Command "
      {{ _pwsh_preamble }}
      \$vmhost = Get-VMHost -Name '{{ _current_esxi_host }}' | Get-View;
      \$lockdown = Get-View \$vmhost.ConfigManager.HostAccessManager;
      \$lockdown.ChangeLockdownMode('{{ esxi_stig_lockdown_level | default('lockdownNormal') }}')
      "
  environment:
    VC_PASS: "{{ vmware_password }}"
  register: _r_256375
  changed_when: false
  when:
    - vmware_stig_enable_hardening | default(false) | bool
    - esxi_70_000001_Manage | default(esxi_70_000001) | default(true) | bool
    - _q_256375.failed | default(false)
  check_mode: false
  no_log: true

# --- V-256377 / ESXI-70-000003: Lockdown exceptions ---
- name: stigrule_256377_lockdown_exceptions_query
  ansible.builtin.shell:
    cmd: >-
      set -o pipefail &&
      pwsh -NoProfile -Command "
      {{ _pwsh_preamble }}
      \$vmhost = Get-VMHost -Name '{{ _current_esxi_host }}' | Get-View;
      \$lockdown = Get-View \$vmhost.ConfigManager.HostAccessManager;
      (\$lockdown.QueryLockdownExceptions()) -join ','
      "
  environment:
    VC_PASS: "{{ vmware_password }}"
  register: _q_256377
  changed_when: false
  check_mode: false
  no_log: true
  when: esxi_70_000003_Manage | default(esxi_70_000003) | default(true) | bool

- name: stigrule_256377_lockdown_exceptions_assert
  ansible.builtin.assert:
    that:
      - (_q_256377.stdout | default('') | trim | length) == 0
    fail_msg: "Lockdown exceptions found: {{ _q_256377.stdout | default('') }}"
    success_msg: "No lockdown exceptions"
  when:
    - esxi_70_000003_Manage | default(esxi_70_000003) | default(true) | bool
    - _q_256377 is not skipped
    - not (_q_256377.failed | default(false))

# --- V-256415 / ESXI-70-000054: iSCSI CHAP ---
- name: stigrule_256415_iscsi_chap_query
  ansible.builtin.shell:
    cmd: >-
      set -o pipefail &&
      pwsh -NoProfile -Command "
      {{ _pwsh_preamble }}
      \$hbas = Get-VMHost -Name '{{ _current_esxi_host }}' | Get-VMHostHba | Where-Object { \$_.Type -eq 'iscsi' };
      if (\$hbas) { \$hbas.AuthenticationProperties.ChapType -join ',' } else { 'NO_ISCSI' }
      "
  environment:
    VC_PASS: "{{ vmware_password }}"
  register: _q_256415
  changed_when: false
  check_mode: false
  no_log: true
  when: esxi_70_000054_Manage | default(esxi_70_000054) | default(true) | bool

- name: stigrule_256415_iscsi_chap_assert
  ansible.builtin.assert:
    that:
      - (_q_256415.stdout | default('NO_ISCSI') | trim) in ['NO_ISCSI', 'Required']
    fail_msg: "iSCSI CHAP not set to Required: {{ _q_256415.stdout | default('') }}"
    success_msg: "iSCSI CHAP is Required or no iSCSI adapters"
  when:
    - esxi_70_000054_Manage | default(esxi_70_000054) | default(true) | bool
    - _q_256415 is not skipped
    - not (_q_256415.failed | default(false))

# --- V-256417 / ESXI-70-000056: Firewall rules ---
- name: stigrule_256417_firewall_query
  ansible.builtin.shell:
    cmd: >-
      set -o pipefail &&
      pwsh -NoProfile -Command "
      {{ _pwsh_preamble }}
      \$open = Get-VMHost -Name '{{ _current_esxi_host }}' | Get-View | Get-VMHostFirewallException |
        Where-Object { (\$_.Enabled -eq \$true) -and (\$_.ExtensionData.AllowedHosts.AllIp -eq 'enabled') -and
          (\$_.Name -notin @('vSphere Web Client','VMware vCenter Agent')) };
      if (\$open) { \$open.Name -join ',' } else { 'COMPLIANT' }
      "
  environment:
    VC_PASS: "{{ vmware_password }}"
  register: _q_256417
  changed_when: false
  check_mode: false
  no_log: true
  when: esxi_70_000056_Manage | default(esxi_70_000056) | default(true) | bool

- name: stigrule_256417_firewall_assert
  ansible.builtin.assert:
    that:
      - (_q_256417.stdout | default('') | trim) == 'COMPLIANT'
    fail_msg: "Firewall rules allow all IPs: {{ _q_256417.stdout | default('') }}"
    success_msg: "Firewall rules restrict access"
  when:
    - esxi_70_000056_Manage | default(esxi_70_000056) | default(true) | bool
    - _q_256417 is not skipped
    - not (_q_256417.failed | default(false))

# =========================================================================
# GROUP E: vSwitch / Port Group security (formerly stubs)
# =========================================================================

# Gather vSwitch info for 000059/000060/000061 loop targets
- name: "ESXi STIG | Gather vSwitch info"
  community.vmware.vmware_vswitch_info:
    esxi_hostname: "{{ _current_esxi_host }}"
  register: _vswitch_info
  check_mode: false
  changed_when: false
  when: >-
    (esxi_70_000059_Manage | default(true) | bool) or
    (esxi_70_000060_Manage | default(true) | bool) or
    (esxi_70_000061_Manage | default(true) | bool)

# --- V-256402 / ESXI-70-000037: Active Directory (audit-only) ---
- name: stigrule_256402_ad_query
  ansible.builtin.shell:
    cmd: >-
      pwsh -NoProfile -Command "
      {{ _pwsh_preamble }}
      \$vmhost = Get-VMHost -Name '{{ _current_esxi_host }}';
      \$authInfo = \$vmhost | Get-VMHostAuthentication;
      if (\$authInfo.Domain) { \$authInfo.Domain } else { 'NOT_JOINED' }
      "
  environment:
    VC_PASS: "{{ vmware_password }}"
  register: _q_256402
  changed_when: false
  check_mode: false
  no_log: true
  when: esxi_70_000037_Manage | default(esxi_70_000037) | default(true) | bool

- name: stigrule_256402_ad_assert
  ansible.builtin.assert:
    that:
      - _q_256402.stdout | default('NOT_JOINED') | trim != 'NOT_JOINED'
    fail_msg: "ESXi host {{ _current_esxi_host }} is not joined to an AD domain"
    success_msg: "ESXi host joined to domain: {{ _q_256402.stdout | default('') | trim }}"
  when:
    - esxi_70_000037_Manage | default(esxi_70_000037) | default(true) | bool
    - _q_256402 is not skipped
    - not (_q_256402.failed | default(false))

# --- V-256414 / ESXI-70-000053: SNMP disabled ---
- name: stigrule_256414_snmp
  community.vmware.vmware_host_snmp:
    hostname: "{{ _current_esxi_host }}"
    state: disabled
  when: esxi_70_000053_Manage | default(esxi_70_000053) | default(true) | bool

# --- V-256420 / ESXI-70-000059: Forged transmits reject (vSwitch-level) ---
- name: stigrule_256420_forged_transmits_vswitch
  community.vmware.vmware_vswitch:
    esxi_hostname: "{{ _current_esxi_host }}"
    switch: "{{ item }}"
    security:
      forged_transmits: false
  loop: >-
    {{ (_vswitch_info.hosts_vswitch_info | default({}))[_current_esxi_host] | default({}) | list }}
  loop_control:
    label: "{{ item }}"
  when:
    - esxi_70_000059_Manage | default(esxi_70_000059) | default(true) | bool
    - _vswitch_info is not skipped

# --- V-256421 / ESXI-70-000060: MAC changes reject (vSwitch-level) ---
- name: stigrule_256421_mac_changes_vswitch
  community.vmware.vmware_vswitch:
    esxi_hostname: "{{ _current_esxi_host }}"
    switch: "{{ item }}"
    security:
      mac_changes: false
  loop: >-
    {{ (_vswitch_info.hosts_vswitch_info | default({}))[_current_esxi_host] | default({}) | list }}
  loop_control:
    label: "{{ item }}"
  when:
    - esxi_70_000060_Manage | default(esxi_70_000060) | default(true) | bool
    - _vswitch_info is not skipped

# --- V-256422 / ESXI-70-000061: Promiscuous mode reject (vSwitch-level) ---
- name: stigrule_256422_promiscuous_mode_vswitch
  community.vmware.vmware_vswitch:
    esxi_hostname: "{{ _current_esxi_host }}"
    switch: "{{ item }}"
    security:
      promiscuous_mode: false
  loop: >-
    {{ (_vswitch_info.hosts_vswitch_info | default({}))[_current_esxi_host] | default({}) | list }}
  loop_control:
    label: "{{ item }}"
  when:
    - esxi_70_000061_Manage | default(esxi_70_000061) | default(true) | bool
    - _vswitch_info is not skipped

# =========================================================================
# GROUP F: Additional advanced settings (vmware_host_config_manager)
# =========================================================================

# --- V-256436 / ESXI-70-000084: Audit record storage validation ---
- name: stigrule_256436_audit_record_validation
  community.vmware.vmware_host_config_manager:
    esxi_hostname: "{{ _current_esxi_host }}"
    options:
      Config.HostAgent.plugins.vimsvc.authValidateRecords: "true"
  when: esxi_70_000084_Manage | default(true) | bool

# --- V-256437 / ESXI-70-000085: Syslog x509 strict ---
- name: stigrule_256437_syslog_x509_strict
  community.vmware.vmware_host_config_manager:
    esxi_hostname: "{{ _current_esxi_host }}"
    options:
      Syslog.global.certificate.checkSSLCerts: "true"
  when: esxi_70_000085_Manage | default(true) | bool

# --- V-256447 / ESXI-70-000095: Execute installed only ---
- name: stigrule_256447_exec_installed_only
  community.vmware.vmware_host_config_manager:
    esxi_hostname: "{{ _current_esxi_host }}"
    options:
      VMkernel.Boot.execInstalledOnly: "true"
  when: esxi_70_000095_Manage | default(true) | bool

# =========================================================================
# GROUP G: Network / port group audit rules (pwsh query+assert)
# =========================================================================

# --- V-256411 / ESXI-70-000048: Port group forged transmits reject ---
- name: stigrule_256411_pg_forged_transmits_query
  ansible.builtin.shell:
    cmd: >-
      pwsh -NoProfile -Command "
      {{ _pwsh_preamble }}
      \$bad = Get-VMHost -Name '{{ _current_esxi_host }}' | Get-VirtualPortGroup | Get-SecurityPolicy |
        Where-Object { \$_.ForgedTransmits -eq \$true };
      if (\$bad) { (\$bad | ForEach-Object { \$_.VirtualPortGroup }) -join ',' } else { 'COMPLIANT' }
      "
  environment:
    VC_PASS: "{{ vmware_password }}"
  register: _q_256411
  changed_when: false
  check_mode: false
  no_log: true
  when: esxi_70_000048_Manage | default(true) | bool

- name: stigrule_256411_pg_forged_transmits_assert
  ansible.builtin.assert:
    that:
      - (_q_256411.stdout | default('') | trim) == 'COMPLIANT'
    fail_msg: "Port groups allow forged transmits: {{ _q_256411.stdout | default('') }}"
    success_msg: "All port groups reject forged transmits"
  when:
    - esxi_70_000048_Manage | default(true) | bool
    - _q_256411 is not skipped
    - not (_q_256411.failed | default(false))

# --- V-256412 / ESXI-70-000049: Port group MAC changes reject ---
- name: stigrule_256412_pg_mac_changes_query
  ansible.builtin.shell:
    cmd: >-
      pwsh -NoProfile -Command "
      {{ _pwsh_preamble }}
      \$bad = Get-VMHost -Name '{{ _current_esxi_host }}' | Get-VirtualPortGroup | Get-SecurityPolicy |
        Where-Object { \$_.MacChanges -eq \$true };
      if (\$bad) { (\$bad | ForEach-Object { \$_.VirtualPortGroup }) -join ',' } else { 'COMPLIANT' }
      "
  environment:
    VC_PASS: "{{ vmware_password }}"
  register: _q_256412
  changed_when: false
  check_mode: false
  no_log: true
  when: esxi_70_000049_Manage | default(true) | bool

- name: stigrule_256412_pg_mac_changes_assert
  ansible.builtin.assert:
    that:
      - (_q_256412.stdout | default('') | trim) == 'COMPLIANT'
    fail_msg: "Port groups allow MAC changes: {{ _q_256412.stdout | default('') }}"
    success_msg: "All port groups reject MAC changes"
  when:
    - esxi_70_000049_Manage | default(true) | bool
    - _q_256412 is not skipped
    - not (_q_256412.failed | default(false))

# --- V-256413 / ESXI-70-000050: Port group promiscuous mode reject ---
- name: stigrule_256413_pg_promiscuous_query
  ansible.builtin.shell:
    cmd: >-
      pwsh -NoProfile -Command "
      {{ _pwsh_preamble }}
      \$bad = Get-VMHost -Name '{{ _current_esxi_host }}' | Get-VirtualPortGroup | Get-SecurityPolicy |
        Where-Object { \$_.AllowPromiscuous -eq \$true };
      if (\$bad) { (\$bad | ForEach-Object { \$_.VirtualPortGroup }) -join ',' } else { 'COMPLIANT' }
      "
  environment:
    VC_PASS: "{{ vmware_password }}"
  register: _q_256413
  changed_when: false
  check_mode: false
  no_log: true
  when: esxi_70_000050_Manage | default(true) | bool

- name: stigrule_256413_pg_promiscuous_assert
  ansible.builtin.assert:
    that:
      - (_q_256413.stdout | default('') | trim) == 'COMPLIANT'
    fail_msg: "Port groups allow promiscuous mode: {{ _q_256413.stdout | default('') }}"
    success_msg: "All port groups reject promiscuous mode"
  when:
    - esxi_70_000050_Manage | default(true) | bool
    - _q_256413 is not skipped
    - not (_q_256413.failed | default(false))

# --- V-256418 / ESXI-70-000057: Firewall default action deny ---
- name: stigrule_256418_firewall_default_query
  ansible.builtin.shell:
    cmd: >-
      pwsh -NoProfile -Command "
      {{ _pwsh_preamble }}
      \$fw = Get-VMHost -Name '{{ _current_esxi_host }}' | Get-VMHostFirewallDefaultPolicy;
      if (\$fw.IncomingEnabled -or \$fw.OutgoingEnabled) { 'NON_COMPLIANT' } else { 'COMPLIANT' }
      "
  environment:
    VC_PASS: "{{ vmware_password }}"
  register: _q_256418
  changed_when: false
  check_mode: false
  no_log: true
  when: esxi_70_000057_Manage | default(false) | bool

- name: stigrule_256418_firewall_default_assert
  ansible.builtin.assert:
    that:
      - (_q_256418.stdout | default('') | trim) == 'COMPLIANT'
    fail_msg: "Firewall default policy allows traffic — should be deny"
    success_msg: "Firewall default policy is deny"
  when:
    - esxi_70_000057_Manage | default(false) | bool
    - _q_256418 is not skipped
    - not (_q_256418.failed | default(false))

# --- V-256424 / ESXI-70-000063: No VLAN 4095 (trunk) on port groups ---
- name: stigrule_256424_vlan_4095_query
  ansible.builtin.shell:
    cmd: >-
      pwsh -NoProfile -Command "
      {{ _pwsh_preamble }}
      \$bad = Get-VMHost -Name '{{ _current_esxi_host }}' | Get-VirtualPortGroup |
        Where-Object { \$_.VLanId -eq 4095 };
      if (\$bad) { \$bad.Name -join ',' } else { 'COMPLIANT' }
      "
  environment:
    VC_PASS: "{{ vmware_password }}"
  register: _q_256424
  changed_when: false
  check_mode: false
  no_log: true
  when: esxi_70_000063_Manage | default(true) | bool

- name: stigrule_256424_vlan_4095_assert
  ansible.builtin.assert:
    that:
      - (_q_256424.stdout | default('') | trim) == 'COMPLIANT'
    fail_msg: "Port groups using VLAN 4095 (trunk): {{ _q_256424.stdout | default('') }}"
    success_msg: "No port groups use VLAN 4095"
  when:
    - esxi_70_000063_Manage | default(true) | bool
    - _q_256424 is not skipped
    - not (_q_256424.failed | default(false))

# --- V-256425 / ESXI-70-000064: No reserved VLANs (1001-1024, 3968-4047, 4094) ---
- name: stigrule_256425_reserved_vlans_query
  ansible.builtin.shell:
    cmd: >-
      pwsh -NoProfile -Command "
      {{ _pwsh_preamble }}
      \$bad = Get-VMHost -Name '{{ _current_esxi_host }}' | Get-VirtualPortGroup |
        Where-Object { (\$_.VLanId -ge 1001 -and \$_.VLanId -le 1024) -or
                       (\$_.VLanId -ge 3968 -and \$_.VLanId -le 4047) -or
                       (\$_.VLanId -eq 4094) };
      if (\$bad) { (\$bad | ForEach-Object { \"\$(\$_.Name)=\$(\$_.VLanId)\" }) -join ',' } else { 'COMPLIANT' }
      "
  environment:
    VC_PASS: "{{ vmware_password }}"
  register: _q_256425
  changed_when: false
  check_mode: false
  no_log: true
  when: esxi_70_000064_Manage | default(true) | bool

- name: stigrule_256425_reserved_vlans_assert
  ansible.builtin.assert:
    that:
      - (_q_256425.stdout | default('') | trim) == 'COMPLIANT'
    fail_msg: "Port groups using reserved VLANs: {{ _q_256425.stdout | default('') }}"
    success_msg: "No port groups use reserved VLANs"
  when:
    - esxi_70_000064_Manage | default(true) | bool
    - _q_256425 is not skipped
    - not (_q_256425.failed | default(false))

# --- V-256426 / ESXI-70-000065: Native VLAN not used for tagged traffic ---
- name: stigrule_256426_native_vlan_query
  ansible.builtin.shell:
    cmd: >-
      pwsh -NoProfile -Command "
      {{ _pwsh_preamble }}
      \$bad = Get-VMHost -Name '{{ _current_esxi_host }}' | Get-VirtualPortGroup |
        Where-Object { \$_.VLanId -eq 1 };
      if (\$bad) { \$bad.Name -join ',' } else { 'COMPLIANT' }
      "
  environment:
    VC_PASS: "{{ vmware_password }}"
  register: _q_256426
  changed_when: false
  check_mode: false
  no_log: true
  when: esxi_70_000065_Manage | default(true) | bool

- name: stigrule_256426_native_vlan_assert
  ansible.builtin.assert:
    that:
      - (_q_256426.stdout | default('') | trim) == 'COMPLIANT'
    fail_msg: "Port groups using native VLAN 1: {{ _q_256426.stdout | default('') }}"
    success_msg: "No port groups use native VLAN 1"
  when:
    - esxi_70_000065_Manage | default(true) | bool
    - _q_256426 is not skipped
    - not (_q_256426.failed | default(false))

# =========================================================================
# GROUP H: Firmware / audit-only rules (pwsh query+assert)
# =========================================================================

# --- V-256427 / ESXI-70-000072: Patches current (HIGH) ---
- name: stigrule_256427_patches_current_query
  ansible.builtin.shell:
    cmd: >-
      pwsh -NoProfile -Command "
      {{ _pwsh_preamble }}
      (Get-VMHost -Name '{{ _current_esxi_host }}').Build
      "
  environment:
    VC_PASS: "{{ vmware_password }}"
  register: _q_256427
  changed_when: false
  check_mode: false
  no_log: true
  when: esxi_70_000072_Manage | default(true) | bool

- name: stigrule_256427_patches_current_assert
  ansible.builtin.assert:
    that:
      - esxi_stig_expected_build | default('') | length == 0 or
        (_q_256427.stdout | default('') | trim) == (esxi_stig_expected_build | string)
    fail_msg: >-
      ESXi build {{ _q_256427.stdout | default('unknown') | trim }} does not match
      expected {{ esxi_stig_expected_build | default('(not set)') }}
    success_msg: "ESXi build: {{ _q_256427.stdout | default('unknown') | trim }}"
  when:
    - esxi_70_000072_Manage | default(true) | bool
    - _q_256427 is not skipped
    - not (_q_256427.failed | default(false))

# --- V-256430 / ESXI-70-000076: Secure Boot ---
- name: stigrule_256430_secure_boot_query
  ansible.builtin.shell:
    cmd: >-
      pwsh -NoProfile -Command "
      {{ _pwsh_preamble }}
      \$vmhost = Get-VMHost -Name '{{ _current_esxi_host }}' | Get-View;
      if (\$vmhost.Runtime.BootTime) {
        try { \$vmhost.QueryTpmAttestationReport().TpmPcrValues | Out-Null; 'SUPPORTED' }
        catch { 'UNKNOWN' }
      } else { 'UNKNOWN' }
      "
  environment:
    VC_PASS: "{{ vmware_password }}"
  register: _q_256430
  changed_when: false
  check_mode: false
  no_log: true
  when: esxi_70_000076_Manage | default(true) | bool

- name: stigrule_256430_secure_boot_assert
  ansible.builtin.assert:
    that:
      - (_q_256430.stdout | default('UNKNOWN') | trim) != 'DISABLED'
    fail_msg: "Secure Boot is disabled on {{ _current_esxi_host }}"
    success_msg: "Secure Boot status: {{ _q_256430.stdout | default('UNKNOWN') | trim }}"
  when:
    - esxi_70_000076_Manage | default(true) | bool
    - _q_256430 is not skipped
    - not (_q_256430.failed | default(false))

# --- V-256431 / ESXI-70-000078: LDAP/AD uses TLS ---
- name: stigrule_256431_ldap_tls_query
  ansible.builtin.shell:
    cmd: >-
      pwsh -NoProfile -Command "
      {{ _pwsh_preamble }}
      \$vmhost = Get-VMHost -Name '{{ _current_esxi_host }}';
      \$authInfo = \$vmhost | Get-VMHostAuthentication;
      if (\$authInfo.Domain) {
        \$adv = Get-AdvancedSetting -Entity \$vmhost -Name 'Config.HostAgent.plugins.hostsvc.esxAdminsGroupAutoAdd';
        if (\$adv) { 'AD_JOINED' } else { 'AD_NO_TLS_INFO' }
      } else { 'NOT_JOINED' }
      "
  environment:
    VC_PASS: "{{ vmware_password }}"
  register: _q_256431
  changed_when: false
  check_mode: false
  no_log: true
  when: esxi_70_000078_Manage | default(true) | bool

- name: stigrule_256431_ldap_tls_assert
  ansible.builtin.assert:
    that:
      - (_q_256431.stdout | default('NOT_JOINED') | trim) in ['AD_JOINED', 'NOT_JOINED']
    fail_msg: "LDAP/AD TLS configuration needs review: {{ _q_256431.stdout | default('') }}"
    success_msg: "LDAP/AD TLS check: {{ _q_256431.stdout | default('') | trim }}"
  when:
    - esxi_70_000078_Manage | default(true) | bool
    - _q_256431 is not skipped
    - not (_q_256431.failed | default(false))

# --- V-256442 / ESXI-70-000090: rhttpproxy FIPS ---
- name: stigrule_256442_rhttpproxy_fips_query
  ansible.builtin.shell:
    cmd: >-
      pwsh -NoProfile -Command "
      {{ _pwsh_preamble }}
      \$vmhost = Get-VMHost -Name '{{ _current_esxi_host }}';
      \$esxcli = Get-EsxCli -VMHost \$vmhost -V2;
      \$result = \$esxcli.system.security.fips140.rhttpproxy.get.Invoke();
      if (\$result.Enabled -eq 'true') { 'COMPLIANT' } else { 'NON_COMPLIANT' }
      "
  environment:
    VC_PASS: "{{ vmware_password }}"
  register: _q_256442
  changed_when: false
  check_mode: false
  no_log: true
  when: esxi_70_000090_Manage | default(true) | bool

- name: stigrule_256442_rhttpproxy_fips_assert
  ansible.builtin.assert:
    that:
      - (_q_256442.stdout | default('') | trim) == 'COMPLIANT'
    fail_msg: "rhttpproxy FIPS 140-2 is not enabled"
    success_msg: "rhttpproxy FIPS 140-2 is enabled"
  when:
    - esxi_70_000090_Manage | default(true) | bool
    - _q_256442 is not skipped
    - not (_q_256442.failed | default(false))

# --- V-256444 / ESXI-70-000092: VM config override cleared ---
- name: stigrule_256444_vm_override_query
  ansible.builtin.shell:
    cmd: >-
      pwsh -NoProfile -Command "
      {{ _pwsh_preamble }}
      \$vmhost = Get-VMHost -Name '{{ _current_esxi_host }}' | Get-View;
      \$overrides = \$vmhost.Config.Vm.SwapPlacement;
      if (\$overrides) { 'HAS_OVERRIDES' } else { 'COMPLIANT' }
      "
  environment:
    VC_PASS: "{{ vmware_password }}"
  register: _q_256444
  changed_when: false
  check_mode: false
  no_log: true
  when: esxi_70_000092_Manage | default(true) | bool

- name: stigrule_256444_vm_override_assert
  ansible.builtin.assert:
    that:
      - (_q_256444.stdout | default('COMPLIANT') | trim) == 'COMPLIANT'
    fail_msg: "VM config overrides found on {{ _current_esxi_host }}"
    success_msg: "No VM config overrides"
  when:
    - esxi_70_000092_Manage | default(true) | bool
    - _q_256444 is not skipped
    - not (_q_256444.failed | default(false))

# --- V-256445 / ESXI-70-000093: VM logger override cleared ---
- name: stigrule_256445_vm_logger_query
  ansible.builtin.shell:
    cmd: >-
      pwsh -NoProfile -Command "
      {{ _pwsh_preamble }}
      \$vmhost = Get-VMHost -Name '{{ _current_esxi_host }}';
      \$adv = Get-AdvancedSetting -Entity \$vmhost -Name 'Config.HostAgent.log.level';
      if (\$adv -and \$adv.Value -eq 'info') { 'COMPLIANT' } else { 'NON_COMPLIANT: ' + \$adv.Value }
      "
  environment:
    VC_PASS: "{{ vmware_password }}"
  register: _q_256445
  changed_when: false
  check_mode: false
  no_log: true
  when: esxi_70_000093_Manage | default(true) | bool

- name: stigrule_256445_vm_logger_assert
  ansible.builtin.assert:
    that:
      - (_q_256445.stdout | default('') | trim) is match('^COMPLIANT')
    fail_msg: "VM logger override: {{ _q_256445.stdout | default('') }}"
    success_msg: "VM logger level is compliant"
  when:
    - esxi_70_000093_Manage | default(true) | bool
    - _q_256445 is not skipped
    - not (_q_256445.failed | default(false))

# --- V-256446 / ESXI-70-000094: TPM encryption ---
- name: stigrule_256446_tpm_encryption_query
  ansible.builtin.shell:
    cmd: >-
      pwsh -NoProfile -Command "
      {{ _pwsh_preamble }}
      \$vmhost = Get-VMHost -Name '{{ _current_esxi_host }}';
      \$esxcli = Get-EsxCli -VMHost \$vmhost -V2;
      \$enc = \$esxcli.system.settings.encryption.get.Invoke();
      if (\$enc.Mode -eq 'TPM') { 'COMPLIANT' } else { 'NON_COMPLIANT: ' + \$enc.Mode }
      "
  environment:
    VC_PASS: "{{ vmware_password }}"
  register: _q_256446
  changed_when: false
  check_mode: false
  no_log: true
  when: esxi_70_000094_Manage | default(true) | bool

- name: stigrule_256446_tpm_encryption_assert
  ansible.builtin.assert:
    that:
      - (_q_256446.stdout | default('') | trim) is match('^COMPLIANT')
    fail_msg: "TPM encryption: {{ _q_256446.stdout | default('') }}"
    success_msg: "TPM encryption is enabled"
  when:
    - esxi_70_000094_Manage | default(true) | bool
    - _q_256446 is not skipped
    - not (_q_256446.failed | default(false))

# =========================================================================
# GROUP I: Remaining audit-only rules
# =========================================================================

# --- V-256403 / ESXI-70-000038: Host profiles / auth proxy (manual) ---
- name: stigrule_256403_host_profiles
  ansible.builtin.debug:
    msg: >-
      ESXI-70-000038: Host profile and auth proxy configuration requires manual
      verification for {{ _current_esxi_host }}. Ensure the host is assigned a
      host profile with proper authentication proxy configuration.
  when: esxi_70_000038_Manage | default(true) | bool

# --- V-256428 / ESXI-70-000070: CIM account access (manual) ---
- name: stigrule_256428_cim_access
  ansible.builtin.debug:
    msg: >-
      ESXI-70-000070: CIM account access requires manual verification for
      {{ _current_esxi_host }}. Verify only authorized accounts have CIM access.
  when: esxi_70_000070_Manage | default(true) | bool

# =========================================================================
# GROUP J: SSH configuration rules (gated behind esxi_stig_enable_ssh_checks)
# =========================================================================

- name: "ESXi STIG | SSH checks block"
  when: esxi_stig_enable_ssh_checks | default(false) | bool
  block:
    # --- V-256382 / ESXI-70-000008: Deploy /etc/issue banner ---
    - name: stigrule_256382_ssh_banner_file
      ansible.builtin.shell:
        cmd: >-
          pwsh -NoProfile -Command "
          {{ _pwsh_preamble }}
          \$vmhost = Get-VMHost -Name '{{ _current_esxi_host }}';
          \$esxcli = Get-EsxCli -VMHost \$vmhost -V2;
          \$content = \$esxcli.software.vib.list.Invoke() | Select-Object -First 1;
          if (\$content) { 'CHECK_SSH' } else { 'NO_ACCESS' }
          "
      environment:
        VC_PASS: "{{ vmware_password }}"
      register: _q_256382
      changed_when: false
      check_mode: false
      no_log: true
      when: esxi_70_000008_Manage | default(true) | bool

    - name: stigrule_256382_ssh_banner_assert
      ansible.builtin.assert:
        that:
          - _q_256382.stdout | default('') | trim == 'CHECK_SSH'
        fail_msg: "Cannot verify /etc/issue banner — SSH access required"
        success_msg: "/etc/issue banner check requires SSH inspection"
      when:
        - esxi_70_000008_Manage | default(true) | bool
        - _q_256382 is not skipped
        - not (_q_256382.failed | default(false))

    # --- V-256383 / ESXI-70-000009: Banner directive in sshd_config ---
    - name: stigrule_256383_ssh_banner_directive_query
      ansible.builtin.shell:
        cmd: >-
          pwsh -NoProfile -Command "
          {{ _pwsh_preamble }}
          \$vmhost = Get-VMHost -Name '{{ _current_esxi_host }}';
          \$esxcli = Get-EsxCli -VMHost \$vmhost -V2;
          \$args = \$esxcli.system.ssh.server.config.list.CreateArgs();
          \$config = \$esxcli.system.ssh.server.config.list.Invoke(\$args);
          \$banner = \$config | Where-Object { \$_.Key -eq 'banner' };
          if (\$banner) { \$banner.Value } else { 'NOT_SET' }
          "
      environment:
        VC_PASS: "{{ vmware_password }}"
      register: _q_256383
      changed_when: false
      check_mode: false
      no_log: true
      when: esxi_70_000009_Manage | default(true) | bool

    - name: stigrule_256383_ssh_banner_directive_assert
      ansible.builtin.assert:
        that:
          - (_q_256383.stdout | default('NOT_SET') | trim) == '/etc/issue'
        fail_msg: "SSH Banner not set to /etc/issue: {{ _q_256383.stdout | default('NOT_SET') }}"
        success_msg: "SSH Banner set to /etc/issue"
      when:
        - esxi_70_000009_Manage | default(true) | bool
        - _q_256383 is not skipped
        - not (_q_256383.failed | default(false))

    # --- V-256384 / ESXI-70-000010: SSH FIPS 140-2 ---
    - name: stigrule_256384_ssh_fips_query
      ansible.builtin.shell:
        cmd: >-
          pwsh -NoProfile -Command "
          {{ _pwsh_preamble }}
          \$vmhost = Get-VMHost -Name '{{ _current_esxi_host }}';
          \$esxcli = Get-EsxCli -VMHost \$vmhost -V2;
          \$result = \$esxcli.system.security.fips140.ssh.get.Invoke();
          if (\$result.Enabled -eq 'true') { 'COMPLIANT' } else { 'NON_COMPLIANT' }
          "
      environment:
        VC_PASS: "{{ vmware_password }}"
      register: _q_256384
      changed_when: false
      check_mode: false
      no_log: true
      when: esxi_70_000010_Manage | default(true) | bool

    - name: stigrule_256384_ssh_fips_assert
      ansible.builtin.assert:
        that:
          - (_q_256384.stdout | default('') | trim) == 'COMPLIANT'
        fail_msg: "SSH FIPS 140-2 mode is not enabled"
        success_msg: "SSH FIPS 140-2 mode is enabled"
      when:
        - esxi_70_000010_Manage | default(true) | bool
        - _q_256384 is not skipped
        - not (_q_256384.failed | default(false))

    # --- V-256386 / ESXI-70-000012: IgnoreRhosts yes ---
    - name: stigrule_256386_ssh_ignore_rhosts_query
      ansible.builtin.shell:
        cmd: >-
          pwsh -NoProfile -Command "
          {{ _pwsh_preamble }}
          \$vmhost = Get-VMHost -Name '{{ _current_esxi_host }}';
          \$esxcli = Get-EsxCli -VMHost \$vmhost -V2;
          \$args = \$esxcli.system.ssh.server.config.list.CreateArgs();
          \$config = \$esxcli.system.ssh.server.config.list.Invoke(\$args);
          \$val = \$config | Where-Object { \$_.Key -eq 'ignorerhosts' };
          if (\$val) { \$val.Value } else { 'NOT_SET' }
          "
      environment:
        VC_PASS: "{{ vmware_password }}"
      register: _q_256386
      changed_when: false
      check_mode: false
      no_log: true
      when: esxi_70_000012_Manage | default(true) | bool

    - name: stigrule_256386_ssh_ignore_rhosts_assert
      ansible.builtin.assert:
        that:
          - (_q_256386.stdout | default('NOT_SET') | trim | lower) == 'yes'
        fail_msg: "SSH IgnoreRhosts is not set to yes: {{ _q_256386.stdout | default('NOT_SET') }}"
        success_msg: "SSH IgnoreRhosts is yes"
      when:
        - esxi_70_000012_Manage | default(true) | bool
        - _q_256386 is not skipped
        - not (_q_256386.failed | default(false))

    # --- V-256387 / ESXI-70-000013: HostbasedAuthentication no ---
    - name: stigrule_256387_ssh_hostbased_auth_query
      ansible.builtin.shell:
        cmd: >-
          pwsh -NoProfile -Command "
          {{ _pwsh_preamble }}
          \$vmhost = Get-VMHost -Name '{{ _current_esxi_host }}';
          \$esxcli = Get-EsxCli -VMHost \$vmhost -V2;
          \$args = \$esxcli.system.ssh.server.config.list.CreateArgs();
          \$config = \$esxcli.system.ssh.server.config.list.Invoke(\$args);
          \$val = \$config | Where-Object { \$_.Key -eq 'hostbasedauthentication' };
          if (\$val) { \$val.Value } else { 'NOT_SET' }
          "
      environment:
        VC_PASS: "{{ vmware_password }}"
      register: _q_256387
      changed_when: false
      check_mode: false
      no_log: true
      when: esxi_70_000013_Manage | default(true) | bool

    - name: stigrule_256387_ssh_hostbased_auth_assert
      ansible.builtin.assert:
        that:
          - (_q_256387.stdout | default('NOT_SET') | trim | lower) == 'no'
        fail_msg: "SSH HostbasedAuthentication is not disabled: {{ _q_256387.stdout | default('NOT_SET') }}"
        success_msg: "SSH HostbasedAuthentication is disabled"
      when:
        - esxi_70_000013_Manage | default(true) | bool
        - _q_256387 is not skipped
        - not (_q_256387.failed | default(false))

    # --- V-256388 / ESXI-70-000014: PermitRootLogin no ---
    - name: stigrule_256388_ssh_permit_root_query
      ansible.builtin.shell:
        cmd: >-
          pwsh -NoProfile -Command "
          {{ _pwsh_preamble }}
          \$vmhost = Get-VMHost -Name '{{ _current_esxi_host }}';
          \$esxcli = Get-EsxCli -VMHost \$vmhost -V2;
          \$args = \$esxcli.system.ssh.server.config.list.CreateArgs();
          \$config = \$esxcli.system.ssh.server.config.list.Invoke(\$args);
          \$val = \$config | Where-Object { \$_.Key -eq 'permitrootlogin' };
          if (\$val) { \$val.Value } else { 'NOT_SET' }
          "
      environment:
        VC_PASS: "{{ vmware_password }}"
      register: _q_256388
      changed_when: false
      check_mode: false
      no_log: true
      when: esxi_70_000014_Manage | default(false) | bool

    - name: stigrule_256388_ssh_permit_root_assert
      ansible.builtin.assert:
        that:
          - (_q_256388.stdout | default('NOT_SET') | trim | lower) == 'no'
        fail_msg: "SSH PermitRootLogin is not disabled: {{ _q_256388.stdout | default('NOT_SET') }}"
        success_msg: "SSH PermitRootLogin is disabled"
      when:
        - esxi_70_000014_Manage | default(false) | bool
        - _q_256388 is not skipped
        - not (_q_256388.failed | default(false))

    # --- V-256389 / ESXI-70-000015: PermitEmptyPasswords no ---
    - name: stigrule_256389_ssh_permit_empty_pw_query
      ansible.builtin.shell:
        cmd: >-
          pwsh -NoProfile -Command "
          {{ _pwsh_preamble }}
          \$vmhost = Get-VMHost -Name '{{ _current_esxi_host }}';
          \$esxcli = Get-EsxCli -VMHost \$vmhost -V2;
          \$args = \$esxcli.system.ssh.server.config.list.CreateArgs();
          \$config = \$esxcli.system.ssh.server.config.list.Invoke(\$args);
          \$val = \$config | Where-Object { \$_.Key -eq 'permitemptypasswords' };
          if (\$val) { \$val.Value } else { 'NOT_SET' }
          "
      environment:
        VC_PASS: "{{ vmware_password }}"
      register: _q_256389
      changed_when: false
      check_mode: false
      no_log: true
      when: esxi_70_000015_Manage | default(true) | bool

    - name: stigrule_256389_ssh_permit_empty_pw_assert
      ansible.builtin.assert:
        that:
          - (_q_256389.stdout | default('NOT_SET') | trim | lower) == 'no'
        fail_msg: "SSH PermitEmptyPasswords is not disabled: {{ _q_256389.stdout | default('NOT_SET') }}"
        success_msg: "SSH PermitEmptyPasswords is disabled"
      when:
        - esxi_70_000015_Manage | default(true) | bool
        - _q_256389 is not skipped
        - not (_q_256389.failed | default(false))

    # --- V-256390 / ESXI-70-000016: PermitUserEnvironment no ---
    - name: stigrule_256390_ssh_permit_user_env_query
      ansible.builtin.shell:
        cmd: >-
          pwsh -NoProfile -Command "
          {{ _pwsh_preamble }}
          \$vmhost = Get-VMHost -Name '{{ _current_esxi_host }}';
          \$esxcli = Get-EsxCli -VMHost \$vmhost -V2;
          \$args = \$esxcli.system.ssh.server.config.list.CreateArgs();
          \$config = \$esxcli.system.ssh.server.config.list.Invoke(\$args);
          \$val = \$config | Where-Object { \$_.Key -eq 'permituserenvironment' };
          if (\$val) { \$val.Value } else { 'NOT_SET' }
          "
      environment:
        VC_PASS: "{{ vmware_password }}"
      register: _q_256390
      changed_when: false
      check_mode: false
      no_log: true
      when: esxi_70_000016_Manage | default(true) | bool

    - name: stigrule_256390_ssh_permit_user_env_assert
      ansible.builtin.assert:
        that:
          - (_q_256390.stdout | default('NOT_SET') | trim | lower) == 'no'
        fail_msg: "SSH PermitUserEnvironment is not disabled: {{ _q_256390.stdout | default('NOT_SET') }}"
        success_msg: "SSH PermitUserEnvironment is disabled"
      when:
        - esxi_70_000016_Manage | default(true) | bool
        - _q_256390 is not skipped
        - not (_q_256390.failed | default(false))

    # --- V-256394 / ESXI-70-000020: StrictModes yes ---
    - name: stigrule_256394_ssh_strict_modes_query
      ansible.builtin.shell:
        cmd: >-
          pwsh -NoProfile -Command "
          {{ _pwsh_preamble }}
          \$vmhost = Get-VMHost -Name '{{ _current_esxi_host }}';
          \$esxcli = Get-EsxCli -VMHost \$vmhost -V2;
          \$args = \$esxcli.system.ssh.server.config.list.CreateArgs();
          \$config = \$esxcli.system.ssh.server.config.list.Invoke(\$args);
          \$val = \$config | Where-Object { \$_.Key -eq 'strictmodes' };
          if (\$val) { \$val.Value } else { 'NOT_SET' }
          "
      environment:
        VC_PASS: "{{ vmware_password }}"
      register: _q_256394
      changed_when: false
      check_mode: false
      no_log: true
      when: esxi_70_000020_Manage | default(true) | bool

    - name: stigrule_256394_ssh_strict_modes_assert
      ansible.builtin.assert:
        that:
          - (_q_256394.stdout | default('NOT_SET') | trim | lower) == 'yes'
        fail_msg: "SSH StrictModes is not enabled: {{ _q_256394.stdout | default('NOT_SET') }}"
        success_msg: "SSH StrictModes is enabled"
      when:
        - esxi_70_000020_Manage | default(true) | bool
        - _q_256394 is not skipped
        - not (_q_256394.failed | default(false))

    # --- V-256395 / ESXI-70-000021: Compression no ---
    - name: stigrule_256395_ssh_compression_query
      ansible.builtin.shell:
        cmd: >-
          pwsh -NoProfile -Command "
          {{ _pwsh_preamble }}
          \$vmhost = Get-VMHost -Name '{{ _current_esxi_host }}';
          \$esxcli = Get-EsxCli -VMHost \$vmhost -V2;
          \$args = \$esxcli.system.ssh.server.config.list.CreateArgs();
          \$config = \$esxcli.system.ssh.server.config.list.Invoke(\$args);
          \$val = \$config | Where-Object { \$_.Key -eq 'compression' };
          if (\$val) { \$val.Value } else { 'NOT_SET' }
          "
      environment:
        VC_PASS: "{{ vmware_password }}"
      register: _q_256395
      changed_when: false
      check_mode: false
      no_log: true
      when: esxi_70_000021_Manage | default(true) | bool

    - name: stigrule_256395_ssh_compression_assert
      ansible.builtin.assert:
        that:
          - (_q_256395.stdout | default('NOT_SET') | trim | lower) == 'no'
        fail_msg: "SSH Compression is not disabled: {{ _q_256395.stdout | default('NOT_SET') }}"
        success_msg: "SSH Compression is disabled"
      when:
        - esxi_70_000021_Manage | default(true) | bool
        - _q_256395 is not skipped
        - not (_q_256395.failed | default(false))

    # --- V-256396 / ESXI-70-000022: GatewayPorts no ---
    - name: stigrule_256396_ssh_gateway_ports_query
      ansible.builtin.shell:
        cmd: >-
          pwsh -NoProfile -Command "
          {{ _pwsh_preamble }}
          \$vmhost = Get-VMHost -Name '{{ _current_esxi_host }}';
          \$esxcli = Get-EsxCli -VMHost \$vmhost -V2;
          \$args = \$esxcli.system.ssh.server.config.list.CreateArgs();
          \$config = \$esxcli.system.ssh.server.config.list.Invoke(\$args);
          \$val = \$config | Where-Object { \$_.Key -eq 'gatewayports' };
          if (\$val) { \$val.Value } else { 'NOT_SET' }
          "
      environment:
        VC_PASS: "{{ vmware_password }}"
      register: _q_256396_ssh
      changed_when: false
      check_mode: false
      no_log: true
      when: esxi_70_000022_Manage | default(true) | bool

    - name: stigrule_256396_ssh_gateway_ports_assert
      ansible.builtin.assert:
        that:
          - (_q_256396_ssh.stdout | default('NOT_SET') | trim | lower) == 'no'
        fail_msg: "SSH GatewayPorts is not disabled: {{ _q_256396_ssh.stdout | default('NOT_SET') }}"
        success_msg: "SSH GatewayPorts is disabled"
      when:
        - esxi_70_000022_Manage | default(true) | bool
        - _q_256396_ssh is not skipped
        - not (_q_256396_ssh.failed | default(false))

    # --- V-256397 / ESXI-70-000023: X11Forwarding no ---
    - name: stigrule_256397_ssh_x11_forwarding_query
      ansible.builtin.shell:
        cmd: >-
          pwsh -NoProfile -Command "
          {{ _pwsh_preamble }}
          \$vmhost = Get-VMHost -Name '{{ _current_esxi_host }}';
          \$esxcli = Get-EsxCli -VMHost \$vmhost -V2;
          \$args = \$esxcli.system.ssh.server.config.list.CreateArgs();
          \$config = \$esxcli.system.ssh.server.config.list.Invoke(\$args);
          \$val = \$config | Where-Object { \$_.Key -eq 'x11forwarding' };
          if (\$val) { \$val.Value } else { 'NOT_SET' }
          "
      environment:
        VC_PASS: "{{ vmware_password }}"
      register: _q_256397_ssh
      changed_when: false
      check_mode: false
      no_log: true
      when: esxi_70_000023_Manage | default(true) | bool

    - name: stigrule_256397_ssh_x11_forwarding_assert
      ansible.builtin.assert:
        that:
          - (_q_256397_ssh.stdout | default('NOT_SET') | trim | lower) == 'no'
        fail_msg: "SSH X11Forwarding is not disabled: {{ _q_256397_ssh.stdout | default('NOT_SET') }}"
        success_msg: "SSH X11Forwarding is disabled"
      when:
        - esxi_70_000023_Manage | default(true) | bool
        - _q_256397_ssh is not skipped
        - not (_q_256397_ssh.failed | default(false))

    # --- V-256399 / ESXI-70-000025: PermitTunnel no ---
    - name: stigrule_256399_ssh_permit_tunnel_query
      ansible.builtin.shell:
        cmd: >-
          pwsh -NoProfile -Command "
          {{ _pwsh_preamble }}
          \$vmhost = Get-VMHost -Name '{{ _current_esxi_host }}';
          \$esxcli = Get-EsxCli -VMHost \$vmhost -V2;
          \$args = \$esxcli.system.ssh.server.config.list.CreateArgs();
          \$config = \$esxcli.system.ssh.server.config.list.Invoke(\$args);
          \$val = \$config | Where-Object { \$_.Key -eq 'permittunnel' };
          if (\$val) { \$val.Value } else { 'NOT_SET' }
          "
      environment:
        VC_PASS: "{{ vmware_password }}"
      register: _q_256399_ssh
      changed_when: false
      check_mode: false
      no_log: true
      when: esxi_70_000025_Manage | default(true) | bool

    - name: stigrule_256399_ssh_permit_tunnel_assert
      ansible.builtin.assert:
        that:
          - (_q_256399_ssh.stdout | default('NOT_SET') | trim | lower) == 'no'
        fail_msg: "SSH PermitTunnel is not disabled: {{ _q_256399_ssh.stdout | default('NOT_SET') }}"
        success_msg: "SSH PermitTunnel is disabled"
      when:
        - esxi_70_000025_Manage | default(true) | bool
        - _q_256399_ssh is not skipped
        - not (_q_256399_ssh.failed | default(false))

    # --- V-256400 / ESXI-70-000026: ClientAliveCountMax 3 ---
    - name: stigrule_256400_ssh_client_alive_count_query
      ansible.builtin.shell:
        cmd: >-
          pwsh -NoProfile -Command "
          {{ _pwsh_preamble }}
          \$vmhost = Get-VMHost -Name '{{ _current_esxi_host }}';
          \$esxcli = Get-EsxCli -VMHost \$vmhost -V2;
          \$args = \$esxcli.system.ssh.server.config.list.CreateArgs();
          \$config = \$esxcli.system.ssh.server.config.list.Invoke(\$args);
          \$val = \$config | Where-Object { \$_.Key -eq 'clientalivecountmax' };
          if (\$val) { \$val.Value } else { 'NOT_SET' }
          "
      environment:
        VC_PASS: "{{ vmware_password }}"
      register: _q_256400_ssh
      changed_when: false
      check_mode: false
      no_log: true
      when: esxi_70_000026_Manage | default(true) | bool

    - name: stigrule_256400_ssh_client_alive_count_assert
      ansible.builtin.assert:
        that:
          - (_q_256400_ssh.stdout | default('NOT_SET') | trim) == (esxi_stig_ssh_client_alive_count_max | default(3) | string)
        fail_msg: >-
          SSH ClientAliveCountMax is {{ _q_256400_ssh.stdout | default('NOT_SET') }},
          expected {{ esxi_stig_ssh_client_alive_count_max | default(3) }}
        success_msg: "SSH ClientAliveCountMax is {{ _q_256400_ssh.stdout | default('') | trim }}"
      when:
        - esxi_70_000026_Manage | default(true) | bool
        - _q_256400_ssh is not skipped
        - not (_q_256400_ssh.failed | default(false))

    # --- V-256401 / ESXI-70-000027: ClientAliveInterval 200 ---
    - name: stigrule_256401_ssh_client_alive_interval_query
      ansible.builtin.shell:
        cmd: >-
          pwsh -NoProfile -Command "
          {{ _pwsh_preamble }}
          \$vmhost = Get-VMHost -Name '{{ _current_esxi_host }}';
          \$esxcli = Get-EsxCli -VMHost \$vmhost -V2;
          \$args = \$esxcli.system.ssh.server.config.list.CreateArgs();
          \$config = \$esxcli.system.ssh.server.config.list.Invoke(\$args);
          \$val = \$config | Where-Object { \$_.Key -eq 'clientaliveinterval' };
          if (\$val) { \$val.Value } else { 'NOT_SET' }
          "
      environment:
        VC_PASS: "{{ vmware_password }}"
      register: _q_256401_ssh
      changed_when: false
      check_mode: false
      no_log: true
      when: esxi_70_000027_Manage | default(true) | bool

    - name: stigrule_256401_ssh_client_alive_interval_assert
      ansible.builtin.assert:
        that:
          - (_q_256401_ssh.stdout | default('NOT_SET') | trim) == (esxi_stig_ssh_client_alive_interval | default(200) | string)
        fail_msg: >-
          SSH ClientAliveInterval is {{ _q_256401_ssh.stdout | default('NOT_SET') }},
          expected {{ esxi_stig_ssh_client_alive_interval | default(200) }}
        success_msg: "SSH ClientAliveInterval is {{ _q_256401_ssh.stdout | default('') | trim }}"
      when:
        - esxi_70_000027_Manage | default(true) | bool
        - _q_256401_ssh is not skipped
        - not (_q_256401_ssh.failed | default(false))

    # --- V-256434 / ESXI-70-000082: AllowTcpForwarding no ---
    - name: stigrule_256434_ssh_allow_tcp_fwd_query
      ansible.builtin.shell:
        cmd: >-
          pwsh -NoProfile -Command "
          {{ _pwsh_preamble }}
          \$vmhost = Get-VMHost -Name '{{ _current_esxi_host }}';
          \$esxcli = Get-EsxCli -VMHost \$vmhost -V2;
          \$args = \$esxcli.system.ssh.server.config.list.CreateArgs();
          \$config = \$esxcli.system.ssh.server.config.list.Invoke(\$args);
          \$val = \$config | Where-Object { \$_.Key -eq 'allowtcpforwarding' };
          if (\$val) { \$val.Value } else { 'NOT_SET' }
          "
      environment:
        VC_PASS: "{{ vmware_password }}"
      register: _q_256434
      changed_when: false
      check_mode: false
      no_log: true
      when: esxi_70_000082_Manage | default(true) | bool

    - name: stigrule_256434_ssh_allow_tcp_fwd_assert
      ansible.builtin.assert:
        that:
          - (_q_256434.stdout | default('NOT_SET') | trim | lower) == 'no'
        fail_msg: "SSH AllowTcpForwarding is not disabled: {{ _q_256434.stdout | default('NOT_SET') }}"
        success_msg: "SSH AllowTcpForwarding is disabled"
      when:
        - esxi_70_000082_Manage | default(true) | bool
        - _q_256434 is not skipped
        - not (_q_256434.failed | default(false))

    # --- V-256449 / ESXI-70-000274: FIPS SSH ciphers ---
    - name: stigrule_256449_ssh_fips_ciphers_query
      ansible.builtin.shell:
        cmd: >-
          pwsh -NoProfile -Command "
          {{ _pwsh_preamble }}
          \$vmhost = Get-VMHost -Name '{{ _current_esxi_host }}';
          \$esxcli = Get-EsxCli -VMHost \$vmhost -V2;
          \$args = \$esxcli.system.ssh.server.config.list.CreateArgs();
          \$config = \$esxcli.system.ssh.server.config.list.Invoke(\$args);
          \$val = \$config | Where-Object { \$_.Key -eq 'ciphers' };
          if (\$val) { \$val.Value } else { 'NOT_SET' }
          "
      environment:
        VC_PASS: "{{ vmware_password }}"
      register: _q_256449
      changed_when: false
      check_mode: false
      no_log: true
      when: esxi_70_000274_Manage | default(true) | bool

    - name: stigrule_256449_ssh_fips_ciphers_assert
      ansible.builtin.assert:
        that:
          - (_q_256449.stdout | default('NOT_SET') | trim) != 'NOT_SET'
          - "'aes128-ctr' in (_q_256449.stdout | default('') | trim) or
             'aes256-ctr' in (_q_256449.stdout | default('') | trim) or
             'aes128-gcm' in (_q_256449.stdout | default('') | trim) or
             'aes256-gcm' in (_q_256449.stdout | default('') | trim)"
        fail_msg: "SSH ciphers not FIPS-compliant: {{ _q_256449.stdout | default('NOT_SET') }}"
        success_msg: "SSH ciphers: {{ _q_256449.stdout | default('') | trim }}"
      when:
        - esxi_70_000274_Manage | default(true) | bool
        - _q_256449 is not skipped
        - not (_q_256449.failed | default(false))
