<!DOCTYPE html>
<html>
<head>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color: #333; line-height: 1.6; }
        .container { width: 100%; max-width: 800px; margin: 0 auto; border: 1px solid #e0e0e0; border-radius: 8px; overflow: hidden; }
        .header { background-color: #005696; color: #ffffff; padding: 20px; text-align: center; }
        .content { padding: 30px; }
        .section-title { color: #005696; border-bottom: 2px solid #005696; padding-bottom: 5px; margin-top: 30px; font-size: 18px; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; }
        th { background-color: #f8f9fa; color: #666; text-align: left; padding: 12px; border-bottom: 2px solid #dee2e6; }
        td { padding: 12px; border-bottom: 1px solid #dee2e6; }
        .status-warn { color: #856404; background-color: #fff3cd; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
        .footer { background-color: #f1f1f1; color: #777; padding: 15px; text-align: center; font-size: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Infrastructure Compliance Report</h1>
            <p>vCenter Instance: <strong>{{ inventory_hostname }}</strong></p>
        </div>
        <div class="content">
            <p>Hello,</p>
            <p>Our automated audit has identified compliance or capacity issues on <strong>{{ vm_count }}</strong> virtual machines assigned to your account. Please review the specific actions required below.</p>

            {# --- SECTION: STALE SNAPSHOTS --- #}
            {% if issues.aged_snapshots | length > 0 %}
            <div class="section-title">Aged Snapshots (Action: Delete)</div>
            <p>The following snapshots are older than {{ vmware_snapshot_age_warning_days }} days and are impacting storage performance.</p>
            <table>
                <thead>
                    <tr>
                        <th>VM Name</th>
                        <th>Snapshot Name</th>
                        <th>Age (Days)</th>
                        <th>Size</th>
                    </tr>
                </thead>
                <tbody>
     {% for snap in issues.aged_snapshots %}
                    <tr>
                        <td><strong>{{ snap.vm_name }}</strong></td>
                        <td>{{ snap.snapshot_name }}</td>
                        <td><span class="status-warn">{{ snap.age_days }} days</span></td>
                        <td>{{ snap.size_gb | round(2) }} GB</td>
                    </tr>
     {% endfor %}
                </tbody>
            </table>
            {% endif %}

            {# --- SECTION: BACKUP COMPLIANCE --- #}
            {% if (issues.no_backup | length > 0) or (issues.overdue_backup | length > 0) %}
            <div class="section-title">Data Protection Compliance</div>
            <table>
                <thead>
                    <tr>
                        <th>VM Name</th>
                        <th>Issue Type</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
     {% for vm in issues.no_backup %}
                    <tr>
                        <td><strong>{{ vm.name }}</strong></td>
                        <td>No Backup Found</td>
                        <td><span style="color: #721c24; background-color: #f8d7da; padding: 2px 6px; border-radius: 4px;">CRITICAL</span></td>
                    </tr>
     {% endfor %}
     {% for vm in issues.overdue_backup %}
                    <tr>
                        <td><strong>{{ vm.name }}</strong></td>
                        <td>Backup Overdue</td>
                        <td><span class="status-warn">{{ vm.days_since_backup }} Days Ago</span></td>
                    </tr>
     {% endfor %}
                </tbody>
            </table>
            {% endif %}

            {# --- SECTION: POWER STATES --- #}
            {% if issues.powered_off | length > 0 %}
            <div class="section-title">Resource Optimization</div>
            <p>The following VMs are powered off. If these are no longer required, please consider decommissioning them to reclaim resources.</p>
            <ul>
     {% for vm in issues.powered_off %}
                <li><strong>{{ vm.name }}</strong> (Cluster: {{ vm.cluster }})</li>
     {% endfor %}
            </ul>
            {% endif %}

            <p style="margin-top: 40px;">If you have questions regarding these items, please contact the Infrastructure Team by replying to this email.</p>
        </div>
        <div class="footer">
            Generated by NCS Ansible Automation Suite &copy; 2026<br>
            Audit Type: {{ vmware_ctx.audit_type }} | Run Date: {{ ansible_date_time.date }}
        </div>
    </div>
</body>
</html>
