<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>vCenter Compliance Report</title>
    <style>
        /* Webmail / Mobile Styles */
        body { font-family: 'Segoe UI', Tahoma, Geneva, sans-serif; color: #333; background-color: #f4f6f9; margin: 0; padding: 0; }
        .badge { padding: 3px 8px; border-radius: 4px; font-size: 0.8em; font-weight: bold; text-transform: uppercase; }
        .badge-crit { background-color: #fadbd8; color: #922b21; }
        .badge-warn { background-color: #fdebd0; color: #9c6f04; }
    </style>
</head>
<body style="font-family: 'Segoe UI', Tahoma, sans-serif; background-color: #f4f6f9; margin: 0; padding: 0;">

    <div style="background-color: #2c3e50; color: white; padding: 25px; text-align: center; border-bottom: 4px solid #3498db;">
        <h1 style="margin: 0; font-weight: 300;">vCenter Compliance Report</h1>
        <p style="margin: 5px 0 0 0; font-size: 0.9em; opacity: 0.9;">Owner: <strong>{{ owner_email }}</strong></p>
    </div>

    <div style="padding: 30px; max-width: 900px; margin: 20px auto; background: #fff; border-radius: 8px; border: 1px solid #ddd;">

        <p>This automated report identifies compliance issues with your VMs on vCenter: <strong>{{ inventory_hostname }}</strong>.</p>

        <div style="background-color: #f8f9fa; border: 1px solid #eee; padding: 15px; border-radius: 6px; margin-bottom: 25px; display: flex;">
            <div style="margin-right: 20px;">
                <span style="display:block; color:#7f8c8d; font-size:0.8em; text-transform:uppercase;">Critical Issues</span>
                <span style="font-size:1.5em; font-weight:bold; color: #c0392b;">{{ (issues.no_backup|length) + (issues.no_backup_tags|length) + (issues.overdue_backup|length) }}</span>
            </div>
            <div style="margin-right: 20px;">
                <span style="display:block; color:#7f8c8d; font-size:0.8em; text-transform:uppercase;">Warnings</span>
                <span style="font-size:1.5em; font-weight:bold; color: #d35400;">{{ issues.aged_snapshots|length }}</span>
            </div>
             <div>
                <span style="display:block; color:#7f8c8d; font-size:0.8em; text-transform:uppercase;">Total VMs Checked</span>
                <span style="font-size:1.5em; font-weight:bold; color: #2c3e50;">{{ vm_count }}</span>
            </div>
        </div>

        {# --- CRITICAL: NO BACKUP --- #}
        {% if issues.no_backup | default([]) | length > 0 %}
        <div style="margin-bottom: 40px;">
            <h2 style="color: #c0392b; border-bottom: 2px solid #fadbd8; padding-bottom: 8px;">‚ö†Ô∏è CRITICAL: VMs Never Backed Up</h2>
            <p>The following VMs are scheduled but have <strong>NEVER been backed up</strong>:</p>
            <table width="100%" cellpadding="10" cellspacing="0" style="border-collapse: collapse; font-size: 0.9em;">
                <tr style="background-color: #f8f9fa; border-bottom: 2px solid #ddd;">
                    <th align="left">VM Name</th>
                    <th align="left">Cluster</th>
                    <th align="left">Schedule</th>
                </tr>
                {% for vm in issues.no_backup %}
                <tr style="border-bottom: 1px solid #eee;">
                    <td><strong>{{ vm.name }}</strong></td>
                    <td>{{ vm.cluster }}</td>
                    <td><span class="badge badge-crit" style="background-color: #fadbd8; color: #922b21; padding: 3px 6px; border-radius: 4px;">{{ vm.backup_schedule }}</span></td>
                </tr>
                {% endfor %}
            </table>
        </div>
        {% endif %}

        {# --- CRITICAL: MISSING TAGS --- #}
        {% if issues.no_backup_tags | default([]) | length > 0 %}
        <div style="margin-bottom: 40px;">
            <h2 style="color: #c0392b; border-bottom: 2px solid #fadbd8; padding-bottom: 8px;">‚ö†Ô∏è CRITICAL: Missing Backup Tags</h2>
            <p>These VMs are missing the required "Backup Schedule" tag:</p>
            <table width="100%" cellpadding="10" cellspacing="0" style="border-collapse: collapse; font-size: 0.9em;">
                <tr style="background-color: #f8f9fa; border-bottom: 2px solid #ddd;">
                    <th align="left">VM Name</th>
                    <th align="left">Cluster</th>
                    <th align="left">Power State</th>
                </tr>
                {% for vm in issues.no_backup_tags %}
                <tr style="border-bottom: 1px solid #eee;">
                    <td><strong>{{ vm.name }}</strong></td>
                    <td>{{ vm.cluster }}</td>
                    <td>{{ vm.power_state }}</td>
                </tr>
                {% endfor %}
            </table>
            <div style="background-color: #fdedec; border-left: 4px solid #e74c3c; padding: 15px; margin-top: 10px;">
                <strong>Action Required:</strong> Please apply a Backup Tag (e.g., 'Daily', 'Weekly') via vCenter tags.
            </div>
        </div>
        {% endif %}

        {# --- WARNING: SNAPSHOTS --- #}
        {% if issues.aged_snapshots | default([]) | length > 0 %}
        <div style="margin-bottom: 40px;">
            <h2 style="color: #d35400; border-bottom: 2px solid #fdebd0; padding-bottom: 8px;">üî∏ WARNING: Aged Snapshots (> 7 Days)</h2>
            <table width="100%" cellpadding="10" cellspacing="0" style="border-collapse: collapse; font-size: 0.9em;">
                <tr style="background-color: #f8f9fa; border-bottom: 2px solid #ddd;">
                    <th align="left">VM Name</th>
                    <th align="left">Snapshot Name</th>
                    <th align="left">Age</th>
                    <th align="left">Size</th>
                </tr>
                {% for snap in issues.aged_snapshots %}
                <tr style="border-bottom: 1px solid #eee;">
                    <td><strong>{{ snap.vm_name }}</strong></td>
                    <td>{{ snap.snapshot_name }}</td>
                    <td><span class="badge badge-warn" style="background-color: #fdebd0; color: #9c6f04; padding: 3px 6px; border-radius: 4px;">{{ snap.age_days }} days</span></td>
                    <td>{{ snap.size_gb }} GB</td>
                </tr>
                {% endfor %}
            </table>
        </div>
        {% endif %}

        <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #eee; font-size: 0.8em; color: #999; text-align: center;">
            <p>Generated by Ansible Infrastructure Monitoring | {{ ansible_date_time.date }}</p>
        </div>
    </div>
</body>
</html>
