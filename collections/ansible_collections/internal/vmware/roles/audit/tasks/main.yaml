---
# collections/ansible_collections/internal/vmware/roles/audit/tasks/main.yaml
# internal.vmware.audit : main.yaml

- name: VMware health audit
  block:
    - name: Initialize alert list
      ansible.builtin.set_fact:
        vmware_alerts: []

    - name: Phase 2 | Checks
      ansible.builtin.include_tasks: checks.yaml
      tags: [checks]

    - name: Phase 3 | Summary
      ansible.builtin.include_tasks: summary.yaml
      tags: [summary]

    - name: Phase 3.5 | Notify
      ansible.builtin.include_tasks: notify/workload.yaml
      tags: [notify]

    - name: Phase 4 | Export
      ansible.builtin.include_tasks: export.yaml
      tags: [export]

  rescue:
    - name: Log audit failure
      ansible.builtin.debug:
        msg: >-
          VMware audit failed for {{ inventory_hostname }}:
          {{ ansible_failed_result.msg | default('unknown error') }}

    - name: Mark checks failed
      ansible.builtin.set_fact:
        vmware_ctx: "{{ vmware_ctx | combine({'checks_failed': true}) }}"
