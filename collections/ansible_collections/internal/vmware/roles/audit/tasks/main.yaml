---
# internal.vmware.audit : tasks/main.yaml

- name: VMware health audit
  block:
    - name: Phase 1 | Initialize Audit State
      ansible.builtin.include_tasks: init.yaml
      tags: [always]

    - name: Phase 2 | Execute Audit Logic
      ansible.builtin.include_tasks: checks.yaml
      tags: [checks]

      # - name: Phase 3.5 | Workload Notifications
      #   ansible.builtin.include_tasks: notify/workload.yaml
      #   when:
      #     - vmware_enable_email_notifications | default(false) | bool
      #     - >-
      #       ansible_date_time.weekday | lower in
      #       (vmware_owner_notification_days | map('lower') | list)
      #   tags: [notify]

  rescue:
    # FIX: Split the rescue actions into two distinct tasks
    - name: Set audit failure flag
      ansible.builtin.set_fact:
        _vmw_audit_failed: true

    - name: Log audit failure
      ansible.builtin.debug:
        msg: >-
          VMware audit failed for {{ inventory_hostname }}.
          Exporting partial results.

  always:
    - name: Phase 3 | Finalize Audit Payload
      ansible.builtin.include_tasks: finalize.yaml
      tags: [export]

    - name: Phase 4 | Validate Audit Payload
      ansible.builtin.include_tasks: validate.yaml
      when: vmware_validate_export_schema | default(true) | bool
      tags: [export]

    - name: Phase 5 | Export Audit State
      ansible.builtin.include_tasks: export.yaml
      tags: [export]
