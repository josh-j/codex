---
# internal.vmware.audit : summary.yaml
#
# Aggregates alert counts by severity and category.
# Stores results in _vmw_summary and syncs into vmware_ctx.

- name: Generate summary metrics
  block:
    - name: Calculate alert summary
      ansible.builtin.set_fact:
        _vmw_summary: "{{ summary_data }}"
      vars:
        _alerts: "{{ vmware_alerts | default([]) }}"
        summary_data:
          alerts:
            total: "{{ _alerts | length }}"
            critical_count: "{{ _alerts | selectattr('severity', 'equalto', 'CRITICAL') | list | length }}"
            warning_count: "{{ _alerts | selectattr('severity', 'equalto', 'WARNING')  | list | length }}"
            info_count: "{{ _alerts | selectattr('severity', 'equalto', 'INFO')     | list | length }}"
            by_category:
              backup: "{{ _alerts | selectattr('category', 'equalto', 'backup')         | list | length }}"
              capacity: "{{ _alerts | selectattr('category', 'equalto', 'capacity')       | list | length }}"
              configuration: "{{ _alerts | selectattr('category', 'equalto', 'configuration')  | list | length }}"
              connectivity: "{{ _alerts | selectattr('category', 'equalto', 'connectivity')   | list | length }}"
              snapshots: "{{ _alerts | selectattr('category', 'equalto', 'snapshots')      | list | length }}"
              alarms: "{{ _alerts | selectattr('category', 'equalto', 'alarms')         | list | length }}"
              infrastructure: "{{ _alerts | selectattr('category', 'equalto', 'infrastructure') | list | length }}"
              security: "{{ _alerts | selectattr('category', 'equalto', 'security')       | list | length }}"
          checks_completed:
            - appliance
            - datacenters
            - clusters
            - hosts
            - datastores
            - vms
            - snapshots
            - alarms

    - name: Log summary
      ansible.builtin.debug:
        msg: >-
          {{ inventory_hostname }} | {{ _vmw_summary.alerts.total }} alert(s) |
          {{ _vmw_summary.alerts.critical_count }}C /
          {{ _vmw_summary.alerts.warning_count }}W /
          {{ _vmw_summary.alerts.info_count }}I

  rescue:
    - name: Set empty summary on failure
      ansible.builtin.set_fact:
        _vmw_summary:
          alerts:
            total: 0
            critical_count: 0
            warning_count: 0
            info_count: 0
            by_category: {}
          checks_completed: []

- name: Sync alerts and summary into vmware_ctx
  ansible.builtin.set_fact:
    vmware_ctx: >-
      {{
        vmware_ctx | combine({
          'alerts':  vmware_alerts | default([]),
          'summary': _vmw_summary  | default({})
        }, recursive=true)
      }}
  changed_when: false
