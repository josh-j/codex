---
# internal.vmware.audit : tasks/finalize.yaml

- name: Compute audit rollups
  ansible.builtin.set_fact:
    _vmw_rollups: >-
      {{
        (vmware_alerts | default([]) | list)
        | internal.core.compute_audit_rollups
      }}
  changed_when: false

- name: Extract summary and health from rollups
  ansible.builtin.set_fact:
    _vmw_summary: "{{ _vmw_rollups.summary | default({}) }}"
    _vmw_health: "{{ _vmw_rollups.health | default('HEALTHY') }}"
  changed_when: false

- name: Attach finalized audit state to vmware_ctx
  ansible.builtin.set_fact:
    vmware_ctx: >-
      {{
        (ncs_ctx | default(vmware_ctx))
        | internal.vmware.attach_audit_results(
          (vmware_alerts | default([]) | list),
          (_vmw_audit_failed | default(false) | bool),
          _vmw_health,
          _vmw_summary
        )
      }}
  changed_when: false

- name: Build audit export payload
  ansible.builtin.set_fact:
    _vmware_audit_export_path: "{{ ncs_export_path }}"
    _vmware_audit_export_data: >-
      {{
        (vmware_alerts | default([]) | list)
        | internal.vmware.build_audit_export_payload(
          vmware_ctx,
          (_vmw_audit_failed | default(false) | bool),
          _vmw_health,
          _vmw_summary,
          ansible_facts['date_time']['iso8601'],
          {
            'cpu_crit': (vmware_cpu_critical_pct | default(90) | int),
            'memory_crit': (vmware_memory_critical_pct | default(90) | int),
            'storage_crit': (
              vmware_datastore_free_critical_pct | default(10) | int
            )
          }
        )
      }}
  changed_when: false
