---
# internal.vmware.audit : checks/health.yaml
#
# Evaluates vCenter appliance and infrastructure health.
# Appends results to vmware_alerts.

- name: Evaluate infrastructure health alerts
  ansible.builtin.set_fact:
    vmware_alerts: "{{ vmware_alerts | default([]) + (checks | internal.core.build_alerts) }}"
  vars:
    _appliance: "{{ vmware_ctx.health.appliance | default({}) }}"
    _overall:   "{{ _appliance.health.overall | default('unknown') | lower }}"
    checks:
      - condition: "{{ vmware_ctx.discovery.datacenters.metrics.total | default(0) | int == 0 }}"
        severity:  CRITICAL
        category:  configuration
        message:   "No datacenters found in vCenter inventory."
        detail:
          expected: "At least 1"
          found:    "{{ vmware_ctx.discovery.datacenters.metrics.total | default(0) }}"

      - condition: "{{ _overall != 'green' }}"
        severity:  CRITICAL
        category:  infrastructure
        message:   "vCenter Appliance Health is {{ _overall | upper }}"
        detail:
          overall:   "{{ _overall }}"
          database:  "{{ _appliance.health.database | default('unknown') }}"
          storage:   "{{ _appliance.health.storage  | default('unknown') }}"
          swap:      "{{ _appliance.health.swap     | default('unknown') }}"

      - condition: "{{ _appliance.config.ssh_enabled | default(false) | bool }}"
        severity:  WARNING
        category:  security
        message:   "SSH is currently enabled on vCenter Appliance."
        detail:
          ssh_enabled:    true
          recommendation: "Disable SSH via VAMI (port 5480) unless actively troubleshooting."

      - condition: >-
          {{
            _appliance.backup.enabled is defined and
            not (_appliance.backup.enabled | default(false) | bool)
          }}
        severity:  CRITICAL
        category:  backup
        message:   "vCenter File-Based Backup is NOT configured or disabled."
        detail:
          configured: "{{ _appliance.backup.configured | default(false) }}"
          enabled:    "{{ _appliance.backup.enabled    | default(false) }}"
          location:   "{{ _appliance.backup.location   | default('Not Configured') }}"
