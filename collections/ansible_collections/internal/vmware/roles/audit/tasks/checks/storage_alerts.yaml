---
# internal.vmware.audit : checks/storage_alerts.yaml
#
# Called by storage.yaml after guard check.
# vars here are task-scoped and reliably available to all tasks.

- name: Set datastore filter vars
  ansible.builtin.set_fact:
    _ds: "{{ vmware_ctx.inventory.datastores.list | default([]) }}"
    _critical_pct: "{{ vmware_datastore_free_critical_pct | default(10) | float }}"
    _warning_pct: "{{ vmware_datastore_free_warning_pct  | default(15) | float }}"
    _ds_critical: "{{ _ds | selectattr('free_pct', 'lt', vmware_datastore_free_critical_pct | default(10) | float) | list }}"
    _ds_warning: "{{ _ds | selectattr('free_pct', 'lt', vmware_datastore_free_warning_pct  | default(15) | float) | selectattr('free_pct', 'ge', vmware_datastore_free_critical_pct | default(10) | float) | list }}"
    _ds_maintenance: "{{ vmware_ctx.inventory.datastores.list | default([]) | rejectattr('maintenance_mode', 'in', ['normal', 'Normal']) | list }}"
    _ds_inaccessible: "{{ vmware_ctx.inventory.datastores.list | default([]) | selectattr('accessible', 'equalto', false) | list }}"

- name: Alert on critically low datastores
  ansible.builtin.set_fact:
    vmware_alerts: "{{ vmware_alerts | default([]) + [alert] }}"
  vars:
    alert:
      severity: CRITICAL
      category: capacity
      message: "Datastore {{ item.name }} critically low ({{ item.free_pct }}% free)"
      detail:
        datastore: "{{ item.name }}"
        free_pct: "{{ item.free_pct }}"
        threshold_pct: "{{ _critical_pct }}"
  loop: "{{ _ds_critical }}"
  loop_control:
    label: "{{ item.name }}"

- name: Alert on low datastores
  ansible.builtin.set_fact:
    vmware_alerts: "{{ vmware_alerts | default([]) + [alert] }}"
  vars:
    alert:
      severity: WARNING
      category: capacity
      message: "Datastore {{ item.name }} low ({{ item.free_pct }}% free)"
      detail:
        datastore: "{{ item.name }}"
        free_pct: "{{ item.free_pct }}"
        threshold_pct: "{{ _warning_pct }}"
  loop: "{{ _ds_warning }}"
  loop_control:
    label: "{{ item.name }}"

- name: Alert on datastores in maintenance mode
  ansible.builtin.set_fact:
    vmware_alerts: "{{ vmware_alerts | default([]) + [alert] }}"
  vars:
    alert:
      severity: WARNING
      category: configuration
      message: "Datastore {{ item.name }} in maintenance mode ({{ item.maintenance_mode }})"
      detail:
        datastore: "{{ item.name }}"
        maintenance_mode: "{{ item.maintenance_mode }}"
  loop: "{{ _ds_maintenance }}"
  loop_control:
    label: "{{ item.name }}"

- name: Alert on inaccessible datastores
  ansible.builtin.set_fact:
    vmware_alerts: "{{ vmware_alerts | default([]) + [alert] }}"
  vars:
    alert:
      severity: CRITICAL
      category: connectivity
      message: "Datastore {{ item.name }} is inaccessible"
      detail:
        datastore: "{{ item.name }}"
        accessible: false
  loop: "{{ _ds_inaccessible }}"
  loop_control:
    label: "{{ item.name }}"
