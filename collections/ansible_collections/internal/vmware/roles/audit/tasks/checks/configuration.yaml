---
# internal.vmware.audit : checks/configuration.yaml
#
# Evaluates cluster HA/DRS compliance and per-cluster resource utilisation.
# Appends results to vmware_alerts.

- name: Evaluate cluster configuration alerts
  when: item.value.compliance is defined
  ansible.builtin.set_fact:
    vmware_alerts: "{{ vmware_alerts | default([]) + (checks | internal.core.build_alerts) }}"
  vars:
    _c: "{{ item.value }}"
    checks:
      - condition: >-
          {{
            not (_c.compliance.ha_enabled  | default(false) | bool) or
            not (_c.compliance.drs_enabled | default(false) | bool)
          }}
        severity: WARNING
        category: configuration
        message: "Cluster '{{ item.key }}' has HA or DRS disabled"
        detail:
          cluster: "{{ item.key }}"
          ha_enabled: "{{ _c.compliance.ha_enabled  | default(false) }}"
          drs_enabled: "{{ _c.compliance.drs_enabled | default(false) }}"

      - condition: "{{ _c.utilization.mem_pct | default(0) | float > vmware_cluster_mem_warning_pct | default(90) | float }}"
        severity: WARNING
        category: capacity
        message: "Cluster '{{ item.key }}' memory usage is high ({{ _c.utilization.mem_pct | default(0) }}%)"
        detail:
          cluster: "{{ item.key }}"
          usage_pct: "{{ _c.utilization.mem_pct | default(0) }}"

      - condition: "{{ _c.utilization.cpu_pct | default(0) | float > vmware_cluster_cpu_warning_pct | default(90) | float }}"
        severity: WARNING
        category: capacity
        message: "Cluster '{{ item.key }}' CPU usage is high ({{ _c.utilization.cpu_pct | default(0) }}%)"
        detail:
          cluster: "{{ item.key }}"
          usage_pct: "{{ _c.utilization.cpu_pct | default(0) }}"

  loop: "{{ vmware_ctx.inventory.clusters.by_name | default({}) | dict2items }}"
  loop_control:
    label: "{{ item.key }}"
