---
# internal.vmware.audit : checks/resources.yaml
#
# Aggregates CPU and memory usage across all clusters fleet-wide.
# Uses threshold_alert for tiered CRITICAL/WARNING evaluation.

- name: Evaluate global resource alerts
  ansible.builtin.set_fact:
    vmware_alerts: >-
      {{
        vmware_alerts | default([])
        + (_cpu_pct | internal.core.threshold_alert('capacity', _cpu_msg, vmware_cpu_critical_pct    | default(90), vmware_cpu_warning_pct    | default(80)))
        + (_mem_pct | internal.core.threshold_alert('capacity', _mem_msg, vmware_memory_critical_pct | default(90), vmware_memory_warning_pct | default(80)))
      }}
  vars:
    _clusters: "{{ vmware_ctx.inventory.clusters.by_name | default({}) | dict2items }}"
    _cpu_cap: "{{ _clusters | map(attribute='value.resource_summary.cpuCapacityMHz') | map('int') | sum }}"
    _cpu_used: "{{ _clusters | map(attribute='value.resource_summary.cpuUsedMHz')     | map('int') | sum }}"
    _mem_cap: "{{ _clusters | map(attribute='value.resource_summary.memCapacityMB')  | map('int') | sum }}"
    _mem_used: "{{ _clusters | map(attribute='value.resource_summary.memUsedMB')      | map('int') | sum }}"
    _cpu_pct: "{{ ((_cpu_used | int / [_cpu_cap | int, 1] | max) * 100) | round(1) }}"
    _mem_pct: "{{ ((_mem_used | int / [_mem_cap | int, 1] | max) * 100) | round(1) }}"
    _cpu_msg: "Total vCenter CPU usage is {{ 'critical' if _cpu_pct | float > vmware_cpu_critical_pct | default(90) | float else 'high' }} ({{ _cpu_pct }}%)"
    _mem_msg: "Total vCenter memory usage is {{ 'critical' if _mem_pct | float > vmware_memory_critical_pct | default(90) | float else 'high' }} ({{ _mem_pct }}%)"
