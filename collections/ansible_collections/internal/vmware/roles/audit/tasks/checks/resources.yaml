---
# internal.vmware.audit : tasks/checks/resources.yaml

- name: Audit | Evaluate Global vCenter Resource Saturation (alerts)
  ansible.builtin.set_fact:
    _resource_rollup: >-
      {{
        (vmware_ctx.inventory.clusters.list | default([]))
        | internal.vmware.audit_resource_rollup(
          vmware_cpu_critical_pct | default(90) | int,
          vmware_cpu_warning_pct | default(80) | int,
          vmware_memory_critical_pct | default(90) | int,
          vmware_memory_warning_pct | default(80) | int
        )
      }}
    vmware_alerts: >-
      {{
        (vmware_alerts | default([]) | list)
        | internal.core.append_alerts(_resource_rollup.alerts | default([]) | list)
      }}
  changed_when: false

- name: Audit | Persist resource utilization gauges (non-alert data only)
  ansible.builtin.set_fact:
    vmware_ctx: >-
      {{
        vmware_ctx
        | internal.vmware.attach_audit_utilization(
          _resource_rollup.utilization | default({})
        )
      }}
  changed_when: false
