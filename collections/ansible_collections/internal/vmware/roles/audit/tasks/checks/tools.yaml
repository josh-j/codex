---
# internal.vmware.audit : checks/tools.yaml
#
# Collects VM Tools status for all powered-on VMs and alerts on
# missing or unmanaged tools installations.

- name: Gather VM Tools info from vCenter
  community.vmware.vmware_vm_info:
    hostname: "{{ _vcenter_hostname }}"
    username: "{{ vmware_username }}"
    password: "{{ vmware_password }}"
    validate_certs: "{{ vmware_validate_certs | default(false) | bool }}"
    vm_type: vm
  register: _vm_tools_raw
  delegate_to: localhost
  no_log: true
  failed_when: false

- name: Alert on VM Tools issues
  when: _vm_tools_raw is success
  ansible.builtin.set_fact:
    vmware_alerts: "{{ vmware_alerts | default([]) + [alert] }}"
  vars:
    _vms_with_issues: >-
      {{
        _vm_tools_raw.virtual_machines | default([])
        | selectattr('power_state', 'equalto', 'poweredOn')
        | rejectattr('guest_tools_status', 'in', ['toolsOk', 'toolsOld'])
        | list
      }}
    alert:
      severity: WARNING
      category: configuration
      message: "VM {{ item.guest_name | default('Unknown') }} has VMware Tools issue ({{ item.guest_tools_status | default('notInstalled') }})"
      detail:
        vm_name: "{{ item.guest_name    | default('Unknown') }}"
        power_state: "{{ item.power_state   | default('unknown') }}"
        tools_status: "{{ item.guest_tools_status | default('notInstalled') }}"
  loop: "{{ _vms_with_issues }}"
  loop_control:
    label: "{{ item.guest_name | default('Unknown') }}"
