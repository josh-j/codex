---
# internal.vmware.audit : checks/alarms.yaml
#
# Evaluates active vCenter alarms and appends to vmware_alerts.

- name: Evaluate alarm alerts
  ansible.builtin.set_fact:
    vmware_alerts: "{{ vmware_alerts | default([]) + (checks | internal.core.build_alerts) }}"
  vars:
    _alarms: "{{ vmware_ctx.health.alarms | default({}) }}"
    _critical_count: "{{ _alarms.metrics.critical_count | default(0) | int }}"
    _warning_count: "{{ _alarms.metrics.warning_count  | default(0) | int }}"
    checks:
      - condition: "{{ _critical_count | int > 0 }}"
        severity: CRITICAL
        category: alarms
        message: "{{ _critical_count }} critical alarm(s) active in vCenter"
        detail:
          critical_count: "{{ _critical_count }}"
          warning_count: "{{ _warning_count }}"
        affected_items: "{{ _alarms.by_severity.critical | default([]) }}"

      - condition: "{{ _warning_count | int > 0 and _critical_count | int == 0 }}"
        severity: WARNING
        category: alarms
        message: "{{ _warning_count }} warning alarm(s) active in vCenter"
        detail:
          warning_count: "{{ _warning_count }}"
        affected_items: "{{ _alarms.by_severity.warning | default([]) }}"
