---
# VM Snapshot Checks
- name: Build VM Owner Map
  ansible.builtin.set_fact:
    _vm_owner_map: >-
      {%- set res = {} -%}
      {%- for vm in (vmware_ctx.inventory.vms.list | default([])) -%}
        {%- set _ = res.update({vm.name: vm.owner_email}) -%}
      {%- endfor -%}
      {{ res }}
  changed_when: false

- name: Gather all snapshots from vCenter
  community.vmware.vmware_all_snapshots_info:
    hostname: "{{ vmware_ctx.discovery.connection.hostname }}"
    username: "{{ vmware_ctx.discovery.connection.username }}"
    password: "{{ vmware_ctx.discovery.connection.password }}"
    validate_certs: "{{ (vmware_ctx.config | default({})).get('validate_certs', false) | bool }}"
    datacenter: "{{ vmware_ctx.discovery.datacenter.name | default(omit) }}"
  register: _snapshots_raw
  delegate_to: localhost
  failed_when: false

- name: Filter and enrich aged snapshots
  ansible.builtin.set_fact:
    _temp_aged_snapshots: "{{ _temp_aged_snapshots | default([]) + [snapshot_enriched] }}"
  vars:
    _cfg: "{{ vmware_ctx.config | default({}) }}"
    _curr_ep: "{{ (run_ctx.timestamp | default(now().isoformat()) | to_datetime('%Y-%m-%dT%H:%M:%S%z')).strftime('%s') | int }}"
    threshold_days: "{{ _cfg.snapshot_age_warning_days | default(3) }}"
    creation_time: "{{ item.creation_time | default('') }}"
    creation_clean: "{{ creation_time | regex_replace('^\s*(\d{4}-\d{2}-\d{2})T(\d{2}:\d{2}:\d{2}).*$', '\1 \2') }}"
    is_valid_date: "{{ (creation_clean | regex_search('^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}$')) is not none }}"
    creation_epoch: "{{ (creation_clean | to_datetime('%Y-%m-%d %H:%M:%S')).strftime('%s') | int if is_valid_date else 0 }}"
    age_days: "{{ ((_curr_ep | int - creation_epoch | int) / 86400) | int }}"
    owner_email: "{{ _vm_owner_map.get(item.vm_name, '') }}"
    snapshot_enriched:
      vm_name: "{{ item.vm_name | default('unknown') }}"
      snapshot_name: "{{ item.name | default('unnamed') | urldecode }}"
      created: "{{ creation_time }}"
      age_days: "{{ age_days }}"
      size_gb: "{{ (item.size_gb | default(0)) | float }}"
      owner_email: "{{ owner_email }}"
  loop: "{{ _snapshots_raw.vmware_all_snapshots_info | default([]) }}"
  loop_control:
    label: "{{ item.vm_name | default('unknown') }}"
  when:
    - _snapshots_raw is success
    - is_valid_date
    - age_days | int >= threshold_days | int

- name: Calculate snapshot metrics
  ansible.builtin.set_fact:
    vmware_ctx: >-
      {{
        vmware_ctx | internal.core.recursive_combine({
          'inventory': {
            'snapshots': {
              'aged': (_temp_aged_snapshots | default([])),
              'metrics': {
                'total_aged': (_temp_aged_snapshots | default([]) | length),
                'total_size_gb': (_temp_aged_snapshots | default([]) | map(attribute='size_gb') | sum),
                'large_snapshots': (_temp_aged_snapshots | default([]) | selectattr('size_gb', '>', ((vmware_ctx.config | default({})).snapshot_size_warning_gb | default(50))) | list)
              }
            }
          }
        })
      }}
  changed_when: false

- name: Snapshot Alerts
  block:
    - name: "Check: Aged Snapshot Summary"
      ansible.builtin.include_role:
        name: internal.core.reporting
        tasks_from: alert
      vars:
        _snaps: "{{ vmware_ctx.inventory.snapshots }}"
        ncs_alert_severity: "WARNING"
        ncs_alert_category: "snapshots"
        ncs_alert_message: "{{ _snaps.metrics.total_aged }} snapshots older than {{ (vmware_ctx.config | default({})).snapshot_age_warning_days | default(3) }} days"
        ncs_alert_details:
          total_size_gb: "{{ _snaps.metrics.total_size_gb }}"
          total_count: "{{ _snaps.metrics.total_aged }}"
        ncs_alert_affected_items: "{{ _snaps.aged }}"
      when: (vmware_ctx.inventory.snapshots.metrics.total_aged | default(0) | int) > 0

    - name: "Check: Large Snapshots"
      ansible.builtin.include_role:
        name: internal.core.reporting
        tasks_from: alert
      vars:
        ncs_alert_severity: "WARNING"
        ncs_alert_category: "snapshots"
        ncs_alert_message: "VM {{ item.vm_name }} has large snapshot ({{ item.size_gb }} GB)"
      loop: "{{ vmware_ctx.inventory.snapshots.metrics.large_snapshots | default([]) }}"
      loop_control:
        label: "{{ item.vm_name }}"
