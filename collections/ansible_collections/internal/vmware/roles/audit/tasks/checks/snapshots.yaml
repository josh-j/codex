---
# internal.vmware.audit : checks/snapshots.yaml
#
# Collects all vCenter snapshots, identifies aged and oversized snapshots,
# updates vmware_ctx.inventory.snapshots, and appends alerts.

- name: Build VM owner map
  ansible.builtin.set_fact:
    _vm_owner_map: "{{ vmware_ctx.inventory.vms.list | default([]) | items2dict(key_name='name', value_name='owner_email') }}"

- name: Gather all snapshots from vCenter
  community.vmware.vmware_all_snapshots_info:
    hostname: "{{ _vcenter_hostname }}"
    username: "{{ vmware_username }}"
    password: "{{ vmware_password }}"
    validate_certs: "{{ vmware_validate_certs | default(false) | bool }}"
    datacenter: "{{ vmware_ctx.discovery.datacenters.primary | default(omit) }}"
  register: _snapshots_raw
  delegate_to: localhost
  no_log: true
  failed_when: false

- name: Process snapshots
  when: _snapshots_raw is success
  changed_when: false
  vars:
    _threshold: "{{ vmware_snapshot_age_warning_days | default(7) | int }}"
    _size_threshold: "{{ vmware_snapshot_size_warning_gb  | default(100) | int }}"
    _curr_ep: "{{ (run_ctx.timestamp | default(now().isoformat()) | to_datetime('%Y-%m-%dT%H:%M:%S%z')).strftime('%s') | int }}"
    _aged_snapshots: >-
      {{
        _snapshots_raw.vmware_all_snapshots_info | default([])
        | internal.core.filter_by_age(_curr_ep, _threshold)
        | internal.vmware.enrich_snapshots(_vm_owner_map)
      }}
    _large_snapshots: "{{ _aged_snapshots | selectattr('size_gb', 'gt', _size_threshold | float) | list }}"
    _total_size_gb: "{{ _aged_snapshots | map(attribute='size_gb') | sum }}"
  block:
    - name: Store snapshot inventory
      ansible.builtin.set_fact:
        vmware_ctx: >-
          {{
            vmware_ctx | combine({
              'inventory': vmware_ctx.inventory | combine({
                'snapshots': {
                  'aged':   _aged_snapshots,
                  'metrics': {
                    'total_aged':      _aged_snapshots | length,
                    'total_size_gb':   _total_size_gb,
                    'large_snapshots': _large_snapshots
                  }
                }
              }, recursive=true)
            }, recursive=true)
          }}

    - name: Alert on aged snapshots
      ansible.builtin.set_fact:
        vmware_alerts: "{{ vmware_alerts | default([]) + (checks | internal.core.build_alerts) }}"
      vars:
        checks:
          - condition: "{{ _aged_snapshots | length > 0 }}"
            severity: WARNING
            category: snapshots
            message: "{{ _aged_snapshots | length }} snapshot(s) older than {{ _threshold }} days"
            detail:
              total_count: "{{ _aged_snapshots | length }}"
              total_size_gb: "{{ _total_size_gb }}"
            affected_items: "{{ _aged_snapshots }}"

    - name: Alert on large snapshots
      ansible.builtin.set_fact:
        vmware_alerts: "{{ vmware_alerts | default([]) + [alert] }}"
      vars:
        alert:
          severity: WARNING
          category: snapshots
          message: "VM {{ item.vm_name }} has large snapshot ({{ item.size_gb }} GB)"
          detail: "{{ item }}"
      loop: "{{ _large_snapshots }}"
      when: _large_snapshots | length > 0
