---
# internal.vmware.audit : notify/loop.yaml
#
# Per-owner notification loop.
# Filters global VM and snapshot issues down to a specific owner and sends email.

- name: "Filter and compile issues for {{ owner_email }}"
  ansible.builtin.set_fact:
    _my_vm_names: >-
      {{
        vmware_ctx.inventory.vms.list | default([])
        | selectattr('owner_email', 'equalto', owner_email)
        | map(attribute='name')
        | list
      }}
    my_issues:
      no_backup:       "{{ vmware_ctx.inventory.vms.never_backed_up      | default([]) | selectattr('name', 'in', _my_vm_names) | list }}"
      no_backup_tags:  "{{ vmware_ctx.inventory.vms.without_backup_tags  | default([]) | selectattr('name', 'in', _my_vm_names) | list }}"
      overdue_backup:  "{{ vmware_ctx.inventory.vms.with_overdue_backup  | default([]) | selectattr('name', 'in', _my_vm_names) | list }}"
      aged_snapshots:  "{{ vmware_ctx.inventory.snapshots.aged           | default([]) | selectattr('vm_name', 'in', _my_vm_names) | list }}"
      powered_off:     >-
        {{
          vmware_ctx.inventory.vms.list | default([])
          | selectattr('owner_email', 'equalto', owner_email)
          | selectattr('power_state', 'equalto', 'POWEREDOFF')
          | list
        }}

# - name: "Send notification to {{ owner_email }}"
#   when: >-
#     {{
#       my_issues.no_backup      | length > 0 or
#       my_issues.no_backup_tags | length > 0 or
#       my_issues.overdue_backup | length > 0 or
#       my_issues.aged_snapshots | length > 0
#     }}
#   community.general.mail:
#     host:    "{{ ncs_config.email.smtp.server }}"
#     port:    "{{ ncs_config.email.smtp.port }}"
#     from:    "{{ vmware_notification_from | default('noreply@' + inventory_hostname) }}"
#     to:      "{{ owner_email }}"
#     subject: "Action Required: Compliance Report for {{ inventory_hostname }}"
#     subtype: html
#     body:    "{{ lookup('template', 'owner_notification_email.html.j2') }}"
#   vars:
#     issues:   "{{ my_issues }}"
#     vm_count: "{{ _my_vm_names | length }}"
#   delegate_to: localhost
