---
# internal.vmware.audit : notify/loop.yaml

- name: "Compile personalized compliance data for {{ owner_email }}"
  ansible.builtin.set_fact:
    _owner_notification_ctx: >-
      {{
        vmware_ctx | internal.vmware.build_owner_notification_context(owner_email)
      }}
    _my_vms: "{{ (_owner_notification_ctx | default({})).my_vms | default([]) }}"
    _my_names: "{{ (_owner_notification_ctx | default({})).my_names | default([]) }}"
    my_issues: "{{ (_owner_notification_ctx | default({})).my_issues | default({}) }}"

# - name: "Dispatch compliance digest to {{ owner_email }}"
#   # Removed {{ }} to satisfy ansible-lint (rule: no-jinja-when)
#   # When is implicitly Jinja2, so we just write the expression directly.
#   when: >
#     my_issues.no_backup | length > 0 or
#     my_issues.no_backup_tags | length > 0 or
#     my_issues.overdue_backup | length > 0 or
#     my_issues.aged_snapshots | length > 0
#   community.general.mail:
#     host: "{{ ncs_config.email.smtp.server | default('localhost') }}"
#     port: "{{ ncs_config.email.smtp.port | default(25) }}"
#     from: "{{ vmware_notification_from | default('vcenter-audit@' + inventory_hostname) }}"
#     to: "{{ owner_email }}"
#     subject: "[ACTION REQUIRED] Infrastructure Compliance: {{ inventory_hostname }}"
#     subtype: html
#     body: "{{ lookup('ansible.builtin.template', 'owner_notification_email.html.j2') }}"
#   vars:
#     issues: "{{ my_issues }}"
#     vm_count: "{{ _my_names | length }}"
#   delegate_to: localhost
#   no_log: true
