---
# internal.vmware.audit : notify/workload.yaml
#
# Owner notification workflow â€” sends per-owner VM issue summaries.
# Gated by vmware_enable_email_notifications and vmware_owner_notification_days.

# 1. GATEKEEPING
- name: Check notification schedule
  ansible.builtin.set_fact:
    _run_notifications: >-
      {{
        vmware_enable_email_notifications | default(false) | bool and
        run_ctx.day | default('') in vmware_owner_notification_days | default(['tuesday', 'thursday'])
      }}

- name: Log notification skip
  when: not _run_notifications
  ansible.builtin.debug:
    msg: "Skipping notifications: not enabled or not a notification day (today: {{ run_ctx.day | default('unknown') }})"

# 2. IDENTIFY RECIPIENTS
- name: Calculate verified recipient list
  when: _run_notifications
  ansible.builtin.set_fact:
    _vm_owners: >-
      {{
        _discovered
        if ('*' in vmware_notification_allowlist | default([]))
        else (_discovered | intersect(vmware_notification_allowlist | default([])))
      }}
  vars:
    _discovered: >-
      {{
        vmware_ctx.inventory.vms.list | default([])
        | map(attribute='owner_email')
        | select('defined')
        | select('search', '@')
        | unique
        | list
      }}

# 3. EXECUTION LOOP
- name: Process notifications for each verified owner
  when:
    - _run_notifications
    - _vm_owners | length > 0
  ansible.builtin.include_tasks: notify/loop.yaml
  loop: "{{ _vm_owners }}"
  loop_control:
    loop_var: owner_email
