---
# internal.vmware.audit : export.yaml
#
# Writes a single per-host YAML file containing all audit data.
# Consumed by aggregate_yaml_reports.py during the aggregation phase.

- name: Export host audit data
  ansible.builtin.copy:
    dest: "{{ ncs_config.report_directory }}/{{ inventory_hostname }}/{{ inventory_hostname }}.yaml"
    mode: "0664"
    content: >-
      {{
        {
          'host':       inventory_hostname,
          'site':       vmware_ctx.check.site       | default(''),
          'checked_at': vmware_ctx.check.started_at | default(''),
          'discovery':  vmware_ctx.discovery,
          'health':     vmware_ctx.health,
          'inventory':  vmware_ctx.inventory,
          'alerts':     vmware_alerts | default([]),
          'summary':    _vmw_summary  | default({})
        } | to_nice_yaml
      }}
  delegate_to: localhost
  become: false
