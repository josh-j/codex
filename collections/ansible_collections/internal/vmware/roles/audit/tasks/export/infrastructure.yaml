---
# Export Infrastructure Reports
- name: Export | Appliance Health Report
  ansible.builtin.include_role:
    name: internal.core.reporting
    tasks_from: export_csv
  vars:
    _app: "{{ vmware_ctx.health.appliance | default({}) }}"
    ncs_csv_report_name: "infrastructure_appliance"
    ncs_csv_headers: ["vCenter", "Version", "Build", "Health", "DB Health", "SSH Enabled", "Backup Configured", "Uptime (Days)"]
    ncs_csv_keys: ["vcenter", "version", "build", "health_overall", "health_db", "ssh", "backup_configured", "uptime"]
    ncs_csv_data:
      - vcenter: "{{ inventory_hostname }}"
        version: "{{ (_app.info | default({})).version | default('') }}"
        build: "{{ (_app.info | default({})).build | default('') }}"
        health_overall: "{{ (_app.health | default({})).overall | default('unknown') }}"
        health_db: "{{ (_app.health | default({})).database | default('unknown') }}"
        ssh: "{{ (_app.config | default({})).ssh_enabled | default(false) }}"
        backup_configured: "{{ (_app.backup | default({})).configured | default(false) }}"
        uptime: "{{ (_app.info | default({})).uptime_days | default(0) }}"

- name: Export | Cluster Capacity Report
  ansible.builtin.include_role:
    name: internal.core.reporting
    tasks_from: export_csv
  vars:
    _clusters: "{{ vmware_ctx.inventory.clusters.by_name | default({}) }}"
    ncs_csv_report_name: "infrastructure_clusters"
    ncs_csv_headers: ["vCenter", "Cluster", "Hosts", "CPU Use (%)", "Mem Use (%)", "HA Enabled", "DRS Enabled"]
    ncs_csv_keys: ["vcenter", "name", "hosts", "cpu_pct", "mem_pct", "ha", "drs"]
    ncs_csv_data: >-
      {%- set out = [] -%}
      {%- for it in (_clusters | dict2items) -%}
        {%- set c = it.value -%}
        {%- set _ = out.append({
          'vcenter': inventory_hostname,
          'name': it.key,
          'hosts': (c.hosts | default([]) | length),
          'cpu_pct': (c.utilization.cpu_pct | default(0)),
          'mem_pct': (c.utilization.mem_pct | default(0)),
          'ha': (c.compliance.ha_enabled | default(false)),
          'drs': (c.compliance.drs_enabled | default(false))
        }) -%}
      {%- endfor -%}
      {{ out }}
    ncs_csv_sort_by: "mem_pct"

- name: Export | Host Inventory Report
  ansible.builtin.include_role:
    name: internal.core.reporting
    tasks_from: export_csv
  vars:
    _hosts: "{{ vmware_ctx.inventory.hosts.list | default([]) }}"
    ncs_csv_report_name: "infrastructure_hosts"
    ncs_csv_headers: ["vCenter", "Host Name", "Cluster", "Connection State", "Power State", "Version"]
    ncs_csv_keys: ["vcenter", "name", "cluster", "connection_state", "power_state", "version"]
    ncs_csv_data: "{{ (_hosts | default([])) | map('combine', {'vcenter': inventory_hostname}) | list }}"
    ncs_csv_sort_by: "name"
