---
- name: Manage User Passwords and Aging
  ansible.builtin.user:
    name: "{{ item.name }}"
    password: "{{ item.password }}"
    update_password: "{{ item.update_password | default('on_create') }}"
    password_expire_max: "{{ ubuntu_pass_max_days }}"
    password_expire_min: "{{ ubuntu_pass_min_days }}"
    password_expire_warn: "{{ ubuntu_pass_warn_days }}"
    shell: "{{ item.shell | default('/bin/bash') }}"
    state: present
  loop: "{{ ubuntu_users }}"
  loop_control:
    label: "{{ item.name }}"
  no_log: true # Critical: Protects hashed passwords from appearing in logs
  register: _user_mods

- name: Enforce Password Change on next login (Optional)
  ansible.builtin.command: chage -d 0 {{ item.name }}
  loop: "{{ ubuntu_users }}"
  when:
    - item.force_change | default(false) | bool
    - _user_mods.changed
  loop_control:
    label: "{{ item.name }}"
  changed_when: true

- name: Audit Security State if users changed
  ansible.builtin.include_role:
    name: internal.linux.ubuntu_system_audit
  when: _user_mods.changed
  tags: [skip_ansible_lint]
