---
# roles/ubuntu/tasks/system/normalize.yaml
# Normalizes raw command outputs into the structured 'ubuntu' namespace.

- name: Normalize System Data
  ansible.builtin.set_fact:
    ubuntu: "{{ ubuntu | internal.core.recursive_combine({'system': system_data}) }}"
  vars:
    # 1. DISK USAGE
    _disk_list: >-
      {%- set results = [] -%}
      {%- for mount in ansible_facts['mounts'] | default([]) -%}
        {%- if 'loop' not in mount.device and 'tmpfs' not in mount.device -%}
          {%- set pct = (mount.size_total - mount.size_available) / mount.size_total * 100 if mount.size_total > 0 else 0 -%}
          {%- set disk = {
              'mount': mount.mount,
              'device': mount.device,
              'fstype': mount.fstype,
              'total_gb': (mount.size_total / 1024 / 1024 / 1024) | round(1),
              'free_gb': (mount.size_available / 1024 / 1024 / 1024) | round(1),
              'used_pct': pct | round(1)
          } -%}
          {%- set _ = results.append(disk) -%}
        {%- endif -%}
      {%- endfor -%}
      {{ results }}

    # 2. MEMORY USAGE
    _mem_total: "{{ ansible_facts['memtotal_mb'] | default(1) }}"
    _mem_free: "{{ ansible_facts['memfree_mb'] | default(0) }}"
    _mem_pct: "{{ ((_mem_total | int - _mem_free | int) / (_mem_total | int) * 100) | round(1) if (_mem_total | int) > 0 else 0 }}"

    _swap_total: "{{ ansible_facts['swaptotal_mb'] | default(0) }}"
    _swap_free: "{{ ansible_facts['swapfree_mb'] | default(0) }}"
    _swap_pct: "{{ ((_swap_total | int - _swap_free | int) / (_swap_total | int) * 100) | round(1) if (_swap_total | int) > 0 else 0 }}"

    # 3. STRUCTURE DATA
    system_data:
      hostname: "{{ ansible_facts['hostname'] | default(inventory_hostname) }}"
      uptime_days: "{{ ((ansible_facts['uptime_seconds'] | default(0)) / 86400) | int }}"
      kernel: "{{ ansible_facts['kernel'] | default('unknown') }}"
      load_avg: "{{ (ansible_facts['loadavg'] | default({'15m': 0}))['15m'] }}"

      memory:
        total_mb: "{{ _mem_total }}"
        free_mb: "{{ _mem_free }}"
        used_pct: "{{ _mem_pct }}"

      swap:
        total_mb: "{{ _swap_total }}"
        used_pct: "{{ _swap_pct }}"

      disks: "{{ _disk_list }}"

      services:
        failed_list: "{{ _failed_services_raw.stdout_lines | default([]) }}"
        failed_count: "{{ (_failed_services_raw.stdout_lines | default([])) | length }}"

- name: Log System Health
  ansible.builtin.debug:
    msg: "System Load: {{ ubuntu_ctx.system.load_avg }} | Mem Used: {{ ubuntu_ctx.system.memory.used_pct }}% | Failed Services: {{ ubuntu_ctx.system.services.failed_count }}"

- name: Normalize Security Data
  ansible.builtin.set_fact:
    ubuntu: "{{ ubuntu | internal.core.recursive_combine({'security': security_data}) }}"
  vars:
    # 1. PARSE SSH CONFIG
    _ssh_config_dict: >-
      {{
         (_sshd_raw.stdout_lines | default([]))
         | map('split', ' ')
         | map('list')
         | select('count', 2)
         | items2dict(key_name=0, value_name=1)
      }}

    # 2. PARSE SHADOW FILE
    _shadow_dict: >-
      {%- set res = {} -%}
      {%- for line in (_shadow_raw.stdout_lines | default([])) -%}
        {%- set parts = line.split(':') -%}
        {%- if parts | length > 1 -%}
          {%- set _ = res.update({parts[0]: parts[1:]}) -%}
        {%- endif -%}
      {%- endfor -%}
      {{ res }}

    # 3. CALCULATE PASSWORD AGING
    _current_epoch_days: "{{ ((ansible_facts['date_time'] | default({'epoch': 0}))['epoch'] | int / 86400) | int }}"

    _users_list: >-
      {%- set results = [] -%}
      {%- for user, info in (ansible_facts['getent_passwd'] | default({})).items() -%}
        {%- set shadow_entry = _shadow_dict.get(user, []) -%}
        {%- set last_change = shadow_entry[1] | default(0) | int -%}
        {%- set age = (_current_epoch_days | int - last_change) if last_change > 0 else -1 -%}
        {%- set user_data = {
            'name': user,
            'uid': info[1],
            'gid': info[2],
            'home': info[4],
            'shell': info[5],
            'last_change_days': last_change,
            'password_age_days': age
        } -%}
        {%- set _ = results.append(user_data) -%}
      {%- endfor -%}
      {{ results }}

    # 4. STRUCTURE DATA
    security_data:
      ssh_config: "{{ _ssh_config_dict }}"
      shadow_entries: "{{ _shadow_dict }}"
      users: "{{ _users_list }}"

      file_stats: >-
        {%- set fstats = {} -%}
        {%- for res in (_file_stats_raw.results | default([])) -%}
          {%- if res.stat is defined and res.stat.exists -%}
            {%- set _ = fstats.update({res.item: res.stat}) -%}
          {%- endif -%}
        {%- endfor -%}
        {{ fstats }}

      world_writable_files: "{{ _world_writable_raw.stdout_lines | default([]) }}"
