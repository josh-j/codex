
- name: Normalize System Data
  ansible.builtin.set_fact:
    ubuntu: "{{ ubuntu | combine({'system': system_data}, recursive=true) }}"
  vars:
    # 1. DISK USAGE
    _disk_list: >-
      {%- set results = [] -%}
      {%- for mount in ansible_facts['mounts'] -%}
        {%- if 'loop' not in mount.device and 'tmpfs' not in mount.device -%}
          {%- set pct = (mount.size_total - mount.size_available) / mount.size_total * 100 -%}
          {%- set disk = {
              'mount': mount.mount,
              'device': mount.device,
              'fstype': mount.fstype,
              'total_gb': (mount.size_total / 1024 / 1024 / 1024) | round(1),
              'free_gb': (mount.size_available / 1024 / 1024 / 1024) | round(1),
              'used_pct': pct | round(1)
          } -%}
          {%- set _ = results.append(disk) -%}
        {%- endif -%}
      {%- endfor -%}
      {{ results }}

    # 2. MEMORY USAGE
    _mem_total: "{{ ansible_facts['memtotal_mb'] | default(1) }}"
    _mem_free: "{{ ansible_facts['memfree_mb'] | default(0) }}"
    _mem_pct: "{{ ((_mem_total | int - _mem_free | int) / (_mem_total | int) * 100) | round(1) if (_mem_total | int) > 0 else 0 }}"

    _swap_total: "{{ ansible_facts['swaptotal_mb'] | default(0) }}"
    _swap_free: "{{ ansible_facts['swapfree_mb'] | default(0) }}"
    _swap_pct: "{{ ((_swap_total | int - _swap_free | int) / (_swap_total | int) * 100) | round(1) if (_swap_total | int) > 0 else 0 }}"

    # 3. STRUCTURE DATA
    system_data:
      hostname: "{{ ansible_facts['hostname'] }}"
      uptime_days: "{{ (ansible_facts['uptime_seconds'] / 86400) | int }}"
      kernel: "{{ ansible_facts['kernel'] }}"
      load_avg: "{{ ansible_facts['loadavg']['15m'] }}"

      memory:
        total_mb: "{{ _mem_total }}"
        free_mb: "{{ _mem_free }}"
        used_pct: "{{ _mem_pct }}"

      swap:
        total_mb: "{{ _swap_total }}"
        used_pct: "{{ _swap_pct }}"

      disks: "{{ _disk_list }}"

      services:
        failed_list: "{{ _failed_services_raw.stdout_lines }}"
        failed_count: "{{ _failed_services_raw.stdout_lines | length }}"

- name: Log System Health
  ansible.builtin.debug:
    msg: "System Load: {{ ubuntu.system.load_avg }} | Mem Used: {{ ubuntu.system.memory.used_pct }}% | Failed Services: {{ ubuntu.system.services.failed_count }}"


- name: Normalize Security Data
  ansible.builtin.set_fact:
    ubuntu: "{{ ubuntu | combine({'security': security_data}, recursive=true) }}"
  vars:
    # 1. PARSE SSH CONFIG
    _ssh_config_dict: >-
      {{
         _sshd_raw.stdout_lines
         | map('split', ' ')
         | map('list')
         | items2dict(key_name=0, value_name=1)
      }}

    # 2. PARSE SHADOW FILE
    _shadow_dict: >-
      {%- set res = {} -%}
      {%- for line in _shadow_raw.stdout_lines -%}
        {%- set parts = line.split(':') -%}
        {%- if parts | length > 1 -%}
          {%- set _ = res.update({parts[0]: parts[1:]}) -%}
        {%- endif -%}
      {%- endfor -%}
      {{ res }}

    # 3. CALCULATE PASSWORD AGING
    # Use ansible_facts['date_time'] instead of top-level facts
    _current_epoch_days: "{{ (ansible_facts['date_time']['epoch'] | int / 86400) | int }}"

    _users_list: >-
      {%- set results = [] -%}
      {%- for user, info in ansible_facts['getent_passwd'].items() -%}
        {%- set shadow_entry = _shadow_dict.get(user, []) -%}

        {# Shadow field 2 is 'Last Change' (index 1 in our list) #}
        {%- set last_change = shadow_entry[1] | default(0) | int -%}

        {# Casting inside logic to avoid jinja[invalid] string vs int comparison errors #}
        {%- set age = (_current_epoch_days | int - last_change) if last_change > 0 else -1 -%}

        {%- set user_data = {
            'name': user,
            'uid': info[1],
            'gid': info[2],
            'home': info[4],
            'shell': info[5],
            'last_change_days': last_change,
            'password_age_days': age,
            'shadow_info': shadow_entry
        } -%}
        {%- set _ = results.append(user_data) -%}
      {%- endfor -%}
      {{ results }}

    # 4. STRUCTURE DATA
    security_data:
      ssh_config: "{{ _ssh_config_dict }}"
      shadow_entries: "{{ _shadow_dict }}"
      users: "{{ _users_list }}"

      file_stats: >-
        {%- set fstats = {} -%}
        {%- for res in _file_stats_raw.results -%}
          {%- if res.stat.exists -%}
            {%- set _ = fstats.update({res.item: res.stat}) -%}
          {%- endif -%}
        {%- endfor -%}
        {{ fstats }}

      world_writable_files: "{{ _world_writable_raw.stdout_lines | default([]) }}"

