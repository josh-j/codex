<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {% set view = linux_fleet_view | default({}) %}
    {% set meta = view.get('meta', {}) %}
    <title>Linux Infrastructure Audit | {{ meta.get('report_date', report_date | default(now(utc=true, fmt='%Y-%m-%d'))) }}</title>
    <style>
        {{ '' | internal.core.shared_report_css }}
    </style>
</head>
<body>
{% set rows = view.get('rows', []) %}
{% set active_alerts = view.get('active_alerts', []) %}
{% set stig_fleet = view.get('stig_fleet', {}) %}
{% set stig_fleet_rows = stig_fleet.get('rows', []) %}
<div class="app-layout">
    <main class="content">
        <div style="margin-bottom: 15px; font-size: 0.85rem;">
            <a href="../../site_health_report.html" style="color: var(--indigo); text-decoration: none; font-weight: 600;">⬅ Back to Global Site Report</a>
        </div>

        <header class="content-header">
            <div class="title-group">
                <h1>Linux Fleet Health Dashboard</h1>
            </div>
            <div style="color: var(--text-muted); font-size: 0.9rem;">
                <strong>Generated:</strong> {{ meta.get('report_date', report_date | default(now(utc=true, fmt='%Y-%m-%d %H:%M:%S'))) }}
            </div>
        </header>

        <h2 class="sub-title">System Status Overview</h2>
        <div class="card-wrap">
            <table>
                <thead>
                    <tr>
                        <th>Hostname</th>
                        <th>Health</th>
                        <th>OS Version</th>
                        <th>Critical Faults</th>
                        <th>Warnings</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in rows %}
                    {% set _badge = (row.status.raw | default('UNKNOWN')) | internal.core.status_badge_meta %}
                    <tr>
                        <td>
                            <a href="{{ row.links.node_report_latest | default('./' ~ row.name ~ '/health_report.html') }}" style="color: var(--indigo); font-weight: bold; text-decoration: none;">
                                {{ row.name }} ↗
                            </a>
                        </td>
                        <td><span class="badge {{ _badge.css_class }}">{{ _badge.label }}</span></td>
                        <td>{{ row.distribution | default('Ubuntu') }} {{ row.distribution_version | default('') }}</td>
                        <td class="{{ 'text-danger' if row.summary.critical_count|default(0)|int > 0 else '' }}">
                            {{ row.summary.critical_count | default(0) }}
                        </td>
                        <td class="{{ 'text-warning' if row.summary.warning_count|default(0)|int > 0 else '' }}">
                            {{ row.summary.warning_count | default(0) }}
                        </td>
                    </tr>
                    {% else %}
                    <tr><td colspan="5" style="text-align: center; padding: 40px; color: var(--text-muted);">No Linux audit rows found.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <h2 class="sub-title">Active Alerts & Fault Details</h2>
        <div class="card-wrap">
            <table>
                <thead>
                    <tr>
                        <th>Hostname</th>
                        <th>Severity</th>
                        <th>Subsystem</th>
                        <th>Alert Message / Detail</th>
                    </tr>
                </thead>
                <tbody>
                    {% for alert in active_alerts %}
                    <tr>
                        <td class="{{ 'alert-row-critical' if alert.severity|upper == 'CRITICAL' else 'alert-row-warning' }}">
                            <strong>{{ alert.host }}</strong>
                        </td>
                        {% set _badge = alert.severity | internal.core.status_badge_meta %}
                        <td><span class="badge {{ _badge.css_class }}">{{ _badge.label }}</span></td>
                        <td style="text-transform: uppercase; font-size: 0.8rem; font-weight: 700; color: var(--indigo);">
                            {{ alert.category | default('System') }}
                        </td>
                        <td>{{ alert.message }}</td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 40px; color: var(--text-muted);">
                            <strong>No active faults detected.</strong> All systems are operating normally.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <h2 class="sub-title">STIG Compliance Audit</h2>
        <div class="card-wrap">
            <table>
                <thead>
                    <tr>
                        <th>Hostname</th>
                        <th>Compliance Health</th>
                        <th>Open Findings</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in stig_fleet_rows %}
                    {% set _badge = (row.status.raw | default('UNKNOWN')) | internal.core.status_badge_meta %}
                    <tr>
                        <td><strong>{{ row.host }}</strong></td>
                        <td><span class="badge {{ _badge.css_class }}">{{ _badge.label }}</span></td>
                        <td>{{ row.findings_open | default(0) }} finding(s)</td>
                    </tr>
                    {% else %}
                    <tr><td colspan="3" style="text-align:center; padding: 30px; color: var(--text-muted);">No STIG results found.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </main>
</div>
</body>
</html>
