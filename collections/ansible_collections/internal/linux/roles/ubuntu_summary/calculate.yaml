# roles/ubuntu/tasks/summary/calculate.yaml
# Aggregates findings from all domains into a high-level status

- name: Calculate Overall Health Status
  ansible.builtin.set_fact:
    ubuntu: "{{ ubuntu | combine({'summary': summary_data}, recursive=true) }}"
  vars:
    # 1. PULL METRICS FROM DOMAINS
    _pending_patches: "{{ ubuntu.updates.pending_count | default(0) }}"
    _failed_services: "{{ ubuntu.system.services.failed_count | default(0) }}"

    # Define Thresholds
    _disk_threshold: "{{ ubuntu.config.disk_warning_pct | default(90) }}"
    _patch_limit: "{{ ubuntu.config.updates_critical_threshold | default(50) }}"

    _disk_issues: "{{ ubuntu.system.disks | default([]) | selectattr('used_pct', 'gt', _disk_threshold | int) | list | length }}"

    # Safe access to shadow_entries
    _root_shadow: "{{ ubuntu.security.shadow_entries['root'][0] | default('!') }}"
    _security_issues: "{{ _root_shadow not in ['!', '*'] }}"

    # 2. DETERMINE STATUS BADGES
    _patch_status: "{{ 'CRITICAL' if (_pending_patches | int) > (_patch_limit | int) else ('WARNING' if (_pending_patches | int) > 0 else 'OK') }}"

    _system_status: "{{ 'CRITICAL' if (_failed_services | int > 0 or _disk_issues | int > 0) else 'OK' }}"
    _security_status: "{{ 'CRITICAL' if _security_issues else 'OK' }}"

    # 3. CALCULATE OVERALL HEALTH
    _is_critical: "{{ _patch_status == 'CRITICAL' or _system_status == 'CRITICAL' or _security_status == 'CRITICAL' }}"
    _overall: "{{ 'CRITICAL' if _is_critical else ('WARNING' if _patch_status == 'WARNING' else 'HEALTHY') }}"

    summary_data:
      health: "{{ _overall }}"
      patch_status: "{{ _patch_status }}"
      security_status: "{{ _security_status }}"
      system_status: "{{ _system_status }}"
      issues_count: "{{ (_pending_patches | int) + (_failed_services | int) + (_disk_issues | int) }}"
