# roles/ubuntu/tasks/summary/export.yaml
# Export the "Master Inventory & Health" report

- name: Export Executive Summary Row
  ansible.builtin.include_role:
    name: internal.core.reporting
    tasks_from: export_csv.yaml
  vars:
    ncs_csv_report_name: "ubuntu_fleet_summary"
    ncs_csv_headers:
      [
        "Hostname", "IP Address", "OS Kernel", "Uptime (Days)",
        "Overall Health", "Pending Updates", "Reboot Req",
        "Failed Svcs", "Security Status"  # <--- ADDED
      ]
    ncs_csv_keys:
      [
        "hostname", "ip", "kernel", "uptime",
        "health", "updates", "reboot",
        "failed_svcs", "sec_status"       # <--- ADDED
      ]

    # Construct the master row
    ncs_csv_data:
      - hostname: "{{ inventory_hostname }}"
        ip: "{{ ubuntu_ctx.system.ip | default('N/A') }}"
        kernel: "{{ ubuntu_ctx.system.kernel | default('N/A') }}"
        uptime: "{{ ubuntu_ctx.system.uptime_days | default(0) }}"

        # Aggregated Data from calculate.yaml
        health: "{{ ubuntu_ctx.summary.health }}"
        updates: "{{ ubuntu_ctx.updates.pending_count }}"
        reboot: "{{ ubuntu_ctx.updates.reboot_pending }}"
        failed_svcs: "{{ ubuntu_ctx.system.services.failed_count }}"

        # Security Status (Calculated from Shadow/Password Locking)
        sec_status: "{{ ubuntu_ctx.summary.security_status | default('UNKNOWN') }}"

  when: ubuntu_ctx.config.export_csv | default(true) | bool
