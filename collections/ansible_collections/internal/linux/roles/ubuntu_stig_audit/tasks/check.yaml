---
# internal.linux.ubuntu_stig_audit : tasks/check.yaml
#
# Runs DISA STIG rules in check_mode (read-only simulation).
# Skipped if hardening is enabled to avoid running the logic twice.
#
# Toggles:
#   ubuntu_stig_enable_audit:    true  - runs compliance checks
#   ubuntu_stig_enable_hardening: false - if true, skips audit

- name: "Ubuntu STIG | Evaluate compliance (read-only)"
  tags: [stig, security, audit]
  when:
    - ubuntu_stig_enable_audit    | default(false) | bool
    - not (ubuntu_stig_enable_hardening | default(false) | bool)
  block:
    - name: "Ubuntu STIG | Execute STIG rules"
      ansible.builtin.include_tasks: ubuntu2404.yaml
      args:
        apply:
          check_mode: true
      ignore_errors: true # noqa: ignore-errors

    - name: "Ubuntu STIG | Flag audit as complete"
      ansible.builtin.set_fact:
        _stig_audit_ran: true
