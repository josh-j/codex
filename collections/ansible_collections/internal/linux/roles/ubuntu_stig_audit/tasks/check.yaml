---
# internal.linux.ubuntu_stig_audit : tasks/check.yaml

- name: "Ubuntu STIG | Evaluate compliance (read-only)"
  tags: [stig, security, audit]
  when:
    - ubuntu_stig_enable_audit | default(true) | bool
    - not (ubuntu_stig_enable_hardening | default(false) | bool)
  block:
    - name: "Ubuntu STIG | Execute STIG rules in simulation"
      ansible.builtin.include_tasks: ubuntu2404.yaml
      args:
        apply:
          check_mode: true
          tags: [stig_task]
      # We rely on the stig_xml callback artifacts for reporting; include_tasks
      # does not reliably return per-task results for export.
      ignore_errors: true # noqa: ignore-errors

    - name: "Ubuntu STIG | Flag audit as complete"
      ansible.builtin.set_fact:
        _stig_audit_ran: true
      changed_when: false

    - name: "Ubuntu STIG | Debug expected callback artifact path"
      when: ubuntu_stig_debug_mode | default(false) | bool
      ansible.builtin.debug:
        msg: >-
          Expect stig_xml callback artifact at:
          {{ ncs_config | internal.core.resolve_ncs_path('artifacts', inventory_hostname, 'xccdf-results_' ~ inventory_hostname, 'json') }}
