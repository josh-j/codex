---
# collections/ansible_collections/internal/linux/roles/ubuntu_stig_audit/tasks/main.yaml

# =============================================================================
# Phase 0 | Preconditions / Input Validation
# =============================================================================

- name: "Ubuntu STIG | Phase 0 | Gather service facts"
  ansible.builtin.service_facts:

- name: "Ubuntu STIG | Phase 0 | Validate discovery data exists"
  ansible.builtin.include_role:
    name: internal.core.common
    tasks_from: validate_typed_schema.yaml
  vars:
    ncs_validate_data: "{{ ubuntu_ctx }}"
    ncs_validate_schema_ref: "internal.linux:schemas/ubuntu_ctx.yaml"
    ncs_validate_root_key: "ubuntu_ctx"
    ncs_validate_fail_msg: "STIG audit requires discovery data. Run ubuntu_system_discover first."

# =============================================================================
# Phase 1 | Evaluate
# =============================================================================

- name: "Ubuntu STIG | Phase 1 | Evaluate"
  block:
    - name: "Ubuntu STIG | Phase 1a | Run audit"
      ansible.builtin.import_tasks: check.yaml
      tags: [checks, stig, security]

  rescue:
    - name: "Ubuntu STIG | Phase 1r | Set failure flag"
      ansible.builtin.set_fact:
        _stig_audit_failed: true
      changed_when: false

    - name: "Ubuntu STIG | Phase 1r | Log failure"
      ansible.builtin.debug:
        msg: "STIG audit failed on {{ inventory_hostname }}. Exporting partial results."

  always:
    # =============================================================================
    # Phase 2 | Finalize / Export
    # =============================================================================
    - name: "Ubuntu STIG | Phase 2a | Read callback artifact"
      ansible.builtin.include_role:
        name: internal.core.stig
        tasks_from: read_callback_artifact.yaml
      vars:
        _stig_artifacts_dir: "{{ ncs_config | internal.core.resolve_ncs_path('artifacts', audit_type='stig') | dirname }}"
        _stig_artifact_host_hint: "{{ inventory_hostname }}"
        _stig_is_hardening: "{{ ubuntu_stig_enable_hardening | default(false) | bool }}"

    - name: "Ubuntu STIG | Phase 2b | Export reports via core finalize"
      ansible.builtin.include_role:
        name: internal.core.stig
        tasks_from: finalize.yaml
      vars:
        stig_quiet_mode: "{{ ubuntu_stig_quiet_mode | default(false) }}"
        stig_target_type: "{{ ubuntu_stig_target_type | default('ubuntu_2404') }}"
