---
# collections/ansible_collections/internal/linux/roles/ubuntu_stig_audit/tasks/main.yaml

# =============================================================================
# Phase 0 | Preconditions / Input Validation
# =============================================================================

- name: "Ubuntu STIG | Phase 0 | Gather service facts"
  ansible.builtin.service_facts:

- name: "Ubuntu STIG | Phase 0 | Validate discovery data exists"
  ansible.builtin.include_role:
    name: internal.core.common
    tasks_from: validate_typed_schema.yaml
  vars:
    ncs_validate_data: "{{ ubuntu_ctx }}"
    ncs_validate_schema_path: "{{ role_path ~ '/../ubuntu_system_discover/defaults/main.yaml' }}"
    ncs_validate_root_key: "ubuntu_ctx"
    ncs_validate_fail_msg: "STIG audit requires discovery data. Run ubuntu_system_discover first."

# =============================================================================
# Phase 1 | Evaluate
# =============================================================================

- name: "Ubuntu STIG | Phase 1 | Evaluate"
  block:
    - name: "Ubuntu STIG | Phase 1a | Run audit"
      ansible.builtin.import_tasks: check.yaml
      tags: [checks, stig, security]

  rescue:
    # Phase 1 rescue: preserve partial export path on failure.
    - name: "Ubuntu STIG | Phase 1r | Set failure flag"
      ansible.builtin.set_fact:
        _stig_audit_failed: true

    - name: "Ubuntu STIG | Phase 1r | Log failure"
      ansible.builtin.debug:
        msg: "STIG audit failed on {{ inventory_hostname }}. Exporting partial results."

  always:
    # =============================================================================
    # Phase 2 | Finalize / Export
    # =============================================================================
    - name: "Ubuntu STIG | Phase 2 | Process and export results"
      when: _stig_audit_ran | default(false)
      block:
        - name: "Ubuntu STIG | Phase 2a | Read callback artifact"
          ansible.builtin.slurp:
            src: "{{ ubuntu_stig_artifact_file }}"
          register: _artifact_raw
          delegate_to: localhost
          become: false
          ignore_errors: true

        - name: "Ubuntu STIG | Phase 2b | Load callback findings for core finalize"
          ansible.builtin.set_fact:
            audit_full_list: >-
              {{
                (
                  (_artifact_raw.content | b64decode | from_json)
                  if ('content' in _artifact_raw and not (_artifact_raw.failed | default(false)))
                  else []
                )
              }}

        - name: "Ubuntu STIG | Phase 2c | Export reports via core finalize"
          ansible.builtin.include_role:
            name: internal.core.stig
            tasks_from: finalize.yaml
          vars:
            stig_quiet_mode: "{{ ubuntu_stig_quiet_mode | default(false) }}"
            stig_target_type: "{{ ubuntu_stig_target_type | default('ubuntu2404') }}"
            ncs_export_path: >-
              {{
                (ncs_config.report_directory | default('/srv/samba/reports'))
                ~ '/platform/ubuntu/'
                ~ inventory_hostname
                ~ '/stig.yaml'
              }}
