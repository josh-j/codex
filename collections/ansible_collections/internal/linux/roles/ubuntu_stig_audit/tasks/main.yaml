---
# collections/ansible_collections/internal/linux/roles/ubuntu_stig_audit/tasks/main.yaml

- name: Validate discovery data exists dynamically
  ansible.builtin.assert:
    that:
      - ubuntu_ctx | internal.core.validate_schema_from_file(role_path ~ '/../ubuntu_system_discover/defaults/main.yaml', 'ubuntu_ctx')
    fail_msg: "STIG audit requires discovery data. Run ubuntu_system_discover first."

- name: Ubuntu STIG Audit
  block:
    - name: "Ubuntu STIG | Run audit"
      ansible.builtin.import_tasks: check.yaml
      tags: [checks, stig, security]

  rescue:
    # FIX: Split the rescue actions into two distinct tasks
    - name: "Ubuntu STIG | Set failure flag"
      ansible.builtin.set_fact:
        _stig_audit_failed: true

    - name: "Ubuntu STIG | Log failure"
      ansible.builtin.debug:
        msg: "STIG audit failed on {{ inventory_hostname }}. Exporting partial results."

  always:
    - name: "Ubuntu STIG | Process and Export Results"
      when: _stig_audit_ran | default(false)
      block:
        - name: "Ubuntu STIG | Read Callback Artifact"
          ansible.builtin.slurp:
            src: "{{ ubuntu_stig_artifact_file }}"
          register: _artifact_raw
          delegate_to: localhost
          become: false
          ignore_errors: true

        - name: "Ubuntu STIG | Load callback findings for core finalize"
          ansible.builtin.set_fact:
            audit_full_list: >-
              {{
                (
                  (_artifact_raw.content | b64decode | from_json)
                  if ('content' in _artifact_raw and not (_artifact_raw.failed | default(false)))
                  else []
                )
              }}

        - name: "Ubuntu STIG | Export reports via core finalize"
          ansible.builtin.include_role:
            name: internal.core.stig
            tasks_from: finalize.yaml
          vars:
            stig_quiet_mode: "{{ ubuntu_stig_quiet_mode | default(false) }}"
            stig_target_type: "{{ ubuntu_stig_target_type | default('ubuntu2404') }}"
            ncs_export_path: >-
              {{
                (ncs_config.report_directory | default('/srv/samba/reports'))
                ~ '/platform/ubuntu/'
                ~ inventory_hostname
                ~ '/stig.yaml'
              }}
