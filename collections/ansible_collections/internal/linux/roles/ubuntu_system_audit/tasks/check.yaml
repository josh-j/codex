---
# internal.linux.ubuntu_system_audit : check.yaml

- name: Evaluate system health
  ansible.builtin.set_fact:
    ubuntu_alerts: "{{ checks | internal.core.build_alerts }}"
  vars:
    _disks_over_warning: "{{ ubuntu_ctx.system.disks | selectattr('used_pct', 'gt', ubuntu_disk_warning_pct | int) | list }}"
    _disks_over_critical: "{{ ubuntu_ctx.system.disks | selectattr('used_pct', 'gt', 95) | list }}"
    checks:
      - condition: "{{ _disks_over_warning | length > 0 }}"
        severity: "{{ 'CRITICAL' if _disks_over_critical | length > 0 else 'WARNING' }}"
        category: capacity
        message: "{{ _disks_over_warning | length }} filesystem(s) over {{ ubuntu_disk_warning_pct }}% usage"
        detail:
          disks: "{{ _disks_over_warning }}"

      - condition: "{{ ubuntu_ctx.system.memory.used_pct | float > ubuntu_mem_warning_pct | int }}"
        severity: WARNING
        category: capacity
        message: "High memory usage: {{ ubuntu_ctx.system.memory.used_pct }}%"
        detail:
          total_mb: "{{ ubuntu_ctx.system.memory.total_mb }}"
          free_mb: "{{ ubuntu_ctx.system.memory.free_mb }}"

      - condition: >-
          {{
            ubuntu_ctx.system.swap.total_mb | int > 0 and
            ubuntu_ctx.system.swap.used_pct | float > ubuntu_swap_warning_pct | int
          }}
        severity: WARNING
        category: performance
        message: "High swap usage: {{ ubuntu_ctx.system.swap.used_pct }}%"
        detail: {}

      - condition: "{{ ubuntu_ctx.system.services.failed_list | length > 0 }}"
        severity: CRITICAL
        category: availability
        message: "{{ ubuntu_ctx.system.services.failed_count }} systemd service(s) in failed state"
        detail:
          failed_services: "{{ ubuntu_ctx.system.services.failed_list }}"

      - condition: "{{ ubuntu_ctx.system.load_avg | float > ubuntu_load_warning_threshold | int }}"
        severity: WARNING
        category: performance
        message: "High system load (15m avg): {{ ubuntu_ctx.system.load_avg }}"
        detail: {}

      - condition: "{{ ubuntu_ctx.system.uptime_days | int > 365 }}"
        severity: WARNING
        category: maintenance
        message: "Server has not rebooted in {{ ubuntu_ctx.system.uptime_days }} days (over 1 year)"
        detail: {}

      - condition: "{{ ubuntu_ctx.updates.pending_count | int > 0 }}"
        severity: "{{ 'CRITICAL' if ubuntu_ctx.updates.pending_count | int > ubuntu_updates_critical_threshold | int else 'WARNING' }}"
        category: patching
        message: "{{ ubuntu_ctx.updates.pending_count }} package(s) require updates"
        detail:
          reboot_pending: "{{ ubuntu_ctx.updates.reboot_pending }}"

      - condition: "{{ ubuntu_ctx.updates.reboot_pending | bool }}"
        severity: WARNING
        category: patching
        message: "Reboot required to apply pending updates"
        detail: {}

- name: Log alert summary
  ansible.builtin.debug:
    msg: >-
      {{ inventory_hostname }} |
      {{ ubuntu_alerts | length }} alert(s) |
      {{ ubuntu_alerts | selectattr('severity', 'equalto', 'CRITICAL') | list | length }} critical
