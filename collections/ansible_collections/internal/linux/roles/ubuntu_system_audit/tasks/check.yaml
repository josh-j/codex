---
# collections/ansible_collections/internal/linux/roles/ubuntu_system_audit/tasks/check.yaml

- name: Audit | Evaluate OS Health and Capacity
  ansible.builtin.set_fact:
    ubuntu_alerts: >-
      {{
        (checks | internal.core.build_alerts) +
        (ubuntu_ctx.system.memory.used_pct | internal.core.threshold_alert(
          'capacity',
          'Memory usage is high: ' ~ ubuntu_ctx.system.memory.used_pct ~ '%',
          98,
          ubuntu_mem_warning_pct | default(85),
          {'total_mb': ubuntu_ctx.system.memory.total_mb}
        )) + (_disk_alerts | default([]))
      }}
  vars:
    # Tiered Disk Logic: Evaluates every mount point independently
    _disk_alerts: >-
      {%- set d_alerts = [] -%}
      {%- for disk in ubuntu_ctx.system.disks | default([]) -%}
        {%- set alert = disk.used_pct | internal.core.threshold_alert(
          'capacity',
          'Storage saturation on ' ~ disk.mount ~ ': ' ~ disk.used_pct ~ '%',
          95,
          ubuntu_disk_warning_pct | default(80),
          {'device': disk.device, 'mount': disk.mount}
        ) -%}
        {%- if alert -%}{%- set _ = d_alerts.extend(alert) -%}{%- endif -%}
      {%- endfor -%}
      {{ d_alerts }}

    # Standard Policy Checks
    checks:
      - condition: "{{ ubuntu_ctx.system.services.failed_count | int > 0 }}"
        severity: CRITICAL
        category: availability
        message: "{{ ubuntu_ctx.system.services.failed_count }} systemd service(s) failed"
        detail:
          failed_list: "{{ ubuntu_ctx.system.services.failed_list }}"

      - condition: "{{ ubuntu_ctx.updates.reboot_pending | bool }}"
        severity: WARNING
        category: patching
        message: "System requires a reboot to apply kernel or security updates"

      - condition: "{{ ubuntu_ctx.system.load_avg | float > (ansible_facts['processor_vcpus'] | default(2) | int * 1.5) }}"
        severity: WARNING
        category: performance
        message: "System load is high relative to CPU count ({{ ubuntu_ctx.system.load_avg }})"

      - condition: "{{ ubuntu_ctx.system.uptime_days | int > 180 }}"
        severity: WARNING
        category: maintenance
        message: "Legacy Uptime: Server has not rebooted in over 6 months"
