---
# collections/ansible_collections/internal/linux/roles/ubuntu_system_audit/tasks/check.yaml

- name: Audit | Evaluate OS Health and Capacity
  ansible.builtin.set_fact:
    ubuntu_alerts: >-
      {{
        (checks | internal.core.build_alerts) +
        (ubuntu_ctx.system.memory.used_pct | internal.core.threshold_alert(
          'capacity',
          'Memory Saturation: ' ~ ubuntu_ctx.system.memory.used_pct ~ '%',
          98.0,
          ubuntu_memory_warning_pct | default(85.0),
          {'total_mb': ubuntu_ctx.system.memory.total_mb}
        )) + (_storage_alerts | default([]))
      }}
  vars:
    # Tiered Storage Logic: Evaluates every mount point independently
    _storage_alerts: >-
      {%- set s_alerts = [] -%}
      {%- for disk in ubuntu_ctx.system.disks | default([]) -%}
        {%- set alert = disk.used_pct | internal.core.threshold_alert(
          'capacity',
          'Storage Saturation on ' ~ disk.mount ~ ': ' ~ disk.used_pct ~ '%',
          95.0,
          ubuntu_storage_warning_pct | default(80.0),
          {'device': disk.device, 'mount': disk.mount}
        ) -%}
        {%- if alert -%}{%- set _ = s_alerts.extend(alert) -%}{%- endif -%}
      {%- endfor -%}
      {{ s_alerts }}

    # Standard Policy Checks
    checks:
      - condition: "{{ ubuntu_ctx.system.services.failed_count | int > 0 }}"
        severity: CRITICAL
        category: availability
        message: "{{ ubuntu_ctx.system.services.failed_count }} systemd service(s) failed"
        detail:
          failed_list: "{{ ubuntu_ctx.system.services.failed_list }}"

      - condition: "{{ ubuntu_ctx.updates.reboot_pending | bool }}"
        severity: WARNING
        category: patching
        message: "System requires a reboot to apply kernel or security updates"

      - condition: "{{ ubuntu_ctx.system.load_avg | float > (ansible_facts['processor_vcpus'] | default(2) | int * 1.5) }}"
        severity: WARNING
        category: performance
        message: "System Load High: {{ ubuntu_ctx.system.load_avg }} (relative to CPU count)"

      - condition: "{{ ubuntu_ctx.system.uptime_days | int > 180 }}"
        severity: WARNING
        category: maintenance
        message: "Uptime Policy Violation: Server has not rebooted in over 6 months"
