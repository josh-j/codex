---
# roles/ubuntu/tasks/system/check.yaml
# Analyze system metrics and alert on health issues.

# ========================================================================
# 1. DISK USAGE CHECKS
# ========================================================================
- name: "Check: High Disk Usage"
  ansible.builtin.include_role:
    name: internal.core.reporting
    tasks_from: alert.yaml
  vars:
    # 1. Define Threshold (Default: 90%)
    _threshold: "{{ ubuntu.config.disk_warning_pct | default(90) | int }}"

    # 2. Filter Disks exceeding threshold
    _full_disks: >-
      {{ ubuntu.system.disks
         | selectattr('used_pct', 'gt', _threshold)
         | list }}

    # 3. Alert Parameters
    ops_alert_severity: "{{ 'CRITICAL' if _full_disks | map(attribute='used_pct') | max | float > 95 else 'WARNING' }}"
    ops_alert_category: "capacity"
    ops_alert_message: "{{ _full_disks | length }} filesystems are nearly full (>{{ _threshold }}%)"
    ops_alert_details:
      mounts: "{{ _full_disks | map(attribute='mount') | list }}"
      details: "{{ _full_disks }}"

  when: _full_disks | length > 0

# ========================================================================
# 2. MEMORY & SWAP CHECKS
# ========================================================================
- name: "Check: High Memory Usage"
  ansible.builtin.include_role:
    name: internal.core.reporting
    tasks_from: alert.yaml
  vars:
    _threshold: "{{ ubuntu.config.mem_warning_pct | default(95) | int }}"
    _current: "{{ ubuntu.system.memory.used_pct | float }}"

    ops_alert_severity: "WARNING"
    ops_alert_category: "capacity"
    ops_alert_message: "High Memory Usage: {{ _current }}%"
    ops_alert_details:
      total_mb: "{{ ubuntu.system.memory.total_mb }}"
      free_mb: "{{ ubuntu.system.memory.free_mb }}"
  when: _current > _threshold

- name: "Check: High Swap Usage"
  ansible.builtin.include_role:
    name: internal.core.reporting
    tasks_from: alert.yaml
  vars:
    _threshold: "{{ ubuntu.config.swap_warning_pct | default(80) | int }}"
    _current: "{{ ubuntu.system.swap.used_pct | float }}"

    ops_alert_severity: "WARNING"
    ops_alert_category: "performance"
    ops_alert_message: "High Swap Usage: {{ _current }}%"
  when:
    - ubuntu.system.swap.total_mb | int > 0
    - _current > _threshold

# ========================================================================
# 3. SERVICE HEALTH
# ========================================================================
- name: "Check: Failed System Services"
  ansible.builtin.include_role:
    name: internal.core.reporting
    tasks_from: alert.yaml
  vars:
    _failed: "{{ ubuntu.system.services.failed_list }}"

    ops_alert_severity: "CRITICAL"
    ops_alert_category: "availability"
    ops_alert_message: "{{ _failed | length }} systemd services are in a failed state"
    ops_alert_details:
      failed_services: "{{ _failed }}"
  when: _failed | length > 0

# ========================================================================
# 4. LOAD & UPTIME
# ========================================================================
- name: "Check: High System Load (15m)"
  ansible.builtin.include_role:
    name: internal.core.reporting
    tasks_from: alert.yaml
  vars:
    # Simple threshold: Load > 4x Core count is usually bad.
    # For simplicity here, we default to a flat number (e.g., 20) or user config.
    _threshold: "{{ ubuntu.config.load_warning_threshold | default(20) | int }}"
    _current: "{{ ubuntu.system.load_avg | float }}"

    ops_alert_severity: "WARNING"
    ops_alert_category: "performance"
    ops_alert_message: "High System Load (15m): {{ _current }}"
  when: _current > _threshold

- name: "Check: Long Uptime (>1 Year)"
  ansible.builtin.include_role:
    name: internal.core.reporting
    tasks_from: alert.yaml
  vars:
    _threshold: 365
    _current: "{{ ubuntu.system.uptime_days | int }}"

    ops_alert_severity: "WARNING"
    ops_alert_category: "maintenance"
    ops_alert_message: "Server has not been rebooted in over a year ({{ _current }} days)"
  when: _current > _threshold

# ========================================================================
# 5. Analyze patching status and generate alerts
# ========================================================================
- name: "Check: Pending OS Updates"
  ansible.builtin.include_role:
    name: internal.core.reporting
    tasks_from: alert.yaml
  vars:
    _count: "{{ ubuntu.updates.pending_count | int }}"
    # Configurable threshold (Default: 50)
    _crit_threshold: "{{ ubuntu.config.updates_critical_threshold | default(50) | int }}"

    ops_alert_severity: "{{ 'CRITICAL' if _count > _crit_threshold else 'WARNING' }}"
    ops_alert_category: "patching"
    ops_alert_message: "{{ _count }} packages require updates"
    ops_alert_details:
      count: "{{ _count }}"
      reboot_pending: "{{ ubuntu.updates.reboot_pending }}"
  when: _count > 0

- name: "Check: Reboot Pending"
  ansible.builtin.include_role:
    name: internal.core.reporting
    tasks_from: alert.yaml
  vars:
    ops_alert_severity: "WARNING"
    ops_alert_category: "patching"
    ops_alert_message: "Server requires reboot to apply updates"
    ops_alert_details:
      pending_since: "Unknown" # apt doesn't easily track *when* the flag was set
  when: ubuntu.updates.reboot_pending | bool

