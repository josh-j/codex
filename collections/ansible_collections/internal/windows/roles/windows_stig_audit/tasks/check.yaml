---
# internal.windows.windows_stig_audit : tasks/check.yaml
#
# Minimal native Windows Server STIG baseline checks.
# Produces canonical-ish STIG rows consumed by internal.core.stig/finalize.yaml.

- name: "Windows STIG | Gather native baseline facts"
  ansible.windows.win_powershell:
    script: |
      $facts = @{
        name = $env:COMPUTERNAME
      }

      # 1) RDP NLA
      try {
        $nla = Get-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name UserAuthentication -ErrorAction SilentlyContinue
        $facts['rdp_nla'] = if ($nla) { [int]$nla.UserAuthentication } else { $null }
      } catch { $facts['rdp_nla'] = $null }

      # 2) Firewall Profiles
      try {
        $profiles = Get-NetFirewallProfile -ErrorAction SilentlyContinue
        $facts['firewall_disabled_profiles'] = @($profiles | Where-Object { -not $_.Enabled } | Select-Object -ExpandProperty Name)
      } catch { $facts['firewall_disabled_profiles'] = @('ERROR') }

      # 3) SMBv1
      try {
        $feature = Get-WindowsOptionalFeature -Online -FeatureName SMB1Protocol -ErrorAction SilentlyContinue
        $facts['smb1_state'] = if ($feature) { [string]$feature.State } else { 'Unknown' }
      } catch { $facts['smb1_state'] = 'ERROR' }

      # 4) Guest account
      try {
        $guest = Get-LocalUser -Name 'Guest' -ErrorAction SilentlyContinue
        $facts['guest_enabled'] = if ($guest) { [bool]$guest.Enabled } else { $null }
      } catch { $facts['guest_enabled'] = $null }

      # 5) Password complexity
      try {
        $cfg = Join-Path $env:TEMP 'secpol-export.cfg'
        secedit /export /cfg $cfg | Out-Null
        $line = Select-String -Path $cfg -Pattern '^PasswordComplexity\s*=\s*(\d+)\s*$' | Select-Object -First 1
        $facts['password_complexity'] = if ($line) { [int]$line.Matches[0].Groups[1].Value } else { -1 }
        Remove-Item $cfg -ErrorAction SilentlyContinue
      } catch { $facts['password_complexity'] = -2 }

      # 6) Defender
      try {
        $mp = Get-MpComputerStatus -ErrorAction SilentlyContinue
        $facts['defender_realtime'] = if ($mp) { [bool]$mp.RealTimeProtectionEnabled } else { $null }
      } catch { $facts['defender_realtime'] = $null }

      # 7/8) WinRM
      try {
        $svc = winrm get winrm/config/service
        $facts['winrm_allow_unencrypted'] = if ($svc -match 'AllowUnencrypted\s*=\s*(\w+)') { $Matches[1] } else { 'Unknown' }
        $auth = winrm get winrm/config/service/auth
        $facts['winrm_basic_auth'] = if ($auth -match 'Basic\s*=\s*(\w+)') { $Matches[1] } else { 'Unknown' }
      } catch {
        $facts['winrm_allow_unencrypted'] = 'ERROR'
        $facts['winrm_basic_auth'] = 'ERROR'
      }

      # 9) UAC Admin Approval
      try {
        $uac = Get-ItemProperty -Path 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System' -Name FilterAdministratorToken -ErrorAction SilentlyContinue
        $facts['uac_filter_admin'] = if ($uac) { [int]$uac.FilterAdministratorToken } else { $null }
      } catch { $facts['uac_filter_admin'] = $null }

      # 10) Audit Logon
      try {
        $auditpol = auditpol /get /subcategory:"Logon" /r
        $csv = $auditpol | ConvertFrom-Csv
        $facts['audit_logon_setting'] = if ($csv) { [string]($csv[0].'Inclusion Setting') } else { 'Unknown' }
      } catch { $facts['audit_logon_setting'] = 'ERROR' }

      $facts | ConvertTo-Json -Compress
  register: _windows_stig_facts_result

- name: "Windows STIG | Evaluate compliance"
  ansible.builtin.include_role:
    name: internal.core.stig
    tasks_from: audit_orchestrator
  vars:
    _facts: "{{ _windows_stig_facts_result.output[0] | from_json }}"
    raw_discovery_data: ["{{ _facts }}"]
    audit_logic_inline: |
      {{- [
        {
          "id": "WN-SRV-000001",
          "title": "RDP must require Network Level Authentication (NLA)",
          "severity": "CAT_II",
          "check": (_facts.rdp_nla == 1),
          "fail_msg": "UserAuthentication=" ~ (_facts.rdp_nla | default('null'))
        },
        {
          "id": "WN-SRV-000002",
          "title": "Windows Firewall must be enabled for all profiles",
          "severity": "CAT_I",
          "check": (_facts.firewall_disabled_profiles | length == 0),
          "fail_msg": "Disabled profiles: " ~ (_facts.firewall_disabled_profiles | join(', '))
        },
        {
          "id": "WN-SRV-000003",
          "title": "SMBv1 protocol must be disabled",
          "severity": "CAT_I",
          "check": (_facts.smb1_state in ['Disabled', 'DisabledWithPayloadRemoved']),
          "fail_msg": "SMB1Protocol State=" ~ _facts.smb1_state
        },
        {
          "id": "WN-SRV-000004",
          "title": "Guest account must be disabled",
          "severity": "CAT_II",
          "check": (_facts.guest_enabled == false),
          "fail_msg": "Guest Enabled=" ~ (_facts.guest_enabled | default('null'))
        },
        {
          "id": "WN-SRV-000005",
          "title": "Password complexity must be enabled",
          "severity": "CAT_II",
          "check": (_facts.password_complexity == 1),
          "fail_msg": "PasswordComplexity=" ~ _facts.password_complexity
        },
        {
          "id": "WN-SRV-000006",
          "title": "Microsoft Defender real-time protection must be enabled",
          "severity": "CAT_II",
          "check": (_facts.defender_realtime == true),
          "fail_msg": "RealTimeProtectionEnabled=" ~ (_facts.defender_realtime | default('null'))
        },
        {
          "id": "WN-SRV-000007",
          "title": "WinRM must not allow unencrypted traffic",
          "severity": "CAT_I",
          "check": (_facts.winrm_allow_unencrypted | lower in ['false']),
          "fail_msg": "AllowUnencrypted=" ~ _facts.winrm_allow_unencrypted
        },
        {
          "id": "WN-SRV-000008",
          "title": "WinRM Basic authentication must be disabled",
          "severity": "CAT_I",
          "check": (_facts.winrm_basic_auth | lower in ['false']),
          "fail_msg": "WinRM Basic=" ~ _facts.winrm_basic_auth
        },
        {
          "id": "WN-SRV-000009",
          "title": "UAC Admin Approval Mode for the built-in Administrator account must be enabled",
          "severity": "CAT_II",
          "check": (_facts.uac_filter_admin == 1),
          "fail_msg": "FilterAdministratorToken=" ~ (_facts.uac_filter_admin | default('null'))
        },
        {
          "id": "WN-SRV-000010",
          "title": "Audit Logon events must record both success and failure",
          "severity": "CAT_II",
          "check": (_facts.audit_logon_setting is search('Success') and _facts.audit_logon_setting is search('Failure')),
          "fail_msg": "Logon Audit Setting=" ~ _facts.audit_logon_setting
        }
      ] | internal.core.stig_eval | to_json -}}

- name: "Windows STIG | Mark audit as complete"
  ansible.builtin.set_fact:
    _stig_audit_ran: true
  changed_when: false
