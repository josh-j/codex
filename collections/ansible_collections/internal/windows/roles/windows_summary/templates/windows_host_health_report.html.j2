<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Windows Host Health - {{ inventory_hostname }}</title>
  <style>{{ '' | internal.core.shared_report_css }}</style>
</head>
<body>
{% set view = windows_node_view | default({}) %}
{% set node = view.get('node', {}) %}
{% set meta = view.get('meta', {}) %}
{% set summary = node.get('summary', {}) %}
{% set apps = summary.get('applications', {}) %}
{% set updates = summary.get('updates', {}) %}
{% set services = summary.get('services', {}) %}
{% set data = node.get('data', {}) %}
{% set update_results = (data.get('updates', {}) or {}).get('results', []) %}
{% set pending_apps = (data.get('applications', {}) or {}).get('apps_to_update', []) %}
{% set badge = (node.get('status', {}).get('raw', 'UNKNOWN')) | internal.core.status_badge_meta %}
<div class="report-shell">
  <header class="report-header">
    <h1>Windows Host Health - {{ node.get('name', inventory_hostname) }}</h1>
    <p><span class="badge {{ badge.css_class }}">{{ badge.label }}</span></p>
    <p>
      <a href="{{ node.get('links', {}).get('global_dashboard', '../../../site_health_report.html') }}">Global Site</a>
      /
      <a href="{{ node.get('links', {}).get('fleet_dashboard', '../windows_health_report.html') }}">Windows Fleet</a>
    </p>
    {% if meta.get('report_date') %}
    <p style="color: var(--text-muted);">Generated: {{ meta.get('report_date') }}</p>
    {% endif %}
  </header>
  <section class="card-wrap">
    <table>
      <tbody>
        <tr><th>CCMExec Running</th><td>{{ services.get('ccmexec_running', false) }}</td></tr>
        <tr><th>ConfigMgr Apps</th><td>{{ apps.get('configmgr_count', 0) }}</td></tr>
        <tr><th>Installed Apps</th><td>{{ apps.get('installed_count', 0) }}</td></tr>
        <tr><th>Apps To Update</th><td>{{ apps.get('apps_to_update_count', 0) }}</td></tr>
        <tr><th>Update Results</th><td>{{ updates.get('results_count', 0) }}</td></tr>
        <tr><th>Update Failures</th><td>{{ updates.get('failed_count', 0) }}</td></tr>
      </tbody>
    </table>
  </section>
  {% set alerts = node.get('alerts', []) %}
  <section class="card-wrap">
    <h2>Alerts</h2>
    <table>
      <thead><tr><th>Severity</th><th>Category</th><th>Message</th></tr></thead>
      <tbody>
      {% for alert in alerts %}
      {% set badge = (alert.get('severity', 'INFO')) | internal.core.status_badge_meta %}
      <tr>
        <td><span class="badge {{ badge.css_class }}">{{ badge.label }}</span></td>
        <td>{{ alert.get('category', 'windows') }}</td>
        <td>
          <div>{{ alert.get('message', '') }}</div>
          {% set detail = alert.get('detail', {}) %}
          {% if detail and detail|length > 0 %}
          <details style="margin-top: 6px;">
            <summary style="cursor: pointer; color: var(--text-muted);">Technical details</summary>
            <div style="margin-top: 8px;">
              <table>
                <tbody>
                  {% for k, v in detail.items() %}
                  <tr>
                    <th style="width: 180px;">{{ k }}</th>
                    <td><code>{{ v }}</code></td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </details>
          {% endif %}
          {% if alert.get('recommendation') or alert.get('remediation') %}
          <div style="margin-top: 6px; color: var(--text-muted);">
            <strong>Remediation:</strong> {{ alert.get('recommendation', alert.get('remediation', '')) }}
          </div>
          {% endif %}
        </td>
      </tr>
      {% else %}
      <tr><td colspan="3">No alerts</td></tr>
      {% endfor %}
      </tbody>
    </table>
  </section>
  <section class="card-wrap">
    <h2>Pending ConfigMgr Updates</h2>
    <table>
      <thead><tr><th>Application</th><th>Current</th><th>Target</th><th>Reason</th></tr></thead>
      <tbody>
      {% for app in pending_apps %}
      <tr>
        <td>{{ app.get('Name', app.get('name', 'unknown')) }}</td>
        <td>{{ app.get('Current Version', app.get('CurrentVersion', app.get('current_version', ''))) }}</td>
        <td>{{ app.get('Target Version', app.get('TargetVersion', app.get('target_version', ''))) }}</td>
        <td>{{ app.get('Update Reason', app.get('UpdateReason', app.get('reason', ''))) }}</td>
      </tr>
      {% else %}
      <tr><td colspan="4">No pending ConfigMgr updates recorded.</td></tr>
      {% endfor %}
      </tbody>
    </table>
  </section>
  <section class="card-wrap">
    <h2>Recent Update Results</h2>
    <table>
      <thead><tr><th>Application</th><th>Failed</th><th>Message</th></tr></thead>
      <tbody>
      {% for r in update_results %}
      <tr>
        <td>{{ r.get('item', {}).get('Name', r.get('item', r.get('ApplicationName', 'unknown'))) }}</td>
        <td>{{ r.get('failed', false) }}</td>
        <td>{{ r.get('msg', r.get('message', '')) }}</td>
      </tr>
      {% else %}
      <tr><td colspan="3">No update results captured.</td></tr>
      {% endfor %}
      </tbody>
    </table>
  </section>
</div>
</body>
</html>
