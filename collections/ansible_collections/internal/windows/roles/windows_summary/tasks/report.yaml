---
- name: Phase 3 | Generate Windows Node & Fleet Reports
  delegate_to: localhost
  run_once: true
  vars:
    _playbooks_root: "{{ playbook_dir | dirname }}"
    _reports_root: "{{ ncs_config.report_directory | default('/srv/samba/reports') }}"
    _platform_root: "{{ _reports_root }}/platform"
    _windows_report_dir: "{{ _platform_root }}/windows"
    _windows_reporting_skip_keys: >-
      {{
        (
          '' | internal.core.report_skip_keys
        )
        | union(['windows_fleet_state'])
      }}
    report_stamp: "{{ now(utc=true, fmt='%Y%m%d') }}"
    report_date: "{{ now(utc=true, fmt='%Y-%m-%d %H:%M:%S') }}"
    report_id: "{{ now(utc=true, fmt='%Y%m%dT%H%M%SZ') }}"
  block:
    # Phase 3a | Aggregate platform state
    - name: Prepare Windows aggregated platform state
      ansible.builtin.include_role:
        name: internal.core.reporting
        tasks_from: prepare_platform_state.yaml
      vars:
        ncs_reporting_scripts_dir: "{{ _playbooks_root }}/scripts"
        ncs_reporting_platform_dir: "{{ _windows_report_dir }}"
        ncs_reporting_aggregate_output: "{{ _windows_report_dir }}/windows_fleet_state.yaml"
        ncs_reporting_aggregate_var_name: "windows_aggregated_hosts"

    # Phase 3b | Ensure host directories
    - name: Ensure per-host report directories exist
      ansible.builtin.include_role:
        name: internal.core.reporting
        tasks_from: host_loop_ensure_dirs.yaml
      vars:
        ncs_reporting_hosts_map: "{{ windows_aggregated_hosts.hosts | default(windows_aggregated_hosts) }}"
        ncs_reporting_host_dir_root: "{{ _windows_report_dir }}"
        ncs_reporting_skip_keys: "{{ _windows_reporting_skip_keys }}"

    # Phase 3c | Render host reports
    - name: Render detailed per-host Windows HTML reports
      ansible.builtin.include_role:
        name: internal.core.reporting
        tasks_from: host_loop_render_template.yaml
      vars:
        ncs_reporting_hosts_map: "{{ windows_aggregated_hosts.hosts | default(windows_aggregated_hosts) }}"
        ncs_reporting_template_src: "windows_host_health_report.html.j2"
        ncs_reporting_template_dest: "{{ _windows_report_dir }}/{{ item.key }}/health_report_{{ report_stamp }}.html"
        ncs_reporting_skip_keys: "{{ _windows_reporting_skip_keys }}"
        ncs_reporting_item_vars:
          windows_node_view: >-
            {{
              (item.value | default({}))
              | internal.windows.windows_node_view(
                hostname=item.key,
                report_stamp=report_stamp,
                report_date=report_date,
                report_id=report_id
              )
            }}

    # Phase 3d | Build fleet view model
    - name: Build Windows fleet dashboard view model
      ansible.builtin.set_fact:
        windows_fleet_view: >-
          {{
            (windows_aggregated_hosts.hosts | default(windows_aggregated_hosts))
            | internal.windows.windows_fleet_view(
              report_stamp=report_stamp,
              report_date=report_date,
              report_id=report_id
            )
          }}

    # Phase 3e | Render fleet report
    - name: Render Windows Fleet HTML Report
      ansible.builtin.template:
        src: "windows_health_report.html.j2"
        dest: "{{ _windows_report_dir }}/windows_health_report_{{ report_stamp }}.html"
        mode: "0644"

    # Phase 3f | Maintain fleet latest symlink
    - name: Maintain latest Windows fleet symlink
      ansible.builtin.file:
        src: "windows_health_report_{{ report_stamp }}.html"
        dest: "{{ _windows_report_dir }}/windows_health_report.html"
        state: link
        force: true

    # Phase 3g | Maintain host latest symlinks
    - name: Maintain latest Windows host symlinks
      ansible.builtin.include_role:
        name: internal.core.reporting
        tasks_from: host_loop_latest_symlink.yaml
      vars:
        ncs_reporting_hosts_map: "{{ windows_aggregated_hosts.hosts | default(windows_aggregated_hosts) }}"
        ncs_reporting_host_dir_root: "{{ _windows_report_dir }}"
        ncs_reporting_latest_src_name: "health_report_{{ report_stamp }}.html"
        ncs_reporting_latest_dest_name: "health_report.html"
        ncs_reporting_skip_keys: "{{ _windows_reporting_skip_keys }}"
