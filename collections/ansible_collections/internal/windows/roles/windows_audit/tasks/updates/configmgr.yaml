---
# configmgr.yaml - ConfigMgr Application Updates

- name: Initialize Role Context
  ansible.builtin.include_role:
    name: internal.windows.common
    tasks_from: sync_ctx

- name: ConfigMgr application update management
  block:
    - name: Initialize Windows ConfigMgr namespace
      ansible.builtin.set_fact:
        windows_ctx: "{{ windows_ctx | internal.core.recursive_combine(structure) }}"
      vars:
        structure:
          config:
            startup_delay: "{{ startup_delay | default(0) }}"
            skip_startup_delay: "{{ skip_startup_delay | default(false) }}"
            remote_scripts_path: "{{ remote_scripts_path | default('C:\\Temp\\AnsibleScripts') }}"
            update_log_directory: "{{ update_log_directory | default('C:\\Temp\\ConfigMgrLogs') }}"
            excluded_apps: "{{ excluded_apps | default([]) }}"
            force_update: "{{ force_update | default(false) }}"
            allow_reboot: "{{ allow_reboot | default(false) }}"
            enforce_preference: "{{ enforce_preference | default('Immediate') }}"
            update_priority: "{{ update_priority | default('Normal') }}"
            cleanup_old_logs: "{{ cleanup_old_logs | default(true) }}"
            export_csv: true
          services:
            ccmexec_running: false
          applications:
            apps_to_update: []
            excluded_apps: []
            already_current: []
            total_apps: 0
            summary: {}
          updates:
            results: []
            logs: []

    - name: Add startup delay
      ansible.windows.win_shell: Start-Sleep -Seconds {{ windows_ctx.config.startup_delay }}
      when: not windows_ctx.config.skip_startup_delay | bool

    - name: Check if CCMExec service is running
      ansible.windows.win_service:
        name: CCMExec
      register: _ccm_service

    - name: Store CCMExec status and fail if not running
      ansible.builtin.set_fact:
        windows_ctx: "{{ windows_ctx | combine({'services': {'ccmexec_running': _ccm_service.state == 'running'}}, recursive=true) }}"

    - name: Fail if CCMExec is not running
      ansible.builtin.fail:
        msg: "ConfigMgr client service (CCMExec) is not running"
      when: not windows_ctx.services.ccmexec_running

    - name: Create log directory on remote host
      ansible.windows.win_file:
        path: "{{ windows_ctx.config.update_log_directory }}"
        state: directory

    - name: Ensure scripts directory exists
      ansible.windows.win_file:
        path: "{{ windows_ctx.config.remote_scripts_path }}"
        state: directory

    - name: Copy Get-ConfigMgrApplications.ps1 script
      ansible.windows.win_copy:
        src: Get-ConfigMgrApplications.ps1
        dest: "{{ windows_ctx.config.remote_scripts_path }}\\Get-ConfigMgrApplications.ps1"

    - name: Copy Update-ConfigMgrApplication.ps1 script
      ansible.windows.win_copy:
        src: Update-ConfigMgrApplication.ps1
        dest: "{{ windows_ctx.config.remote_scripts_path }}\\Update-ConfigMgrApplication.ps1"

    - name: Get and filter ConfigMgr applications
      ansible.windows.win_powershell:
        script: |
          param([string[]]$ExcludedPatterns)
          & "{{ windows_ctx.config.remote_scripts_path }}\\Get-ConfigMgrApplications.ps1" -ExcludedPatterns $ExcludedPatterns
        parameters:
          ExcludedPatterns: "{{ windows_ctx.config.excluded_apps }}"
      register: _filtered_apps_result

    - name: Parse filtered applications
      ansible.builtin.set_fact:
        windows_ctx: "{{ windows_ctx | combine({'applications': apps_data}, recursive=true) }}"
      vars:
        filtered_data: "{{ _filtered_apps_result.output[0] | from_json }}"
        apps_data:
          apps_to_update: "{{ filtered_data.AppsToUpdate | default([]) }}"
          excluded_apps: "{{ filtered_data.ExcludedApps | default([]) }}"
          already_current: "{{ filtered_data.AlreadyCurrent | default([]) }}"
          total_apps: "{{ filtered_data.AllApps | default(0) }}"
          summary: "{{ filtered_data.Summary | default({}) }}"

    - name: Log update summary
      ansible.builtin.include_role:
        name: internal.core.common
        tasks_from: logging/info
      vars:
        ncs_log_message: >-
          ConfigMgr Apps: {{ windows_ctx.applications.total_apps }} total,
          {{ windows_ctx.applications.apps_to_update | length }} to update,
          {{ windows_ctx.applications.excluded_apps | length }} excluded

    - name: Trigger ConfigMgr application updates
      ansible.windows.win_powershell:
        script: |
          param(
            [string]$ApplicationName,
            [string]$LogDirectory,
            [bool]$Force,
            [bool]$AllowReboot,
            [string]$EnforcePreference,
            [string]$Priority
          )
          & "{{ windows_ctx.config.remote_scripts_path }}\Update-ConfigMgrApplication.ps1" `
            -ApplicationName $ApplicationName `
            -LogDirectory $LogDirectory `
            -Force $Force `
            -AllowReboot $AllowReboot `
            -EnforcePreference $EnforcePreference `
            -Priority $Priority `
            -NoWait
        parameters:
          ApplicationName: "{{ item.Name }}"
          LogDirectory: "{{ windows_ctx.config.update_log_directory }}"
          Force: "{{ windows_ctx.config.force_update }}"
          AllowReboot: "{{ windows_ctx.config.allow_reboot }}"
          EnforcePreference: "{{ windows_ctx.config.enforce_preference }}"
          Priority: "{{ windows_ctx.config.update_priority }}"
      loop: "{{ windows_ctx.applications.apps_to_update }}"
      loop_control:
        label: "{{ item.Name }}"
      register: _update_results
      when: windows_ctx.applications.apps_to_update | length > 0

    - name: Store update results
      ansible.builtin.set_fact:
        windows_ctx: "{{ windows_ctx | combine({'updates': {'results': _update_results.results | default([])}}, recursive=true) }}"

    # ========================================================================
    # CSV EXPORT
    # ========================================================================

    - name: Export apps to update to CSV
      ansible.builtin.include_role:
        name: internal.core.reporting
        tasks_from: export_csv.yaml
      vars:
        ncs_csv_report_name: "configmgr_apps_to_update"
        ncs_csv_headers: ["Server", "App Name", "Current Version", "Target Version", "Update Reason"]
        ncs_csv_data: "{{ windows_ctx.applications.apps_to_update }}"
        ncs_csv_sort_by: "App Name"
      when:
        - windows_ctx.config.export_csv
        - windows_ctx.applications.apps_to_update | length > 0

  rescue:
    - name: Log ConfigMgr update failure
      ansible.builtin.include_role:
          name: internal.core.common
          tasks_from: logging/error
      vars:
        ncs_log_message: "ConfigMgr update process failed: {{ ansible_failed_result.msg | default('Unknown error') }}"

    - name: Set empty update data
      ansible.builtin.set_fact:
        windows_ctx: "{{ windows_ctx | combine({'applications': empty_apps, 'updates': empty_updates}, recursive=true) }}"
      vars:
        empty_apps:
          apps_to_update: []
          excluded_apps: []
          already_current: []
          total_apps: 0
          summary: {}
        empty_updates:
          results: []
          logs: []

- name: Finalize Windows Context
  ansible.builtin.set_fact:
    windows: "{{ windows_ctx }}"
  changed_when: false
