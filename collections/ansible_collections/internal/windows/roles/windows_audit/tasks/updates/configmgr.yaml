---
# configmgr.yaml - ConfigMgr Application Updates

- name: ConfigMgr application update management
  block:
    - name: Initialize Windows ConfigMgr namespace
      ansible.builtin.set_fact:
        windows_ctx: "{{ windows_ctx | internal.core.recursive_combine(structure) }}"
      vars:
        structure:
          config:
            startup_delay: "{{ windows_audit_startup_delay | default(0) | int }}"
            skip_startup_delay: "{{ windows_audit_skip_startup_delay | default(false) | bool }}"
            remote_scripts_path: "{{ windows_audit_remote_scripts_path | default('C:\\Temp\\AnsibleScripts') }}"
            update_log_directory: "{{ windows_audit_update_log_directory | default('C:\\Temp\\ConfigMgrLogs') }}"
            excluded_apps: "{{ windows_audit_excluded_apps | default([]) }}"
            force_update: "{{ windows_audit_force_update | default(false) | bool }}"
            allow_reboot: "{{ windows_audit_allow_reboot | default(false) | bool }}"
            enforce_preference: "{{ windows_audit_enforce_preference | default('Immediate') }}"
            update_priority: "{{ windows_audit_update_priority | default('Normal') }}"
            cleanup_old_logs: "{{ cleanup_old_logs | default(true) | bool }}"
            export_csv: true
          services:
            ccmexec_running: false
          applications:
            apps_to_update: []
            excluded_apps: []
            already_current: []
            total_apps: 0
            summary: {}
          updates:
            results: []
            logs: []

    - name: Add startup delay
      ansible.windows.win_shell: Start-Sleep -Seconds {{ windows_ctx.config.startup_delay }}
      when: not windows_ctx.config.skip_startup_delay | bool

    - name: Check if CCMExec service is running
      ansible.windows.win_service:
        name: CCMExec
      register: _ccm_service

    - name: Store CCMExec status
      ansible.builtin.set_fact:
        _win_ccmexec_running: "{{ _ccm_service.state == 'running' }}"

    - name: Fail if CCMExec is not running
      ansible.builtin.fail:
        msg: "ConfigMgr client service (CCMExec) is not running"
      when: not _win_ccmexec_running | bool

    - name: Create log directory on remote host
      ansible.windows.win_file:
        path: "{{ windows_ctx.config.update_log_directory }}"
        state: directory

    - name: Ensure scripts directory exists
      ansible.windows.win_file:
        path: "{{ windows_ctx.config.remote_scripts_path }}"
        state: directory

    - name: Copy Get-ConfigMgrApplications.ps1 script
      ansible.windows.win_copy:
        src: Get-ConfigMgrApplications.ps1
        dest: "{{ windows_ctx.config.remote_scripts_path }}\\Get-ConfigMgrApplications.ps1"

    - name: Copy Update-ConfigMgrApplication.ps1 script
      ansible.windows.win_copy:
        src: Update-ConfigMgrApplication.ps1
        dest: "{{ windows_ctx.config.remote_scripts_path }}\\Update-ConfigMgrApplication.ps1"

    - name: Get and filter ConfigMgr applications
      ansible.windows.win_powershell:
        script: |
          param([string[]]$ExcludedPatterns)
          & "{{ windows_ctx.config.remote_scripts_path }}\\Get-ConfigMgrApplications.ps1" -ExcludedPatterns $ExcludedPatterns
        parameters:
          ExcludedPatterns: "{{ windows_ctx.config.excluded_apps }}"
      register: _filtered_apps_result

    - name: Parse filtered applications
      ansible.builtin.set_fact:
        _win_apps_to_update: "{{ filtered_data.AppsToUpdate | default([]) }}"
        _win_excluded_apps: "{{ filtered_data.ExcludedApps | default([]) }}"
        _win_already_current: "{{ filtered_data.AlreadyCurrent | default([]) }}"
        _win_total_apps: "{{ filtered_data.AllApps | default(0) }}"
        _win_app_summary: "{{ filtered_data.Summary | default({}) }}"
      vars:
        filtered_data: "{{ _filtered_apps_result.output[0] | from_json }}"

    - name: Log update summary
      ansible.builtin.include_role:
        name: internal.core.common
        tasks_from: logging/info
      vars:
        ncs_log_message: >-
          ConfigMgr Apps: {{ _win_total_apps }} total,
          {{ _win_apps_to_update | length }} to update,
          {{ _win_excluded_apps | length }} excluded

    - name: Trigger ConfigMgr application updates
      ansible.windows.win_powershell:
        script: |
          param(
            [string]$ApplicationName,
            [string]$LogDirectory,
            [bool]$Force,
            [bool]$AllowReboot,
            [string]$EnforcePreference,
            [string]$Priority
          )
          & "{{ windows_ctx.config.remote_scripts_path }}\Update-ConfigMgrApplication.ps1" `
            -ApplicationName $ApplicationName `
            -LogDirectory $LogDirectory `
            -Force $Force `
            -AllowReboot $AllowReboot `
            -EnforcePreference $EnforcePreference `
            -Priority $Priority `
            -NoWait
        parameters:
          ApplicationName: "{{ item.Name }}"
          LogDirectory: "{{ windows_ctx.config.update_log_directory }}"
          Force: "{{ windows_ctx.config.force_update }}"
          AllowReboot: "{{ windows_ctx.config.allow_reboot }}"
          EnforcePreference: "{{ windows_ctx.config.enforce_preference }}"
          Priority: "{{ windows_ctx.config.update_priority }}"
      loop: "{{ _win_apps_to_update }}"
      loop_control:
        label: "{{ item.Name }}"
      register: _update_results
      when: _win_apps_to_update | length > 0

    - name: Store update results
      ansible.builtin.set_fact:
        _win_update_results: "{{ _update_results.results | default([]) }}"

    - name: Assemble windows_ctx with update results
      ansible.builtin.set_fact:
        windows_ctx:
          config: "{{ windows_ctx.config }}"
          services:
            ccmexec_running: "{{ _win_ccmexec_running }}"
          applications:
            configmgr_apps: "{{ windows_ctx.applications.configmgr_apps }}"
            installed_apps: "{{ windows_ctx.applications.installed_apps }}"
            metrics: "{{ windows_ctx.applications.metrics }}"
            apps_to_update: "{{ _win_apps_to_update }}"
            excluded_apps: "{{ _win_excluded_apps }}"
            already_current: "{{ _win_already_current }}"
            total_apps: "{{ _win_total_apps }}"
            summary: "{{ _win_app_summary }}"
          updates:
            results: "{{ _win_update_results }}"
            logs: "{{ windows_ctx.updates.logs }}"

  rescue:
    - name: Log ConfigMgr update failure
      ansible.builtin.include_role:
        name: internal.core.common
        tasks_from: logging/error
      vars:
        ncs_log_message: "ConfigMgr update process failed: {{ ansible_failed_result.msg | default('Unknown error') }}"

    - name: Set empty update data
      ansible.builtin.set_fact:
        windows_ctx:
          config: "{{ windows_ctx.config | default({}) }}"
          services:
            ccmexec_running: "{{ _win_ccmexec_running | default(false) }}"
          applications:
            configmgr_apps: "{{ windows_ctx.applications.configmgr_apps | default([]) }}"
            installed_apps: "{{ windows_ctx.applications.installed_apps | default([]) }}"
            metrics: "{{ windows_ctx.applications.metrics | default({}) }}"
            apps_to_update: []
            excluded_apps: []
            already_current: []
            total_apps: 0
            summary: {}
          updates:
            results: []
            logs: []
