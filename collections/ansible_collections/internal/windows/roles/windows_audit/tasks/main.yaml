---
# internal.windows.windows_audit : main
# Main entry point for Windows auditing and updates.

- name: Audit | Resolve Configuration Overrides
  ansible.builtin.set_fact:
    # Use role variables directly (can be passed from playbook)
    windows_audit_force_update: "{{ windows_audit_force_update | default(false) }}"
  changed_when: false

- name: Audit | Initialize and Resolve Context
  ansible.builtin.set_fact:
    # Use ncs_ctx as source of truth, fall back to windows_ctx
    windows_ctx: "{{ ncs_ctx | default(windows_ctx) }}"
  changed_when: false

- name: Validate Windows context namespace (init)
  ansible.builtin.include_role:
    name: internal.core.common
    tasks_from: validate_typed_schema.yaml
  vars:
    ncs_validate_data: "{{ windows_ctx }}"
    ncs_validate_schema_ref: "internal.windows:roles/windows_audit/defaults/context_init_schema.yaml"
    ncs_validate_root_key: "windows_ctx"
    ncs_validate_fail_msg: "windows_ctx failed initialization schema validation."

- name: Windows Audit Orchestrator
  vars:
    _windows_audit_failed: false
  block:
    - name: Run Application Checks
      ansible.builtin.include_tasks: checks/applications.yaml
      tags: ["audit", "applications"]

    - name: Run ConfigMgr Updates
      ansible.builtin.include_tasks: updates/configmgr.yaml
      when: windows_ctx.config.force_update | default(false) | bool
      tags: ["update", "configmgr"]
  rescue:
    - name: Mark Windows audit as failed
      ansible.builtin.set_fact:
        _windows_audit_failed: true
      changed_when: false

    - name: Re-raise audit failure context
      ansible.builtin.fail:
        msg: "{{ ansible_failed_result.msg | default('Windows audit failed') }}"
  always:
    - name: Compute export summary
      ansible.builtin.set_fact:
        _windows_export_summary:
          applications:
            configmgr_count: "{{ windows_ctx.applications.configmgr_apps | length }}"
            installed_count: "{{ windows_ctx.applications.installed_apps | length }}"
            apps_to_update_count: "{{ windows_ctx.applications.apps_to_update | default([]) | length }}"
            total_apps: "{{ windows_ctx.applications.total_apps | default(0) | int }}"
          updates:
            results_count: "{{ windows_ctx.updates.results | default([]) | length }}"
            failed_count: "{{ windows_ctx.updates.results | default([]) | selectattr('failed', 'defined') | selectattr('failed') | list | length }}"
          services:
            ccmexec_running: "{{ windows_ctx.services.ccmexec_running | bool }}"

    - name: Determine audit health status
      ansible.builtin.set_fact:
        _windows_export_health: >-
          {% if _windows_audit_failed | bool -%}
            CRITICAL
          {%- elif (_windows_export_summary.updates.failed_count | int) > 0 -%}
            WARNING
          {%- elif not windows_ctx.services.ccmexec_running | bool -%}
            WARNING
          {%- else -%}
            HEALTHY
          {%- endif %}

    - name: Build Windows audit export payload
      ansible.builtin.set_fact:
        _windows_audit_export_data:
          audit_type: windows_audit
          audit_failed: "{{ _windows_audit_failed | bool }}"
          health: "{{ _windows_export_health | trim }}"
          summary: "{{ _windows_export_summary }}"
          alerts: "{{ windows_ctx.alerts | default([]) }}"
          check_metadata:
            engine: ansible-ncs-windows
            timestamp: "{{ now(utc=true).strftime('%Y-%m-%dT%H:%M:%SZ') }}"
          windows_audit: "{{ windows_ctx }}"

    - name: Validate Windows audit export payload schema
      ansible.builtin.include_role:
        name: internal.core.common
        tasks_from: validate_typed_schema.yaml
      vars:
        ncs_validate_data: "{{ _windows_audit_export_data }}"
        ncs_validate_schema_ref: "internal.windows:schemas/export_data.yaml"
        ncs_validate_root_key: "_windows_audit_export_data"
        ncs_validate_fail_msg: "Windows audit export payload keys do not match the schema."

    - name: Export Windows audit state for aggregation
      ansible.builtin.include_role:
        name: internal.core.state
        tasks_from: export
      vars:
        # ncs_export_path should be passed by the playbook
        ncs_export_data: "{{ _windows_audit_export_data }}"
