---
# applications.yaml - Windows Installed Apps Check

- name: Windows installed applications inventory
  block:
    - name: Initialize Windows namespace
      ansible.builtin.set_fact:
        windows_ctx: "{{ windows_ctx | internal.core.recursive_combine(structure) }}"
      vars:
        structure:
          config:
            startup_delay: "{{ windows_audit_startup_delay | default(0) | int }}"
            skip_startup_delay: "{{ windows_audit_skip_startup_delay | default(false) | bool }}"
            remote_scripts_path: "{{ windows_audit_remote_scripts_path | default('C:\\Temp\\AnsibleScripts') }}"
            local_report_path: "{{ windows_audit_local_report_path | default('./reports') }}"
            export_csv: true
          services:
            ccmexec_running: false
          applications:
            configmgr_apps: []
            installed_apps: []
            metrics: {}

    - name: Add startup delay
      ansible.windows.win_shell: Start-Sleep -Seconds {{ windows_ctx.config.startup_delay }}
      when: not windows_ctx.config.skip_startup_delay | bool

    - name: Check if CCMExec service is running
      ansible.windows.win_service:
        name: CCMExec
      register: _ccm_service

    - name: Store CCMExec status
      ansible.builtin.set_fact:
        _win_ccmexec_running: "{{ _ccm_service.state == 'running' }}"

    - name: Fail if CCMExec is not running
      ansible.builtin.fail:
        msg: "ConfigMgr client service (CCMExec) is not running"
      when: not _win_ccmexec_running | bool

    - name: Ensure scripts directory exists
      ansible.windows.win_file:
        path: "{{ windows_ctx.config.remote_scripts_path }}"
        state: directory

    - name: Copy Get-ConfigMgrApplications.ps1 script
      ansible.windows.win_copy:
        src: Get-ConfigMgrApplications.ps1
        dest: "{{ windows_ctx.config.remote_scripts_path }}\\Get-ConfigMgrApplications.ps1"

    - name: Copy Get-InstalledApplications.ps1 script
      ansible.windows.win_copy:
        src: Get-InstalledApplications.ps1
        dest: "{{ windows_ctx.config.remote_scripts_path }}\\Get-InstalledApplications.ps1"

    - name: Get ConfigMgr applications
      ansible.windows.win_powershell:
        script: |
          & "{{ windows_ctx.config.remote_scripts_path }}\Get-ConfigMgrApplications.ps1" -ExcludedPatterns @()
      register: _configmgr_apps_result

    - name: Parse ConfigMgr applications
      ansible.builtin.set_fact:
        _win_configmgr_apps: "{{ filtered_data.AppsToUpdate | default([]) }}"
      vars:
        filtered_data: "{{ _configmgr_apps_result.output[0] | from_json }}"

    - name: Get installed applications
      ansible.windows.win_powershell:
        script: |
          & "{{ windows_ctx.config.remote_scripts_path }}\Get-InstalledApplications.ps1"
      register: _installed_apps_result

    - name: Parse installed applications
      ansible.builtin.set_fact:
        _win_installed_apps: "{{ _installed_apps_result.output[0] | from_json if _installed_apps_result.output is defined and _installed_apps_result.output | length > 0 else [] }}"

    - name: Log application inventory summary
      ansible.builtin.include_role:
        name: internal.core.common
        tasks_from: logging/info
      vars:
        ncs_log_message: "Applications: {{ _win_configmgr_apps | length }} ConfigMgr apps, {{ _win_installed_apps | length }} installed apps"

    - name: Assemble windows_ctx with application results
      ansible.builtin.set_fact:
        windows_ctx:
          config: "{{ windows_ctx.config }}"
          services:
            ccmexec_running: "{{ _win_ccmexec_running }}"
          applications:
            configmgr_apps: "{{ _win_configmgr_apps }}"
            installed_apps: "{{ _win_installed_apps }}"
            metrics:
              configmgr_count: "{{ _win_configmgr_apps | length }}"
              installed_count: "{{ _win_installed_apps | length }}"

  rescue:
    - name: Log application check failure
      ansible.builtin.include_role:
        name: internal.core.common
        tasks_from: logging/error
      vars:
        ncs_log_message: "Windows application check failed: {{ ansible_failed_result.msg | default('Unknown error') }}"

    - name: Set empty application data
      ansible.builtin.set_fact:
        windows_ctx:
          config: "{{ windows_ctx.config | default({}) }}"
          services:
            ccmexec_running: "{{ _win_ccmexec_running | default(false) }}"
          applications:
            configmgr_apps: []
            installed_apps: []
            metrics:
              configmgr_count: 0
              installed_count: 0
