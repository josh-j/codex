---
# internal.core.state : tasks/load.yaml
#
# Generic Context Loader
# 1. Checks memory for existing context.
# 2. If missing, attempts to load the latest checkpoint from disk.
# 3. Validates the resulting structure against a schema.

- name: "State | Resolve Context: {{ ncs_load_type | default('discovery') }}"
  block:
    - name: "State | Check if missing from memory: {{ ncs_load_root_key }}"
      ansible.builtin.set_fact:
        _ncs_load_from_disk: >-
          {{
            (ncs_ctx | default(lookup('vars', ncs_load_root_key, default={})) | default({})) == {}
            or (ncs_ctx | default(lookup('vars', ncs_load_root_key, default={}))).system.hostname | default('') == ''
          }}

    - name: "State | Load checkpoint from disk: {{ ncs_load_type | default('discovery') }}"
      when: _ncs_load_from_disk | bool
      block:
        - name: "State | Resolve checkpoint path"
          ansible.builtin.set_fact:
            _checkpoint_path: "{{ ncs_checkpoint_path }}"

        - name: "State | Stat checkpoint file"
          ansible.builtin.stat:
            path: "{{ _checkpoint_path }}"
          register: _checkpoint_stat
          delegate_to: localhost

        - name: "State | Load and parse checkpoint"
          when: _checkpoint_stat.stat.exists
          ansible.builtin.set_fact:
            # Dynamically set both the generic ncs_ctx and the specific root fact
            ncs_ctx: "{{ (lookup('file', _checkpoint_path) | from_yaml).data | default({}) }}"
            "{{ ncs_load_root_key }}": "{{ (lookup('file', _checkpoint_path) | from_yaml).data | default({}) }}"
          delegate_to: localhost

- name: "State | Final Verification of context"
  ansible.builtin.include_role:
    name: internal.core.common
    tasks_from: validate_typed_schema.yaml
  vars:
    ncs_validate_data: "{{ ncs_ctx | default(lookup('vars', ncs_load_root_key, default={})) }}"
    ncs_validate_schema_ref: "{{ ncs_load_schema_ref }}"
    ncs_validate_root_key: "{{ ncs_load_root_key }}"
    ncs_validate_fail_msg: "{{ ncs_load_platform | capitalize }} Audit cannot proceed: No valid {{ ncs_load_type | default('discovery') }} data in memory or on disk."
