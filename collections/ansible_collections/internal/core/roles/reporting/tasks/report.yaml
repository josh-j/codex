---
# roles/common/tasks/reporting/report.yaml
# Standardized report registration (Unified Schema)
#
# Usage:
# - name: Register health report
#   include_role:
#     name: internal.core.reporting
#     tasks_from: report.yaml
#   vars:
#     ncs_report_name: "my_audit_name"
#     ncs_report_row_count: 42
#     ncs_report_path: "/path/to/report.ext"   # optional

- name: Report | Validate required fields
  ansible.builtin.assert:
    that:
      - ncs_report_name is defined
      - ncs_report_name | string | length > 0
    fail_msg: "Report registration requires 'ncs_report_name'."
    quiet: true

- name: Report | Compute defaults
  ansible.builtin.set_fact:
    _report_ts: >-
      {{
        run_ctx.timestamp
        | default(ncs.check.timestamp)
      }}

- name: Report | Build report item
  ansible.builtin.set_fact:
    _report_item: >-
      {{
        {
          'name': ncs_report_name,
          'row_count': (ncs_report_row_count | default(0) | int),
          'site': inventory_hostname,
          'timestamp': _report_ts
        }
        | combine( {'path': ncs_report_path} if ncs_report_path is defined else {} )
      }}

- name: Report | Register in ncs.reports
  ansible.builtin.set_fact:
    ncs: >-
      {{
        (ncs | default({}))
        | combine({
            'reports': ((ncs.reports | default([])) + [_report_item])
          }, recursive=true)
      }}

- name: Report | Log registration
  ansible.builtin.include_role:
    name: internal.core.common
    tasks_from: logging/info
  vars:
    ncs_log_message: "Generated report: {{ ncs_report_name }} ({{ ncs_report_row_count | default(0) }} rows)"
