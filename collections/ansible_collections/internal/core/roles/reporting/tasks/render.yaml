---
# roles/common/tasks/reporting/render.yaml
# Render site health reports (Markdown & HTML)

- name: Reporting | Define render report list
  ansible.builtin.set_fact:
    _render_reports:
      - name: "site_health_report_md"
        src: "site_health_report.md.j2"
        path: "{{ ncs_report_dir }}/ncs-report-{{ _ctx.id }}.md"
      - name: "site_health_report_html"
        src: "site_health_report.html.j2"
        path: "{{ ncs_report_dir }}/ncs-report-{{ _ctx.id }}.html"

- name: Reporting | Render site health reports
  ansible.builtin.template:
    src: "{{ item.src }}"
    dest: "{{ item.path }}"
    mode: "0644"
  loop: "{{ _render_reports }}"
  vars:
    date: "{{ _ctx.date }}"
    day: "{{ _ctx.day | default('Unknown') }}"
    include_patch: "{{ 'patch' in (today_tasks | default([])) }}"
    include_weekly: "{{ 'weekly' in (today_tasks | default([])) }}"
    report_share_path: "{{ ncs.config.report_share_path | default('#') }}"

- name: Reporting | Register rendered reports
  ansible.builtin.include_role:
    name: internal.core.reporting
    tasks_from: report.yaml
  vars:
    ncs_report_name: "{{ item.name }}"
    ncs_report_row_count: 0
    ncs_report_path: "{{ item.path }}"
  loop: "{{ _render_reports }}"
  when: not ansible_check_mode
  tags: ["always"]
