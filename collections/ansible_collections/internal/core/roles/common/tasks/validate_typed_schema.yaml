---
# roles/common/tasks/validate_typed_schema.yaml

- name: Resolve schema path (ref or path)
  ansible.builtin.set_fact:
    _schema_path_resolved: >-
      {{
        lookup(
          'internal.core.schema_path',
          ncs_validate_schema_ref | default([]),
          schema_path=ncs_validate_schema_path | default([]),
          playbook_dir=playbook_dir
        )
      }}
  changed_when: false

- name: Fail early if schema cannot be resolved
  ansible.builtin.assert:
    that:
      - _schema_path_resolved is string
      - _schema_path_resolved | length > 0
    fail_msg: >-
      Could not resolve schema.
      schema_ref={{ ncs_validate_schema_ref | default('UNDEFINED') }}
      schema_path={{ ncs_validate_schema_path | default('UNDEFINED') }}
  changed_when: false

- name: Validate payload keys and types from schema
  ansible.builtin.assert:
    that:
      - >-
        ncs_validate_data
        | internal.core.validate_typed_schema_from_file(
            _schema_path_resolved,
            ncs_validate_root_key
          )
    fail_msg: "{{ ncs_validate_fail_msg | default('Schema validation failed.') }}"
    quiet: "{{ ncs_validate_quiet | default(true) | bool }}"
  changed_when: false
