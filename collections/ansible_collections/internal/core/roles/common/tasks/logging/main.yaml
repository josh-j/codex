---
# roles/common/tasks/logging/main.yaml
# Structured logging utilities
# OPTIMIZED: Uses block vars (no set_fact overhead) and shell append (O(1) I/O)

- name: Log message processing block
  vars:
    _log_path: "{{ ncs.config.logging.file_path | default('./logs/ncs_runtime.log') }}"
    _ts: "{{ ncs.check.timestamp | default(ansible_facts['date_time']['iso8601']) }}"

    # LINT FIX: Adjusted spacing to prevent 'jinja[spacing]' errors
    # We use explicit string concatenation for cleaner control over the conditional context
    _log_entry: >-
      [{{ _ts }}]
      [{{ ncs_log_level | default('INFO') | upper }}]
      [{{ inventory_hostname }}]
      {{ ncs_log_message }}{% if ncs_log_context is defined %} | Context: {{ ncs_log_context | to_json }}{% endif %}

  block:
    # 1. SCREEN OUTPUT
    - name: Display log message
      ansible.builtin.debug:
        msg: "{{ _log_entry }}"

    # 2. FILE OUTPUT (Fast Append)
    # Optimization: 'shell >>' is instant (O(1)).
    - name: Fast Append to local log file
      ansible.builtin.shell:
        cmd: "echo {{ _log_entry | quote }} >> {{ _log_path | quote }}"
      delegate_to: localhost
      become: false
      changed_when: false
      when: ncs.config.logging.export_to_file | default(false) | bool
