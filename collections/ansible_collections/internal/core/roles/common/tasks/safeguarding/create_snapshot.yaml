---
# roles/common/tasks/safeguarding/create_snapshot.yaml
# PURPOSE: Take a safety snapshot of the current host in vCenter if it is a VM.
#
# REQUIRED VARS:
#   - snapshot_prefix (e.g., "Ansible_Pre_Hardening")
#   - snapshot_desc   (e.g., "Created before STIG application")

- name: "Safety | Ensure virtualization facts are available"
  ansible.builtin.assert:
    that:
      - ansible_facts['virtualization_type'] is defined
    fail_msg: "virtualization_type fact is missing. Ensure 'gather_facts: true' was run for this host."
  changed_when: false

- name: "Safety | Create VMware Snapshot"
  delegate_to: localhost
  become: false
  when: ansible_facts['virtualization_type'] == "VMware"
  block:
    - name: "Safety | Normalize vCenter hostname"
      ansible.builtin.set_fact:
        _vmware_normalized_host: >-
          {{
            vmware_hostname
            | regex_replace('^https?://', '')
            | regex_replace('/.*$', '')
          }}
      changed_when: false

    - name: "Safety | Discover VM location in vCenter"
      community.vmware.vmware_vm_info:
        hostname: "{{ _vmware_normalized_host }}"
        username: "{{ vmware_username | default(vault_vcenter_username) }}"
        password: "{{ vmware_password | default(vault_vcenter_password) }}"
        validate_certs: "{{ vmware_validate_certs | default(false) }}"
        vm_name: "{{ inventory_hostname }}"
      register: vm_discovery

    - name: "Safety | Validate VM discovery"
      ansible.builtin.assert:
        that:
          - vm_discovery.virtual_machines | length > 0
        fail_msg: "Could not find VM '{{ inventory_hostname }}' in vCenter '{{ _vmware_normalized_host }}'."
      changed_when: false

    - name: "Safety | Extract VM datacenter and folder"
      ansible.builtin.set_fact:
        vm_datacenter: "{{ vm_discovery.virtual_machines[0].datacenter }}"
        vm_folder: "{{ vm_discovery.virtual_machines[0].folder }}"
      changed_when: false

    - name: "Safety | Trigger vCenter Snapshot ({{ snapshot_prefix }})"
      vmware.vmware.vm_snapshot:
        hostname: "{{ _vmware_normalized_host }}"
        username: "{{ vmware_username | default(vault_vcenter_username) }}"
        password: "{{ vmware_password | default(vault_vcenter_password) }}"
        validate_certs: "{{ vmware_validate_certs | default(false) }}"
        datacenter: "{{ vm_datacenter }}"
        name: "{{ inventory_hostname }}"
        folder: "{{ vm_folder }}"
        state: present
        snapshot_name: "{{ snapshot_prefix }}_{{ ansible_facts['date_time']['date'] }}"
        description: "{{ snapshot_desc }} on {{ ansible_facts['date_time']['iso8601'] }}"
        quiesce: true
        memory_dump: false
