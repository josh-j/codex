# roles/common/tasks/reporting/stig.yaml
# REQUIRED VARS:
# - stig_report_dir: Base directory (e.g. /srv/samba/reports).
#                    The task will append /Split/role/timestamp/host automatically.
# - stig_artifact_file: Path to the JSON produced by the callback plugin
# OPTIONAL VARS:
# - stig_destination_folder: (Override) If provided, bypasses path calculation and uses this exact path.

- name: Initialize Context
  ansible.builtin.include_tasks: ../sync_ctx.yaml

# 1. VALIDATION
# -----------------------------------------------------------------------------
- name: "STIG Reporting | Validate Run Context"
  ansible.builtin.include_role:
    name: internal.core.common
    tasks_from: validate_run_ctx.yaml

# 1.1 PATH CALCULATION (Updated to match export_csv logic & accept overrides)
# -----------------------------------------------------------------------------
- name: "STIG Reporting | Determine Run Context"
  ansible.builtin.set_fact:
    # 1. Identify the Role (e.g., 'ubuntu')
    _stig_context_role: >-
      {{ (ansible_parent_role_names | default([ansible_role_name])) | first }}

    # 2. Identify the Run ID (PRIORITY: global_run_id -> ncs.check.id -> Timestamp)
    # This matching logic ensures we don't create split timestamps.
    _stig_run_identifier: >-
      {{
        run_ctx.id
        | default(global_run_id)
        | default(ncs.check.id)
        | default('UNKNOWN')
      }}

- name: "STIG Reporting | Determine Final Output Directory"
  ansible.builtin.set_fact:
    # LOGIC:
    # 1. If caller provided 'stig_destination_folder' (from CSV export), use it EXACTLY.
    # 2. Otherwise, build the standard 'Split/Role/Timestamp' structure.
    _stig_final_dir: >-
      {{
        stig_destination_folder
        | default(
            (stig_report_dir | default('/srv/samba/reports')) ~
            '/Split/' ~
            _stig_context_role ~
            '/' ~
            _stig_run_identifier ~
            '/' ~
            inventory_hostname
          )
      }}

- name: "STIG Reporting | Prepare Output Directory"
  ansible.builtin.file:
    path: "{{ _stig_final_dir }}"
    state: directory
    mode: '0775'
  delegate_to: localhost
  become: false

# 2. PROCESS ARTIFACTS
# -----------------------------------------------------------------------------
- name: "STIG Reporting | Process Artifacts"
  tags: ['stig', 'report']
  block:
    - name: Check if Artifact File Exists
      ansible.builtin.stat:
        path: "{{ stig_artifact_file }}"
      register: _artifact_stat
      delegate_to: localhost
      become: false

    - name: Read Failed/Fixed Rules from JSON
      ansible.builtin.slurp:
        src: "{{ stig_artifact_file }}"
      register: _stig_failures_raw
      delegate_to: localhost
      become: false
      when: _artifact_stat.stat.exists

    # -------------------------------------------------------------------------
    # DATA PREPARATION
    # -------------------------------------------------------------------------
    - name: Parse and Sort STIG Data
      ansible.builtin.set_fact:
        _report_date: "{{ run_ctx.date | default('N/A') }}"
        _failures_raw_list: >-
          {{
            _stig_failures_raw.content | b64decode | from_json
            if (_stig_failures_raw is defined and _stig_failures_raw.content is defined)
            else []
          }}
      delegate_to: localhost

    - name: Finalize Failure List
      ansible.builtin.set_fact:
        _stig_report_data: >-
          {{
            (_failures_raw_list | selectattr('status', 'equalto', 'failed') | selectattr('severity', 'equalto', 'high') | list) +
            (_failures_raw_list | selectattr('status', 'equalto', 'failed') | selectattr('severity', 'equalto', 'medium') | list) +
            (_failures_raw_list | selectattr('status', 'equalto', 'failed') | selectattr('severity', 'equalto', 'low') | list) +
            (_failures_raw_list | selectattr('status', 'equalto', 'fixed') | selectattr('severity', 'equalto', 'high') | list) +
            (_failures_raw_list | selectattr('status', 'equalto', 'fixed') | selectattr('severity', 'equalto', 'medium') | list) +
            (_failures_raw_list | selectattr('status', 'equalto', 'fixed') | selectattr('severity', 'equalto', 'low') | list)
          }}
      delegate_to: localhost

    # -------------------------------------------------------------------------
    # REPORT GENERATION
    # -------------------------------------------------------------------------
    - name: Save Text STIG Report
      ansible.builtin.copy:
        content: |
          ==================================================================
          STIG REMEDIATION REPORT
          Host: {{ inventory_hostname }}
          Date: {{ run_ctx.timestamp | default('N/A') }}
          ==================================================================
          {% for rule in _stig_report_data %}
          ID:       {{ rule.id }}
          Status:   {{ rule.status | upper }}
          Severity: {{ rule.severity | upper }}
          Title:    {{ rule.title }}
          ------------------------------------------------------------------
          {% endfor %}
        dest: "{{ _stig_final_dir }}/stig_{{ _stig_context_role }}_{{ _stig_run_identifier }}_{{ inventory_hostname }}_{{ _report_date }}.txt"
        mode: '0644'
      delegate_to: localhost
      become: false

    - name: Register Text STIG Report
      ansible.builtin.include_role:
        name: internal.core.reporting
        tasks_from: report.yaml
      vars:
        ncs_report_name: "stig_{{ _stig_context_role }}_{{ _stig_run_identifier }}_txt"
        ncs_report_row_count: "{{ _stig_report_data | length }}"
        ncs_report_path: "{{ _stig_final_dir }}/stig_{{ _stig_context_role }}_{{ _stig_run_identifier }}_{{ inventory_hostname }}_{{ _report_date }}.txt"
      when: not ansible_check_mode

    - name: Save HTML STIG Report
      ansible.builtin.template:
        src: "stig_report.html.j2"
        dest: "{{ _stig_final_dir }}/stig_{{ _stig_context_role }}_{{ _stig_run_identifier }}_{{ inventory_hostname }}_{{ _report_date }}.html"
        mode: '0644'
      vars:
        _failures: "{{ _stig_report_data }}"
        timestamp: "{{ run_ctx.timestamp | default('N/A') }}"
      delegate_to: localhost
      become: false
      when: _stig_report_data is defined

    - name: Register HTML STIG Report
      ansible.builtin.include_role:
        name: internal.core.reporting
        tasks_from: report.yaml
      vars:
        ncs_report_name: "stig_{{ _stig_context_role }}_{{ _stig_run_identifier }}_html"
        ncs_report_row_count: "{{ _stig_report_data | length }}"
        ncs_report_path: "{{ _stig_final_dir }}/stig_{{ _stig_context_role }}_{{ _stig_run_identifier }}_{{ inventory_hostname }}_{{ _report_date }}.html"
      when:
        - _stig_report_data is defined
        - not ansible_check_mode

    - name: Register JSON Artifact
      ansible.builtin.include_role:
        name: internal.core.reporting
        tasks_from: report.yaml
      vars:
        ncs_report_name: "stig_{{ _stig_context_role }}_{{ _stig_run_identifier }}_artifact_json"
        ncs_report_row_count: "{{ _failures_raw_list | length }}"
        ncs_report_path: "{{ stig_artifact_file }}"
      when:
        - _artifact_stat.stat.exists
        - not ansible_check_mode

    # -------------------------------------------------------------------------
    # CLEANUP
    # -------------------------------------------------------------------------
    - name: Cleanup Temporary Artifacts
      ansible.builtin.file:
        path: "{{ stig_artifact_file }}"
        state: absent
      delegate_to: localhost
      become: false
