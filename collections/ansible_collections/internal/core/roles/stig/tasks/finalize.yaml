---
# internal.core.stig : tasks/finalize.yaml
#
# Generic STIG report export. Called from collection-level finalize tasks.
# Expects: audit_full_list, stig_target_type, ncs_config

- name: "STIG | Normalize audit results"
  tags: [stig, reporting]
  ansible.builtin.set_fact:
    _stig_report_host_dir: >-
      {{
        (
          ncs_export_path | dirname
          if ncs_export_path is defined
          else (ncs_config.report_directory | default('/srv/samba/reports'))
               ~ '/'
               ~ inventory_hostname
        )
      }}
    _stig_export_path: >-
      {{
        ncs_export_path
        | default(
          (ncs_config.report_directory | default('/srv/samba/reports'))
          ~ '/'
          ~ inventory_hostname
          ~ '/'
          ~ inventory_hostname
          ~ '_stig_'
          ~ stig_target_type
          ~ '.yaml'
        )
      }}
    _stig_checked_at: "{{ now(utc=true, fmt='%Y-%m-%dT%H:%M:%SZ') }}"
    _stig_report_id: "{{ now(utc=true, fmt='%Y%m%dT%H%M%SZ') }}"
    _stig_normalized: "{{ (audit_full_list | default([])) | internal.core.normalize_stig_results(stig_target_type | default('')) }}"
    _stig_audit_full_list_normalized: "{{ _stig_normalized.full_audit | default([]) }}"
    _stig_audit_violations_normalized: "{{ _stig_normalized.violations | default([]) }}"
    _stig_alerts_normalized: "{{ _stig_normalized.alerts | default([]) }}"

- name: "STIG | Summary"
  tags: [stig, reporting]
  when: not (stig_quiet_mode | default(false) | bool)
  ansible.builtin.debug:
    msg: >-
      {{ inventory_hostname }} | {{ stig_target_type | upper }} STIG |
      {{ _stig_audit_full_list_normalized | default([]) | length }} checks |
      {{ _stig_audit_violations_normalized | default([]) | length }} violation(s)

- name: "STIG | Export audit results to YAML"
  tags: [stig, reporting]
  ansible.builtin.include_role:
    name: internal.core.state
    tasks_from: export
  vars:
    ncs_export_path: "{{ _stig_export_path }}"
    ncs_export_data: >-
      {{
        {
          'audit_type': 'stig',
          'audit_failed': (_stig_audit_failed | default(false) | bool),
          'host': inventory_hostname,
          'target_type': stig_target_type,
          'checked_at': _stig_checked_at,
          'health': (
            _stig_alerts_normalized | default([]) | internal.core.health_rollup
          ),
          'summary': {
            'total': (_stig_normalized.summary.total | default(0)),
            'violations': (_stig_normalized.summary.violations | default(0)),
            'passed': (_stig_normalized.summary.passed | default(0)),
            'critical_count': (_stig_normalized.summary.critical_count | default(0)),
            'warning_count': (_stig_normalized.summary.warning_count | default(0))
          },
          'alerts': (_stig_alerts_normalized | default([])),
          'violations': (_stig_audit_violations_normalized | default([])),
          'full_audit': (_stig_audit_full_list_normalized | default([]))
        }
      }}

- name: "STIG | Render HTML report"
  tags: [stig, reporting]
  when: _stig_audit_full_list_normalized | default([]) | length > 0
  ansible.builtin.template:
    src: "stig_report.html.j2"
    dest: "{{ _stig_report_host_dir }}/{{ inventory_hostname }}_stig_{{ stig_target_type }}.html"
    mode: "0664"
  vars:
    timestamp: "{{ _stig_checked_at }}"
    _failures: "{{ _stig_audit_violations_normalized | default([]) }}"
  delegate_to: localhost
  become: false
