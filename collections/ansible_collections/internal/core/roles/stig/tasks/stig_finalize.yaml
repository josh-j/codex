---
# collections/ansible_collections/internal/stig/roles/common/tasks/stig_finalize.yaml

- name: Initialize Context
  ansible.builtin.include_tasks: sync_ctx.yaml

- name: "STIG | Console Summary"
  ansible.builtin.debug:
    msg:
      - "Audit Complete for: {{ inventory_hostname }}"
      - "Violations: {{ violations | default([]) | length }}"

- name: "STIG | Export Violations CSV"
  ansible.builtin.include_role:
    name: internal.core.reporting
    tasks_from: export_csv.yaml
  vars:
    ncs_csv_report_name: "{{ report_prefix }}_violations"
    ncs_csv_data: "{{ violations }}"
    ncs_csv_headers: "{{ export_headers }}"
    ncs_csv_keys: "{{ export_keys }}"
    ncs_csv_sort_by: "name"
    ncs_csv_output_dir: "{{ ncs_report_output_dir | default(omit) }}"
  when: (violations | default([]) | length) > 0

- name: "STIG | Export Full Log CSV"
  ansible.builtin.include_role:
    name: internal.core.reporting
    tasks_from: export_csv.yaml
  vars:
    ncs_csv_report_name: "{{ report_prefix }}_full_audit"
    ncs_csv_data: "{{ full_audit }}"
    ncs_csv_headers: "{{ export_headers }}"
    ncs_csv_keys: "{{ export_keys }}"
    ncs_csv_sort_by: "name"
    ncs_csv_output_dir: "{{ ncs_report_output_dir | default(omit) }}"
  when: (full_audit | default([]) | length) > 0

- name: "STIG | Generate CKLB Files"
  ansible.builtin.template:
    src: "cklb_generic.json.j2"
    dest: "{{ ncs_report_output_dir }}/{{ item.0 }}_{{ _run_id }}_STIG.cklb"
    mode: "0644"
  vars:
    target_name: "{{ item.0 }}"
    audit_data: "{{ item.1 }}"
    _run_id: "{{ run_ctx.id | default('unknown') }}"
  loop: "{{ full_audit | groupby('name') | map('list') | list }}"
  loop_control:
    label: "{{ item.0 }}"
  when:
    - cklb_skeleton_path is defined
    - (full_audit | default([]) | length) > 0

- name: "STIG | Register CKLB Reports"
  ansible.builtin.include_role:
    name: internal.core.reporting
    tasks_from: report.yaml
  vars:
    _run_id: "{{ run_ctx.id | default('unknown') }}"
    ncs_report_name: "{{ report_prefix }}_cklb_{{ item.0 }}_{{ _run_id }}"
    ncs_report_row_count: 0
    ncs_report_path: "{{ ncs_report_output_dir }}/{{ item.0 }}_{{ _run_id }}_STIG.cklb"
  loop: "{{ full_audit | groupby('name') | map('list') | list }}"
  loop_control:
    label: "{{ item.0 }}"
  when:
    - cklb_skeleton_path is defined
    - (full_audit | default([]) | length) > 0
    - not ansible_check_mode
