---
# internal.core.stig : tasks/read_callback_artifact.yaml
#
# Reads a single callback JSON artifact and sets audit_full_list.
#
# Required vars:
#   _stig_artifacts_dir   - path to .artifacts directory
#   _stig_artifact_host_hint - hostname to match in artifact filename
#
# Optional vars:
#   _stig_is_hardening    - when false, remaps 'fixed' â†’ 'failed' (default: false)
#   _stig_require_artifact - fail if no artifact found (default: true)

- name: "STIG Artifact | Locate callback JSON"
  ansible.builtin.find:
    paths: "{{ _stig_artifacts_dir }}"
    file_type: file
    patterns:
      - "xccdf-results_*.json"
    excludes:
      - "*_failures.json"
  register: _stig_cb_json_found
  delegate_to: localhost
  become: false
  changed_when: false

- name: "STIG Artifact | Choose best JSON artifact"
  vars:
    _files: "{{ _stig_cb_json_found.files | default([]) }}"
    _hint: "{{ _stig_artifact_host_hint | default('') }}"
    _preferred: >-
      {%- set out = [] -%}
      {%- for f in _files -%}
        {%- if _hint and _hint in (f.path | default('')) -%}
          {%- set _ = out.append(f) -%}
        {%- endif -%}
      {%- endfor -%}
      {{ out }}
    _cands: "{{ _preferred if (_preferred | length > 0) else _files }}"
  ansible.builtin.set_fact:
    _stig_cb_artifact_path: >-
      {{ (_cands | sort(attribute='mtime') | last | default({})).path | default('') }}
  changed_when: false

- name: "STIG Artifact | Read callback artifact"
  ansible.builtin.slurp:
    src: "{{ _stig_cb_artifact_path }}"
  register: _stig_cb_json_raw
  delegate_to: localhost
  become: false
  when: _stig_cb_artifact_path | length > 0
  changed_when: false

- name: "STIG Artifact | Set audit_full_list from artifact"
  vars:
    _raw: "{{ (_stig_cb_json_raw.content | b64decode) if (_stig_cb_json_raw is defined and ('content' in _stig_cb_json_raw)) else '[]' }}"
    _data: "{{ _raw | from_json }}"
    _hardening: "{{ _stig_is_hardening | default(false) | bool }}"
  ansible.builtin.set_fact:
    audit_full_list: >-
      {%- set out = [] -%}
      {%- for r in (_data | default([])) -%}
        {%- if r is mapping -%}
          {%- set s = (r.status | default('') | string | lower) -%}
          {%- if (not _hardening | bool) and s == 'fixed' -%}
            {%- set _ = out.append(r | combine({'status': 'failed'})) -%}
          {%- else -%}
            {%- set _ = out.append(r) -%}
          {%- endif -%}
        {%- endif -%}
      {%- endfor -%}
      {{ out }}
  when: _stig_cb_artifact_path | length > 0
  changed_when: false

- name: "STIG Artifact | Fail if no artifact found"
  ansible.builtin.fail:
    msg: >-
      No STIG callback JSON artifact found in {{ _stig_artifacts_dir }}.
      Ensure the 'stig_xml' callback is enabled and writing artifacts.
  when:
    - _stig_cb_artifact_path | length == 0
    - _stig_require_artifact | default(true) | bool
