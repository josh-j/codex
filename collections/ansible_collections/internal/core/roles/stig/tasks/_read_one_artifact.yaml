---
# internal.core.stig : tasks/_read_one_artifact.yaml
#
# Reads a single host's callback artifact and appends to audit_full_list.
# Called in a loop from read_callback_artifacts_multi.yaml.
#
# Loop var: _stig_current_target_host

- name: "STIG Artifact | Find JSON for {{ _stig_current_target_host }}"
  ansible.builtin.stat:
    path: "{{ _stig_artifacts_dir }}/xccdf-results_{{ _stig_current_target_host }}.json"
  register: _stig_one_artifact_stat
  delegate_to: localhost
  become: false
  changed_when: false

- name: "STIG Artifact | Read JSON for {{ _stig_current_target_host }}"
  ansible.builtin.slurp:
    src: "{{ _stig_artifacts_dir }}/xccdf-results_{{ _stig_current_target_host }}.json"
  register: _stig_one_artifact_raw
  delegate_to: localhost
  become: false
  when: _stig_one_artifact_stat.stat.exists | default(false)
  changed_when: false

- name: "STIG Artifact | Merge results for {{ _stig_current_target_host }}"
  vars:
    _raw: "{{ (_stig_one_artifact_raw.content | b64decode) if (_stig_one_artifact_raw is defined and ('content' in _stig_one_artifact_raw)) else '[]' }}"
    _data: "{{ _raw | from_json }}"
    _hardening: "{{ _stig_is_hardening | default(false) | bool }}"
    _rows_raw: >-
      {%- set out = [] -%}
      {%- for r in (_data | default([])) -%}
        {%- if r is mapping -%}
          {%- set s = (r.status | default('') | string | lower) -%}
          {%- if (not _hardening | bool) and s == 'fixed' -%}
            {%- set _ = out.append(r | combine({'status': 'failed'})) -%}
          {%- else -%}
            {%- set _ = out.append(r) -%}
          {%- endif -%}
        {%- endif -%}
      {%- endfor -%}
      {{ out }}
    _host_rows_list: "{{ _rows_raw | from_yaml }}"
  ansible.builtin.set_fact:
    audit_full_list: "{{ (audit_full_list | default([])) + _host_rows_list }}"
  when: _stig_one_artifact_stat.stat.exists | default(false)
  changed_when: false

- name: "STIG Artifact | Warn if no artifact for {{ _stig_current_target_host }}"
  ansible.builtin.debug:
    msg: "No callback artifact found for {{ _stig_current_target_host }} in {{ _stig_artifacts_dir }}"
  when: not (_stig_one_artifact_stat.stat.exists | default(false))
