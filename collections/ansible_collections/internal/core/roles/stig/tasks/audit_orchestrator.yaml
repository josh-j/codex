---
# collections/ansible_collections/internal/stig/roles/common/tasks/audit_orchestrator.yaml

- name: Initialize Context
  ansible.builtin.include_tasks: sync_ctx.yaml

# 1. Check if the template exists on the Controller (Localhost)
- name: "AUDIT | Verify Template Exists"
  ansible.builtin.stat:
    path: "{{ audit_logic_template }}"
  register: template_stat
  delegate_to: localhost
  check_mode: false

# 2. Print the path and status safely
- name: "AUDIT | Debug Template Path"
  ansible.builtin.debug:
    msg:
      - "Looking for template at: {{ audit_logic_template }}"
      - "Found on Controller: {{ template_stat.stat.exists }}"
      - "Is Readable: {{ template_stat.stat.readable | default(false) }}"

# 3. Fail early if missing (Preventing the scary crash later)
- name: "AUDIT | Stop if Template Missing"
  ansible.builtin.fail:
    msg: "CRITICAL: Template file not found at {{ audit_logic_template }}. Check your 'check.yaml' path."
  when: not template_stat.stat.exists

# 4. Initialize Lists
- name: "AUDIT | Initialize Result Lists"
  ansible.builtin.set_fact:
    audit_full_list: []
    audit_violations: []


- name: "AUDIT | Debug Template Rendering (Test First Item)"
  ansible.builtin.debug:
    msg: "{{ lookup('template', audit_logic_template) }}"
  # We fake 'item' using the first result from discovery to trigger the render logic
  vars:
    item: "{{ raw_discovery_data | first | default({}) }}"
  ignore_errors: true # Don't stop, just print the error!

# 5. Process Data (Only runs if template exists)
- name: "AUDIT | Processing Loop"
  ansible.builtin.set_fact:
    audit_full_list: >-
      {{
        audit_full_list +
        (
           lookup('template', audit_logic_template) | from_json
           | map('combine', {'name': item.name, 'uuid': item.uuid | default('N/A')})
           | list
        )
      }}
  loop: "{{ raw_discovery_data | default([]) }}"
  loop_control:
    label: "{{ item.name }}"
  when:
    - (stig_filter is undefined) or (stig_filter == "") or (item.name == stig_filter)
    - item.name not in (stig_exclusions | default([]))
    - item.name is not search('vCLS')

- name: "AUDIT | Extract Violations"
  ansible.builtin.set_fact:
    audit_violations: "{{ audit_full_list | selectattr('status', 'equalto', 'FAILED') | list }}"
