---
- name: Verify
  hosts: localhost
  connection: local
  gather_facts: false
  tasks:
    - name: Check if HTML report was created
      ansible.builtin.stat:
        path: "/tmp/molecule_reports/Summary/ops-report-test-run.html"
      register: html_report

    - name: Fail if HTML report is missing
      ansible.builtin.assert:
        that:
          - html_report.stat.exists
        fail_msg: "The HTML report was not generated."

    - name: Verify aggregation logic (Alert counts)
      ansible.builtin.assert:
        that:
          - report.counts.alerts.critical == 1
          - report.counts.alarms.critical == 1
          - report.totals.critical == 2
        fail_msg: "Aggregation counts are incorrect. Report data: {{ report.counts }}"
