---
# collections/ansible_collections/internal/stig/roles/common/tasks/stig_finalize.yaml

- name: "STIG | Console Summary"
  ansible.builtin.debug:
    msg:
      - "Audit Complete for: {{ inventory_hostname }}"
      - "Violations: {{ violations | default([]) | length }}"

- name: "STIG | Export Violations CSV"
  # Point to the file now located INSIDE the collection role
  ansible.builtin.include_tasks: reporting/export_csv.yaml
  vars:
    ops_csv_report_name: "{{ report_prefix }}_violations"
    ops_csv_data: "{{ violations }}"
    ops_csv_headers: "{{ export_headers }}"
    ops_csv_keys: "{{ export_keys }}"
    ops_csv_sort_by: "name"
  when: violations | length > 0

- name: "STIG | Export Full Log CSV"
  ansible.builtin.include_tasks: reporting/export_csv.yaml
  vars:
    ops_csv_report_name: "{{ report_prefix }}_full_audit"
    ops_csv_data: "{{ full_audit }}"
    ops_csv_headers: "{{ export_headers }}"
    ops_csv_keys: "{{ export_keys }}"
    ops_csv_sort_by: "name"

- name: "STIG | Generate CKLB Files"
  ansible.builtin.template:
    src: "cklb_generic.json.j2"
    dest: "{{ ops_report_output_dir }}/{{ item.0 }}_STIG.cklb"
    mode: "0644"
  vars:
    target_name: "{{ item.0 }}"
    audit_data: "{{ item.1 }}"
  loop: "{{ full_audit | groupby('name') | map('list') | list }}"
  loop_control:
    label: "{{ item.0 }}"
  when:
    - cklb_skeleton_path is defined
    - full_audit | length > 0
