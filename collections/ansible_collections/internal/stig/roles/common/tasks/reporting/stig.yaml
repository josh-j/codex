# roles/common/tasks/reporting/stig.yaml
# REQUIRED VARS:
# - stig_report_dir: Base directory (e.g. /srv/samba/reports).
#                    The task will append /Split/role/timestamp/host automatically.
# - stig_artifact_file: Path to the JSON produced by the callback plugin
# OPTIONAL VARS:
# - stig_destination_folder: (Override) If provided, bypasses path calculation and uses this exact path.

# 1. SETUP & FACTS
# -----------------------------------------------------------------------------
- name: "STIG Reporting | Ensure Facts are Available"
  ansible.builtin.setup:
    gather_subset: ['date_time']
  when: ansible_facts['date_time'] is not defined

# 1.1 PATH CALCULATION (Updated to match export_csv logic & accept overrides)
# -----------------------------------------------------------------------------
- name: "STIG Reporting | Determine Run Context"
  ansible.builtin.set_fact:
    # 1. Identify the Role (e.g., 'ubuntu')
    _stig_context_role: >-
      {{ (ansible_parent_role_names | default([ansible_role_name])) | first }}

    # 2. Identify the Run ID (PRIORITY: global_run_id -> ops.check.id -> Timestamp)
    # This matching logic ensures we don't create split timestamps.
    _stig_run_identifier: >-
      {{
        global_run_id
        | default(ops.check.id)
        | default(
            ansible_facts['date_time']['date'] ~ '_' ~
            ansible_facts['date_time']['time'] | replace(':', '')
          )
      }}

- name: "STIG Reporting | Determine Final Output Directory"
  ansible.builtin.set_fact:
    # LOGIC:
    # 1. If caller provided 'stig_destination_folder' (from CSV export), use it EXACTLY.
    # 2. Otherwise, build the standard 'Split/Role/Timestamp' structure.
    _stig_final_dir: >-
      {{
        stig_destination_folder
        | default(
            (stig_report_dir | default('/srv/samba/reports')) ~
            '/Split/' ~
            _stig_context_role ~
            '/' ~
            _stig_run_identifier ~
            '/' ~
            inventory_hostname
          )
      }}

- name: "STIG Reporting | Prepare Output Directory"
  ansible.builtin.file:
    path: "{{ _stig_final_dir }}"
    state: directory
    mode: '0775'
  delegate_to: localhost
  become: false

# 2. PROCESS ARTIFACTS
# -----------------------------------------------------------------------------
- name: "STIG Reporting | Process Artifacts"
  tags: ['stig', 'report']
  block:
    - name: Check if Artifact File Exists
      ansible.builtin.stat:
        path: "{{ stig_artifact_file }}"
      register: _artifact_stat
      delegate_to: localhost
      become: false

    - name: Read Failed/Fixed Rules from JSON
      ansible.builtin.slurp:
        src: "{{ stig_artifact_file }}"
      register: _stig_failures_raw
      delegate_to: localhost
      become: false
      when: _artifact_stat.stat.exists

    # -------------------------------------------------------------------------
    # DATA PREPARATION
    # -------------------------------------------------------------------------
    - name: Parse and Sort STIG Data
      ansible.builtin.set_fact:
        _report_date: "{{ ansible_facts['date_time']['date'] }}"
        _failures_raw_list: >-
          {{
            _stig_failures_raw.content | b64decode | from_json
            if (_stig_failures_raw is defined and _stig_failures_raw.content is defined)
            else []
          }}
      delegate_to: localhost

    - name: Finalize Failure List
      ansible.builtin.set_fact:
        _stig_report_data: >-
          {{
            (_failures_raw_list | selectattr('status', 'equalto', 'failed') | selectattr('severity', 'equalto', 'high') | list) +
            (_failures_raw_list | selectattr('status', 'equalto', 'failed') | selectattr('severity', 'equalto', 'medium') | list) +
            (_failures_raw_list | selectattr('status', 'equalto', 'failed') | selectattr('severity', 'equalto', 'low') | list) +
            (_failures_raw_list | selectattr('status', 'equalto', 'fixed') | selectattr('severity', 'equalto', 'high') | list) +
            (_failures_raw_list | selectattr('status', 'equalto', 'fixed') | selectattr('severity', 'equalto', 'medium') | list) +
            (_failures_raw_list | selectattr('status', 'equalto', 'fixed') | selectattr('severity', 'equalto', 'low') | list)
          }}
      delegate_to: localhost

    # -------------------------------------------------------------------------
    # REPORT GENERATION
    # -------------------------------------------------------------------------
    - name: Save Text STIG Report
      ansible.builtin.copy:
        content: |
          ==================================================================
          STIG REMEDIATION REPORT
          Host: {{ inventory_hostname }}
          Date: {{ ansible_facts['date_time']['iso8601'] }}
          ==================================================================
          {% for rule in _stig_report_data %}
          ID:       {{ rule.id }}
          Status:   {{ rule.status | upper }}
          Severity: {{ rule.severity | upper }}
          Title:    {{ rule.title }}
          ------------------------------------------------------------------
          {% endfor %}
        # CHANGED: Uses _stig_final_dir (ensures no split folders)
        dest: "{{ _stig_final_dir }}/stig_{{ inventory_hostname }}_{{ _report_date }}.txt"
        mode: '0644'
      delegate_to: localhost
      become: false

    - name: Save HTML STIG Report
      ansible.builtin.template:
        src: "stig_report.html.j2"
        # CHANGED: Uses _stig_final_dir
        dest: "{{ _stig_final_dir }}/stig_{{ inventory_hostname }}_{{ _report_date }}.html"
        mode: '0644'
      vars:
        _failures: "{{ _stig_report_data }}"
        timestamp: "{{ lookup('pipe', 'date +%Y-%m-%d\\ %H:%M:%S') }}"
      delegate_to: localhost
      become: false
      when: _stig_report_data is defined

    # -------------------------------------------------------------------------
    # CLEANUP
    # -------------------------------------------------------------------------
    - name: Cleanup Temporary Artifacts
      ansible.builtin.file:
        path: "{{ stig_artifact_file }}"
        state: absent
      delegate_to: localhost
      become: false
