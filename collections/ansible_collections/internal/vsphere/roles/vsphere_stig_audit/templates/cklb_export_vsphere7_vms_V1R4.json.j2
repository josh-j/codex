{% set skeleton = lookup('file', role_path + '/files/cklb_skeleton_vsphere7_vms_V1R4.json') | from_json %}
{# --- PRE-PROCESSING: Convert List to Dictionary for 100% Accurate Lookups --- #}
{% set audit_map = {} %}
{% for result in audit_data %}
  {% set _ = audit_map.update({result.id | trim : result}) %}
{% endfor %}
{
  "title": "{{ skeleton.title }}",
  "id": "{{ skeleton.id }}",
  "cklb_version": "{{ skeleton.cklb_version }}",
  "active": true,
  "mode": 1,
  "has_path": false,
  "target_data": {
    "target_type": "Computing",
    "host_name": "{{ vm_name }}",
    "fqdn": "{{ vm_name }}",
    "ip_address": "{{ hostvars[inventory_hostname]['ansible_host'] | default('') }}",
    "role": "Workstation",
    "comments": "Generated by Ansible STIG Orchestrator"
  },
  "stigs": [
    {% for stig in skeleton.stigs %}
    {
      "stig_name": "{{ stig.stig_name }}",
      "display_name": "{{ stig.display_name }}",
      "stig_id": "{{ stig.stig_id }}",
      "release_info": "{{ stig.release_info }}",
      "version": "{{ stig.version }}",
      "uuid": "{{ stig.uuid }}",
      "size": {{ stig.size }},
      "rules": [
        {% for rule in stig.rules %}
        {# --- ROBUST LOOKUP LOGIC --- #}
        {# Directly pull the result from our map using the Rule Version (VMCH ID) #}
        {% set audit_result = audit_map.get(rule.rule_version) %}

        {% set status = 'not_reviewed' %}
        {% set details = '' %}
        {% set comment = '' %}

        {% if audit_result %}
            {% if audit_result.status == 'FAILED' %}
                {% set status = 'open' %}
                {% set details = audit_result.details %}
                {% set comment = 'Automated Audit: Non-Compliant setting found.' %}
            {% elif audit_result.status == 'PASSED' %}
                {% set status = 'not_a_finding' %}
                {% set details = audit_result.details %}
                {% set comment = 'Automated Audit: Verified Compliant.' %}
            {% endif %}
        {% endif %}

        {
          "rule_id": "{{ rule.rule_id }}",
          "rule_version": "{{ rule.rule_version }}",
          "status": "{{ status }}",
          "finding_details": "{{ details | replace('\"', '\\\"') | replace('\n', '\\n') }}",
          "comments": "{{ comment | replace('\"', '\\\"') | replace('\n', '\\n') }}",
          "severity": "{{ rule.severity }}",
          "group_title": "{{ rule.group_title | replace('\"', '\\\"') | replace('\n', '\\n') }}",
          "rule_title": "{{ rule.rule_title | replace('\"', '\\\"') | replace('\n', '\\n') }}",
          "fix_text": "{{ rule.fix_text | replace('\"', '\\\"') | replace('\n', '\\n') }}",
          "check_content": "{{ rule.check_content | replace('\"', '\\\"') | replace('\n', '\\n') }}",
          "discussion": "{{ rule.discussion | replace('\"', '\\\"') | replace('\n', '\\n') }}",
          "cci_ref": "{{ rule.ccis | first | default('') }}"
        }{{ ',' if not loop.last else '' }}
        {% endfor %}
      ]
    }{{ ',' if not loop.last else '' }}
    {% endfor %}
  ]
}
