{% set res = [] %}
{% set _config = item.advanced_settings | default({}) %}
{% set _hw = item.hardware | default({}) %}

{# --- 1. ADVANCED SETTINGS CHECKS (Variables from defaults/main.yaml) --- #}
{% for rule in vsphere_stig_vm_settings | default([]) %}
    {% set current = _config.get(rule.key, 'MISSING') %}
    {% set status = 'PASSED' %}
    {% set details = 'Value matches' %}

    {% if rule.value == 'ABSENT' %}
        {# Fail if key exists AND is true #}
        {% if current != 'MISSING' and current | string | lower == 'true' %}
            {% set status = 'FAILED' %}
            {% set details = 'Key is TRUE (Should be absent)' %}
        {% else %}
            {% set details = 'Key is absent/false' %}
        {% endif %}
    {% else %}
        {# Standard Key=Value Check #}
        {% if current | string | lower != rule.value | string | lower %}
            {% set status = 'FAILED' %}
            {% set details = "Expected '" ~ rule.value ~ "', found '" ~ current ~ "'" %}
        {% endif %}
    {% endif %}

    {% set _ = res.append({ "id": rule.id, "control": rule.key, "status": status, "details": details }) %}
{% endfor %}

{# --- 2. HARDWARE CHECKS --- #}

{# Floppy Drives [000008] #}
{% set floppy_con = _hw.floppies | selectattr('connected', 'equalto', true) | list %}
{% set floppy_start = _hw.floppies | selectattr('start_connected', 'equalto', true) | list %}
{% if floppy_con | length > 0 or floppy_start | length > 0 %}
    {% set _ = res.append({ "id": "VMCH-70-000008", "control": "Floppy Drive", "status": "FAILED", "details": "Floppy Connected" }) %}
{% else %}
    {% set _ = res.append({ "id": "VMCH-70-000008", "control": "Floppy Drive", "status": "PASSED", "details": "None" }) %}
{% endif %}

{# CD-ROMs (Host Device) [000009] #}
{% set cdrom_host = _hw.cdroms | selectattr('backing', 'equalto', 'host_device') | list %}
{% if cdrom_host | length > 0 %}
    {% set _ = res.append({ "id": "VMCH-70-000009", "control": "CD-ROM Host Device", "status": "FAILED", "details": "Attached to Host Device" }) %}
{% else %}
    {% set _ = res.append({ "id": "VMCH-70-000009", "control": "CD-ROM Host Device", "status": "PASSED", "details": "Safe" }) %}
{% endif %}

{# Parallel Ports [000010] #}
{% if _hw.parallel_ports | length > 0 %}
    {% set _ = res.append({ "id": "VMCH-70-000010", "control": "Parallel Ports", "status": "FAILED", "details": "Present" }) %}
{% else %}
    {% set _ = res.append({ "id": "VMCH-70-000010", "control": "Parallel Ports", "status": "PASSED", "details": "None" }) %}
{% endif %}

{# Serial Ports [000011] #}
{% if _hw.serial_ports | length > 0 %}
    {% set _ = res.append({ "id": "VMCH-70-000011", "control": "Serial Ports", "status": "FAILED", "details": "Present" }) %}
{% else %}
    {% set _ = res.append({ "id": "VMCH-70-000011", "control": "Serial Ports", "status": "PASSED", "details": "None" }) %}
{% endif %}

{# USB Controllers [000012] #}
{% if _hw.usb_present | default(false) %}
     {% set _ = res.append({ "id": "VMCH-70-000012", "control": "USB Controller", "status": "FAILED", "details": "Present" }) %}
{% else %}
     {% set _ = res.append({ "id": "VMCH-70-000012", "control": "USB Controller", "status": "PASSED", "details": "None" }) %}
{% endif %}

{# Disk Persistence [000006] #}
{% set nonpersistent_disks = _hw.disks | default([]) | selectattr('disk_mode', 'equalto', 'independent_nonpersistent') | list %}
{% if nonpersistent_disks | length > 0 %}
    {% set np_names = nonpersistent_disks | map(attribute='label') | join(', ') %}
    {% set _ = res.append({ "id": "VMCH-70-000006", "control": "Disk Persistence", "status": "FAILED", "details": "Non-persistent disks found: " ~ np_names }) %}
{% else %}
    {% set _ = res.append({ "id": "VMCH-70-000006", "control": "Disk Persistence", "status": "PASSED", "details": "All disks are persistent" }) %}
{% endif %}

{# --- 3. MISC CHECKS --- #}

{# vMotion Encryption [000024] #}
{% set vmotion = item.vmotion_encryption | default('disabled') %}
{% if vmotion == 'disabled' %}
    {% set _ = res.append({ "id": "VMCH-70-000024", "control": "vMotion Encryption", "status": "FAILED", "details": "Encryption is Disabled" }) %}
{% else %}
    {% set _ = res.append({ "id": "VMCH-70-000024", "control": "vMotion Encryption", "status": "PASSED", "details": "Set to " ~ vmotion }) %}
{% endif %}

{# Enable Logging [000025] #}
{% if item.logging_enabled | default(true) | bool %}
    {% set _ = res.append({ "id": "VMCH-70-000025", "control": "Enable Logging", "status": "PASSED", "details": "Logging Enabled" }) %}
{% else %}
    {% set _ = res.append({ "id": "VMCH-70-000025", "control": "Enable Logging", "status": "FAILED", "details": "Logging Disabled" }) %}
{% endif %}

{# FT Encryption [000029] #}
{% set ft_enc = item.ft_encryption | default('ftEncryptionDisabled') %}
{% if ft_enc in ['ftEncryptionOpportunistic', 'ftEncryptionRequired'] %}
    {% set _ = res.append({ "id": "VMCH-70-000029", "control": "FT Encryption", "status": "PASSED", "details": "Set to " ~ ft_enc }) %}
{% else %}
    {% set _ = res.append({ "id": "VMCH-70-000029", "control": "FT Encryption", "status": "FAILED", "details": "Encryption is Disabled (" ~ ft_enc ~ ")" }) %}
{% endif %}

{{ res | to_json }}
