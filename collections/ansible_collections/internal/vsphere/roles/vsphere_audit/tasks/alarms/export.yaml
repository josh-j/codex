# roles/vsphere/tasks/alarms/export.yaml
# IO: Write detailed alarm data to disk

- name: Export active alarms to CSV
  ansible.builtin.include_role:
    name: internal.core.reporting
    tasks_from: export_csv
  vars:
    ops_csv_report_name: "vcenter_active_alarms"
    ops_csv_headers:
      [
        "vCenter", "Entity", "Alarm Name", "Severity", "Status",
        "Time", "Description",
      ]
    # Explicit key mapping
    ops_csv_keys:
      [
        "vcenter", "entity", "alarm_name", "severity", "status",
        "time", "description"
      ]
    ops_csv_data: "{{ vcenter.alarms.list }}"
    ops_csv_sort_by: "severity"
  when:
    - vcenter.config.export_csv
    - vcenter.alarms is defined
    - vcenter.alarms.metrics.total | default(0) | int > 0
