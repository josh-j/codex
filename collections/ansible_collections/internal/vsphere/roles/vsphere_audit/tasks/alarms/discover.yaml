---
# roles/vsphere/tasks/alarms/discover.yaml
# Executes PyVmomi script to fetch active alarms and normalizes the data.

- name: Alarm collection and normalization
  block:
    - name: Execute alarm collection script (PyVmomi)
      ansible.builtin.script:
        cmd: >-
          {{ role_path }}/files/get_vcenter_alarms.py
          {{ vcenter.connection.hostname }}
          {{ vcenter.connection.username }}
      environment:
        VC_PASSWORD: "{{ vcenter.connection.password }}"
      register: _alarms_script_result
      delegate_to: localhost
      failed_when: false
      changed_when: false
      check_mode: false          # IMPORTANT: allow read-only collection in --check
      no_log: true               # IMPORTANT: prevents creds from leaking in logs

    - name: Parse alarm results from script
      ansible.builtin.set_fact:
        _alarms_parsed: "{{ (_alarms_script_result.get('stdout', '') | trim) | from_json }}"
      when:
        - _alarms_script_result is mapping
        - (_alarms_script_result.get('rc', 1) | int) == 0
        - (_alarms_script_result.get('stdout', '') | trim | length) > 0
      changed_when: false

    - name: Store alarms in vcenter namespace
      ansible.builtin.set_fact:
        vcenter: "{{ vcenter | combine({'alarms': alarms_data}, recursive=true) }}"
      vars:
        _raw_list: "{{ (_alarms_parsed.alarms | default([])) if (_alarms_parsed is mapping) else [] }}"
        alarms_list: >-
          {%- set res = [] -%}
          {%- for item in _raw_list -%}
            {%- set status_val = item.status | default(item.overallStatus | default('unknown')) -%}

            {%- if item.severity is defined -%}
              {%- set sev_val = item.severity -%}
            {%- elif (status_val | string | lower) == 'red' -%}
              {%- set sev_val = 'critical' -%}
            {%- elif (status_val | string | lower) == 'yellow' -%}
              {%- set sev_val = 'warning' -%}
            {%- else -%}
              {%- set sev_val = 'info' -%}
            {%- endif -%}

            {%- set _ = res.append({
              'site': inventory_hostname,
              'vcenter': inventory_hostname,
              'alarm_name': (item.alarm_name | default(item.name | default('unknown'))),
              'entity': (item.entity_name | default(item.entityName | default('unknown'))),
              'description': (item.alarm_description | default(item.description | default(''))),
              'severity': (sev_val | string | lower),
              'status': status_val,
              'time': (item.time | default(item.timestamp | default('')))
            }) -%}
          {%- endfor -%}
          {{ res }}
        alarms_data:
          list: "{{ alarms_list }}"
          by_severity:
            critical: "{{ alarms_list | selectattr('severity', 'equalto', 'critical') | list }}"
            warning: "{{ alarms_list | selectattr('severity', 'equalto', 'warning') | list }}"
          metrics:
            total: "{{ alarms_list | length }}"
            critical_count: "{{ alarms_list | selectattr('severity', 'equalto', 'critical') | list | length }}"
            warning_count: "{{ alarms_list | selectattr('severity', 'equalto', 'warning') | list | length }}"
      when: _alarms_parsed is defined
      changed_when: false

  rescue:
    - name: Set empty alarm data
      ansible.builtin.set_fact:
        vcenter: "{{ vcenter | combine({'alarms': empty_alarms}, recursive=true) }}"
      vars:
        empty_alarms:
          list: []
          by_severity: { critical: [], warning: [] }
          metrics: { total: 0, critical_count: 0, warning_count: 0 }
      changed_when: false

  always:
    - name: Ensure alarms namespace exists
      ansible.builtin.set_fact:
        vcenter: "{{ vcenter | combine({'alarms': (vcenter.alarms | default(_empty))}, recursive=true) }}"
      vars:
        _empty:
          list: []
          by_severity: { critical: [], warning: [] }
          metrics: { total: 0, critical_count: 0, warning_count: 0 }
      changed_when: false
