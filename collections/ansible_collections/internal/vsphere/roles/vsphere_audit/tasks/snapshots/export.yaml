---
# roles/vsphere/tasks/snapshots/export.yaml
# Export aged snapshot inventory to CSV

- name: Export aged snapshots to CSV
  ansible.builtin.include_role:
    name: internal.core.reporting
    tasks_from: export_csv
  vars:
    ops_csv_report_name: "aged_snapshots"
    ops_csv_headers:
      [
        "vCenter", "Datacenter", "VM Name", "Snapshot Name", "Owner Email",
        "Description", "Age (Days)", "Size (GB)", "Created Date", "State", "Quiesced",
      ]
    # Explicit mapping to the keys created in discover.yaml
    ops_csv_keys:
      [
        "vcenter", "datacenter", "vm_name", "snapshot_name", "owner_email",
        "description", "age_days", "size_gb", "created_date", "state", "quiesced"
      ]
    # FIX: Force to list to prevent generator object errors
    ops_csv_data: "{{ vcenter.snapshots.aged | default([]) | list }}"

    # FIX: Comment out sort temporarily to ensure rows are written even if a key is missing
    # ops_csv_sort_by: "age_days"
  when:
    - vcenter.config.export_csv | default(true) | bool
    - vcenter.snapshots.metrics.total_aged | default(0) | int > 0
