---
# roles/vsphere/tasks/datastores/check.yaml
# Explicit checks for Datastore Capacity, Connectivity, and Maintenance

# ========================================================================
# CAPACITY ALERTS
# ========================================================================

- name: "Check: Datastore Critical Capacity"
  ansible.builtin.include_role:
    name: internal.core.reporting
    tasks_from: alert
  vars:
    ops_alert_severity: "CRITICAL"
    ops_alert_category: "capacity"
    ops_alert_message: "Datastore {{ item.name }} critically low ({{ item.free_pct }}% free)"
    ops_alert_details:
      datastore: "{{ item.name }}"
      free_pct: "{{ item.free_pct }}"
      free_gb: "{{ item.free_gb }}"
      capacity_gb: "{{ item.capacity_gb }}"
      threshold_pct: "{{ vcenter.config.datastore_free_critical_pct | default(10) }}"
  loop: "{{ (vcenter.datastores.list | default([])) | selectattr('status', 'equalto', 'CRITICAL') | list }}"
  loop_control:
    label: "{{ item.name }}"
  when: (vcenter.datastores.list | default([])) | length > 0

- name: "Check: Datastore Low Capacity"
  ansible.builtin.include_role:
    name: internal.core.reporting
    tasks_from: alert
  vars:
    ops_alert_severity: "WARNING"
    ops_alert_category: "capacity"
    ops_alert_message: "Datastore {{ item.name }} low ({{ item.free_pct }}% free)"
    ops_alert_details:
      datastore: "{{ item.name }}"
      free_pct: "{{ item.free_pct }}"
      free_gb: "{{ item.free_gb }}"
      capacity_gb: "{{ item.capacity_gb }}"
      threshold_pct: "{{ vcenter.config.datastore_free_warning_pct | default(15) }}"
  loop: "{{ (vcenter.datastores.list | default([])) | selectattr('status', 'equalto', 'WARNING') | list }}"
  loop_control:
    label: "{{ item.name }}"
  when: (vcenter.datastores.list | default([])) | length > 0

# ========================================================================
# CONFIGURATION ALERTS
# ========================================================================

- name: "Check: Datastore Maintenance Mode"
  ansible.builtin.include_role:
    name: internal.core.reporting
    tasks_from: alert
  vars:
    ops_alert_severity: "WARNING"
    ops_alert_category: "configuration"
    ops_alert_message: "Datastore {{ item.name }} in maintenance mode ({{ item.maintenance_mode }})"
    ops_alert_details:
      datastore: "{{ item.name }}"
      maintenance_mode: "{{ item.maintenance_mode }}"
  loop: >-
    {{
      (vcenter.datastores.list | default([]))
      | selectattr('maintenance_mode', 'defined')
      | rejectattr('maintenance_mode', 'equalto', 'normal')
      | rejectattr('maintenance_mode', 'equalto', 'Normal')
      | list
    }}
  loop_control:
    label: "{{ item.name }}"
  when: (vcenter.datastores.list | default([])) | length > 0

- name: "Check: Datastore Inaccessible"
  ansible.builtin.include_role:
    name: internal.core.reporting
    tasks_from: alert
  vars:
    ops_alert_severity: "CRITICAL"
    ops_alert_category: "connectivity"
    ops_alert_message: "Datastore {{ item.name }} is inaccessible"
    ops_alert_details:
      datastore: "{{ item.name }}"
      accessible: "{{ item.accessible | default('unknown') }}"
  loop: >-
    {{
      (vcenter.datastores.list | default([]))
      | selectattr('accessible', 'defined')
      | selectattr('accessible', 'equalto', false)
      | list
    }}
  loop_control:
    label: "{{ item.name }}"
  when: (vcenter.datastores.list | default([])) | length > 0
