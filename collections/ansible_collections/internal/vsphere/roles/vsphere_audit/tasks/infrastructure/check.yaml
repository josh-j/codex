---
# roles/vsphere/tasks/infrastructure/check.yaml
# Alerting for vCenter Infrastructure, Appliance Health, and Cluster Status

# -----------------------------------------------------------------------------
# Rule-driven checks (Global vCenter Facts)
# -----------------------------------------------------------------------------
- name: VCenter checks | emit alerts
  ansible.builtin.include_role:
    name: internal.core.reporting
    tasks_from: alert
  vars:
    ops_alert_severity: "{{ item.severity }}"
    ops_alert_category: "{{ item.category }}"
    ops_alert_message: "{{ item.message }}"
    ops_alert_details: "{{ item.details | default({}) }}"
  loop:
    # 1) Inventory sanity
    - severity: CRITICAL
      category: configuration
      message: "No datacenters found in vCenter inventory."
      details:
        expected: "At least 1"
        found: "{{ vcenter.datacenters.metrics.total | default(0) }}"
      # FIX: Condition evaluated here in the list
      when: "{{ (vcenter.datacenters.metrics.total | default(0) | int) == 0 }}"

    # 2) Appliance health
    - severity: CRITICAL
      category: infrastructure
      message: "vCenter Appliance Health is {{ vcenter.appliance.health.overall | default('unknown') | upper }}"
      details:
        overall: "{{ vcenter.appliance.health.overall | default('unknown') }}"
        database: "{{ vcenter.appliance.health.database | default('unknown') }}"
        storage: "{{ vcenter.appliance.health.storage | default('unknown') }}"
        swap: "{{ vcenter.appliance.health.swap | default('unknown') }}"
      when: "{{ (vcenter.appliance.health.overall | default('unknown') | lower) != 'green' }}"

    - severity: WARNING
      category: security
      message: "SSH is currently enabled on vCenter Appliance."
      details:
        ssh_enabled: true
        recommendation: "Disable SSH via VAMI (port 5480) unless actively troubleshooting."
      when: "{{ vcenter.appliance.config.ssh_enabled | default(false) | bool }}"

    # 3) Backups
    - severity: CRITICAL
      category: backup
      message: "vCenter File-Based Backup is NOT configured or disabled."
      details:
        configured: "{{ vcenter.appliance.backup.configured | default(false) }}"
        enabled: "{{ vcenter.appliance.backup.enabled | default(false) }}"
        location: "{{ vcenter.appliance.backup.location | default('Not Configured') }}"
      when: >-
        {{
          (vcenter.appliance.backup.enabled is defined)
          and not (vcenter.appliance.backup.enabled | default(false) | bool)
        }}

  # FIX: No Jinja2 brackets in top-level when
  when: item.when | bool
  loop_control:
    label: "{{ item.severity }} {{ item.category }}"

# -----------------------------------------------------------------------------
# Cluster-based checks
# Refactored: Split into discrete tasks to avoid "undefined variable 'item'"
# recursion errors in complex product loops.
# -----------------------------------------------------------------------------

- name: Cluster checks | Configuration (HA/DRS)
  ansible.builtin.include_role:
    name: internal.core.reporting
    tasks_from: alert
  vars:
    ops_alert_severity: WARNING
    ops_alert_category: configuration
    ops_alert_message: "Cluster '{{ item.key }}' has HA or DRS disabled."
    ops_alert_details:
      cluster: "{{ item.key }}"
      ha_enabled: "{{ item.value.compliance.ha_enabled | default(false) }}"
      drs_enabled: "{{ item.value.compliance.drs_enabled | default(false) }}"
  loop: "{{ vcenter.clusters.by_name | default({}) | dict2items }}"
  when: >-
    (item.value.compliance is defined)
    and (
      not (item.value.compliance.ha_enabled | default(false) | bool)
      or not (item.value.compliance.drs_enabled | default(false) | bool)
    )
  loop_control:
    label: "WARNING configuration {{ item.key }}"

- name: Cluster checks | Memory Capacity
  ansible.builtin.include_role:
    name: internal.core.reporting
    tasks_from: alert
  vars:
    ops_alert_severity: WARNING
    ops_alert_category: capacity
    ops_alert_message: "Cluster '{{ item.key }}' Memory is critical ({{ item.value.utilization.mem_pct | default(0) }}%)"
    ops_alert_details:
      cluster: "{{ item.key }}"
      usage_pct: "{{ item.value.utilization.mem_pct | default(0) }}"
      used_mb: "{{ item.value.utilization.mem_used_mb | default(0) }}"
      total_mb: "{{ item.value.utilization.mem_total_mb | default(0) }}"
  loop: "{{ vcenter.clusters.by_name | default({}) | dict2items }}"
  when: "(item.value.utilization.mem_pct | default(0) | float) > 90.0"
  loop_control:
    label: "WARNING capacity {{ item.key }} (Mem)"

- name: Cluster checks | CPU Capacity
  ansible.builtin.include_role:
    name: internal.core.reporting
    tasks_from: alert
  vars:
    ops_alert_severity: WARNING
    ops_alert_category: capacity
    ops_alert_message: "Cluster '{{ item.key }}' CPU is critical ({{ item.value.utilization.cpu_pct | default(0) }}%)"
    ops_alert_details:
      cluster: "{{ item.key }}"
      usage_pct: "{{ item.value.utilization.cpu_pct | default(0) }}"
  loop: "{{ vcenter.clusters.by_name | default({}) | dict2items }}"
  when: "(item.value.utilization.cpu_pct | default(0) | float) > 90.0"
  loop_control:
    label: "WARNING capacity {{ item.key }} (CPU)"
