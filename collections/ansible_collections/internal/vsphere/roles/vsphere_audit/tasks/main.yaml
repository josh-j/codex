---
# roles/vsphere/tasks/main.yaml
# vCenter entry point (domain-based architecture)
# Orchestrates: init -> discovery -> checks -> summary -> export

- name: VCenter operations checks
  block:
    # ========================================================================
    # 1) INITIALIZATION
    # ========================================================================
    - name: Init | vCenter defaults & reachability
      ansible.builtin.import_tasks: init/main.yaml
      tags: [always]

    - name: Init | Stop if vCenter checks marked failed
      ansible.builtin.meta: end_host
      when: vcenter.checks_failed | default(false) | bool
      tags: [always]

    # ========================================================================
    # 2) DISCOVERY PHASE (Read-only)
    # ========================================================================
    - name: Phase 2 | Discovery
      ansible.builtin.import_tasks: discovery.yaml
      when: not (vsphere_skip_discovery | default(false) | bool)
      tags: ['discovery']

    # ========================================================================
    # 3) CHECKS PHASE (Logic & Alerts)
    # ========================================================================
    - name: Phase 3 | Checks
      ansible.builtin.import_tasks: checks.yaml
      tags: ['checks']

    # ========================================================================
    # 4) SUMMARY / METRICS (Barrier)
    # ========================================================================
    - name: Phase 4 | Summary
      ansible.builtin.import_tasks: summary/calculate.yaml
      tags: ['summary']

    # ========================================================================
    # 5) EXPORT PHASE (Passive I/O)
    # ========================================================================
    - name: Phase 5 | Export
      ansible.builtin.import_tasks: exports.yaml
      tags: ['export']

  rescue:
    - name: Log vCenter checks failure
      ansible.builtin.include_role:
        name: internal.core.common
        tasks_from: logging/error
      vars:
        ops_log_message: >-
          vCenter checks failed for {{ inventory_hostname }}:
          {{ ansible_failed_result.msg | default('unknown error') }}

    - name: Mark vCenter checks failed
      ansible.builtin.set_fact:
        vcenter: "{{ (vcenter | default({})) | combine({'checks_failed': true}, recursive=true) }}"
