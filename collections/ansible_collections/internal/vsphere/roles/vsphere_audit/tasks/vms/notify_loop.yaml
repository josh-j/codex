---
# roles/vsphere/tasks/vms/notify_loop.yaml
# Logic: Filters global issues down to a specific user and sends email

- name: "Filter data for {{ owner_email }}"
  ansible.builtin.set_fact:
    # 1. Identify which VMs belong to this user
    _my_vm_names: >-
      {{
         vcenter.vms.list
         | selectattr('owner_email', 'equalto', owner_email)
         | map(attribute='name')
         | list
      }}

- name: "Compile issues for {{ owner_email }}"
  ansible.builtin.set_fact:
    # 2. Filter the Global Issue Lists against the User's VM Names
    my_issues:
      no_backup: >-
        {{ vcenter.vms.never_backed_up | selectattr('name', 'in', _my_vm_names) | list }}

      no_backup_tags: >-
        {{ vcenter.vms.without_backup_tags | selectattr('name', 'in', _my_vm_names) | list }}

      overdue_backup: >-
        {{ vcenter.vms.with_overdue_backup | selectattr('name', 'in', _my_vm_names) | list }}

      aged_snapshots: >-
        {{ vcenter.snapshots.aged | selectattr('vm_name', 'in', _my_vm_names) | list }}

      powered_off: >-
        {{ vcenter.vms.list
           | selectattr('owner_email', 'equalto', owner_email)
           | selectattr('power_state', 'equalto', 'POWEREDOFF')
           | list }}

# LINTER FIX: Replaced 'ignore_errors' with Block/Rescue
# - name: Attempt email delivery
#   block:
#     - name: "Send Email to {{ owner_email }}"
#       community.general.mail:
#         host: "{{ ops.config.smtp.host }}"
#         port: "{{ ops.config.smtp.port }}"
#         from: "{{ ops.config.owner_notification_from }}"
#         to: "{{ owner_email }}"
#         subject: "Action Required: Compliance Report for {{ inventory_hostname }}"
#         subtype: html
#         body: "{{ lookup('template', 'owner_notifications_email.html') }}"
#       vars:
#         # Pass data to the template
#         issues: "{{ my_issues }}"
#         vm_count: "{{ _my_vm_names | length }}"
#       # Only send if there are actual issues
#       when:
#         - (my_issues.no_backup | length > 0) or
#           (my_issues.no_backup_tags | length > 0) or
#           (my_issues.overdue_backup | length > 0) or
#           (my_issues.aged_snapshots | length > 0)
#       delegate_to: localhost

#   rescue:
#     - name: Log email delivery failure
#       ansible.builtin.debug:
#         msg: "WARNING: Failed to send notification to {{ owner_email }}. Check SMTP settings or email address."
