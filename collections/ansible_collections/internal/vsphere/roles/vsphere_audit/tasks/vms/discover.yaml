---
# roles/vsphere/tasks/vms/discover.yaml
# Collects VM info, normalizes data, and calculates compliance lists.

# ========================================================================
# 1. COLLECTION
# ========================================================================

- name: Get VM info from vCenter API
  community.vmware.vmware_vm_info:
    hostname: "{{ ansible_host }}"
    username: "{{ ansible_password }}"
    password: "{{ vcenter.connection.password }}"
    validate_certs: "{{ vcenter.config.validate_certs }}"
    vm_type: vm
    show_attribute: true
    show_tag: true
  register: _vms_raw
  delegate_to: localhost
  retries: 3
  delay: 2
  until: _vms_raw is succeeded

- name: Cache VM info
  ansible.builtin.set_fact:
    vcenter_vms_raw: "{{ _vms_raw }}"

# DEBUG: Verify we have data
- name: DEBUG - Check raw VM count
  ansible.builtin.debug:
    msg:
      - "Raw VMs collected: {{ _vms_raw.virtual_machines | default([]) | length }}"
      - "First VM name: {{ _vms_raw.virtual_machines[0].guest_name | default('NONE') }}"

# ========================================================================
# 2. NORMALIZATION
# ========================================================================

- name: Normalize VMs to list with enriched data
  ansible.builtin.set_fact:
    vcenter: "{{ vcenter | combine({'vms': {'list': vcenter.vms.list | default([]) + [vm_normalized]}}, recursive=true) }}"
  vars:
    owner_tags: "{{ item.tags | default([]) | selectattr('category_name', 'equalto', 'Owner') | list }}"
    backup_tags: "{{ item.tags | default([]) | selectattr('category_name', 'equalto', 'Backup Schedule') | list }}"

    # Robust Email Extraction - handles various attribute key formats
    _attrs: "{{ item.attributes | default({}) }}"
    raw_email: >-
      {{
        _attrs.get('Owner Email', '') or
        _attrs.get('OwnerEmail', '') or
        _attrs.get('owner_email', '') or
        _attrs.get('Owner_Email', '') or
        ''
      }}

    vm_normalized:
      name: "{{ item.guest_name }}"
      uuid: "{{ item.uuid }}"
      power_state: "{{ item.power_state | upper }}"
      guest_os: "{{ item.guest_fullname | default('Unknown') }}"
      cluster: "{{ item.cluster | default('N/A') }}"
      datacenter: "{{ item.datacenter | default('N/A') }}"
      tags: "{{ item.tags | default([]) }}"
      backup_info: "{{ _attrs.get('Last Dell PowerProtect Backup', '') }}"
      backup_schedule: "{{ backup_tags[0].name if backup_tags | length > 0 else 'None' }}"
      owner_email: "{{ raw_email | trim }}"
      vcenter: "{{ inventory_hostname }}"
  loop: "{{ _vms_raw.virtual_machines | default([]) }}"
  loop_control:
    label: "{{ item.guest_name | default('unknown') }}"
  when:
    - item.guest_name is defined

# DEBUG: Verify normalized list
- name: DEBUG - Check normalized VM count and sample
  ansible.builtin.debug:
    msg:
      - "Normalized VMs: {{ vcenter.vms.list | default([]) | length }}"
      - "First VM: {{ vcenter.vms.list[0] | default('NONE') }}"

# ========================================================================
# 3. ANALYSIS
# ========================================================================

- name: Compute run epoch once (shared)
  ansible.builtin.set_fact:
    ops_run_epoch: "{{ lookup('ansible.builtin.pipe', 'date +%s') | int }}"
  run_once: true
  delegate_to: localhost
  delegate_facts: true
  changed_when: false

- name: Bind run epoch to each host
  ansible.builtin.set_fact:
    _current_epoch: "{{ hostvars['localhost'].ops_run_epoch | int }}"
  changed_when: false


- name: Analyze backup status for each VM
  ansible.builtin.set_fact:
    vcenter: "{{ vcenter | combine({'vms': {'backup_analysis': vcenter.vms.backup_analysis | default([]) + [vm_status]}}, recursive=true) }}"
  vars:
    backup_info: "{{ item.backup_info }}"
    has_backup: "{{ backup_info != '' and 'EndTime=' in backup_info }}"
    backup_timestamp_str: "{{ backup_info.split('EndTime=')[1].split(',')[0] if has_backup else '' }}"
    backup_epoch: "{{ (backup_timestamp_str | to_datetime('%Y-%m-%dT%H:%M:%SZ')).strftime('%s') | int if backup_timestamp_str != '' else 0 }}"
    days_since_backup: "{{ ((_current_epoch | int - backup_epoch | int) / 86400) | int if backup_epoch | int > 0 else 9999 }}"
    expected_frequency: "{{ vcenter.config.backup_schedules.get(item.backup_schedule | lower, 0) }}"
    backup_overdue: "{{ expected_frequency | int > 0 and days_since_backup | int > (expected_frequency | int + vcenter.config.backup_grace_period_days | int) }}"
    vm_status:
      vcenter: "{{ item.vcenter }}"
      name: "{{ item.name }}"
      datacenter: "{{ item.datacenter }}"
      cluster: "{{ item.cluster }}"
      power_state: "{{ item.power_state }}"
      backup_schedule: "{{ item.backup_schedule }}"
      has_backup: "{{ has_backup }}"
      last_backup_date: "{{ backup_timestamp_str }}"
      days_since_backup: "{{ days_since_backup }}"
      expected_frequency: "{{ expected_frequency }}"
      backup_overdue: "{{ backup_overdue }}"
      owner_email: "{{ item.owner_email }}"
  loop: "{{ vcenter.vms.list | default([]) }}"
  loop_control:
    label: "{{ item.name }}"

# ========================================================================
# 4. FILTERING & METRICS
# ========================================================================

- name: Build Compliance Lists
  ansible.builtin.set_fact:
    vcenter: "{{ vcenter | combine({'vms': vm_compliance_data}, recursive=true) }}"
  vars:
    never_backed_up: >-
      {{ vcenter.vms.backup_analysis | default([]) |
      selectattr('has_backup', 'equalto', false) |
      selectattr('backup_schedule', 'ne', 'None') |
      selectattr('backup_schedule', 'ne', 'No Backup') | list }}

    with_overdue_backup: >-
      {{ vcenter.vms.backup_analysis | default([]) |
      selectattr('backup_overdue', 'equalto', true) | list }}

    without_backup_tags: >-
      {{ vcenter.vms.backup_analysis | default([]) |
      selectattr('backup_schedule', 'eq', 'None') | list }}

    without_owner_email: >-
      {{ vcenter.vms.list | default([]) |
      selectattr('owner_email', 'equalto', '') | list }}

    # Power Metrics
    _vms: "{{ vcenter.vms.list | default([]) }}"
    _total: "{{ _vms | length }}"
    _powered_off: "{{ _vms | selectattr('power_state', 'equalto', 'POWEREDOFF') | list | length }}"

    vm_compliance_data:
      never_backed_up: "{{ never_backed_up }}"
      with_overdue_backup: "{{ with_overdue_backup }}"
      without_backup_tags: "{{ without_backup_tags }}"
      without_owner_email: "{{ without_owner_email }}"
      metrics:
        total: "{{ _total }}"
        powered_off: "{{ _powered_off }}"
        powered_off_pct: "{{ ((_powered_off | int / _total | int) * 100) | round(1) if _total | int > 0 else 0 }}"

- name: Log VM Summary
  ansible.builtin.include_role:
    name: common
    tasks_from: logging/info
  vars:
    ops_log_message: >-
      Analyzed {{ vcenter.vms.metrics.total }} VMs:
      {{ vcenter.vms.never_backed_up | length }} Never Backed Up,
      {{ vcenter.vms.with_overdue_backup | length }} Overdue
