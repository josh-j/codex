---
# roles/vsphere/tasks/vms/export.yaml
# Export VM Compliance Reports (Filtered for False Positives)

- name: Debug - Show export configuration
  ansible.builtin.debug:
    msg:
      - "Export Config: {{ vcenter.config.export_csv | default(true) }}"
      - "Never Backed Up Count: {{ vcenter.vms.never_backed_up | default([]) | length }}"

# 1. NEVER BACKED UP
- name: Export VMs never backed up
  ansible.builtin.include_role:
    name: internal.core.reporting
    tasks_from: export_csv
  vars:
    ops_csv_report_name: "vms_never_backup"
    ops_csv_headers: ["Site", "VM Name", "Power State", "Backup Schedule", "Cluster", "Owner Email"]
    ops_csv_keys: ["vcenter", "name", "power_state", "backup_schedule", "cluster", "owner_email"]
    # Filter out vCLS/VCSA system VMs
    ops_csv_data: >-
      {{ vcenter.vms.never_backed_up | default([])
         | rejectattr('name', 'search', 'vCLS')
         | rejectattr('name', 'search', 'VCSA') | list }}
    ops_csv_sort_by: "name"
  when: vcenter.config.export_csv | default(true) | bool

# 2. OVERDUE BACKUPS
- name: Export VMs with overdue backups
  ansible.builtin.include_role:
    name: internal.core.reporting
    tasks_from: export_csv
  vars:
    ops_csv_report_name: "vms_overdue_backup"
    ops_csv_headers: ["Site", "VM Name", "Last Backup", "Days Since", "Expected", "Owner Email"]
    ops_csv_keys: ["vcenter", "name", "last_backup_date", "days_since_backup", "expected_frequency", "owner_email"]
    ops_csv_data: "{{ vcenter.vms.with_overdue_backup | default([]) | list }}"
    ops_csv_sort_by: "days_since_backup"
  when: vcenter.config.export_csv | default(true) | bool

# 3. MISSING TAGS
- name: Export VMs without backup tags
  ansible.builtin.include_role:
    name: internal.core.reporting
    tasks_from: export_csv
  vars:
    ops_csv_report_name: "vms_no_backup_tags"
    ops_csv_headers: ["Site", "VM Name", "Power State", "Cluster", "Owner Email"]
    ops_csv_keys: ["vcenter", "name", "power_state", "cluster", "owner_email"]
    # Filter out vCLS/VCSA
    ops_csv_data: >-
      {{ vcenter.vms.without_backup_tags | default([])
         | rejectattr('name', 'search', 'vCLS')
         | rejectattr('name', 'search', 'VCSA') | list }}
    ops_csv_sort_by: "name"
  when: vcenter.config.export_csv | default(true) | bool

# 4. MISSING OWNER
- name: Export VMs without owner email
  ansible.builtin.include_role:
    name: internal.core.reporting
    tasks_from: export_csv
  vars:
    ops_csv_report_name: "vms_no_owner_email"
    ops_csv_headers: ["Site", "VM Name", "Power State", "Cluster"]
    ops_csv_keys: ["vcenter", "name", "power_state", "cluster"]
    # Filter out vCLS/VCSA
    ops_csv_data: >-
      {{ vcenter.vms.without_owner_email | default([])
         | rejectattr('name', 'search', 'vCLS')
         | rejectattr('name', 'search', 'VCSA') | list }}
    ops_csv_sort_by: "name"
  when: vcenter.config.export_csv | default(true) | bool

# 5. POWERED OFF
- name: Export powered-off VMs inventory
  ansible.builtin.include_role:
    name: internal.core.reporting
    tasks_from: export_csv
  vars:
    ops_csv_report_name: "vms_powered_off"
    ops_csv_headers: ["Site", "VM Name", "Guest OS", "Cluster", "Owner Email"]
    ops_csv_keys: ["vcenter", "name", "guest_os", "cluster", "owner_email"]
    ops_csv_data: "{{ vcenter.vms.list | default([]) | selectattr('power_state', 'equalto', 'POWEREDOFF') | list }}"
    ops_csv_sort_by: "name"
  when: vcenter.config.export_csv | default(true) | bool

# 6. FULL INVENTORY (BONUS)
- name: Export Full VM Inventory (Audit)
  ansible.builtin.include_role:
    name: internal.core.reporting
    tasks_from: export_csv
  vars:
    ops_csv_report_name: "vms_inventory_full"
    ops_csv_headers: ["Site", "VM Name", "UUID", "Cluster", "Datacenter", "Power", "OS", "Owner", "Backup Tag"]
    ops_csv_keys: ["vcenter", "name", "uuid", "cluster", "datacenter", "power_state", "guest_os", "owner_email", "backup_schedule"]
    ops_csv_data: "{{ vcenter.vms.list | default([]) }}"
    ops_csv_sort_by: "name"
  when: vcenter.config.export_csv | default(true) | bool
