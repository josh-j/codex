---
# roles/vsphere/tasks/summary/export.yaml
# Export vCenter summary metrics to CSV

- name: Export vcenter summary to CSV
  ansible.builtin.include_role:
    name: internal.core.reporting
    tasks_from: export_csv
  vars:
    ops_csv_report_name: "vcenter_summary"
    ops_csv_headers:
      [
        "vCenter", "Total Alerts", "Critical", "Warning", "Info",
        "Backup Issues", "Capacity Issues", "Config Issues",
        "Infra Issues", "Security Issues", "Checks Completed"
      ]
    # Explicit mapping
    ops_csv_keys:
      [
        "vcenter", "total_alerts", "critical", "warning", "info",
        "backup_issues", "capacity_issues", "config_issues",
        "infra_issues", "security_issues", "checks_completed"
      ]
    ops_csv_data:
      - vcenter: "{{ inventory_hostname }}"
        total_alerts: "{{ vcenter.summary.alerts.total }}"
        critical: "{{ vcenter.summary.alerts.critical_count }}"
        warning: "{{ vcenter.summary.alerts.warning_count }}"
        info: "{{ vcenter.summary.alerts.info_count }}"
        # Category Breakdowns
        backup_issues: "{{ vcenter.summary.alerts.by_category.backup }}"
        capacity_issues: "{{ vcenter.summary.alerts.by_category.capacity }}"
        config_issues: "{{ vcenter.summary.alerts.by_category.configuration }}"
        infra_issues: "{{ vcenter.summary.alerts.by_category.infrastructure }}"
        security_issues: "{{ vcenter.summary.alerts.by_category.security }}"
        # Metadata
        checks_completed: "{{ vcenter.summary.checks_completed | length }}"
  when: vcenter.config.export_csv
