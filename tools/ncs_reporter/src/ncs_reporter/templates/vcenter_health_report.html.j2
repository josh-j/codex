<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {% set view = vmware_node_view | default({}) %}
    {% set node = view.get('node', {}) %}
    <title>{{ node.get('name', 'vCenter') }} | VMware Node Health</title>
    <style>
        {% include 'report_shared.css' %}
    </style>
</head>
<body>
<div class="app-layout">
    <main class="content">
        {% set meta = view.get('meta', {}) %}
        {% set alerts = node.get('alerts', {}) %}
        {% set alert_counts = alerts.get('counts', {}) %}
        {% set alert_items = alerts.get('items', []) %}
        {% set util = node.get('utilization', {}) %}
        {% set cpu = util.get('cpu', {}) %}
        {% set mem = util.get('memory', {}) %}
        {% set appliance = node.get('appliance', {}) %}
        {% set app_info = appliance.get('info', {}) %}
        {% set app_health = appliance.get('health', {}) %}
        {% set app_backup = appliance.get('backup', {}) %}
        {% set app_config = appliance.get('config', {}) %}
        {% set _badge = node.get('status', {}).get('raw', 'UNKNOWN') | status_badge_meta(true) %}

        <div style="margin-bottom: 20px; font-size: 0.9rem; color: var(--text-muted);">
            <a href="{{ node.get('links', {}).get('global_dashboard', '../../site_health_report.html') }}" class="nav-link">Global Site</a>
            <span style="margin: 0 8px;">/</span>
            <a href="{{ node.get('links', {}).get('fleet_dashboard', '../vmware_health_report.html') }}" class="nav-link">VMware Fleet</a>
            <span style="margin: 0 8px;">/</span>
            <span style="font-weight: 600; color: var(--text-primary);">{{ node.get('name', 'vCenter') }}</span>
        </div>

        <header class="content-header">
            <div>
                <h1>vCenter Diagnostics: <code>{{ node.get('name', 'unknown') }}</code></h1>
                <p style="color: var(--text-muted); margin-top: 5px;">
                    Version: {{ node.get('version', 'N/A') }} |
                    Status: <span class="badge {{ _badge.css_class }}">{{ _badge.label }}</span>
                </p>
            </div>
            <div style="color: var(--text-muted); font-size: 0.9rem;">
                {% if meta.get('report_id') %}<div>ID: <code>{{ meta.get('report_id') }}</code></div>{% endif %}
                Generated: {{ meta.get('report_date', report_date | default(now_datetime)) }}
            </div>
        </header>

        <div class="dashboard-grid">
            <div class="card">
                <h3>Inventory Footprint</h3>
                <table>
                    <tr><td>Clusters</td><td><strong>{{ node.get('inventory', {}).get('clusters', 0) }}</strong></td></tr>
                    <tr><td>ESXi Hosts</td><td><strong>{{ node.get('inventory', {}).get('hosts', 0) }}</strong></td></tr>
                    <tr><td>VMs</td><td><strong>{{ node.get('inventory', {}).get('vms', 0) }}</strong></td></tr>
                    <tr><td>Active Alerts</td><td><strong>{{ alert_counts.get('total', 0) }}</strong></td></tr>
                </table>
            </div>

            <div class="card">
                <h3>Resource Saturation</h3>
                {% set cpu_pct = util.get('cpu_pct', cpu.get('pct', 0)) %}
                <div class="gauge-container">
                    <div class="gauge-header"><span>Aggregate CPU</span><span>{{ cpu_pct }}%</span></div>
                    <div class="gauge-bar">
                        <div class="gauge-fill" style="width: {{ cpu_pct }}%; background: {{ 'var(--red)' if cpu_pct > 90 else 'var(--indigo)' }}"></div>
                    </div>
                </div>
                {% set mem_pct = util.get('memory_pct', mem.get('pct', 0)) %}
                <div class="gauge-container">
                    <div class="gauge-header"><span>Aggregate Memory</span><span>{{ mem_pct }}%</span></div>
                    <div class="gauge-bar">
                        <div class="gauge-fill" style="width: {{ mem_pct }}%; background: {{ 'var(--red)' if mem_pct > 90 else 'var(--indigo)' }}"></div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>Appliance Overview</h3>
                <table>
                    <tr><td>Product</td><td><strong>{{ app_info.get('product', 'vCenter Server') }}</strong></td></tr>
                    <tr><td>Build</td><td>{{ app_info.get('build', 'unknown') }}</td></tr>
                    <tr><td>Uptime (days)</td><td>{{ app_info.get('uptime_days', 'N/A') }}</td></tr>
                    <tr><td>SSH Enabled</td><td>{{ 'YES' if app_config.get('ssh_enabled', false) else 'NO' }}</td></tr>
                    <tr><td>Backup Enabled</td><td>{{ 'YES' if app_backup.get('enabled', false) else 'NO' }}</td></tr>
                </table>
            </div>
        </div>

        <h2 class="sub-title">Appliance Health Components</h2>
        <div class="card-wrap">
            <table>
                <thead><tr><th>Component</th><th>Status</th></tr></thead>
                <tbody>
                    {% for key in ['overall', 'cpu', 'memory', 'database', 'storage', 'swap'] %}
     {% set value = app_health.get(key, 'unknown') %}
     {% set _health_badge = value | status_badge_meta(true) %}
                    <tr>
                        <td style="text-transform: capitalize;"><strong>{{ key }}</strong></td>
                        <td><span class="badge {{ _health_badge.css_class }}">{{ _health_badge.label }}</span></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <h2 class="sub-title">Cluster Utilization</h2>
        <div class="card-wrap">
            <table>
                <thead><tr><th>Cluster</th><th>Datacenter</th><th>CPU %</th><th>Memory %</th><th>HA</th><th>DRS</th></tr></thead>
                <tbody>
                    {% for cluster in node.get('clusters', []) %}
     {% set c_util = cluster.get('utilization', {}) %}
     {% set comp = cluster.get('compliance', {}) %}
                    <tr>
                        <td><strong>{{ cluster.get('name', 'unknown') }}</strong></td>
                        <td>{{ cluster.get('datacenter', 'unknown') }}</td>
                        <td class="{{ 'text-danger' if (c_util.get('cpu_pct', 0) | float) > 90 else ('text-warning' if (c_util.get('cpu_pct', 0) | float) > 85 else '') }}">
                            {{ c_util.get('cpu_pct', 0) }}%
                        </td>
                        <td class="{{ 'text-danger' if (c_util.get('mem_pct', 0) | float) > 90 else ('text-warning' if (c_util.get('mem_pct', 0) | float) > 85 else '') }}">
                            {{ c_util.get('mem_pct', 0) }}%
                        </td>
                        <td>{{ 'ON' if comp.get('ha_enabled', false) else 'OFF' }}</td>
                        <td>{{ 'ON' if comp.get('drs_enabled', false) else 'OFF' }}</td>
                    </tr>
                    {% else %}
                    <tr><td colspan="6" style="text-align:center; padding: 30px; color: var(--text-muted);">No cluster inventory data found.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <h2 class="sub-title">Audit Alerts</h2>
        <div class="card-wrap">
            <table>
                <thead><tr><th>Severity</th><th>Category</th><th>Message / Detail</th></tr></thead>
                <tbody>
                    {% for alert in alert_items %}
     {% set _alert_badge = alert.get('severity', 'INFO') | status_badge_meta(true) %}
                    <tr class="{{ 'alert-row-critical' if (alert.get('severity', '') | upper) == 'CRITICAL' else ('alert-row-warning' if (alert.get('severity', '') | upper) == 'WARNING' else '') }}">
                        <td><span class="badge {{ _alert_badge.css_class }}">{{ _alert_badge.label }}</span></td>
                        <td style="text-transform: uppercase; font-weight: 700; color: var(--indigo);">{{ alert.get('category', 'vmware') }}</td>
                        <td>
                            <div>{{ alert.get('message', '') }}</div>
     {% set detail = alert.get('detail', {}) %}
     {% set affected_items = alert.get('affected_items', []) %}
     {% if (detail and detail | length > 0) or (affected_items and affected_items | length > 0) %}
                            <details style="margin-top: 6px;">
                                <summary style="cursor: pointer; color: var(--text-muted);">Technical details</summary>
         {% if detail and detail | length > 0 %}
                                <div style="margin-top: 8px;">
                                    <table>
                                        <tbody>
             {% for k, v in detail.items() %}
                                            <tr>
                                                <th style="width: 180px;">{{ k }}</th>
                                                <td><code>{{ v }}</code></td>
                                            </tr>
             {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
         {% endif %}
         {% if affected_items and affected_items | length > 0 %}
                                <div style="margin-top: 8px;">
                                    <strong>Affected Items ({{ affected_items | length }})</strong>
                                    <ul style="margin-top: 6px;">
             {% for item in affected_items[:10] %}
                                        <li><code>{{ item }}</code></li>
             {% endfor %}
                                    </ul>
                                </div>
         {% endif %}
                            </details>
     {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr><td colspan="3" style="text-align:center; padding: 30px; color: var(--text-muted);">No critical or warning alerts detected.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </main>
</div>
</body>
</html>
