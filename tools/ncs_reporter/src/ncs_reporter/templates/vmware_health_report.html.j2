<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VMware Fleet Health | {{ report_stamp }}</title>
    <style>
        {% include 'report_shared.css' %}
    </style>
</head>
<body>
<div class="app-layout">
    <div class="content">
        {% set view = vmware_fleet_view | default({}) %}
        {% set meta = view.get('meta', {}) %}
        {% set fleet = view.get('fleet', {}) %}
        {% set rows = view.get('rows', []) %}
        {% set active_alerts = view.get('active_alerts', []) %}
        {% set fleet_totals = fleet.get('totals', {}) %}
        {% set fleet_alerts = fleet.get('alerts', {}) %}
        {% set fleet_util = fleet.get('utilization', {}) %}
        {% set fleet_cpu = fleet_util.get('cpu', {}) %}
        {% set fleet_mem = fleet_util.get('memory', {}) %}

        <div class="header">
            <div class="title-group">
                <h1>VMware Infrastructure Fleet</h1>
                <p class="text-muted">Report ID: <code>{{ meta.get('report_id', report_id | default('')) }}</code> | Generated: {{ meta.get('report_date', report_date | default(now_datetime)) }}</p>
            </div>
            <div>
                <a href="../../site_health_report.html" class="nav-link">← Global Dashboard</a>
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="card">
                <h3>Inventory Footprint</h3>
                <table>
                    <tr><td>vCenters</td><td><strong>{{ fleet.get('vcenter_count', 0) }}</strong></td></tr>
                    <tr><td>Total Clusters</td><td><strong>{{ fleet_totals.get('clusters', 0) }}</strong></td></tr>
                    <tr><td>Total ESXi Hosts</td><td><strong>{{ fleet_totals.get('hosts', 0) }}</strong></td></tr>
                    <tr><td>Total VMs</td><td><strong>{{ fleet_totals.get('vms', 0) }}</strong></td></tr>
                </table>
            </div>

            <div class="card">
                <h3>Fleet Saturation</h3>
                {% set cpu_pct = fleet_cpu.get('pct', 0) %}
                <div class="gauge-container">
                    <div class="gauge-header"><span>Aggregate CPU</span><span>{{ cpu_pct }}%</span></div>
                    <div class="gauge-bar"><div class="gauge-fill" style="width: {{ cpu_pct }}%; background: {{ 'var(--red)' if cpu_pct > 90 else 'var(--indigo)' }}"></div></div>
                </div>

                {% set mem_pct = fleet_mem.get('pct', 0) %}
                <div class="gauge-container">
                    <div class="gauge-header"><span>Aggregate Memory</span><span>{{ mem_pct }}%</span></div>
                    <div class="gauge-bar"><div class="gauge-fill" style="width: {{ mem_pct }}%; background: {{ 'var(--red)' if mem_pct > 90 else 'var(--indigo)' }}"></div></div>
                </div>
            </div>

            <div class="card">
                <h3>Health Status</h3>
                <div style="display: flex; justify-content: space-around; padding-top: 10px;">
                    <div style="text-align:center;"><div style="font-size: 2rem; font-weight: 700; color: var(--red);">{{ fleet_alerts.get('critical', 0) }}</div>CRITICAL</div>
                    <div style="text-align:center;"><div style="font-size: 2rem; font-weight: 700; color: var(--amber);">{{ fleet_alerts.get('warning', 0) }}</div>WARNING</div>
                </div>
            </div>
        </div>

        <div class="card-wrap">
            <table>
                <thead>
                    <tr><th>vCenter Host</th><th>Status</th><th>Version</th><th>Clusters</th><th>Hosts</th><th>VMs</th><th>CPU%</th><th>Mem%</th><th>Alerts</th><th>Action</th></tr>
                </thead>
                <tbody>
                    {% for row in rows %}
     {% set _badge = row.status.raw | status_badge_meta(true) %}
     {% set inv = row.inventory | default({}) %}
     {% set util = row.utilization | default({}) %}
                        <tr>
                            <td><strong>{{ row.name }}</strong></td>
                            <td><span class="badge {{ _badge.css_class }}">{{ _badge.label }}</span></td>
                            <td>{{ row.version | default('N/A') }}</td>
                            <td>{{ inv.clusters | default(0) }}</td>
                            <td>{{ inv.hosts | default(0) }}</td>
                            <td>{{ inv.vms | default(0) }}</td>
                            <td>{{ util.cpu_pct | default(0) }}%</td>
                            <td>{{ util.memory_pct | default(0) }}%</td>
                            <td>
                                <span class="text-danger">●</span> {{ row.alerts.critical | default(0) }}
                                <span class="text-warning" style="margin-left:8px;">●</span> {{ row.alerts.warning | default(0) }}
                            </td>
                            <td><a href="{{ row.links.node_report_latest }}" class="nav-link">View Node →</a></td>
                        </tr>
                    {% else %}
                        <tr><td colspan="10" style="text-align:center; padding: 30px; color: var(--text-muted);">No VMware fleet rows found.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <h2 class="sub-title">Active Alerts</h2>
        <div class="card-wrap">
            <table>
                <thead>
                    <tr><th>vCenter</th><th>Severity</th><th>Category</th><th>Message</th></tr>
                </thead>
                <tbody>
                    {% for alert in active_alerts %}
     {% set _badge = (alert.severity | default('UNKNOWN')) | status_badge_meta(true) %}
                    <tr>
                        <td><strong>{{ alert.host }}</strong></td>
                        <td><span class="badge {{ _badge.css_class }}">{{ _badge.label }}</span></td>
                        <td>{{ alert.category | default('vmware') }}</td>
                        <td>{{ alert.message | default('') }}</td>
                    </tr>
                    {% else %}
                    <tr><td colspan="4" style="text-align:center; padding: 30px; color: var(--text-muted);">No critical or warning alerts detected.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
</body>
</html>
