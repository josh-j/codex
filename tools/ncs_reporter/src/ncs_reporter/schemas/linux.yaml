name: linux
platform: linux
display_name: "Linux"

# Detects the key emitted by the internal.linux role via ncs_collector callback.
detection:
  keys_any: [ubuntu_raw_discovery]

# ---------------------------------------------------------------------------
# Fields
#
# Raw Linux data lives under:
#   ubuntu_raw_discovery.data.ansible_facts.*
#   ubuntu_raw_discovery.<module_name>.*
#
# Pass 1 (path):    direct traversal
# Pass 2 (compute): arithmetic over extracted fields
# Pass 3 (script):  subprocess for regex / file parsing
# ---------------------------------------------------------------------------

fields:

  # --- System identity ---

  hostname:
    path: "ubuntu_raw_discovery.data.ansible_facts.hostname"
    type: str
    fallback: "unknown"

  ip_address:
    path: "ubuntu_raw_discovery.data.ansible_facts.default_ipv4.address"
    type: str
    fallback: "N/A"

  kernel:
    path: "ubuntu_raw_discovery.data.ansible_facts.kernel"
    type: str
    fallback: "unknown"

  os_family:
    path: "ubuntu_raw_discovery.data.ansible_facts.os_family"
    type: str
    fallback: "unknown"

  distribution:
    path: "ubuntu_raw_discovery.data.ansible_facts.distribution"
    type: str
    fallback: "unknown"

  distribution_version:
    path: "ubuntu_raw_discovery.data.ansible_facts.distribution_version"
    type: str
    fallback: "unknown"

  # --- Uptime ---

  uptime_seconds:
    path: "ubuntu_raw_discovery.data.ansible_facts.uptime_seconds"
    type: float
    fallback: 0.0

  uptime_days:
    compute: "{uptime_seconds} / 86400"
    type: float
    fallback: 0.0

  load_avg_15m:
    path: "ubuntu_raw_discovery.data.ansible_facts.loadavg.15m"
    type: float
    fallback: 0.0

  # --- Memory ---

  memory_total_mb:
    path: "ubuntu_raw_discovery.data.ansible_facts.memtotal_mb"
    type: float
    fallback: 1.0

  memory_free_mb:
    path: "ubuntu_raw_discovery.data.ansible_facts.memfree_mb"
    type: float
    fallback: 0.0

  memory_used_pct:
    compute: "({memory_total_mb} - {memory_free_mb}) / {memory_total_mb} * 100"
    type: float
    fallback: 0.0

  swap_total_mb:
    path: "ubuntu_raw_discovery.data.ansible_facts.swaptotal_mb"
    type: float
    fallback: 0.0

  swap_free_mb:
    path: "ubuntu_raw_discovery.data.ansible_facts.swapfree_mb"
    type: float
    fallback: 0.0

  swap_used_pct:
    compute: "({swap_total_mb} - {swap_free_mb}) / {swap_total_mb} * 100"
    type: float
    fallback: 0.0

  # --- Services ---

  failed_services:
    path: "ubuntu_raw_discovery.data.failed_services.stdout_lines"
    type: list
    fallback: []

  failed_services_count:
    path: "ubuntu_raw_discovery.data.failed_services.stdout_lines | len_if_list"
    type: int
    fallback: 0

  # --- Updates & reboot ---

  # Raw apt-get --simulate output lines; script parses the "X upgraded," count.
  apt_lines:
    path: "ubuntu_raw_discovery.data.apt_simulate.stdout_lines"
    type: list
    fallback: []

  pending_updates_count:
    script: "apt_updates.py"
    type: int
    fallback: 0

  reboot_pending:
    path: "ubuntu_raw_discovery.data.reboot_stat.stat.exists"
    type: bool
    fallback: false

  # --- Collection timestamp (used as reference for date conditions) ---

  collected_at:
    path: "ubuntu_raw_discovery.metadata.timestamp"
    type: str
    fallback: ""

  # --- Storage ---
  # Raw ansible_facts.mounts list; script filters loop/tmpfs and computes
  # total_gb, free_gb, used_pct for each surviving mount.

  mounts:
    path: "ubuntu_raw_discovery.data.ansible_facts.mounts"
    type: list
    fallback: []

  disks:
    script: "disk_inventory.py"
    type: list
    fallback: []

  # --- Security ---

  getent_passwd:
    path: "ubuntu_raw_discovery.data.ansible_facts.getent_passwd"
    type: dict
    fallback: {}

  shadow_lines:
    path: "ubuntu_raw_discovery.data.shadow_raw.stdout_lines"
    type: list
    fallback: []

  epoch_seconds:
    path: "ubuntu_raw_discovery.data.ansible_facts.date_time.epoch"
    type: float
    fallback: 0.0

  sshd_lines:
    path: "ubuntu_raw_discovery.data.sshd_raw.stdout_lines"
    type: list
    fallback: []

  sshd_config:
    script: "parse_sshd_config.py"
    type: dict
    fallback: {}

  world_writable_files:
    path: "ubuntu_raw_discovery.data.world_writable.stdout_lines"
    type: list
    fallback: []

  world_writable_count:
    path: "ubuntu_raw_discovery.data.world_writable.stdout_lines | len_if_list"
    type: int
    fallback: 0

  users:
    script: "user_inventory.py"
    type: list
    fallback: []

# ---------------------------------------------------------------------------
# Alerts
# ---------------------------------------------------------------------------

alerts:

  # ---- Memory ----

  - id: memory_critical
    category: "Capacity"
    severity: CRITICAL
    condition:
      op: gte
      field: memory_used_pct
      threshold: 98.0
    message: "Memory saturation: {memory_used_pct:.1f}% used"
    detail_fields: [memory_total_mb, memory_free_mb, memory_used_pct]

  - id: memory_warning
    category: "Capacity"
    severity: WARNING
    condition:
      op: gte
      field: memory_used_pct
      threshold: 85.0
    message: "Memory pressure: {memory_used_pct:.1f}% used"
    detail_fields: [memory_total_mb, memory_free_mb, memory_used_pct]

  # ---- Storage (per-disk, via computed_filter on enriched disk list) ----

  - id: disk_critical
    category: "Capacity"
    severity: CRITICAL
    condition:
      op: computed_filter
      field: disks
      expression: "{used_pct}"
      cmp: gte
      threshold: 95.0
    message: "One or more filesystems critically full (≥95%)"
    affected_items_field: disks

  - id: disk_warning
    category: "Capacity"
    severity: WARNING
    condition:
      op: computed_filter
      field: disks
      expression: "{used_pct}"
      cmp: gte
      threshold: 80.0
    message: "One or more filesystems reaching capacity (≥80%)"
    affected_items_field: disks

  # ---- Services ----

  - id: services_failed
    category: "Availability"
    severity: CRITICAL
    condition:
      op: gt
      field: failed_services_count
      threshold: 0
    message: "{failed_services_count} systemd service(s) failed"
    detail_fields: [failed_services, failed_services_count]

  # ---- Patching ----

  - id: reboot_pending
    category: "Patching"
    severity: WARNING
    condition:
      op: eq
      field: reboot_pending
      threshold: 1.0
    message: "System requires a reboot to apply kernel or security updates"

  - id: pending_updates
    category: "Patching"
    severity: WARNING
    condition:
      op: gt
      field: pending_updates_count
      threshold: 0
    message: "{pending_updates_count} package update(s) pending"
    detail_fields: [pending_updates_count]

  # ---- Maintenance ----

  - id: uptime_violation
    category: "Maintenance"
    severity: WARNING
    condition:
      op: gt
      field: uptime_days
      threshold: 180.0
    message: "Uptime policy violation: server has not rebooted in over 6 months ({uptime_days:.0f} days)"
    detail_fields: [uptime_days]

  # ---- Security ----

  - id: world_writable_files
    category: "Security"
    severity: WARNING
    condition:
      op: gt
      field: world_writable_count
      threshold: 0
    message: "{world_writable_count} world-writable file(s) detected"
    detail_fields: [world_writable_count]
    affected_items_field: world_writable_files

# ---------------------------------------------------------------------------
# Sections (template rendering)
# ---------------------------------------------------------------------------

sections:

  - id: system_overview
    title: "System Overview"
    type: key_value
    fields:
      - {label: "Hostname",         field: hostname}
      - {label: "IP Address",       field: ip_address}
      - {label: "Distribution",     field: distribution}
      - {label: "Version",          field: distribution_version}
      - {label: "Kernel",           field: kernel}
      - {label: "Uptime (days)",    field: uptime_days}
      - {label: "Load Avg (15m)",   field: load_avg_15m}

  - id: memory
    title: "Memory"
    type: key_value
    fields:
      - {label: "Total (MB)",       field: memory_total_mb}
      - {label: "Free (MB)",        field: memory_free_mb}
      - {label: "Used %",           field: memory_used_pct}
      - {label: "Swap Total (MB)",  field: swap_total_mb}
      - {label: "Swap Used %",      field: swap_used_pct}

  - id: disks
    title: "Filesystems"
    type: table
    rows_field: disks
    columns:
      - {label: "Mount",      field: mount}
      - {label: "Device",     field: device}
      - {label: "FS Type",    field: fstype}
      - {label: "Total (GB)", field: total_gb}
      - {label: "Free (GB)",  field: free_gb}
      - {label: "Used %",     field: used_pct,  badge: true}

  - id: patching
    title: "Patching & Services"
    type: key_value
    fields:
      - {label: "Failed Services",   field: failed_services_count}
      - {label: "Pending Updates",   field: pending_updates_count}
      - {label: "Reboot Required",   field: reboot_pending}

  - id: alerts
    title: "Active Alerts"
    type: alert_panel
