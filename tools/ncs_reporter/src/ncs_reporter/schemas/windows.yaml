name: windows
platform: windows
display_name: "Windows"

# Detects the key emitted by the internal.windows role via ncs_collector callback.
detection:
  keys_any: [windows_raw_audit]

# ---------------------------------------------------------------------------
# Fields
#
# Raw Windows data lives under:
#   windows_raw_audit.<module_name>.*
#
# PowerShell script outputs are JSON strings wrapped by Ansible's win_powershell
# register format: {"output": ["<json_string>"], ...}
# These are unwrapped by the unwrap_ps_json.py script.
# ---------------------------------------------------------------------------

fields:

  # --- Collection timestamp ---

  collected_at:
    path: "windows_raw_audit.metadata.timestamp"
    type: str
    fallback: ""

  # --- CCMExec service ---

  ccm_service_state:
    path: "windows_raw_audit.data.ccm_service.state"
    type: str
    fallback: "unknown"

  # --- ConfigMgr applications (PowerShell JSON) ---
  # The raw field is Ansible's win_powershell output format.
  # unwrap_ps_json.py extracts it; key="AllApps" gives the full app list.

  raw_configmgr_apps:
    path: "windows_raw_audit.data.configmgr_apps"
    type: dict
    fallback: {}

  configmgr_apps:
    script: "unwrap_ps_json.py"
    script_args:
      source_field: "raw_configmgr_apps"
      key: "AllApps"
    type: list
    fallback: []

  apps_to_update:
    script: "unwrap_ps_json.py"
    script_args:
      source_field: "raw_configmgr_apps"
      key: "AppsToUpdate"
    type: list
    fallback: []

  # --- Installed applications (PowerShell JSON) ---

  raw_installed_apps:
    path: "windows_raw_audit.data.installed_apps"
    type: dict
    fallback: {}

  installed_apps:
    script: "unwrap_ps_json.py"
    script_args:
      source_field: "raw_installed_apps"
    type: list
    fallback: []

  # --- Windows Update results ---

  update_results:
    path: "windows_raw_audit.data.update_results"
    type: list
    fallback: []

# ---------------------------------------------------------------------------
# Alerts
# ---------------------------------------------------------------------------

alerts:

  # ---- Services ----

  - id: ccmexec_not_running
    category: "Services"
    severity: WARNING
    condition:
      op: ne_str
      field: ccm_service_state
      value: "running"
    message: "ConfigMgr client service (CCMExec) is not running (state: {ccm_service_state})"
    detail_fields: [ccm_service_state]

  # ---- Updates ----

  - id: failed_updates
    category: "Patching"
    severity: WARNING
    condition:
      op: filter_count
      field: update_results
      filter_field: failed
      filter_value: true
      threshold: 0
    message: "One or more ConfigMgr application updates failed"
    affected_items_field: update_results

  # ---- Applications ----

  - id: apps_pending_update
    category: "Patching"
    severity: WARNING
    condition:
      op: exists
      field: apps_to_update
    message: "ConfigMgr applications have pending updates"
    affected_items_field: apps_to_update

# ---------------------------------------------------------------------------
# Sections (template rendering)
# ---------------------------------------------------------------------------

sections:

  - id: services
    title: "Services"
    type: key_value
    fields:
      - {label: "CCMExec State", field: ccm_service_state}

  - id: configmgr_apps
    title: "ConfigMgr Applications"
    type: table
    rows_field: configmgr_apps
    columns:
      - {label: "Name",    field: Name}
      - {label: "Version", field: Version}

  - id: apps_to_update
    title: "Applications Pending Update"
    type: table
    rows_field: apps_to_update
    columns:
      - {label: "Name",           field: Name}
      - {label: "Current Version", field: CurrentVersion}
      - {label: "Target Version",  field: TargetVersion}

  - id: update_results
    title: "Update Results"
    type: table
    rows_field: update_results
    columns:
      - {label: "Application", field: application}
      - {label: "Status",      field: status,  badge: true}
      - {label: "Failed",      field: failed,  badge: true}

  - id: alerts
    title: "Active Alerts"
    type: alert_panel
