# justfile for ncs-reporter

set dotenv-load

python := if path_exists(".venv/bin/python") { ".venv/bin/python" } else { "python3" }
pytest := if path_exists(".venv/bin/pytest") { ".venv/bin/pytest" } else { "pytest" }
ruff   := if path_exists(".venv/bin/ruff")   { ".venv/bin/ruff" }   else { "ruff" }
mypy   := if path_exists(".venv/bin/mypy")   { ".venv/bin/mypy" }   else { "mypy" }

export PYTHONPATH := "src"

# Default task: list all commands
default:
    @just --list

# Install dependencies into a virtual environment
setup:
    python3 -m venv .venv
    .venv/bin/pip install --upgrade pip
    .venv/bin/pip install -e .
    .venv/bin/pip install ruff mypy pytest

# Run linting checks
lint:
    {{ ruff }} check .

# Format code
format:
    {{ ruff }} format .

# Run type checking
check:
    {{ mypy }} src

# Run unit tests
test:
    {{ pytest }} tests

# Generate site health dashboard
site input groups output="reports":
    {{ python }} -m ncs_reporter.cli site --input {{ input }} --groups {{ groups }} --output-dir {{ output }}

# Generate linux fleet report
linux input output="reports/platform/ubuntu":
    {{ python }} -m ncs_reporter.cli linux --input {{ input }} --output-dir {{ output }}

# Generate vmware fleet report
vmware input output="reports/platform/vmware":
    {{ python }} -m ncs_reporter.cli vmware --input {{ input }} --output-dir {{ output }}

# Generate windows fleet report
windows input output="reports/platform/windows":
    {{ python }} -m ncs_reporter.cli windows --input {{ input }} --output-dir {{ output }}

# Generate a single node report from raw YAML
node platform input hostname output=".":
    {{ python }} -m ncs_reporter.cli node --platform {{ platform }} --input {{ input }} --hostname {{ hostname }} --output-dir {{ output }}

# Run all quality checks
test-all: lint check test
