image: python:3.11

stages:
  - lint
  - syntax
  - test

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  ANSIBLE_FORCE_COLOR: "true"
  PY_COLORS: "1"

cache:
  paths:
    - .cache/pip

before_script:
  - python -m pip install --upgrade pip
  - pip install ansible-core ansible-lint yamllint
  - export ANSIBLE_CONFIG="$CI_PROJECT_DIR/ansible.cfg"
  - export ANSIBLE_LOCAL_TEMP="/tmp/ansible-local"
  - export ANSIBLE_REMOTE_TEMP="/tmp/ansible-remote"

# ─────────────────────────────────────────────────────────────────────────────
# 1) LINT STAGE
# ─────────────────────────────────────────────────────────────────────────────
yaml_lint:
  stage: lint
  script:
    - yamllint .

ansible_lint:
  stage: lint
  script:
    - ansible-lint

ruff:
  stage: lint
  script:
    - pip install ruff
    - ruff check .

mypy:
  stage: lint
  script:
    - pip install mypy types-pyyaml
    - mypy .

# ─────────────────────────────────────────────────────────────────────────────
# 2) SYNTAX STAGE
# ─────────────────────────────────────────────────────────────────────────────
playbook_syntax:
  stage: syntax
  script:
    - echo "dummy_password" > .vaultpass
    - |
      for playbook in playbooks/*.yml; do
        [ -f "$playbook" ] || continue
        echo "Checking syntax for $playbook..."
        ansible-playbook -i inventory/production --syntax-check "$playbook"
      done

# ─────────────────────────────────────────────────────────────────────────────
# 3) TEST STAGE (Unit & E2E Tests)
# ─────────────────────────────────────────────────────────────────────────────
unit_tests:
  stage: test
  script:
    - pip install -e "$CI_PROJECT_DIR/../ncs_reporter"
    - export PYTHONPATH="$PYTHONPATH:$CI_PROJECT_DIR/libs/ncs_core/src"
    - pytest tests/unit "$CI_PROJECT_DIR/../ncs_reporter/tests"
