---
# playbooks/generate_reports.yml
# Unified reporting engine execution and dashboard generation.
# This playbook bridges the gap between raw Ansible telemetry and human-readable
# reports. It dumps inventory group metadata to JSON and invokes the
# 'ncs-reporter' CLI tool to normalize raw YAML data into view models.
# The process renders rich HTML dashboards, STIG compliance summaries,
# and platform-specific health reports based on the latest audit artifacts.

- name: "Reporting Phase | Unified Fleet Report Generation"
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    _reports_root: "{{ ncs_config.report_directory }}"
    _platform_root: "{{ _reports_root }}/platform"
    _groups_json: "{{ _platform_root }}/inventory_groups.json"

    report_stamp: "{{ now(utc=true, fmt='%Y%m%d') }}"

  tasks:
    - name: Ensure platform root exists
      ansible.builtin.file:
        path: "{{ _platform_root }}"
        state: directory
        mode: "0755"

    - name: Dump inventory groups for reporter
      ansible.builtin.copy:
        content: "{{ groups | to_json }}"
        dest: "{{ _groups_json }}"
        mode: "0644"

    - name: Run Unified Reporting Engine (ncs-reporter all)
      block:
        - name: Execute NCS reporter CLI
          ansible.builtin.command:
            cmd: >-
              ncs-reporter all
              --platform-root "{{ _platform_root }}"
              --reports-root "{{ _reports_root }}"
              --groups "{{ _groups_json }}"
              --report-stamp "{{ report_stamp }}"
              --config-dir "{{ playbook_dir }}/../files/ncs_reporter_configs"
          register: _reporter_result
          changed_when: _reporter_result.rc == 0

      rescue:
        - name: Handle report generation failure
          ansible.builtin.debug:
            msg: >-
              ncs-reporter exited {{ _reporter_result.rc | default('unknown') }}.
              stderr: {{ _reporter_result.stderr | default('') }}
