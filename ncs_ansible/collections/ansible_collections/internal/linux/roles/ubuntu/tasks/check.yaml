---
# internal.linux.ubuntu_stig_audit : tasks/check.yaml

- name: "Ubuntu STIG | Evaluate compliance (read-only)"
  tags: [stig, security, audit]
  when:
    - ubuntu_stig_enable_audit | default(true) | bool
    - not (ubuntu_stig_enable_hardening | default(false) | bool)
  block:
    - name: "Ubuntu STIG | Execute STIG rules in simulation"
      ansible.builtin.include_tasks: ubuntu2404.yaml
      args:
        apply:
          check_mode: true
          tags: [stig_task]
          vars:
            stig_target_host: "{{ inventory_hostname }}"
            stig_target_type: "ubuntu"
            stig_platform: "linux/ubuntu"
      # ncs_collector captures per-task STIG results from runner events; include_tasks
      # does not reliably return per-task results for direct export here.
      ignore_errors: true # noqa: ignore-errors

    - name: "Ubuntu STIG | Flag audit as complete"
      ansible.builtin.set_fact:
        _stig_audit_ran: true
      changed_when: false
