---
# internal.linux.ubuntu : tasks/stig.yaml

# =============================================================================
# Phase 0 | Preconditions
# =============================================================================

- name: "Ubuntu STIG | Phase 0 | Gather service facts"
  ansible.builtin.service_facts:

# =============================================================================
# Phase 1 | Evaluate
# =============================================================================

- name: "Ubuntu STIG | Phase 1 | Evaluate"
  block:
    - name: "Ubuntu STIG | Phase 1a | Run audit"
      ansible.builtin.import_tasks: check.yaml
      tags: [checks, stig, security]

  rescue:
    - name: "Ubuntu STIG | Phase 1r | Set failure flag"
      ansible.builtin.set_fact:
        _stig_audit_failed: true
      changed_when: false

    - name: "Ubuntu STIG | Phase 1r | Log failure"
      ansible.builtin.debug:
        msg: "STIG audit failed on {{ inventory_hostname }}. Exporting partial results."

  always:
    - name: "Ubuntu STIG | Log completion"

      ansible.builtin.debug:
        msg: "Ubuntu STIG audit completed. Results emitted via ncs_collector."
